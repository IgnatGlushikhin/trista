const _typeLookup=function(){const t={},e=["Array","Object","Function","Date","RegExp","Float32Array"];for(let i=0;i<e.length;i++)t["[object "+e[i]+"]"]=e[i].toLowerCase();return t}(),pc={version:"__CURRENT_SDK_VERSION__",revision:"__REVISION__",config:{},common:{},apps:{},data:{},unpack:function(){console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.")},makeArray:function(t){let e;const i=[],s=t.length;for(e=0;e<s;++e)i.push(t[e]);return i},type:function(t){if(null===t)return"null";const e=typeof t;return"undefined"===e||"number"===e||"string"===e||"boolean"===e?e:_typeLookup[Object.prototype.toString.call(t)]},extend:function(t,e){let i,s;for(i in e)s=e[i],"object"===pc.type(s)?t[i]=pc.extend({},s):"array"===pc.type(s)?t[i]=pc.extend([],s):t[i]=s;return t},isDefined:function(t){return void 0!==t}};
/**
 * @name pc
 * @namespace
 * @description Root namespace for the PlayCanvas Engine
 * @preserve PlayCanvas Engine v__CURRENT_SDK_VERSION__ revision __REVISION__
 * http://playcanvas.com
 * Copyright 2011-2018 PlayCanvas Ltd. All rights reserved.
// #ifdef DEBUG
 * DEBUG BUILD
// #endif
// #ifdef PROFILER
 * PROFILER BUILD
// #endif
 */"undefined"!=typeof window&&(window.pc=pc),"undefined"!=typeof exports&&(exports.pc=pc),function(){if("undefined"==typeof document)return;const t=function(t){const e=document.createEvent("CustomEvent");e.initCustomEvent("fullscreenchange",!0,!1,null),t.target.dispatchEvent(e)},e=function(t){const e=document.createEvent("CustomEvent");e.initCustomEvent("fullscreenerror",!0,!1,null),t.target.dispatchEvent(e)};document.addEventListener("webkitfullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),document.addEventListener("MSFullscreenChange",t,!1),document.addEventListener("webkitfullscreenerror",e,!1),document.addEventListener("mozfullscreenerror",e,!1),document.addEventListener("MSFullscreenError",e,!1),Element.prototype.mozRequestFullScreen?Element.prototype.requestFullscreen=function(){this.mozRequestFullScreen()}:Element.prototype.requestFullscreen=Element.prototype.requestFullscreen||Element.prototype.webkitRequestFullscreen||Element.prototype.msRequestFullscreen,document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen,document.hasOwnProperty("fullscreenElement")||Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,get:function(){return document.webkitCurrentFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}}),document.hasOwnProperty("fullscreenEnabled")||Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,get:function(){return document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}})}(),Math.log2=Math.log2||function(t){return Math.log(t)*Math.LOG2E},function(){if("undefined"==typeof navigator||"undefined"==typeof document)return;navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;const t=function(){const t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(t)},e=function(){const t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(t)};document.addEventListener("webkitpointerlockchange",t,!1),document.addEventListener("webkitpointerlocklost",t,!1),document.addEventListener("mozpointerlockchange",t,!1),document.addEventListener("mozpointerlocklost",t,!1),document.addEventListener("webkitpointerlockerror",e,!1),document.addEventListener("mozpointerlockerror",e,!1),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,t,e)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}(),String.prototype.endsWith||(String.prototype.endsWith=function(t,e){return(void 0===e||e>this.length)&&(e=this.length),this.substring(e-t.length,e)===t}),String.prototype.includes||(String.prototype.includes=function(t,e){return"number"!=typeof e&&(e=0),!(e+t.length>this.length)&&-1!==this.indexOf(t,e)}),String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return this.substr(!e||e<0?0:+e,t.length)===t}),pc.extend(pc,function(){const t=Math.ceil(10),e={namesToIds:{},idsToNames:{},nextId:0,isKeywordExist:function(t){return void 0!==this.namesToIds[t]},isKeywordIdExist:function(t){return t>=0&&t<this.nextId},getIdByName:function(t){if(void 0===this.namesToIds[t]){if(this.nextId>=320)return console.warn("320 keywords limit exceed. "+t+" was not added!"),null;this.namesToIds[t]=this.nextId,this.idsToNames[this.nextId]=t,this.nextId++}return this.namesToIds[t]}},i=function(){return this.bitfield=new Uint32Array(t),this.cardinality=0,this};return pc.extend(i.prototype,{setEnabledKeywords:function(t){this.clear();for(let e=0;e<t.length;e++)this.enableKeyword(t[e])},enableKeyword:function(t){this.enableKeywordId(pc.KeywordsCollection.getIdByName(t))},disableKeyword:function(t){void 0!==pc.KeywordsCollection.namesToIds[t]&&this.disableKeywordId(pc.KeywordsCollection.getIdByName(t))},enableKeywordId:function(t){if(t>=pc.KeywordsCollection.nextId||t<0)return;const e=Math.floor(t/32),i=1<<t%32;(this.bitfield[e]&i)===i||(this.cardinality++,this.bitfield[e]|=i)},disableKeywordId:function(t){if(t>=pc.KeywordsCollection.nextId||t<0)return;const e=Math.floor(t/32),i=1<<t%32;(this.bitfield[e]&i)===i&&(this.cardinality--,this.bitfield[e]&=~i)},isKeywordEnabled:function(t){return void 0!==pc.KeywordsCollection.namesToIds[t]&&this.isKeywordIdEnabled(pc.KeywordsCollection.getIdByName(t))},isKeywordIdEnabled:function(t){if(t>=pc.KeywordsCollection.nextId||t<0)return!1;const e=Math.floor(t/32),i=1<<t%32;return(this.bitfield[e]&i)===i},subset:function(e){let i,s,n=!0;for(let r=0;r<t;r++)i=this.bitfield[r],s=e.bitfield[r],n=n&&(s&i)===i;return n},getEnabledKeywords:function(){const t=pc.KeywordsCollection.nextId,e=[];for(let i=0;i<t;i++){const t=pc.KeywordsCollection.idsToNames[i];this.isKeywordEnabled(t)&&e.push(t)}return e},getEnabledKeywordsIds:function(){const t=pc.KeywordsCollection.nextId,e=[];for(let i=0;i<t;i++)this.isKeywordEnabled(i)&&e.push(i);return e},merge:function(e){let i,s;for(let n=0;n<t;n++)i=this.bitfield[n],s=e.bitfield[n],this.bitfield[n]=i|s;this.updateCardinality()},clear:function(){for(let e=0;e<t;e++)this.bitfield[e]=0;this.cardinality=0},copy:function(e){for(let i=0;i<t;i++)this.bitfield[i]=e.bitfield[i];this.cardinality=e.cardinality},updateCardinality:function(){this.cardinality=0;for(let e=0;e<t;e++){let t=this.bitfield[e];0!==t&&(t-=t>>1&1431655765,t=(858993459&t)+(t>>2&858993459),this.cardinality+=16843009*(t+(t>>4)&252645135)>>24)}}}),pc.extend(i,{union:function(e,i,s){void 0===s?s=new pc.KeywordSet:s.clear();for(let n=0;n<t;n++)s.bitfield[n]=e.bitfield[n]|i.bitfield[n];return s.updateCardinality(),s},intersection:function(e,i,s){void 0===s?s=new pc.KeywordSet:s.clear();for(let n=0;n<t;n++)s.bitfield[n]=e.bitfield[n]&i.bitfield[n];return s.updateCardinality(),s},differenceLeft:function(e,i,s){void 0===s?s=new pc.KeywordSet:s.clear();for(let n=0;n<t;n++)s.bitfield[n]=(e.bitfield[n]^i.bitfield[n])&e.bitfield[n];return s.updateCardinality(),s},differenceRight:function(t,e,i){return pc.KeywordSet.differenceLeft(e,t,i)},difference:function(e,i,s){void 0===s?s=new pc.KeywordSet:s.clear();for(let n=0;n<t;n++)s.bitfield[n]=e.bitfield[n]^i.bitfield[n];return s.updateCardinality(),s}}),{KeywordSet:i,KeywordsCollection:e,Keywords:{LIGHTMAP_ON:e.getIdByName("LIGHTMAP_ON"),DIRLIGHTMAP_COMBINED:e.getIdByName("DIRLIGHTMAP_COMBINED"),POINT_COOKIE:e.getIdByName("POINT_COOKIE"),POINT:e.getIdByName("POINT"),SPOT:e.getIdByName("SPOT"),DIRECTIONAL_COOKIE:e.getIdByName("DIRECTIONAL_COOKIE"),DIRECTIONAL:e.getIdByName("DIRECTIONAL"),VERTEXLIGHT_ON:e.getIdByName("VERTEXLIGHT_ON"),LIGHTPROBE_SH:e.getIdByName("LIGHTPROBE_SH"),FOG_LINEAR:e.getIdByName("FOG_LINEAR"),FOG_EXP:e.getIdByName("FOG_EXP"),FOG_EXP2:e.getIdByName("FOG_EXP2")}}}()),Object.assign(pc,function(){const t=function(t,e,i,s){const n=t&&t.length;3===n||4===n?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=void 0!==t[3]?t[3]:1):(this.r=t||0,this.g=e||0,this.b=i||0,this.a=void 0!==s?s:1)};return Object.assign(t.prototype,{clone:function(){return new pc.Color(this.r,this.g,this.b,this.a)},copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},set:function(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=void 0===s?1:s,this},setFromArray:function(t,e){return e=e||0,this.r=t[e+0],this.g=t[e+1],this.b=t[e+2],this.a=t[e+3],this},fromString:function(t){const e=parseInt(t.replace("#","0x"),16);let i;return t.length>7?i=pc.math.intToBytes32(e):(i=pc.math.intToBytes24(e),i[3]=255),this.set(i[0]/255,i[1]/255,i[2]/255,i[3]/255),this},toString:function(t){let e="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===t){const t=Math.round(255*this.a).toString(16);this.a<16/255?e+="0"+t:e+=t}return e}}),{Color:t}}()),pc.guid=function(){let t=0;return{create:function(){return"id:"+t++}}}(),Object.assign(pc,{_accumulatedTime:0,_pausedTime:0,pause:function(){pc._pausedTime=pc._now()},resume:function(){pc._accumulatedTime+=pc._now()-pc._pausedTime,pc._pausedTime=0},now:function(){return pc._pausedTime||pc._now()-pc._accumulatedTime},_now:window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now}),Object.assign(pc,{hashCode:function(t){let e=0;for(let i=0,s=t.length;i<s;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return e}}),Object.assign(pc,{URI:function(t){const e=t.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/);this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9],this.toString=function(){let t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+this.authority),t+=this.path,this.query&&(t+="?"+this.query),this.fragment&&(t+="#"+this.fragment),t},this.getQuery=function(){let t,e;const i={};return this.query&&(t=decodeURIComponent(this.query).split("&"),t.forEach((t,s,n)=>{e=t.split("="),i[e[0]]=e[1]},this)),i},this.setQuery=function(t){let e="";for(const i in t)t.hasOwnProperty(i)&&(""!==e&&(e+="&"),e+=encodeURIComponent(i)+"="+encodeURIComponent(t[i]));this.query=e}}}),pc.path={delimiter:"/",join:function(...t){let e;const i=t.length;let s=t[0];for(e=0;e<i-1;++e){const i=t[e],n=t[e+1];if(!pc.isDefined(i)||!pc.isDefined(n))throw new Error("undefined argument to pc.path.join");n[0]!==pc.path.delimiter?i&&n&&i[i.length-1]!==pc.path.delimiter&&n[0]!==pc.path.delimiter?s+=pc.path.delimiter+n:s+=n:s=n}return s},normalize:function(t){const e=t.startsWith(pc.path.delimiter),i=t.endsWith(pc.path.delimiter),s=t.split("/");let n="",r=[];for(let t=0;t<s.length;t++)""!==s[t]&&"."!==s[t]&&(".."===s[t]&&r.length>0?r=r.slice(0,r.length-2):(t>0&&r.push(pc.path.delimiter),r.push(s[t])));return n=r.join(""),e||n[0]!==pc.path.delimiter||(n=n.slice(1)),i&&n[n.length-1]!==pc.path.delimiter&&(n+=pc.path.delimiter),n},split:function(t){const e=t.split(pc.path.delimiter),i=e.slice(e.length-1)[0];return[e.slice(0,e.length-1).join(pc.path.delimiter),i]},getBasename:function(t){return pc.path.split(t)[1]},getDirectory:function(t){const e=t.split(pc.path.delimiter);return e.slice(0,e.length-1).join(pc.path.delimiter)},getExtension:function(t){const e=t.split("?")[0].split(".").pop();return e!==t?"."+e:""},isRelativePath:function(t){return"/"!==t.charAt(0)&&null===t.match(/:\/\//)},extractPath:function(t){let e=".";const i=t.split("/");let s=0;if(i.length>1)for(!1===pc.path.isRelativePath(t)&&(e=""),s=0;s<i.length-1;++s)e+="/"+i[s];return e}},pc.string=function(){const t=55296,e=56319,i=56320,s=57343,n=127462,r=127487,o=127995,a=127999;function c(n,r){const o=n.length;if((r=r||0)<0||r>=o)return null;const a=n.charCodeAt(r);let c;return o>1&&a>=t&&a<=e&&(c=n.charCodeAt(r+1),c>=i&&c<=s)?{code:1024*(a-t)+c-i+65536,long:!0}:{code:a,long:!1}}function h(t,e,i){if(!t)return!1;const s=c(t);if(s){const t=s.code;return t>=e&&t<=i}return!1}function l(i,s){if(s===i.length-1)return 1;if(h(i[s],t,e)){const t=i.substring(s,s+2),e=i.substring(s+2,s+4);return h(e,o,a)||h(t,n,r)&&h(e,n,r)?4:2}return 1}return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(t,...e){let i,s=0;for(s=0;s<e.length;s++)i=new RegExp("\\{"+s+"\\}","gi"),t=t.replace(i,e[s]);return t},startsWith:function(t,e){return console.warn("WARNING: startsWith: Function is deprecated. Use String.startsWith instead."),t.startsWith(e)},endsWith:function(t,e){return console.warn("WARNING: endsWith: Function is deprecated. Use String.endsWith instead."),t.endsWith(e)},toBool:function(t,e){if("true"===t)return!0;if(e){if("false"===t)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(t,e){const i=c(t,e);return i&&i.code},getCodePoints:function(t){if("string"!=typeof t)throw new TypeError("Not a string");let e=0;const i=[];let s;for(;s=c(t,e);)i.push(s.code),e+=s.long?2:1;return i},getSymbols:function(t){if("string"!=typeof t)throw new TypeError("Not a string");let e=0;const i=t.length,s=[];let n,r=0;for(;e<i;){if(r+=l(t,e+r),n=t[e+r],h(n,8400,8447)&&(n=t[e+r++]),h(n,65024,65039)&&(n=t[e+r++]),n&&8205===n.charCodeAt(0)){n=t[e+r++];continue}const i=t.substring(e,e+r);s.push(i),e+=r,r=0}return s},fromCodePoint:function(...t){const e=[];let i,s,n;for(let r=0;r<t.length;++r)i=Number(t[r]),s=i-65536,n=i>65535?[55296+(s>>10),s%1024+56320]:[i],e.push(String.fromCharCode.apply(null,n));return e.join("")}}}(),pc.events={attach:function(t){const e=pc.events;return t.on=e.on,t.off=e.off,t.fire=e.fire,t.once=e.once,t.hasEvent=e.hasEvent,t.bind=e.on,t.unbind=e.off,t.hasListeners=e.hasListeners,t._callbacks={},t._callbackActive={},t},on:function(t,e,i){return t&&"string"==typeof t&&e?(this._callbacks||(this._callbacks={}),this._callbacks[t]||(this._callbacks[t]=[]),this._callbackActive||(this._callbackActive={}),this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].push({callback:e,scope:i||this}),this):this},off:function(t,e,i){if(!this._callbacks)return this;if(this._callbackActive)if(t)this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());else for(const t in this._callbackActive)this._callbacks[t]&&this._callbacks[t]===this._callbackActive[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());if(t)if(e){const s=this._callbacks[t];if(!s)return this;let n=s.length;for(;n--;)s[n].callback===e&&(i&&s[n].scope!==i||s.splice(n,1))}else this._callbacks[t]&&delete this._callbacks[t];else this._callbacks=null;return this},fire:function(t,e,i,s,n,r,o,a,c){if(!t||!this._callbacks||!this._callbacks[t])return this;let h;this._callbackActive||(this._callbackActive={}),this._callbackActive[t]?(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),h=this._callbacks[t].slice()):this._callbackActive[t]=this._callbacks[t];for(let l=0;(h||this._callbackActive[t])&&l<(h||this._callbackActive[t]).length;l++){const p=(h||this._callbackActive[t])[l];if(p.callback.call(p.scope,e,i,s,n,r,o,a,c),p.callback.once){const e=this._callbacks[t].indexOf(p);-1!==e&&(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(e,1))}}return h||(this._callbackActive[t]=null),this},once:function(t,e,i){return e.once=!0,this.on(t,e,i),this},hasEvent:function(t){return this._callbacks&&this._callbacks[t]&&0!==this._callbacks[t].length||!1},hasListeners:function(t){return this._callbacks&&this._callbacks[t]&&this._callbacks[t].length>0}},Object.assign(pc,function(){const t={desktop:!1,mobile:!1,ios:!1,android:!1,windows:!1,cocoonjs:!1,xbox:!1,gamepads:!1,touch:!1},e=navigator.userAgent;return/(windows|mac os|linux|cros)/i.test(e)&&(t.desktop=!0),/xbox/i.test(e)&&(t.xbox=!0),/(windows phone|iemobile|wpdesktop)/i.test(e)?(t.desktop=!1,t.mobile=!0,t.windows=!0):/android/i.test(e)?(t.desktop=!1,t.mobile=!0,t.android=!0):/ip([ao]d|hone)/i.test(e)&&(t.desktop=!1,t.mobile=!0,t.ios=!0),navigator.isCocoonJS&&(t.cocoonjs=!0),t.touch="ontouchstart"in window,t.gamepads="getGamepads"in navigator,{platform:t}}()),Object.assign(pc,function(){const t=function(){this._list=[],this._index={}};return Object.assign(t.prototype,{push:function(t){if(this._index[t.id])throw Error("Key already in index "+t.id);const e=this._list.push(t)-1;this._index[t.id]=e},add:function(t){return!this.has(t)&&(this.push(t),!0)},has:function(t){return void 0!==this._index[t.id]},sort:function(t){this._list.sort(t);for(let t=0;t<this._list.length;t++)this._index[this._list[t].id]=t},remove:function(t){const e=this._index[t.id];return void 0!==e&&(this._index[t.id]=void 0,this._list[e]=this._list[this._list.length-1],this._list.length--,e===this._list.length||(this._index[this._list[e].id]=e,!0))},list:function(){return this._list},clear:function(){this._list.length=0,this._index={}}}),{IndexedList:t}}()),pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(t,e,i){return t>=i?i:t<=e?e:t},intToBytes24:function(t){return[t>>16&255,t>>8&255,255&t]},intToBytes32:function(t){return[t>>24&255,t>>16&255,t>>8&255,255&t]},bytesToInt24:function(t,e,i){return t.length&&(i=t[2],e=t[1],t=t[0]),t<<16|e<<8|i},bytesToInt32:function(t,e,i,s){return t.length&&(s=t[3],i=t[2],e=t[1],t=t[0]),(t<<24|e<<16|i<<8|s)>>>32},lerp:function(t,e,i){return t+(e-t)*pc.math.clamp(i,0,1)},lerpAngle:function(t,e,i){return e-t>180&&(e-=360),e-t<-180&&(e+=360),pc.math.lerp(t,e,pc.math.clamp(i,0,1))},powerOfTwo:function(t){return 0!==t&&!(t&t-1)},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},random:function(t,e){const i=e-t;return Math.random()*i+t},smoothstep:function(t,e,i){return i<=t?0:i>=e?1:(i=(i-t)/(e-t))*i*(3-2*i)},smootherstep:function(t,e,i){return i<=t?0:i>=e?1:(i=(i-t)/(e-t))*i*i*(i*(6*i-15)+10)},sign:function(t){return t<0?-1:1}},Object.assign(pc,function(){const t=function(t,e){t&&2===t.length?(this.x=t[0],this.y=t[1]):(this.x=t||0,this.y=e||0)},e=new t;return Object.assign(t.prototype,{add:function(t){return this.x+=t.x,this.y+=t.y,this},add2:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},clone:function(){return(new t).copy(this)},copy:function(t){return this.x=t.x,this.y=t.y,this},dot:function(t){return this.x*t.x+this.y*t.y},equals:function(t){return e.copy(this),e.sub(t),e.lengthSq()<999999943962493e-25},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},lerp:function(t,e,i){return i=pc.math.clamp(i,0,1),this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this},lerpUnclamped:function(t,e,i){return this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this},mul:function(t){return this.x*=t.x,this.y*=t.y,this},mul2:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this},normalize:function(){const t=this.x*this.x+this.y*this.y;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e}return this},scale:function(t){return this.x*=t,this.y*=t,this},set:function(t,e){return this.x=t,this.y=e,this},sub:function(t){return this.x-=t.x,this.y-=t.y,this},sub2:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},toString:function(){return"["+this.x+", "+this.y+"]"}}),Object.defineProperty(t,"ONE",{get:function(){const e=new t(1,1);return e._data=new Float32Array(2),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"RIGHT",{get:function(){const e=new t(1,0);return e._data=new Float32Array(2),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"UP",{get:function(){const e=new t(0,1);return e._data=new Float32Array(2),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"ZERO",{get:function(){const e=new t(0,0);return e._data=new Float32Array(2),Object.freeze(e),function(){return e}}()}),{Vec2:t}}()),Object.assign(pc,function(){const t=function(t,e,i){t&&3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t||0,this.y=e||0,this.z=i||0)},e=new t;return Object.assign(t.prototype,{add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},add2:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},clone:function(){return(new t).copy(this)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},cross:function(t,e){const i=t.x,s=t.y,n=t.z,r=e.x,o=e.y,a=e.z;return this.x=s*a-o*n,this.y=n*r-a*i,this.z=i*o-r*s,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},equals:function(t,i=999999943962493e-25){return e.copy(this),e.sub(t),e.lengthSq()<i},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},lerp:function(t,e,i){return i=pc.math.clamp(i,0,1),this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this.z=t.z+i*(e.z-t.z),this},lerpUnclamped:function(t,e,i){return this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this.z=t.z+i*(e.z-t.z),this},mul:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},mul2:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},normalize:function(){const t=this.x*this.x+this.y*this.y+this.z*this.z;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e}return this},project:function(t){const e=(this.x*t.x+this.y*t.y+this.z*t.z)/(t.x*t.x+t.y*t.y+t.z*t.z);return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this},set:function(t,e,i){return this.x=t,this.y=e,this.z=i||0,this},sub:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},sub2:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}}),Object.defineProperty(t,"BACK",{get:function(){const e=new t(0,0,1);return e._data=new Float32Array(3),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"DOWN",{get:function(){const e=new t(0,-1,0);return e._data=new Float32Array(3),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"FORWARD",{get:function(){const e=new t(0,0,-1);return e._data=new Float32Array(3),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"LEFT",{get:function(){const e=new t(-1,0,0);return e._data=new Float32Array(3),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"ONE",{get:function(){const e=new t(1,1,1);return e._data=new Float32Array(3),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"RIGHT",{get:function(){const e=new t(1,0,0);return e._data=new Float32Array(3),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"UP",{get:function(){const e=new t(0,1,0);return e._data=new Float32Array(3),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"ZERO",{get:function(){const e=new t(0,0,0);return e._data=new Float32Array(3),Object.freeze(e),function(){return e}}()}),{Vec3:t}}()),Object.assign(pc,function(){const t=function(t,e,i,s){t&&4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=s||0)},e=new t;return Object.assign(t.prototype,{add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},add2:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this},clone:function(){return(new t).copy(this)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},equals:function(t){return e.copy(this),e.sub(t),e.lengthSq()<999999943962493e-25},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},lerp:function(t,e,i){return this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this.z=t.z+i*(e.z-t.z),this.w=t.w+i*(e.w-t.w),this},mul:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},mul2:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this},normalize:function(){const t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e,this.w*=e}return this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},set:function(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this},setFromArray:function(t,e){return e=e||0,this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},sub:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},sub2:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}}),Object.defineProperty(t,"ONE",{get:function(){const e=new t(1,1,1,1);return e._data=new Float32Array(4),Object.freeze(e),function(){return e}}()}),Object.defineProperty(t,"ZERO",{get:function(){const e=new t(0,0,0,0);return e._data=new Float32Array(4),Object.freeze(e),function(){return e}}()}),{Vec4:t}}()),Object.assign(pc,function(){const t=function(){const t=new Float32Array(9);t[0]=t[4]=t[8]=1,this.data=t};return Object.assign(t.prototype,{clone:function(){return(new pc.Mat3).copy(this)},copy:function(t){const e=t.data,i=this.data;return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],this},set:function(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this},equals:function(t){const e=this.data,i=t.data;return e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]&&e[3]===i[3]&&e[4]===i[4]&&e[5]===i[5]&&e[6]===i[6]&&e[7]===i[7]&&e[8]===i[8]},isIdentity:function(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&1===t[4]&&0===t[5]&&0===t[6]&&0===t[7]&&1===t[8]},setIdentity:function(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},toString:function(){let t="[";for(let e=0;e<9;e++)t+=this.data[e],t+=9!==e?", ":"";return t+="]",t},transpose:function(){const t=this.data;let e;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}}),Object.defineProperty(t,"IDENTITY",{get:function(){const e=Object.freeze(new t);return function(){return e}}()}),Object.defineProperty(t,"ZERO",{get:function(){const e=Object.freeze((new t).set([0,0,0,0,0,0,0,0,0]));return function(){return e}}()}),{Mat3:t}}()),Object.assign(pc,function(){const t=function(){const t=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1,this.data=t};return Object.assign(t.prototype,{add2:function(t,e){const i=t.data,s=e.data,n=this.data;return n[0]=i[0]+s[0],n[1]=i[1]+s[1],n[2]=i[2]+s[2],n[3]=i[3]+s[3],n[4]=i[4]+s[4],n[5]=i[5]+s[5],n[6]=i[6]+s[6],n[7]=i[7]+s[7],n[8]=i[8]+s[8],n[9]=i[9]+s[9],n[10]=i[10]+s[10],n[11]=i[11]+s[11],n[12]=i[12]+s[12],n[13]=i[13]+s[13],n[14]=i[14]+s[14],n[15]=i[15]+s[15],this},add:function(t){return this.add2(this,t)},clone:function(){return(new pc.Mat4).copy(this)},copy:function(t){const e=t.data,i=this.data;return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],this},equals:function(t){const e=this.data,i=t.data;return e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]&&e[3]===i[3]&&e[4]===i[4]&&e[5]===i[5]&&e[6]===i[6]&&e[7]===i[7]&&e[8]===i[8]&&e[9]===i[9]&&e[10]===i[10]&&e[11]===i[11]&&e[12]===i[12]&&e[13]===i[13]&&e[14]===i[14]&&e[15]===i[15]},isIdentity:function(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]},mul2:function(t,e){let i,s,n,r;const o=t.data,a=e.data,c=this.data,h=o[0],l=o[1],p=o[2],u=o[3],d=o[4],_=o[5],f=o[6],m=o[7],g=o[8],y=o[9],E=o[10],T=o[11],A=o[12],b=o[13],S=o[14],R=o[15];return i=a[0],s=a[1],n=a[2],r=a[3],c[0]=h*i+d*s+g*n+A*r,c[1]=l*i+_*s+y*n+b*r,c[2]=p*i+f*s+E*n+S*r,c[3]=u*i+m*s+T*n+R*r,i=a[4],s=a[5],n=a[6],r=a[7],c[4]=h*i+d*s+g*n+A*r,c[5]=l*i+_*s+y*n+b*r,c[6]=p*i+f*s+E*n+S*r,c[7]=u*i+m*s+T*n+R*r,i=a[8],s=a[9],n=a[10],r=a[11],c[8]=h*i+d*s+g*n+A*r,c[9]=l*i+_*s+y*n+b*r,c[10]=p*i+f*s+E*n+S*r,c[11]=u*i+m*s+T*n+R*r,i=a[12],s=a[13],n=a[14],r=a[15],c[12]=h*i+d*s+g*n+A*r,c[13]=l*i+_*s+y*n+b*r,c[14]=p*i+f*s+E*n+S*r,c[15]=u*i+m*s+T*n+R*r,this},mul:function(t){return this.mul2(this,t)},transformPoint:function(t,e){const i=this.data,s=t.x,n=t.y,r=t.z;return(e=void 0===e?new pc.Vec3:e).x=s*i[0]+n*i[4]+r*i[8]+i[12],e.y=s*i[1]+n*i[5]+r*i[9]+i[13],e.z=s*i[2]+n*i[6]+r*i[10]+i[14],e},transformVector:function(t,e){const i=this.data,s=t.x,n=t.y,r=t.z;return(e=void 0===e?new pc.Vec3:e).x=s*i[0]+n*i[4]+r*i[8],e.y=s*i[1]+n*i[5]+r*i[9],e.z=s*i[2]+n*i[6]+r*i[10],e},transformVec4:function(t,e){const i=this.data,s=t.x,n=t.y,r=t.z,o=t.w;return(e=void 0===e?new pc.Vec4:e).x=s*i[0]+n*i[4]+r*i[8]+o*i[12],e.y=s*i[1]+n*i[5]+r*i[9]+o*i[13],e.z=s*i[2]+n*i[6]+r*i[10]+o*i[14],e.w=s*i[3]+n*i[7]+r*i[11]+o*i[15],e},setLookAt:function(){const t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3;return function(s,n,r){if(i.sub2(n,s),i.length()<1e-6)return this.setIdentity();i.normalize(),e.copy(r).normalize(),t.cross(e,i).normalize(),e.cross(i,t);const o=this.data;return o[0]=t.x,o[1]=t.y,o[2]=t.z,o[3]=0,o[4]=e.x,o[5]=e.y,o[6]=e.z,o[7]=0,o[8]=i.x,o[9]=i.y,o[10]=i.z,o[11]=0,o[12]=s.x,o[13]=s.y,o[14]=s.z,o[15]=1,this}}(),setFrustum:function(t,e,i,s,n,r){const o=2*n,a=e-t,c=s-i,h=r-n,l=this.data;return l[0]=o/a,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=o/c,l[6]=0,l[7]=0,l[8]=-(e+t)/a,l[9]=-(s+i)/c,l[10]=(-r-n)/h,l[11]=-1,l[12]=0,l[13]=0,l[14]=-o*r/h,l[15]=0,this},setPerspective:function(t,e,i,s,n){let r,o;return n?(r=i*Math.tan(t*Math.PI/360),o=r/e):(o=i*Math.tan(t*Math.PI/360),r=o*e),this.setFrustum(-r,r,-o,o,i,s)},setOrtho:function(t,e,i,s,n,r){const o=this.data;return o[0]=2/(e-t),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/(s-i),o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/(r-n),o[11]=0,o[12]=-(e+t)/(e-t),o[13]=-(s+i)/(s-i),o[14]=-(r+n)/(r-n),o[15]=1,this},setFromAxisAngle:function(t,e){e*=pc.math.DEG_TO_RAD;const i=t.x,s=t.y,n=t.z,r=Math.cos(e),o=Math.sin(e),a=1-r,c=a*i,h=a*s,l=this.data;return l[0]=c*i+r,l[1]=c*s+o*n,l[2]=c*n-o*s,l[3]=0,l[4]=c*s-o*n,l[5]=h*s+r,l[6]=h*n+o*i,l[7]=0,l[8]=c*n+o*s,l[9]=h*n-i*o,l[10]=a*n*n+r,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,this},setTranslate:function(t,e,i){const s=this.data;return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=t,s[13]=e,s[14]=i,s[15]=1,this},setScale:function(t,e,i){const s=this.data;return s[0]=t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this},invert:function(){const t=this.data,e=t[0],i=t[1],s=t[2],n=t[3],r=t[4],o=t[5],a=t[6],c=t[7],h=t[8],l=t[9],p=t[10],u=t[11],d=t[12],_=t[13],f=t[14],m=t[15],g=e*o-i*r,y=e*a-s*r,E=e*c-n*r,T=i*a-s*o,A=i*c-n*o,b=s*c-n*a,S=h*_-l*d,R=h*f-p*d,I=h*m-u*d,C=l*f-p*_,M=l*m-u*_,v=p*m-u*f,P=g*v-y*M+E*C+T*I-A*R+b*S;if(0===P)this.setIdentity();else{const O=1/P;t[0]=(o*v-a*M+c*C)*O,t[1]=(-i*v+s*M-n*C)*O,t[2]=(_*b-f*A+m*T)*O,t[3]=(-l*b+p*A-u*T)*O,t[4]=(-r*v+a*I-c*R)*O,t[5]=(e*v-s*I+n*R)*O,t[6]=(-d*b+f*E-m*y)*O,t[7]=(h*b-p*E+u*y)*O,t[8]=(r*M-o*I+c*S)*O,t[9]=(-e*M+i*I-n*S)*O,t[10]=(d*A-_*E+m*g)*O,t[11]=(-h*A+l*E-u*g)*O,t[12]=(-r*C+o*R-a*S)*O,t[13]=(e*C-i*R+s*S)*O,t[14]=(-d*T+_*y-f*g)*O,t[15]=(h*T-l*y+p*g)*O}return this},set:function(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this},setFromArray:function(t,e){e=e||0;const i=this.data;for(let s=0;s<16;s++)i[s]=t[e+s];return this},setIdentity:function(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},setTRS:function(t,e,i){const s=t.x,n=t.y,r=t.z,o=e.x,a=e.y,c=e.z,h=e.w,l=i.x,p=i.y,u=i.z,d=o+o,_=a+a,f=c+c,m=o*d,g=o*_,y=o*f,E=a*_,T=a*f,A=c*f,b=h*d,S=h*_,R=h*f,I=this.data;return I[0]=(1-(E+A))*l,I[1]=(g+R)*l,I[2]=(y-S)*l,I[3]=0,I[4]=(g-R)*p,I[5]=(1-(m+A))*p,I[6]=(T+b)*p,I[7]=0,I[8]=(y+S)*u,I[9]=(T-b)*u,I[10]=(1-(m+E))*u,I[11]=0,I[12]=s,I[13]=n,I[14]=r,I[15]=1,this},transpose:function(){let t;const e=this.data;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},invertTo3x3:function(t){const e=this.data,i=t.data,s=e[0],n=e[1],r=e[2],o=e[4],a=e[5],c=e[6],h=e[8],l=e[9],p=e[10],u=p*a-c*l,d=-p*n+r*l,_=c*n-r*a,f=-p*o+c*h,m=p*s-r*h,g=-c*s+r*o,y=l*o-a*h,E=-l*s+n*h,T=a*s-n*o,A=s*u+n*f+r*y;if(0===A)return this;const b=1/A;return i[0]=b*u,i[1]=b*d,i[2]=b*_,i[3]=b*f,i[4]=b*m,i[5]=b*g,i[6]=b*y,i[7]=b*E,i[8]=b*T,this},getTranslation:function(t){return(t=void 0===t?new pc.Vec3:t).set(this.data[12],this.data[13],this.data[14])},getX:function(t){return(t=void 0===t?new pc.Vec3:t).set(this.data[0],this.data[1],this.data[2])},getY:function(t){return(t=void 0===t?new pc.Vec3:t).set(this.data[4],this.data[5],this.data[6])},getZ:function(t){return(t=void 0===t?new pc.Vec3:t).set(this.data[8],this.data[9],this.data[10])},getScale:function(){const t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3;return function(s){return s=void 0===s?new pc.Vec3:s,this.getX(t),this.getY(e),this.getZ(i),s.set(t.length(),e.length(),i.length()),s}}(),setFromEulerAngles:function(t,e,i){t*=pc.math.DEG_TO_RAD,e*=pc.math.DEG_TO_RAD,i*=pc.math.DEG_TO_RAD;const s=Math.sin(-t),n=Math.cos(-t),r=Math.sin(-e),o=Math.cos(-e),a=Math.sin(-i),c=Math.cos(-i),h=this.data;return h[0]=o*c,h[1]=-o*a,h[2]=r,h[3]=0,h[4]=n*a+c*s*r,h[5]=n*c-s*r*a,h[6]=-o*s,h[7]=0,h[8]=s*a-n*c*r,h[9]=c*s+n*r*a,h[10]=n*o,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this},getEulerAngles:function(){const t=new pc.Vec3;return function(e=new pc.Vec3){this.getScale(t);const i=t.x,s=t.y,n=t.z,r=this.data,o=Math.asin(-r[2]/i),a=.5*Math.PI;let c=0,h=0;return o<a?o>-a?(c=Math.atan2(r[6]/s,r[10]/n),h=Math.atan2(r[1]/i,r[0]/i)):(h=0,c=-Math.atan2(r[4]/s,r[5]/s)):(h=0,c=Math.atan2(r[4]/s,r[5]/s)),e.set(c,o,h).scale(pc.math.RAD_TO_DEG)}}(),toString:function(){let t,e;for(e="[",t=0;t<16;t+=1)e+=this.data[t],e+=15!==t?", ":"";return e+="]",e}}),Object.defineProperty(t,"IDENTITY",{get:function(){const e=Object.freeze(new t);return function(){return e}}()}),Object.defineProperty(t,"ZERO",{get:function(){const e=Object.freeze((new t).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));return function(){return e}}()}),{Mat4:t}}()),Object.assign(pc,function(){const t=function(t,e,i,s){t&&4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=void 0===t?0:t,this.y=void 0===e?0:e,this.z=void 0===i?0:i,this.w=void 0===s?1:s)};return Object.assign(t.prototype,{clone:function(){return new pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},equals:function(t){return this.dot(t)>.999998986721039},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},negate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this},transformVectorInverse:function(t,e){e=e||new pc.Vec3;const i=2*t.x,s=2*t.y,n=2*t.z,r=this.w*this.w-.5,o=this.x*i+this.y*s+this.z*n;return e.x=i*r-(this.y*n-this.z*s)*this.w+this.x*o,e.y=s*r-(this.z*i-this.x*n)*this.w+this.y*o,e.z=n*r-(this.x*s-this.y*i)*this.w+this.z*o,e},extractAxes:function(t,e,i){const s=this.x,n=this.y,r=this.z,o=this.w,a=s+s,c=n+n,h=r+r,l=a*s,p=c*n,u=h*r,d=a*n,_=a*r,f=a*o,m=c*r,g=c*o,y=h*o;t.set(1-p-u,d+y,_-g),e.set(d-y,1-l-u,m+f),i.set(_+g,m-f,1-l-p)},getAxisAngle:function(t){let e=2*Math.acos(this.w);const i=Math.sin(e/2);return 0!==i?(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i,(t.x<0||t.y<0||t.z<0)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*pc.math.RAD_TO_DEG},getEulerAngles:function(t=new pc.Vec3){let e,i,s;const n=this.x,r=this.y,o=this.z,a=this.w,c=2*(a*r-n*o);return c<=-.99999?(e=2*Math.atan2(n,a),i=-Math.PI/2,s=0):c>=.99999?(e=2*Math.atan2(n,a),i=Math.PI/2,s=0):(e=Math.atan2(2*(a*n+r*o),1-2*(n*n+r*r)),i=Math.asin(c),s=Math.atan2(2*(a*o+n*r),1-2*(r*r+o*o))),t.set(e,i,s).scale(pc.math.RAD_TO_DEG)},getUnityEulerAngles:function(){const t=new pc.Mat4,e=new pc.Vec3,i=new pc.Vec3(1,0,0),s=new pc.Vec3(0,1,0),n=new pc.Vec3(0,0,1);this.transformVector(i,i),this.transformVector(s,s),this.transformVector(n,n),t.data[0]=i.x,t.data[1]=i.y,t.data[2]=i.z,t.data[4]=s.x,t.data[5]=s.y,t.data[6]=s.z,t.data[8]=n.x,t.data[9]=n.y,t.data[10]=n.z,t.data[15]=1;const r=t.data,o=r[0],a=r[8],c=r[1],h=r[5],l=r[9],p=r[2],u=r[10];return e.x=Math.asin(-pc.math.clamp(l,-1,1)),Math.abs(l)<.99999?(e.y=Math.atan2(a,u),e.z=Math.atan2(c,h)):(e.y=Math.atan2(-p,o),e.z=0),e.scale(pc.math.RAD_TO_DEG),e},invert:function(){return this.conjugate().normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},mul:function(t){const e=this.x,i=this.y,s=this.z,n=this.w,r=t.x,o=t.y,a=t.z,c=t.w;return this.x=n*r+e*c+i*a-s*o,this.y=n*o+i*c+s*r-e*a,this.z=n*a+s*c+e*o-i*r,this.w=n*c-e*r-i*o-s*a,this},mul2:function(t,e){const i=t.x,s=t.y,n=t.z,r=t.w,o=e.x,a=e.y,c=e.z,h=e.w;return this.x=r*o+i*h+s*c-n*a,this.y=r*a+s*h+n*o-i*c,this.z=r*c+n*h+i*a-s*o,this.w=r*h-i*o-s*a-n*c,this},nearest:function(t,e){e=e||new pc.Quat;const i=(this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)+(this.z-t.z)*(this.z-t.z)+(this.w-t.w)*(this.w-t.w),s=(this.x+t.x)*(this.x+t.x)+(this.y+t.y)*(this.y+t.y)+(this.z+t.z)*(this.z+t.z)+(this.w+t.w)*(this.w+t.w);return e.copy(t),i>s&&(e.x*=-1,e.y*=-1,e.z*=-1,e.w*=-1),e},normalize:function(){let t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},set:function(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this},fromTo:function(t,e){const i=t.length(),s=t.x/i,n=t.y/i,r=t.z/i,o=e.length(),a=e.x/o,c=e.y/o,h=e.z/o;this.w=Math.cos(Math.acos(s*a+n*c+r*h)/2);const l=Math.sqrt(1-this.w*this.w);if(this.x=(n*h-c*r)*l,this.y=(r*a-h*s)*l,this.z=(s*c-a*n)*l,this.lengthSq()<Number.EPSILON){const t=Math.abs(e.x),i=Math.abs(e.y),s=Math.abs(e.z),n=t<i?t<s?pc.Vec3.RIGHT:pc.Vec3.FORWARD:i<s?pc.Vec3.UP:pc.Vec3.FORWARD;this.x=e.y*n.z-n.y*e.z,this.y=e.z*n.x-n.z*e.x,this.z=e.x*n.y-n.x*e.y;const r=1/this.length();this.x*=r,this.y*=r,this.z*=r}return this},setFromAxisAngle:function(t,e){e*=.5*pc.math.DEG_TO_RAD;const i=Math.sin(e),s=Math.cos(e);return this.x=i*t.x,this.y=i*t.y,this.z=i*t.z,this.w=s,this},setFromEulerAngles:function(t,e,i){const s=.5*pc.math.DEG_TO_RAD;t*=s,e*=s,i*=s;const n=Math.sin(t),r=Math.cos(t),o=Math.sin(e),a=Math.cos(e),c=Math.sin(i),h=Math.cos(i);return this.x=n*a*h-r*o*c,this.y=r*o*h+n*a*c,this.z=r*a*c-n*o*h,this.w=r*a*h+n*o*c,this},setFromMat4:function(t){let e,i,s,n,r,o,a,c,h,l,p;e=(t=t.data)[0],i=t[1],s=t[2],n=t[4],r=t[5],o=t[6],a=t[8],c=t[9],h=t[10];let u=1/Math.sqrt(e*e+i*i+s*s),d=1/Math.sqrt(n*n+r*r+o*o),_=1/Math.sqrt(a*a+c*c+h*h);u=Number.isFinite(u)?u:1,d=Number.isFinite(d)?d:1,_=Number.isFinite(_)?_:1,e*=u,i*=u,s*=u,n*=d,r*=d,o*=d,a*=_,c*=_,h*=_;const f=e+r+h;return f>=0?(l=Math.sqrt(f+1),this.w=.5*l,l=.5/l,this.x=(o-c)*l,this.y=(a-s)*l,this.z=(i-n)*l):e>r?e>h?(p=e-(r+h)+1,p=Math.sqrt(p),this.x=.5*p,p=.5/p,this.w=(o-c)*p,this.y=(i+n)*p,this.z=(s+a)*p):(p=h-(e+r)+1,p=Math.sqrt(p),this.z=.5*p,p=.5/p,this.w=(i-n)*p,this.x=(a+s)*p,this.y=(c+o)*p):r>h?(p=r-(h+e)+1,p=Math.sqrt(p),this.y=.5*p,p=.5/p,this.w=(a-s)*p,this.z=(o+c)*p,this.x=(n+i)*p):(p=h-(e+r)+1,p=Math.sqrt(p),this.z=.5*p,p=.5/p,this.w=(i-n)*p,this.x=(a+s)*p,this.y=(c+o)*p),this},slerp:function(t,e,i){return i=pc.math.clamp(i,0,1),this.slerpUnclamped(t,e,i)},slerpUnclamped:function(t,e,i){let s,n,r,o;const a=t.x,c=t.y,h=t.z,l=t.w;s=e.x,n=e.y,r=e.z,o=e.w;let p=l*o+a*s+c*n+h*r;if(p<0&&(o=-o,s=-s,n=-n,r=-r,p=-p),Math.abs(p)>=1)return this.w=l,this.x=a,this.y=c,this.z=h,this;const u=Math.acos(p),d=Math.sqrt(1-p*p);if(Math.abs(d)<.001)return this.w=.5*l+.5*o,this.x=.5*a+.5*s,this.y=.5*c+.5*n,this.z=.5*h+.5*r,this;const _=Math.sin((1-i)*u)/d,f=Math.sin(i*u)/d;return this.w=l*_+o*f,this.x=a*_+s*f,this.y=c*_+n*f,this.z=h*_+r*f,this},transformVector:function(t,e){void 0===e&&(e=new pc.Vec3);const i=t.x,s=t.y,n=t.z,r=this.x,o=this.y,a=this.z,c=this.w,h=c*i+o*n-a*s,l=c*s+a*i-r*n,p=c*n+r*s-o*i,u=-r*i-o*s-a*n;return e.x=h*c+u*-r+l*-a-p*-o,e.y=l*c+u*-o+p*-r-h*-a,e.z=p*c+u*-a+h*-o-l*-r,e},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},setLookAt:function(t,e){if(t.equals(pc.Vec3.ZERO))return this.copy(pc.Quat.IDENTITY);const i=(new pc.Mat4).setLookAt(pc.Vec3.ZERO,t,e);return this.setFromMat4(i),this}}),Object.defineProperty(t,"IDENTITY",{get:function(){const e=Object.freeze(new t);return function(){return e}}()}),Object.defineProperty(t,"ZERO",{get:function(){const e=Object.freeze(new t(0,0,0,0));return function(){return e}}()}),{Quat:t}}()),Object.assign(pc,function(){const t=function(t){if(this.keys=[],this.type=1,this.tension=.5,t)for(let e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()};return Object.assign(t.prototype,{add:function(t,e){const i=this.keys,s=i.length;let n=0;for(;n<s&&!(i[n][0]>t);n++);const r=[t,e];return this.keys.splice(n,0,r),r},get:function(t){return this.keys[t]},sort:function(){this.keys.sort((t,e)=>t[0]-e[0])},value:function(t){let e,i;const s=this.keys;if(!s.length)return 0;if(t<s[0][0])return s[0][1];if(t>s[s.length-1][0])return s[s.length-1][1];let n=0,r=s.length?s[0][1]:0,o=1,a=0;for(e=0,i=s.length;e<i;e++){if(s[e][0]===t)return s[e][1];if(a=s[e][1],t<s[e][0]){o=s[e][0];break}n=s[e][0],r=s[e][1]}const c=o-n;let h=0===c?0:(t-n)/c;if(1===this.type)h*=h*(3-2*h);else if(2===this.type||3===this.type){const t=r,i=a;let c=t+(t-i),l=i+(i-t),p=o-n,u=p,d=p;return e>0&&e--,e>0&&(c=s[e-1][1],u=s[e][0]-s[e-1][0]),s.length>e+1&&(p=s[e+1][0]-s[e][0]),s.length>e+2&&(d=s[e+2][0]-s[e+1][0],l=s[e+2][1]),c=t+(c-t)*p/u,l=i+(l-i)*p/d,2===this.type?this._interpolateCatmullRom(c,t,i,l,h):this._interpolateCardinal(c,t,i,l,h,this.tension)}return pc.math.lerp(r,a,h)},_interpolateHermite:function(t,e,i,s,n){const r=n*n,o=n*n*n;return t*(2*o-3*r+1)+e*(-2*o+3*r)+i*(o-2*r+n)+s*(o-r)},_interpolateCardinal:function(t,e,i,s,n,r){const o=r*(i-t),a=r*(s-e);return this._interpolateHermite(e,i,o,a,n)},_interpolateCatmullRom:function(t,e,i,s,n){return this._interpolateCardinal(t,e,i,s,n,.5)},closest:function(t){const e=this.keys,i=e.length;let s=2,n=null;for(let r=0;r<i;r++){const i=Math.abs(t-e[r][0]);if(!(s>=i))break;s=i,n=e[r]}return n},clone:function(){const t=new pc.Curve;return t.keys=pc.extend(t.keys,this.keys),t.type=this.type,t},quantize:function(t){t=Math.max(t,2);const e=new Float32Array(t),i=1/(t-1);for(let s=0;s<t;s++){const t=this.value(i*s);e[s]=t}return e}}),Object.defineProperty(t.prototype,"length",{get:function(){return this.keys.length}}),{Curve:t,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3}}()),Object.assign(pc,function(){const t=function(...t){let e;if(this.curves=[],this._type=pc.CURVE_SMOOTHSTEP,t.length>1)for(e=0;e<t.length;e++)this.curves.push(new pc.Curve(t[e]));else if(0===t.length);else{const i=t[0];if("number"===pc.type(i))for(e=0;e<i;e++)this.curves.push(new pc.Curve);else for(e=0;e<i.length;e++)this.curves.push(new pc.Curve(i[e]))}};return Object.assign(t.prototype,{get:function(t){return this.curves[t]},value:function(t,e){const i=this.curves.length;(e=e||[]).length=i;for(let s=0;s<i;s++)e[s]=this.curves[s].value(t);return e},clone:function(){const t=new pc.CurveSet;t.curves=[];for(let e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t},quantize:function(t){t=Math.max(t,2);const e=this.curves.length,i=new Float32Array(t*e),s=1/(t-1),n=[];for(let r=0;r<t;r++){const t=this.value(s*r,n);if(1===e)i[r]=t[0];else for(let s=0;s<e;s++)i[r*e+s]=t[s]}return i}}),Object.defineProperty(t.prototype,"length",{get:function(){return this.curves.length}}),Object.defineProperty(t.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t;for(let e=0;e<this.curves.length;e++)this.curves[e].type=t}}),{CurveSet:t}}()),pc.extend(pc,function(){const t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=1/(4*Math.PI),i=1/(2*Math.PI),s=15/(16*Math.PI),n=5/(64*Math.PI),r=15/(64*Math.PI),o=new pc.Color,a=new pc.Vec3,c=new Float64Array(t),h=function(e){return this.data=new Float64Array(e||t),this};return h.fromArray=function(t){const e=Object.create(h.prototype);return e.data=t,e},pc.extend(h.prototype,{get:function(t,e){return this.data[9*t+e]},set:function(t,e,i){this.data[9*t+e]=i},copy:function(t){for(let e=0;e<this.data.length;e++)this.data[e]=t.data[e]},clear:function(){for(let t=0;t<this.data.length;t++)this.data[t]=0},setFromInterpolation:function(t,e){for(let i=0;i<this.data.length;i++){this.data[i]=0;for(let s=0;s<t.length;s++)this.data[i]+=t[s].data[i]*e[s]}},addCubemap:function(e,i){const s=e.width;let n=0;const r=this.data;c.set(t),this.data=c;for(let t=0;t<6;t++){const r=e._levels[0][t];for(let e=0;e<s;e++)for(let c=0;c<s;c++){const h=e*s+c,l=c/(s-1)*2-1,p=e/(s-1)*2-1,u=1+l*l+p*p,d=4/(Math.sqrt(u)*u);switch(a.set(l,-p,1).normalize(),t){case 0:a.set(a.z,-a.y,-a.x);break;case 1:a.set(-a.z,-a.y,a.x);break;case 2:a.set(a.x,a.z,a.y);break;case 3:a.set(a.x,-a.z,-a.y);break;case 4:a.set(a.x,-a.y,a.z);break;case 5:a.set(-a.x,-a.y,-a.z)}o.set(r[4*h+0]/255,r[4*h+1]/255,r[4*h+2]/255,1),this.addDirectionalLight(a,o,i,d/2.956),n+=d}}for(let t=0;t<this.data.length;t++)r[t]+=4*c[t]*Math.PI/n;this.data=r},addAmbientLight:function(t){o.copy(t).toLinear(),this.data[0]+=o.r,this.data[9]+=o.g,this.data[18]+=o.b},addSkyGradient:function(t,e,i){this.addAmbientLight(e),this.addDirectionalLight(pc.Vec3.UP,t,1,1),this.addDirectionalLight(pc.Vec3.DOWN,i,1,1)},addPointLight:function(t,e,i,s){const n=t.length()/s;a.copy(t).normalize();const r=pc.math.clamp(1/(1+25*n*n)*pc.math.clamp(5*(1-n),0,1),0,1);this.addDirectionalLight(a,e,i,r)},addSpotLight:function(t,e,i,s,n){this.addPointLight(t,e,i,s)},addDirectionalLight:function(t,e,i,s){o.copy(e).scale(i).toLinear().scale(2.956*s),this.addLightFromDirection(t,o)},addLightFromDirection:function(t,o){const a=e,c=i*t.y,h=i*t.z,l=i*t.x,p=s*(t.x*t.y),u=s*(t.y*t.z),d=n*(3*t.z*t.z-1),_=s*(t.x*t.z),f=r*(t.x*t.x-t.y*t.y);this.data[0]+=o.r*a,this.data[1]+=o.r*c,this.data[2]+=o.r*h,this.data[3]+=o.r*l,this.data[4]+=o.r*p,this.data[5]+=o.r*u,this.data[6]+=o.r*d,this.data[7]+=o.r*_,this.data[8]+=o.r*f,this.data[9]+=o.g*a,this.data[10]+=o.g*c,this.data[11]+=o.g*h,this.data[12]+=o.g*l,this.data[13]+=o.g*p,this.data[14]+=o.g*u,this.data[15]+=o.g*d,this.data[16]+=o.g*_,this.data[17]+=o.g*f,this.data[18]+=o.b*a,this.data[19]+=o.b*c,this.data[20]+=o.b*h,this.data[21]+=o.b*l,this.data[22]+=o.b*p,this.data[23]+=o.b*u,this.data[24]+=o.b*d,this.data[25]+=o.b*_,this.data[26]+=o.b*f},updateUniforms:function(){this.uniforms||(this.uniforms=[new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4]);for(let t=0;t<3;t++)this.uniforms[t].x=this.get(t,3),this.uniforms[t].y=this.get(t,1),this.uniforms[t].z=this.get(t,2),this.uniforms[t].w=this.get(t,0)-this.get(t,6);for(let t=0;t<3;t++)this.uniforms[t+3].x=this.get(t,4),this.uniforms[t+3].y=this.get(t,5),this.uniforms[t+3].z=3*this.get(t,6),this.uniforms[t+3].w=this.get(t,7);this.uniforms[6].x=this.get(0,8),this.uniforms[6].y=this.get(1,8),this.uniforms[6].z=this.get(2,8),this.uniforms[6].w=1;for(let t=0;t<7;t++)this.uniforms[t].data},isEmpty:function(){for(let t=0;t<this.data.length;t++)if(Math.abs(this.data[t])>=1e-8)return!1;return!0}}),{SphericalHarmonicsL2:h}}()),Object.assign(pc,function(){const t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3,s=new pc.Vec3,n=new pc.Vec3,r=function(t,e){this.center=t||new pc.Vec3,this.halfExtents=e||new pc.Vec3,this._min=new pc.Vec3,this._max=new pc.Vec3};return Object.assign(r.prototype,{add:function(t){const e=this.center,i=e.x,s=e.y,n=e.z,r=this.halfExtents,o=r.x,a=r.y,c=r.z;let h=i-o,l=i+o,p=s-a,u=s+a,d=n-c,_=n+c;const f=t.center,m=f.x,g=f.y,y=f.z,E=t.halfExtents,T=E.x,A=E.y,b=E.z,S=m-T,R=m+T,I=g-A,C=g+A,M=y-b,v=y+b;S<h&&(h=S),R>l&&(l=R),I<p&&(p=I),C>u&&(u=C),M<d&&(d=M),v>_&&(_=v),e.x=.5*(h+l),e.y=.5*(p+u),e.z=.5*(d+_),r.x=.5*(l-h),r.y=.5*(u-p),r.z=.5*(_-d)},copy:function(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents),this.type=t.type},clone:function(){return new pc.BoundingBox(this.center.clone(),this.halfExtents.clone())},intersects:function(t){const e=this.getMax(),i=this.getMin(),s=t.getMax(),n=t.getMin();return i.x<=s.x&&e.x>=n.x&&i.y<=s.y&&e.y>=n.y&&i.z<=s.z&&e.z>=n.z},_intersectsRay:function(n,r){const o=t.copy(this.getMin()).sub(n.origin),a=e.copy(this.getMax()).sub(n.origin),c=n.direction;0===c.x?(o.x=o.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,a.x=a.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(o.x/=c.x,a.x/=c.x),0===c.y?(o.y=o.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,a.y=a.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(o.y/=c.y,a.y/=c.y),0===c.z?(o.z=o.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,a.z=a.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(o.z/=c.z,a.z/=c.z);const h=i.set(Math.min(o.x,a.x),Math.min(o.y,a.y),Math.min(o.z,a.z)),l=s.set(Math.max(o.x,a.x),Math.max(o.y,a.y),Math.max(o.z,a.z)),p=Math.min(Math.min(l.x,l.y),l.z),u=Math.max(Math.max(h.x,h.y),h.z),d=p>=u&&u>=0;return d&&r.copy(n.direction).scale(u).add(n.origin),d},_fastIntersectsRay:function(r){const o=t,a=e,c=i,h=s,l=n,p=r.direction;return o.sub2(r.origin,this.center),h.set(Math.abs(o.x),Math.abs(o.y),Math.abs(o.z)),c.mul2(o,p),!(h.x>this.halfExtents.x&&c.x>=0)&&(!(h.y>this.halfExtents.y&&c.y>=0)&&(!(h.z>this.halfExtents.z&&c.z>=0)&&(l.set(Math.abs(p.x),Math.abs(p.y),Math.abs(p.z)),a.cross(p,o),a.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),!(a.x>this.halfExtents.y*l.z+this.halfExtents.z*l.y)&&(!(a.y>this.halfExtents.x*l.z+this.halfExtents.z*l.x)&&!(a.z>this.halfExtents.x*l.y+this.halfExtents.y*l.x)))))},intersectsRay:function(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)},setToInfinity:function(){this.center.set(0,0,0),this.halfExtents.set(Number.MAX_SAFE_INTEGER/2,Number.MAX_SAFE_INTEGER/2,Number.MAX_SAFE_INTEGER/2)},setMinMax:function(t,e){this.center.add2(e,t).scale(.5),this.halfExtents.sub2(e,t).scale(.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},containsPoint:function(t){const e=this.getMin(),i=this.getMax();return!(t.x<e.x||t.x>i.x||t.y<e.y||t.y>i.y||t.z<e.z||t.z>i.z)},setFromTransformedAabb:function(t,e,i){const s=this.center,n=this.halfExtents,r=t.center,o=t.halfExtents,a=(e=e.data)[0],c=e[4],h=e[8],l=e[1],p=e[5],u=e[9],d=e[2],_=e[6],f=e[10],m=Math.abs(a),g=Math.abs(c),y=Math.abs(h),E=Math.abs(l),T=Math.abs(p),A=Math.abs(u),b=Math.abs(d),S=Math.abs(_),R=Math.abs(f);if(s.set(e[12]+a*r.x+c*r.y+h*r.z,e[13]+l*r.x+p*r.y+u*r.z,e[14]+d*r.x+_*r.y+f*r.z),n.set(m*o.x+g*o.y+y*o.z,E*o.x+T*o.y+A*o.z,b*o.x+S*o.y+R*o.z),i){const t=e[3],i=e[7],a=e[11],c=e[15],h=Math.abs(t),l=Math.abs(i),p=Math.abs(a),u=Math.abs(c),d=c+t*r.x+i*r.y+a*r.z,_=u+h*o.x+l*o.y+p*o.z;s.scale(1/d),n.scale(1/_)}},compute:function(i,s){if(0===i.length)return void this.setToInfinity();s=s||3;const n=t.set(i[0],i[1],i[2]),r=e.set(i[0],i[1],i[2]),o=i.length/s;for(let t=1;t<o;t++){const e=i[t*s+0],o=i[t*s+1],a=i[t*s+2];e<n.x&&(n.x=e),o<n.y&&(n.y=o),a<n.z&&(n.z=a),e>r.x&&(r.x=e),o>r.y&&(r.y=o),a>r.z&&(r.z=a)}this.setMinMax(n,r)},expandToPoint:function(t){const e=this.getMin(),i=this.getMax();e.x=Math.min(e.x,t.x),e.y=Math.min(e.y,t.y),e.z=Math.min(e.z,t.z),i.x=Math.max(i.x,t.x),i.y=Math.max(i.y,t.y),i.z=Math.max(i.z,t.z),this.setMinMax(e,i)}}),{BoundingBox:r}}()),Object.assign(pc,function(){const t=new pc.Mat4,e=function(t,e){t=t||(new pc.Mat4).setPerspective(90,16/9,.1,1e3),e=e||new pc.Mat4,this.planes=[],this.unityPlanesOrthographic=[],this.unityPlanesPerspective=[];for(let t=0;t<6;t++)this.planes[t]=[];this.unityPlanesOrthographic[0]=this.planes[1],this.unityPlanesOrthographic[1]=this.planes[0],this.unityPlanesOrthographic[2]=this.planes[2],this.unityPlanesOrthographic[3]=this.planes[3],this.unityPlanesOrthographic[4]=this.planes[5],this.unityPlanesOrthographic[5]=this.planes[4],this.unityPlanesPerspective[0]=this.planes[1],this.unityPlanesPerspective[1]=this.planes[0],this.unityPlanesPerspective[2]=this.planes[3],this.unityPlanesPerspective[3]=this.planes[2],this.unityPlanesPerspective[4]=this.planes[5],this.unityPlanesPerspective[5]=this.planes[4],this.update(t,e)};return Object.assign(e.prototype,{update:function(e,i){t.mul2(e,i);const s=t.data;this.planes[0][0]=s[3]-s[0],this.planes[0][1]=s[7]-s[4],this.planes[0][2]=s[11]-s[8],this.planes[0][3]=s[15]-s[12];let n=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=n,this.planes[0][1]/=n,this.planes[0][2]/=n,this.planes[0][3]/=n,this.planes[1][0]=s[3]+s[0],this.planes[1][1]=s[7]+s[4],this.planes[1][2]=s[11]+s[8],this.planes[1][3]=s[15]+s[12],n=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]),this.planes[1][0]/=n,this.planes[1][1]/=n,this.planes[1][2]/=n,this.planes[1][3]/=n,this.planes[2][0]=s[3]+s[1],this.planes[2][1]=s[7]+s[5],this.planes[2][2]=s[11]+s[9],this.planes[2][3]=s[15]+s[13],n=Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]),this.planes[2][0]/=n,this.planes[2][1]/=n,this.planes[2][2]/=n,this.planes[2][3]/=n,this.planes[3][0]=s[3]-s[1],this.planes[3][1]=s[7]-s[5],this.planes[3][2]=s[11]-s[9],this.planes[3][3]=s[15]-s[13],n=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]),this.planes[3][0]/=n,this.planes[3][1]/=n,this.planes[3][2]/=n,this.planes[3][3]/=n,this.planes[4][0]=s[3]-s[2],this.planes[4][1]=s[7]-s[6],this.planes[4][2]=s[11]-s[10],this.planes[4][3]=s[15]-s[14],n=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]),this.planes[4][0]/=n,this.planes[4][1]/=n,this.planes[4][2]/=n,this.planes[4][3]/=n,this.planes[5][0]=s[3]+s[2],this.planes[5][1]=s[7]+s[6],this.planes[5][2]=s[11]+s[10],this.planes[5][3]=s[15]+s[14],n=Math.sqrt(this.planes[5][0]*this.planes[5][0]+this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]),this.planes[5][0]/=n,this.planes[5][1]/=n,this.planes[5][2]/=n,this.planes[5][3]/=n},containsPoint:function(t){for(let e=0;e<6;e++)if(this.planes[e][0]*t.x+this.planes[e][1]*t.y+this.planes[e][2]*t.z+this.planes[e][3]<=0)return!1;return!0},containsSphere:function(t){let e,i,s=0;const n=t.radius,r=t.center,o=r.x,a=r.y,c=r.z,h=this.planes;let l;for(i=0;i<6;i++){if(l=h[i],e=l[0]*o+l[1]*a+l[2]*c+l[3],e<=-n)return 0;e>n&&s++}return 6===s?2:1}}),{Frustum:e}}()),function(){const t={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BLENDEQUATION_MIN:3,BLENDEQUATION_MAX:4,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,BUFFER_GPUDYNAMIC:3,CLEARFLAG_COLOR:1,CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CLEARFLAG_USE_SKYBOX:8,CUBEFACE_POSX:0,CUBEFACE_NEGX:1,CUBEFACE_POSY:2,CUBEFACE_NEGY:3,CUBEFACE_POSZ:4,CUBEFACE_NEGZ:5,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,TYPE_INT8:0,TYPE_UINT8:1,TYPE_INT16:2,TYPE_UINT16:3,TYPE_INT32:4,TYPE_UINT32:5,TYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,FUNC_NEVER:0,FUNC_LESS:1,FUNC_EQUAL:2,FUNC_LESSEQUAL:3,FUNC_GREATER:4,FUNC_NOTEQUAL:5,FUNC_GREATEREQUAL:6,FUNC_ALWAYS:7,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,PIXELFORMAT_R32F:15,PIXELFORMAT_DEPTH:16,PIXELFORMAT_DEPTHSTENCIL:17,PIXELFORMAT_111110F:18,PIXELFORMAT_SRGB:19,PIXELFORMAT_SRGBA:20,PIXELFORMAT_ETC1:21,PIXELFORMAT_ETC2_RGB:22,PIXELFORMAT_ETC2_RGBA:23,PIXELFORMAT_PVRTC_2BPP_RGB_1:24,PIXELFORMAT_PVRTC_2BPP_RGBA_1:25,PIXELFORMAT_PVRTC_4BPP_RGB_1:26,PIXELFORMAT_PVRTC_4BPP_RGBA_1:27,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",SHADERTAG_MATERIAL:1,STENCILOP_KEEP:0,STENCILOP_ZERO:1,STENCILOP_REPLACE:2,STENCILOP_INCREMENT:3,STENCILOP_INCREMENTWRAP:4,STENCILOP_DECREMENT:5,STENCILOP_DECREMENTWRAP:6,STENCILOP_INVERT:7,TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,TEXHINT_NONE:0,TEXHINT_SHADOWMAP:1,TEXHINT_ASSET:2,TEXHINT_LIGHTMAP:3,UNIFORMTYPE_BOOL:0,UNIFORMTYPE_INT:1,UNIFORMTYPE_FLOAT:2,UNIFORMTYPE_VEC2:3,UNIFORMTYPE_VEC3:4,UNIFORMTYPE_VEC4:5,UNIFORMTYPE_IVEC2:6,UNIFORMTYPE_IVEC3:7,UNIFORMTYPE_IVEC4:8,UNIFORMTYPE_BVEC2:9,UNIFORMTYPE_BVEC3:10,UNIFORMTYPE_BVEC4:11,UNIFORMTYPE_MAT2:12,UNIFORMTYPE_MAT3:13,UNIFORMTYPE_MAT4:14,UNIFORMTYPE_TEXTURE2D:15,UNIFORMTYPE_TEXTURECUBE:16,UNIFORMTYPE_FLOATARRAY:17,UNIFORMTYPE_TEXTURE2D_SHADOW:18,UNIFORMTYPE_TEXTURECUBE_SHADOW:19,UNIFORMTYPE_TEXTURE3D:20};Object.assign(pc,t),pc.gfx={},Object.assign(pc.gfx,t)}(),Object.assign(pc,function(){const t=function(t){this.name=t,this.value=null,this.previous_value=null,this.versionObject=new pc.VersionedObject};return Object.assign(t.prototype,{setValue:function(t){this.value=t,this.previous_value=null,this.versionObject.increment()},pushValue:function(t){if(this.previous_value)throw new Error("pushValue is limited to storing 1 previous value");const e=this.value;this.setValue(t),this.previous_value=e},popValue:function(){this.setValue(this.previous_value)},getValue:function(t){return this.value}}),{ScopeId:t}}()),Object.assign(pc,function(){const t=function(t){this.name=t,this.variables={},this.namespaces={}};return Object.assign(t.prototype,{resolve:function(t){return this.variables.hasOwnProperty(t)||(this.variables[t]=new pc.ScopeId(t)),this.variables[t]},getSubSpace:function(t){return this.namespaces.hasOwnProperty(t)||(this.namespaces[t]=new pc.ScopeSpace(t)),this.namespaces[t]}}),{ScopeSpace:t}}()),Object.assign(pc,function(){const t=function(){this.globalId=0,this.revision=0};return Object.assign(t.prototype,{equals:function(t){return this.globalId===t.globalId&&this.revision===t.revision},notequals:function(t){return this.globalId!==t.globalId||this.revision!==t.revision},copy:function(t){this.globalId=t.globalId,this.revision=t.revision},reset:function(){this.globalId=0,this.revision=0}}),{Version:t}}()),Object.assign(pc,function(){let t=0;const e=function(){t++,this.version=new pc.Version,this.version.globalId=t};return Object.assign(e.prototype,{increment:function(){this.version.revision++}}),{VersionedObject:e}}()),Object.assign(pc,function(){function t(t){this.array[this.index]=t}function e(t,e){this.array[this.index]=t,this.array[this.index+1]=e}function i(t,e,i){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=i}function s(t,e,i,s){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=i,this.array[this.index+3]=s}function n(n,r){switch(this.index=0,r.dataType){case pc.TYPE_INT8:this.array=new Int8Array(n,r.offset);break;case pc.TYPE_UINT8:this.array=new Uint8Array(n,r.offset);break;case pc.TYPE_INT16:this.array=new Int16Array(n,r.offset);break;case pc.TYPE_UINT16:this.array=new Uint16Array(n,r.offset);break;case pc.TYPE_INT32:this.array=new Int32Array(n,r.offset);break;case pc.TYPE_UINT32:this.array=new Uint32Array(n,r.offset);break;case pc.TYPE_FLOAT32:this.array=new Float32Array(n,r.offset)}switch(r.numComponents){case 1:this.set=t;break;case 2:this.set=e;break;case 3:this.set=i;break;case 4:this.set=s}}function r(t){this.vertexBuffer=t,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const e=this.vertexBuffer.getFormat();for(let t=0;t<e.elements.length;t++){const i=e.elements[t];this.accessors[t]=new n(this.buffer,i),this.element[i.name]=this.accessors[t]}}return n.prototype.get=function(t){return this.array[this.index+t]},Object.assign(r.prototype,{next:function(t){void 0===t&&(t=1);let e=0;const i=this.accessors,s=this.accessors.length,n=this.vertexBuffer.getFormat();for(;e<s;){const s=i[e++];s.index+=t*n.size/s.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}}),{VertexIterator:r}}()),Object.assign(pc,function(){const t=[];t[pc.TYPE_INT8]=1,t[pc.TYPE_UINT8]=1,t[pc.TYPE_INT16]=2,t[pc.TYPE_UINT16]=2,t[pc.TYPE_INT32]=4,t[pc.TYPE_UINT32]=4,t[pc.TYPE_FLOAT32]=4;return{VertexFormat:function(e,i){let s,n,r;for(this.elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.elementMap={},this.size=0,s=0,n=i.length;s<n;s++){const n=i[s];r={name:n.semantic,offset:0,stride:0,stream:-1,scopeId:e.scope.resolve(n.semantic),dataType:n.type,numComponents:n.components,normalize:void 0!==n.normalize&&n.normalize,size:n.components*t[n.type]},this.elements.push(r),this.size+=4*Math.ceil(r.size/4),n.semantic===pc.SEMANTIC_TEXCOORD0?this.hasUv0=!0:n.semantic===pc.SEMANTIC_TEXCOORD1?this.hasUv1=!0:n.semantic===pc.SEMANTIC_COLOR?this.hasColor=!0:n.semantic===pc.SEMANTIC_TANGENT&&(this.hasTangents=!0)}let o=0;for(s=0,n=this.elements.length;s<n;s++)r=this.elements[s],r.offset=o,r.stride=this.size,o+=r.size,this.elementMap[r.name]=r}}}()),Object.assign(pc,function(){const t=function(t,e,i,s,n){this.usage=s||pc.BUFFER_STATIC,this.format=e,this.numVertices=i,this.numBytes=e.size*i,t._vram.vb+=this.numBytes,this.device=t,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes)};return Object.defineProperty(t.prototype,"storage",{set:function(t){this._storage=t},get:function(){return this._storage}}),Object.assign(t.prototype,{destroy:function(){this.bufferId&&(this.device._vram.vb-=this.numBytes),this.invalidateBuffer()},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){const t=this.device.gl;let e;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case pc.BUFFER_STATIC:e=t.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:e=t.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:e=t.STREAM_DRAW;break;case pc.BUFFER_GPUDYNAMIC:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ARRAY_BUFFER,this.bufferId),t.bufferData(t.ARRAY_BUFFER,this.storage,e)},setData:function(t){return t.byteLength!==this.numBytes?(console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+t.byteLength),!1):(this.storage=t,this.unlock(),!0)}}),{VertexBuffer:t}}()),Object.assign(pc,function(){const t=function(t,e,i,s,n){this.usage=s||pc.BUFFER_STATIC,this.format=e,this.numIndices=i,this.device=t;const r=this.device.gl;let o;e===pc.INDEXFORMAT_UINT8?(o=1,this.glFormat=r.UNSIGNED_BYTE):e===pc.INDEXFORMAT_UINT16?(o=2,this.glFormat=r.UNSIGNED_SHORT):e===pc.INDEXFORMAT_UINT32&&(o=4,this.glFormat=r.UNSIGNED_INT),this.bytesPerIndex=o,this.numBytes=this.numIndices*o,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),t._vram.ib+=this.numBytes};return Object.assign(t.prototype,{destroy:function(){this.bufferId&&(this.device._vram.ib-=this.numBytes),this.invalidateBuffer()},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){const t=this.device.gl;let e;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case pc.BUFFER_STATIC:e=t.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:e=t.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:e=t.STREAM_DRAW;break;case pc.BUFFER_GPUDYNAMIC:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.bufferId),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.storage,e)},setData:function(t){return t.byteLength!==this.numBytes?(console.error("IndexBuffer: wrong initial data size: expected "+this.numBytes+", got "+t.byteLength),!1):(this.storage=t,this.unlock(),!0)}}),{IndexBuffer:t}}()),Object.assign(pc,function(){const t=function(t,e){e=e||pc.BUFFER_GPUDYNAMIC,this.device=t.device;const i=this.device.gl;this._inputBuffer=t,e===pc.BUFFER_GPUDYNAMIC&&t.usage!==e&&(i.bindBuffer(i.ARRAY_BUFFER,t.bufferId),i.bufferData(i.ARRAY_BUFFER,t.storage,i.DYNAMIC_COPY)),this._outputBuffer=new pc.VertexBuffer(t.device,t.format,t.numVertices,e,t.storage)};return t.createShader=function(t,e,i){return pc.shaderChunks.createShaderFromCode(t,e,null,i,!0)},Object.assign(t.prototype,{destroy:function(){this._outputBuffer.destroy()},process:function(t,e){void 0===e&&(e=!0);const i=this.device;if(i.setRenderTarget(null),i.updateBegin(),i.setVertexBuffer(this._inputBuffer,0),i.setRaster(!1),i.setTransformFeedbackBuffer(this._outputBuffer),i.setShader(t),i.draw({type:pc.PRIMITIVE_POINTS,base:0,count:this._inputBuffer.numVertices,indexed:!1}),i.setTransformFeedbackBuffer(null),i.setRaster(!0),i.updateEnd(),e){const t=this._inputBuffer.bufferId;this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=t}}}),Object.defineProperty(t.prototype,"inputBuffer",{get:function(){return this._inputBuffer}}),Object.defineProperty(t.prototype,"outputBuffer",{get:function(){return this._outputBuffer}}),{TransformFeedback:t}}()),Object.assign(pc,function(){const t=function(t,e){if(this.device=t,this.name=null,this._width=4,this._height=4,this._depth=1,this._pot=!0,this._format=pc.PIXELFORMAT_R8_G8_B8_A8,this.rgbm=!1,this.intensity=1,this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!0,this._premultiplyAlpha=!1,this._mipmaps=!0,this._minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR,this._magFilter=pc.FILTER_LINEAR,this._anisotropy=1,this._addressU=pc.ADDRESS_CLAMP_TO_EDGE,this._addressV=pc.ADDRESS_CLAMP_TO_EDGE,this._addressW=pc.ADDRESS_CLAMP_TO_EDGE,this._compareOnRead=!1,this._compareFunc=pc.FUNC_LESS,this._atlas=null,this._rects=null,this.profilerHint=0,this._buffer=null,void 0!==e&&(this.name=e.name,this._width=void 0!==e.width?e.width:this._width,this._height=void 0!==e.height?e.height:this._height,this._pot=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height),this._format=void 0!==e.format?e.format:this._format,this.rgbm=void 0!==e.rgbm?e.rgbm:this.rgbm,void 0!==e.mipmaps?this._mipmaps=e.mipmaps:this._mipmaps=void 0!==e.autoMipmap?e.autoMipmap:this._mipmaps,this._levels=e.levels,this._atlas=e.atlas,this._rects=e.rects,this._cubemap=void 0!==e.cubemap?e.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==e.fixCubemapSeams?e.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=void 0!==e.minFilter?e.minFilter:this._minFilter,this._magFilter=void 0!==e.magFilter?e.magFilter:this._magFilter,this._anisotropy=void 0!==e.anisotropy?e.anisotropy:this._anisotropy,this._addressU=void 0!==e.addressU?e.addressU:this._addressU,this._addressV=void 0!==e.addressV?e.addressV:this._addressV,this._compareOnRead=void 0!==e.compareOnRead?e.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==e._compareFunc?e._compareFunc:this._compareFunc,this._flipY=void 0!==e.flipY?e.flipY:this._flipY,this._premultiplyAlpha=void 0!==e.premultiplyAlpha?e.premultiplyAlpha:this._premultiplyAlpha,t.webgl2&&(this._depth=void 0!==e.depth?e.depth:this._depth,this._volume=void 0!==e.volume?e.volume:this._volume,this._addressW=void 0!==e.addressW?e.addressW:this._addressW),this.profilerHint=void 0!==e.profilerHint?e.profilerHint:this.profilerHint),this._compressed=this._format===pc.PIXELFORMAT_DXT1||this._format===pc.PIXELFORMAT_DXT3||this._format===pc.PIXELFORMAT_DXT5||this._format>=pc.PIXELFORMAT_ETC1,this._invalid=!1,this._lockedLevel=-1,!this._levels)if(this._cubemap)this._levels=[[null,null,null,null,null,null]];else{const t=this.createBuffer(this._format,this._width,this._height);this._levels=[t]}this.dirtyAll(),this._gpuSize=0};Object.defineProperty(t.prototype,"minFilter",{get:function(){return this._minFilter},set:function(t){this._minFilter!==t&&(this._minFilter=t,this._parameterFlags|=1)}}),Object.defineProperty(t.prototype,"magFilter",{get:function(){return this._magFilter},set:function(t){this._magFilter!==t&&(this._magFilter=t,this._parameterFlags|=2)}}),Object.defineProperty(t.prototype,"addressU",{get:function(){return this._addressU},set:function(t){this._addressU!==t&&(this._addressU=t,this._parameterFlags|=4)}}),Object.defineProperty(t.prototype,"addressV",{get:function(){return this._addressV},set:function(t){this._addressV!==t&&(this._addressV=t,this._parameterFlags|=8)}}),Object.defineProperty(t.prototype,"addressW",{get:function(){return this._addressW},set:function(t){this.device.webgl2&&(this._volume?t!==this._addressW&&(this._addressW=t,this._parameterFlags|=16):console.warn("pc.Texture#addressW: Can't set W addressing mode for a non-3D texture."))}}),Object.defineProperty(t.prototype,"compareOnRead",{get:function(){return this._compareOnRead},set:function(t){this._compareOnRead!==t&&(this._compareOnRead=t,this._parameterFlags|=32)}}),Object.defineProperty(t.prototype,"compareFunc",{get:function(){return this._compareFunc},set:function(t){this._compareFunc!==t&&(this._compareFunc=t,this._parameterFlags|=64)}}),Object.defineProperty(t.prototype,"anisotropy",{get:function(){return this._anisotropy},set:function(t){this._anisotropy!==t&&(this._anisotropy=t,this._parameterFlags|=128)}}),Object.defineProperty(t.prototype,"autoMipmap",{get:function(){return this._mipmaps},set:function(t){this._mipmaps=t}}),Object.defineProperty(t.prototype,"mipmaps",{get:function(){return this._mipmaps},set:function(t){this._mipmaps!==t&&(this._mipmaps=t,this._minFilterDirty=!0,t&&(this._needsMipmapsUpload=!0))}}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width}}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height}}),Object.defineProperty(t.prototype,"depth",{get:function(){return this._depth}}),Object.defineProperty(t.prototype,"format",{get:function(){return this._format}}),Object.defineProperty(t.prototype,"cubemap",{get:function(){return this._cubemap}});let e=null;return Object.defineProperty(t.prototype,"gpuSize",{get:function(){e||(e=[],e[pc.PIXELFORMAT_A8]=1,e[pc.PIXELFORMAT_L8]=1,e[pc.PIXELFORMAT_L8_A8]=1,e[pc.PIXELFORMAT_R5_G6_B5]=2,e[pc.PIXELFORMAT_R5_G5_B5_A1]=2,e[pc.PIXELFORMAT_R4_G4_B4_A4]=2,e[pc.PIXELFORMAT_R8_G8_B8]=4,e[pc.PIXELFORMAT_R8_G8_B8_A8]=4,e[pc.PIXELFORMAT_RGB16F]=8,e[pc.PIXELFORMAT_RGBA16F]=8,e[pc.PIXELFORMAT_RGB32F]=16,e[pc.PIXELFORMAT_RGBA32F]=16,e[pc.PIXELFORMAT_R32F]=4,e[pc.PIXELFORMAT_DEPTH]=4,e[pc.PIXELFORMAT_DEPTHSTENCIL]=4,e[pc.PIXELFORMAT_111110F]=4,e[pc.PIXELFORMAT_SRGB]=4,e[pc.PIXELFORMAT_SRGBA]=4);let t=1;!this._pot||!this._mipmaps&&this._minFilter!==pc.FILTER_NEAREST_MIPMAP_NEAREST&&this._minFilter!==pc.FILTER_NEAREST_MIPMAP_LINEAR&&this._minFilter!==pc.FILTER_LINEAR_MIPMAP_NEAREST&&this._minFilter!==pc.FILTER_LINEAR_MIPMAP_LINEAR||this._compressed&&1===this._levels.length||(t=Math.round(Math.log2(Math.max(this._width,this._height))+1));let i=this._width,s=this._height,n=this._depth,r=0;for(let o=0;o<t;o++){if(this._compressed)if(this._format===pc.PIXELFORMAT_ETC1)r+=Math.floor((i+3)/4)*Math.floor((s+3)/4)*8*n;else if(this._format===pc.PIXELFORMAT_PVRTC_2BPP_RGB_1||this._format===pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1)r+=Math.max(i,16)*Math.max(s,8)/(4*n);else if(this._format===pc.PIXELFORMAT_PVRTC_4BPP_RGB_1||this._format===pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1)r+=Math.max(i,8)*Math.max(s,8)/(2*n);else{const t=4,e=4,o=this._format===pc.PIXELFORMAT_DXT1?8:16;r+=Math.floor((i+t-1)/t)*Math.floor((s+e-1)/e)*o*n}else r+=i*s*n*e[this._format];i=Math.max(.5*i,1),s=Math.max(.5*s,1),n=Math.max(.5*n,1)}return this._cubemap&&(r*=6),r}}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume}}),Object.defineProperty(t.prototype,"flipY",{get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}}),Object.defineProperty(t.prototype,"premultiplyAlpha",{get:function(){return this._premultiplyAlpha},set:function(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}}),Object.assign(t.prototype,{destroy:function(){this.device&&this.device.destroyTexture(this),this.device=null,this._levels=null},dirtyAll:function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255},lock:function(t){if(void 0===(t=t||{level:0,face:0,mode:pc.TEXTURELOCK_WRITE}).level&&(t.level=0),void 0===t.face&&(t.face=0),void 0===t.mode&&(t.mode=pc.TEXTURELOCK_WRITE),this._lockedLevel=t.level,null===this._levels[t.level])switch(this._format){case pc.PIXELFORMAT_A8:case pc.PIXELFORMAT_L8:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth);break;case pc.PIXELFORMAT_L8_A8:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case pc.PIXELFORMAT_R5_G6_B5:case pc.PIXELFORMAT_R5_G5_B5_A1:case pc.PIXELFORMAT_R4_G4_B4_A4:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth);break;case pc.PIXELFORMAT_R8_G8_B8:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_R8_G8_B8_A8:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case pc.PIXELFORMAT_DXT1:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case pc.PIXELFORMAT_DXT3:case pc.PIXELFORMAT_DXT5:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case pc.PIXELFORMAT_RGB16F:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_RGB32F:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_RGBA16F:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case pc.PIXELFORMAT_RGBA32F:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[t.level]},setSource:function(t){let e,i,s,n=!1;if(this._cubemap){if(t[0]){for(i=t[0].width||0,s=t[0].height||0,e=0;e<6;e++)if(!(t[e]&&t[e].width===i&&t[e].height===s&&(t[e]instanceof HTMLImageElement||t[e]instanceof HTMLCanvasElement||t[e]instanceof HTMLVideoElement))){n=!0;break}}else n=!0;if(!n)for(e=0;e<6;e++)this._levels[0][e]!==t[e]&&(this._levelsUpdated[0][e]=!0)}else t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||(n=!0),n||(t!==this._levels[0]&&(this._levelsUpdated[0]=!0),i=t.width,s=t.height);if(n)if(this._width=4,this._height=4,this._pot=!0,this._cubemap)for(e=0;e<6;e++)this._levels[0][e]=null,this._levelsUpdated[0][e]=!0;else this._levels[0]=null,this._levelsUpdated[0]=!0;else this._width=i,this._height=s,this._pot=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height),this._levels[0]=t;this._invalid===n&&n||(this._invalid=n,this.upload())},getSource:function(){return this._levels[0]},unlock:function(){-1===this._lockedLevel&&console.log("pc.Texture#unlock: Attempting to unlock a texture that is not locked."),this.upload(),this._lockedLevel=-1},upload:function(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps},getDds:function(){this.format!==pc.PIXELFORMAT_R8_G8_B8_A8&&console.error("This format is not implemented yet");let t,e,i=128,s=0;for(;this._levels[s];){let t;if(this.cubemap)for(e=0;e<6;e++){if(!this._levels[s][e])return console.error("No level data for mip "+s+", face "+e),null;if(t=this._levels[s][e].length,!t)return console.error("No byte array for mip "+s+", face "+e),null;i+=t}else{if(t=this._levels[s].length,!t)return console.error("No byte array for mip "+s),null;i+=t}i+=this._levels[s].length,s++}const n=new ArrayBuffer(i),r=new Uint32Array(n,0,32);let o=528391;this._levels.length>1&&(o|=131072);let a=4096;this._levels.length>1&&(a|=4194304),(this._levels.length>1||this.cubemap)&&(a|=8);const c=this.cubemap?65024:0;for(r[0]=542327876,r[1]=124,r[2]=o,r[3]=this.height,r[4]=this.width,r[5]=this.width*this.height*4,r[6]=0,r[7]=this._levels.length,s=0;s<11;s++)r[8+s]=0;r[19]=32,r[20]=65,r[21]=0,r[22]=32,r[23]=16711680,r[24]=65280,r[25]=255,r[26]=4278190080,r[27]=a,r[28]=c,r[29]=0,r[30]=0,r[31]=0;let h,l,p=128;if(this.cubemap)for(e=0;e<6;e++)for(s=0;s<this._levels.length;s++){for(h=this._levels[s][e],l=new Uint8Array(n,p,h.length),t=0;t<h.length;t++)l[t]=h[t];p+=h.length}else for(s=0;s<this._levels.length;s++){for(h=this._levels[s],l=new Uint8Array(n,p,h.length),t=0;t<h.length;t++)l[t]=h[t];p+=h.length}return n},clone:function(){const t={name:this.name,width:this._width,height:this._height,addressU:this._addressU,addressV:this._addressV,mipmaps:this._mipmaps,minFilter:this._minFilter,magFilter:this._magFilter,autoMipmap:this._mipmaps,rgbm:this.rgbm,anisotropy:this._anisotropy,format:this._format},e=new pc.Texture(this.device,t);return e.setSource(this._levels[0]),e},createBuffer:function(t,e,i){switch(t){case pc.PIXELFORMAT_R8_G8_B8:return new Uint8Array(3*e*i);case pc.PIXELFORMAT_R8_G8_B8_A8:return new Uint8Array(4*e*i)}return null}}),{Texture:t}}()),Object.assign(pc,function(){const t={depth:!0,face:0},e=function(e,i,s){if(e instanceof pc.GraphicsDevice?(this._colorBuffer=i,e=s):this._colorBuffer=e.colorBuffer,this._glFrameBuffer=null,this._glDepthBuffer=null,e=void 0!==e?e:t,this._depthBuffer=e.depthBuffer,this._face=void 0!==e.face?e.face:0,this._depthBuffer){const t=this._depthBuffer._format;t===pc.PIXELFORMAT_DEPTH?(this._depth=!0,this._stencil=!1):t===pc.PIXELFORMAT_DEPTHSTENCIL?(this._depth=!0,this._stencil=!0):(console.warn("Incorrect depthBuffer format. Must be pc.PIXELFORMAT_DEPTH or pc.PIXELFORMAT_DEPTHSTENCIL"),this._depth=!1,this._stencil=!1)}else this._depth=void 0===e.depth||e.depth,this._stencil=void 0!==e.stencil&&e.stencil;this._samples=void 0!==e.samples?e.samples:1,this.autoResolve=void 0===e.autoResolve||e.autoResolve,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null};return Object.assign(e.prototype,{destroy:function(){if(!this._device)return;const t=this._device,e=t.targets.indexOf(this);-1!==e&&t.targets.splice(e,1);const i=t.gl;this._glFrameBuffer&&(i.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(i.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(i.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(i.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(i.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)},resolve:function(t,e){if(!this._device)return;if(!this._device.webgl2)return;const i=this._device.gl;void 0===t&&(t=!0),void 0===e&&this._depthBuffer&&(e=!0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._glFrameBuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),i.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(t?i.COLOR_BUFFER_BIT:0)|(e?i.DEPTH_BUFFER_BIT:0),i.NEAREST),i.bindFramebuffer(i.FRAMEBUFFER,this._glFrameBuffer)},copy:function(t,e,i){if(!this._device){if(!t._device)return console.error("Render targets are not initialized"),!1;this._device=t._device}return this._device.copyRenderTarget(t,this,e,i)}}),Object.defineProperty(e.prototype,"colorBuffer",{get:function(){return this._colorBuffer}}),Object.defineProperty(e.prototype,"depthBuffer",{get:function(){return this._depthBuffer}}),Object.defineProperty(e.prototype,"face",{get:function(){return this._face}}),Object.defineProperty(e.prototype,"width",{get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}}),Object.defineProperty(e.prototype,"height",{get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}),{RenderTarget:e}}()),Object.assign(pc,{ShaderInput:function(t,e,i,s){this.locationId=s,this.scopeId=t.scope.resolve(e),this.version=new pc.Version,i===pc.UNIFORMTYPE_FLOAT&&"[0]"===e.substr(e.length-3)&&(i=pc.UNIFORMTYPE_FLOATARRAY),this.dataType=i,this.dataType===pc.UNIFORMTYPE_VEC2?this.value=[null,null]:this.dataType===pc.UNIFORMTYPE_VEC3?this.value=[null,null,null]:this.value=[null,null,null,null],this.array=[]}}),Object.assign(pc,function(){const t=function(t,e){this.device=t,this.definition=e,this.attributes=[],this.uniforms=[],this.samplers=[],this._keywords=[],this._supportsKeywords=!1,this._globalKeywordsVersion=0,this.ready=!1,this._refCount=0,this.device.createShader(this)};return Object.assign(t.prototype,{destroy:function(){this.device.destroyShader(this)}}),{Shader:t}}()),Object.assign(pc,function(){const t=function(t){this._device=t,this._cache={},this._generators={},this._isClearingCache=!1};return t.prototype.register=function(t,e){this.isRegistered(t)||(this._generators[t]=e)},t.prototype.unregister=function(t){this.isRegistered(t)&&delete this._generators[t]},t.prototype.isRegistered=function(t){return void 0!==this._generators[t]},t.prototype.getProgram=function(t,e){const i=this._generators[t];if(void 0===i)return console.warn("ProgramLibrary#getProgram: No program library functions registered for: "+t),null;const s=this._device,n=i.generateKey(e);let r=this._cache[n];if(!r){const t=i.createShaderDefinition(s,e);r=this._cache[n]=new pc.Shader(s,t)}return r},t.prototype.clearCache=function(){const t=this._cache;this._isClearingCache=!0;for(const e in t)t.hasOwnProperty(e)&&t[e].destroy();this._cache={},this._isClearingCache=!1},t.prototype.removeFromCache=function(t){if(this._isClearingCache)return;const e=this._cache;for(const i in e)if(e.hasOwnProperty(i)&&e[i]===t){delete e[i];break}},{ProgramLibrary:t}}()),Object.assign(pc,function(){const t=new Float32Array([1,1,1,1]),e=new Float32Array([0,0,0,0]),i=new Float32Array([0,0,0,1]),s=new Float32Array([1,0,0,1]),n=new Float32Array([0,0,1,1]),r={};r[pc.SEMANTIC_POSITION]=0,r[pc.SEMANTIC_NORMAL]=1,r[pc.SEMANTIC_TANGENT]=2,r[pc.SEMANTIC_BLENDWEIGHT]=3,r[pc.SEMANTIC_BLENDINDICES]=4,r[pc.SEMANTIC_COLOR]=5,r[pc.SEMANTIC_TEXCOORD0]=6,r[pc.SEMANTIC_TEXCOORD1]=7,r[pc.SEMANTIC_TEXCOORD2]=8,r[pc.SEMANTIC_TEXCOORD3]=9,r[pc.SEMANTIC_TEXCOORD4]=10,r[pc.SEMANTIC_TEXCOORD5]=11,r[pc.SEMANTIC_TEXCOORD6]=12,r[pc.SEMANTIC_TEXCOORD7]=13,r[pc.SEMANTIC_ATTR0]=14,r[pc.SEMANTIC_ATTR1]=15,r[pc.SEMANTIC_ATTR2]=16,r[pc.SEMANTIC_ATTR3]=17,r[pc.SEMANTIC_ATTR4]=18,r[pc.SEMANTIC_ATTR5]=19,r[pc.SEMANTIC_ATTR6]=20,r[pc.SEMANTIC_ATTR7]=21,r[pc.SEMANTIC_ATTR8]=22,r[pc.SEMANTIC_ATTR9]=23,r[pc.SEMANTIC_ATTR10]=24,r[pc.SEMANTIC_ATTR11]=25,r[pc.SEMANTIC_ATTR12]=26,r[pc.SEMANTIC_ATTR13]=27,r[pc.SEMANTIC_ATTR14]=28,r[pc.SEMANTIC_ATTR15]=29;const o={};o[pc.UNIFORMTYPE_BOOL]=0,o[pc.UNIFORMTYPE_INT]=0,o[pc.UNIFORMTYPE_FLOAT]=0,o[pc.UNIFORMTYPE_VEC2]=new Float32Array([0,0]),o[pc.UNIFORMTYPE_VEC3]=new Float32Array([0,0,0]),o[pc.UNIFORMTYPE_VEC4]=new Float32Array([0,0,0,0]),o[pc.UNIFORMTYPE_IVEC2]=new Int32Array([0,0]),o[pc.UNIFORMTYPE_IVEC3]=new Int32Array([0,0,0]),o[pc.UNIFORMTYPE_IVEC4]=new Int32Array([0,0,0,0]),o[pc.UNIFORMTYPE_BVEC2]=0,o[pc.UNIFORMTYPE_BVEC3]=0,o[pc.UNIFORMTYPE_BVEC4]=0,o[pc.UNIFORMTYPE_MAT2]=new Float32Array([0,0,0,0]),o[pc.UNIFORMTYPE_MAT3]=new Float32Array([0,0,0,0,0,0,0,0,0]),o[pc.UNIFORMTYPE_MAT4]=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),o[pc.UNIFORMTYPE_TEXTURE2D]=null,o[pc.UNIFORMTYPE_TEXTURECUBE]=null,o[pc.UNIFORMTYPE_FLOATARRAY]=new Float32Array([0,0,0,0]),o[pc.UNIFORMTYPE_TEXTURE2D_SHADOW]=null,o[pc.UNIFORMTYPE_TEXTURECUBE_SHADOW]=null;const a=function(t,e){const i=t.width,s=t.height;if(i>e||s>e){const n=e/Math.max(i,s),r=Math.floor(i*n),o=Math.floor(s*n);console.warn("Image dimensions larger than max supported texture size of "+e+". Resizing from "+i+", "+s+" to "+r+", "+o+".");const a=document.createElement("canvas");return a.width=r,a.height=o,a.getContext("2d").drawImage(t,0,0,i,s,0,0,r,o),a}return t};function c(t,e){let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,null);const n=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE&&(i=!1),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(s),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(n),i}const h=function(t,e){let i;this.canvas=t,this.shader=null,this.indexBuffer=null,this.vertexBuffers=[],this.vbOffsets=[],this._enableAutoInstancing=!1,this.autoInstancingMaxObjects=16384,this.attributesInvalidated=!0,this.boundBuffer=null,this.boundElementBuffer=null,this.instancedAttribs={},this.enabledAttributes={},this.attributePointers={},this.transformFeedbackBuffer=null,this.activeFramebuffer=null,this.textureUnit=0,this.textureUnits=[],this._maxPixelRatio=2,this.renderTarget=null,this.feedback=null,this._width=0,this._height=0,this.updateClientRect(),this.vertexShaderCache={},this.fragmentShaderCache={},this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this.contextLost=!1,this._contextLostHandler=function(t){t.preventDefault(),this.contextLost=!0,console.log("pc.GraphicsDevice: WebGL context lost."),this.fire("devicelost")}.bind(this),this._contextRestoredHandler=function(){console.log("pc.GraphicsDevice: WebGL context restored."),this.initializeContext(),this.contextLost=!1,this.fire("devicerestored")}.bind(this),t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1);const s=!(!e||void 0===e.preferWebGl2)&&e.preferWebGl2,n=s?["webgl2","experimental-webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];let r,o,a,h,l,p=null;for((e=e||{}).stencil=!0,e.antialias=!e.disableAntiAliasing&&window.devicePixelRatio<2,e.alpha=!1,i=0;i<n.length;i++){try{p=t.getContext(n[i],e)}catch(t){}if(p){this.webgl2=s&&i<2;break}}if(!p)throw new Error("WebGL not supported");for(p.blendColor(0,0,0,0),this.gl=p,this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),i=0;i<this.maxCombinedTextures;i++)this.textureUnits.push([null,null,null]);this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH},this.glAddress=[p.REPEAT,p.CLAMP_TO_EDGE,p.MIRRORED_REPEAT],this.glBlendEquation=[p.FUNC_ADD,p.FUNC_SUBTRACT,p.FUNC_REVERSE_SUBTRACT,this.webgl2?p.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:p.FUNC_ADD,this.webgl2?p.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:p.FUNC_ADD],this.glBlendFunction=[p.ZERO,p.ONE,p.SRC_COLOR,p.ONE_MINUS_SRC_COLOR,p.DST_COLOR,p.ONE_MINUS_DST_COLOR,p.SRC_ALPHA,p.SRC_ALPHA_SATURATE,p.ONE_MINUS_SRC_ALPHA,p.DST_ALPHA,p.ONE_MINUS_DST_ALPHA],this.glComparison=[p.NEVER,p.LESS,p.EQUAL,p.LEQUAL,p.GREATER,p.NOTEQUAL,p.GEQUAL,p.ALWAYS],this.glStencilOp=[p.KEEP,p.ZERO,p.REPLACE,p.INCR,p.INCR_WRAP,p.DECR,p.DECR_WRAP,p.INVERT],this.glClearFlag=[0,p.COLOR_BUFFER_BIT,p.DEPTH_BUFFER_BIT,p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT,p.STENCIL_BUFFER_BIT,p.STENCIL_BUFFER_BIT|p.COLOR_BUFFER_BIT,p.STENCIL_BUFFER_BIT|p.DEPTH_BUFFER_BIT,p.STENCIL_BUFFER_BIT|p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT],this.glCull=[0,p.BACK,p.FRONT,p.FRONT_AND_BACK],this.glFilter=[p.NEAREST,p.LINEAR,p.NEAREST_MIPMAP_NEAREST,p.NEAREST_MIPMAP_LINEAR,p.LINEAR_MIPMAP_NEAREST,p.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[p.POINTS,p.LINES,p.LINE_LOOP,p.LINE_STRIP,p.TRIANGLES,p.TRIANGLE_STRIP,p.TRIANGLE_FAN],this.glType=[p.BYTE,p.UNSIGNED_BYTE,p.SHORT,p.UNSIGNED_SHORT,p.INT,p.UNSIGNED_INT,p.FLOAT],this.pcUniformType={},this.pcUniformType[p.BOOL]=pc.UNIFORMTYPE_BOOL,this.pcUniformType[p.INT]=pc.UNIFORMTYPE_INT,this.pcUniformType[p.FLOAT]=pc.UNIFORMTYPE_FLOAT,this.pcUniformType[p.FLOAT_VEC2]=pc.UNIFORMTYPE_VEC2,this.pcUniformType[p.FLOAT_VEC3]=pc.UNIFORMTYPE_VEC3,this.pcUniformType[p.FLOAT_VEC4]=pc.UNIFORMTYPE_VEC4,this.pcUniformType[p.INT_VEC2]=pc.UNIFORMTYPE_IVEC2,this.pcUniformType[p.INT_VEC3]=pc.UNIFORMTYPE_IVEC3,this.pcUniformType[p.INT_VEC4]=pc.UNIFORMTYPE_IVEC4,this.pcUniformType[p.BOOL_VEC2]=pc.UNIFORMTYPE_BVEC2,this.pcUniformType[p.BOOL_VEC3]=pc.UNIFORMTYPE_BVEC3,this.pcUniformType[p.BOOL_VEC4]=pc.UNIFORMTYPE_BVEC4,this.pcUniformType[p.FLOAT_MAT2]=pc.UNIFORMTYPE_MAT2,this.pcUniformType[p.FLOAT_MAT3]=pc.UNIFORMTYPE_MAT3,this.pcUniformType[p.FLOAT_MAT4]=pc.UNIFORMTYPE_MAT4,this.pcUniformType[p.SAMPLER_2D]=pc.UNIFORMTYPE_TEXTURE2D,this.pcUniformType[p.SAMPLER_CUBE]=pc.UNIFORMTYPE_TEXTURECUBE,this.webgl2&&(this.pcUniformType[p.SAMPLER_2D_SHADOW]=pc.UNIFORMTYPE_TEXTURE2D_SHADOW,this.pcUniformType[p.SAMPLER_CUBE_SHADOW]=pc.UNIFORMTYPE_TEXTURECUBE_SHADOW,this.pcUniformType[p.SAMPLER_3D]=pc.UNIFORMTYPE_TEXTURE3D),this.targetToSlot={},this.targetToSlot[p.TEXTURE_2D]=0,this.targetToSlot[p.TEXTURE_CUBE_MAP]=1,this.targetToSlot[p.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[pc.UNIFORMTYPE_BOOL]=function(t,e){t.value!==e&&(p.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[pc.UNIFORMTYPE_INT]=this.commitFunction[pc.UNIFORMTYPE_BOOL],this.commitFunction[pc.UNIFORMTYPE_FLOAT]=function(t,e){t.value!==e&&(p.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[pc.UNIFORMTYPE_VEC2]=function(t,e){l=t.value,r=e[0],o=e[1],l[0]===r&&l[1]===o||(l[0]=r,l[1]=o,p.uniform2fv(t.locationId,l))},this.commitFunction[pc.UNIFORMTYPE_VEC3]=function(t,e){l=t.value,r=e[0],o=e[1],a=e[2],l[0]===r&&l[1]===o&&l[2]===a||(l[0]=r,l[1]=o,l[2]=a,p.uniform3fv(t.locationId,l))},this.commitFunction[pc.UNIFORMTYPE_VEC4]=function(t,e){l=t.value,r=e[0],o=e[1],a=e[2],h=e[3],(e.length>4||l[0]!==r||l[1]!==o||l[2]!==a||l[3]!==h)&&(p.uniform4fv(t.locationId,e),l[0]=r,l[1]=o,l[2]=a,l[3]=h)},this.commitFunction[pc.UNIFORMTYPE_IVEC2]=function(t,e){l=t.value,r=e[0],o=e[1],l[0]===r&&l[1]===o||(p.uniform2iv(t.locationId,e),l[0]=r,l[1]=o)},this.commitFunction[pc.UNIFORMTYPE_BVEC2]=this.commitFunction[pc.UNIFORMTYPE_IVEC2],this.commitFunction[pc.UNIFORMTYPE_IVEC3]=function(t,e){l=t.value,r=e[0],o=e[1],a=e[2],l[0]===r&&l[1]===o&&l[2]===a||(p.uniform3iv(t.locationId,e),l[0]=r,l[1]=o,l[2]=a)},this.commitFunction[pc.UNIFORMTYPE_BVEC3]=this.commitFunction[pc.UNIFORMTYPE_IVEC3],this.commitFunction[pc.UNIFORMTYPE_IVEC4]=function(t,e){l=t.value,r=e[0],o=e[1],a=e[2],h=e[3],l[0]===r&&l[1]===o&&l[2]===a&&l[3]===h||(p.uniform4iv(t.locationId,e),l[0]=r,l[1]=o,l[2]=a,l[3]=h)},this.commitFunction[pc.UNIFORMTYPE_BVEC4]=this.commitFunction[pc.UNIFORMTYPE_IVEC4],this.commitFunction[pc.UNIFORMTYPE_MAT2]=function(t,e){p.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[pc.UNIFORMTYPE_MAT3]=function(t,e){p.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[pc.UNIFORMTYPE_MAT4]=function(t,e){p.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[pc.UNIFORMTYPE_FLOATARRAY]=function(t,e){p.uniform1fv(t.locationId,e)},this.scope=new pc.ScopeSpace("Device"),this.programLib=new pc.ProgramLibrary(this);for(const t in pc.programlib)pc.programlib.hasOwnProperty(t)&&this.programLib.register(t,pc.programlib[t]);pc.events.attach(this),this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0,this.useTexCubeLod=this.extTextureLod&&this.maxTextures<16;let u=this.vertexUniformsCount;for(u-=16,u-=8,u-=1,u-=16,this.boneLimit=Math.floor(u/4),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),"Apple A8 GPU"===this.unmaskedRenderer&&(this.forceCpuParticles=!0),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[],i=pc.PRIMITIVE_POINTS;i<=pc.PRIMITIVE_TRIFAN;i++)this._primsPerFrame[i]=0;this._renderTargetCreationTime=0,this._vram={texShadow:0,texAsset:0,texLightmap:0,tex:0,vb:0,ib:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=c(p,p.FLOAT):this.textureFloatRenderable=!1,this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=c(p,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.textureFloatHighPrecision=function(t){if(!t.textureFloatRenderable)return!1;const e=t.gl,i=pc.shaderChunks,s=i.createShaderFromCode(t,i.fullscreenQuadVS,i.precisionTestPS,"ptest1"),n=i.createShaderFromCode(t,i.fullscreenQuadVS,i.precisionTest2PS,"ptest2"),r=new pc.Texture(t,{format:pc.PIXELFORMAT_RGBA32F,width:1,height:1,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),o=new pc.RenderTarget(t,r,{depth:!1});pc.drawQuadWithShader(t,o,s);const a=new pc.Texture(t,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:1,height:1,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),c=new pc.RenderTarget(t,a,{depth:!1});t.constantTexSource.setValue(r),pc.drawQuadWithShader(t,c,n),e.bindFramebuffer(e.FRAMEBUFFER,c._glFrameBuffer);const h=new Uint8Array(4);e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,h),e.bindFramebuffer(e.FRAMEBUFFER,t.activeFramebuffer);const l=h[0]/255/16777216+h[1]/255/65536+h[2]/255/256+h[3]/255;return r.destroy(),o.destroy(),a.destroy(),c.destroy(),0===l}(this),this.initializeGrabPassTexture(),this.activeDrawCall=null};return Object.assign(h.prototype,{getPrecision:function(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),o=i.precision>0&&n.precision>0,a=s.precision>0&&r.precision>0;o||(a?(e="mediump",console.warn("WARNING: highp not supported, using mediump")):(e="lowp",console.warn("WARNING: highp and mediump not supported, using lowp")))}return e},initializeExtensions:function(){const t=this.gl;let e;const i=t.getSupportedExtensions(),s=function(...e){let s=null;for(let n=0;n<e.length;n++)-1!==i.indexOf(e[n])&&(s=t.getExtension(e[n]));return s};this.webgl2?(this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureHalfFloatLinear=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=s("EXT_color_buffer_float")):(this.extBlendMinmax=s("EXT_blend_minmax"),this.extDrawBuffers=s("EXT_draw_buffers"),this.extInstancing=s("ANGLE_instanced_arrays"),this.extInstancing&&(e=this.extInstancing,t.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),t.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),t.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)),this.extStandardDerivatives=s("OES_standard_derivatives"),this.extTextureFloat=s("OES_texture_float"),this.extTextureHalfFloat=s("OES_texture_half_float"),this.extTextureHalfFloatLinear=s("OES_texture_half_float_linear"),this.extTextureLod=s("EXT_shader_texture_lod"),this.extUintElement=s("OES_element_index_uint"),this.extVertexArrayObject=s("OES_vertex_array_object"),this.extVertexArrayObject&&(e=this.extVertexArrayObject,t.createVertexArray=e.createVertexArrayOES.bind(e),t.deleteVertexArray=e.deleteVertexArrayOES.bind(e),t.isVertexArray=e.isVertexArrayOES.bind(e),t.bindVertexArray=e.bindVertexArrayOES.bind(e)),this.extColorBufferFloat=null),this.extDebugRendererInfo=s("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=s("OES_texture_float_linear"),this.extTextureFilterAnisotropic=s("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=s("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=s("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=s("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=s("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extParallelShaderCompile=s("KHR_parallel_shader_compile")},initializeCapabilities:function(){const t=this.gl;let e;this.maxPrecision=this.precision=this.getPrecision();const i=t.getContextAttributes();this.supportsMsaa=i.antialias,this.supportsStencil=i.stencil,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)):(e=this.extDrawBuffers,this.maxDrawBuffers=e?t.getParameter(e.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"",e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},initializeRenderState:function(){const t=this.gl;this.blending=!1,t.disable(t.BLEND),this.blendSrc=pc.BLENDMODE_ONE,this.blendDst=pc.BLENDMODE_ZERO,this.blendSrcAlpha=pc.BLENDMODE_ONE,this.blendDstAlpha=pc.BLENDMODE_ZERO,this.separateAlphaBlend=!1,this.blendEquation=pc.BLENDEQUATION_ADD,this.blendAlphaEquation=pc.BLENDEQUATION_ADD,this.separateAlphaEquation=!1,t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,t.colorMask(!0,!0,!0,!0),this.cullMode=pc.CULLFACE_BACK,t.enable(t.CULL_FACE),t.cullFace(t.BACK),this.depthTest=!0,t.enable(t.DEPTH_TEST),this.depthFunc=pc.FUNC_LESSEQUAL,t.depthFunc(t.LEQUAL),this.depthWrite=!0,t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=pc.FUNC_ALWAYS,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=pc.STENCILOP_KEEP,this.stencilZfailFront=this.stencilZfailBack=pc.STENCILOP_KEEP,this.stencilZpassFront=this.stencilZpassBack=pc.STENCILOP_KEEP,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearRed=0,this.clearBlue=0,this.clearGreen=0,this.clearAlpha=0,t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this.depthRange=new pc.Vec2(0,1),t.depthRange(this.depthRange.x,this.depthRange.y)},initializeContext:function(){let t,e;for(this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),t=0,e=this.shaders.length;t<e;t++)this.compileAndLinkShader(this.shaders[t]);for(this.shader=null,t=0,e=this.buffers.length;t<e;t++)this.buffers[t].bufferId=void 0,this.buffers[t].unlock();for(this.boundBuffer=null,this.boundElementBuffer=null,this.indexBuffer=null,this.attributesInvalidated=!0,this.enabledAttributes={},this.vertexBuffers=[],t=0,e=this.textures.length;t<e;t++){const e=this.textures[t];this.destroyTexture(e),e.dirtyAll()}for(this.textureUnit=0,this.textureUnits.length=0,t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null]);for(t=0,e=this.targets.length;t<e;t++)this.targets[t]._glFrameBuffer=void 0,this.targets[t]._glDepthBuffer=void 0,this.targets[t]._glResolveFrameBuffer=void 0,this.targets[t]._glMsaaColorBuffer=void 0,this.targets[t]._glMsaaDepthBuffer=void 0;this.renderTarget=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null},initializeGrabPassTexture:function(){if(this.grabPassTexture)return;const t=new pc.Texture(this,{format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!1});t.minFilter=pc.FILTER_LINEAR,t.magFilter=pc.FILTER_LINEAR,t.addressU=pc.ADDRESS_CLAMP_TO_EDGE,t.addressV=pc.ADDRESS_CLAMP_TO_EDGE,t.name="texture_grabPass",t.setSource(this.canvas);const e=this.scope.resolve(t.name);e.setValue(t),this.grabPassTextureId=e,this.grabPassTexture=t},updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(t,e,i,s){this.vx===t&&this.vy===e&&this.vw===i&&this.vh===s||(this.gl.viewport(t,e,i,s),this.vx=t,this.vy=e,this.vw=i,this.vh=s)},setDepthRange:function(t,e){this.depthRange.x===t&&this.depthRange.y===e||(this.depthRange.set(t,e),this.gl.depthRange(t,e))},setScissor:function(t,e,i,s){this.sx===t&&this.sy===e&&this.sw===i&&this.sh===s||(this.gl.scissor(t,e,i,s),this.sx=t,this.sy=e,this.sw=i,this.sh=s)},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(t){this.programLib=t},setFramebuffer:function(t){this.activeFramebuffer!==t&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.activeFramebuffer=t)},_checkFbo:function(){const t=this.gl;switch(t.checkFramebufferStatus(t.FRAMEBUFFER)){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case t.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");break;case t.FRAMEBUFFER_COMPLETE:}},copyRenderTarget:function(t,e,i,s){const n=this.gl;if(!this.webgl2&&s)return console.error("Depth is not copyable on WebGL 1.0"),!1;if(i)if(e){if(!t._colorBuffer||!e._colorBuffer)return console.error("Can't copy color buffer, because one of the render targets doesn't have it"),!1;if(t._colorBuffer._format!==e._colorBuffer._format)return console.error("Can't copy render targets of different color formats"),!1}else if(!t._colorBuffer)return console.error("Can't copy empty color buffer to backbuffer"),!1;if(s){if(!t._depthBuffer||!e._depthBuffer)return console.error("Can't copy depth buffer, because one of the render targets doesn't have it"),!1;if(t._depthBuffer._format!==e._depthBuffer._format)return console.error("Can't copy render targets of different depth formats"),!1}if(this.webgl2&&e){const r=this.renderTarget;this.renderTarget=e,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,t?t._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,e._glFrameBuffer);const o=t?t.width:e.width,a=t?t.height:e.height;n.blitFramebuffer(0,0,o,a,0,0,o,a,(i?n.COLOR_BUFFER_BIT:0)|(s?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=r,n.bindFramebuffer(n.FRAMEBUFFER,r?r._glFrameBuffer:null)}else{if(!this._copyShader){const t=pc.shaderChunks;this._copyShader=t.createShaderFromCode(this,t.fullscreenQuadVS,t.outputTex2DPS,"outputTex2D")}this.constantTexSource.setValue(t._colorBuffer),pc.drawQuadWithShader(this,e,this._copyShader)}return!0},updateBegin:function(){const t=this.gl;this.boundBuffer=null,this.boundElementBuffer=null;const e=this.renderTarget;if(e)if(e._glFrameBuffer){this.setFramebuffer(e._glFrameBuffer);const t=e._colorBuffer;t&&(this.setViewport(0,0,t._width,t._height),this.setScissor(0,0,t._width,t._height))}else{const i=pc.now();this.fire("fbo:create",{timestamp:i,target:this}),e._device=this,e._glFrameBuffer=t.createFramebuffer(),this.setFramebuffer(e._glFrameBuffer);const s=e._colorBuffer;s&&(s._glTexture||(s._width=Math.min(s.width,this.maxRenderBufferSize),s._height=Math.min(s.height,this.maxRenderBufferSize),this.setTexture(s,0)),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,s._cubemap?t.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:t.TEXTURE_2D,s._glTexture,0));const n=e._depthBuffer;if(n&&this.webgl2)n._glTexture||(n._width=Math.min(n.width,this.maxRenderBufferSize),n._height=Math.min(n.height,this.maxRenderBufferSize),this.setTexture(n,0)),e._stencil?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,n._cubemap?t.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:t.TEXTURE_2D,e._depthBuffer._glTexture,0):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,n._cubemap?t.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:t.TEXTURE_2D,e._depthBuffer._glTexture,0);else if(e._depth){e._samples>1&&this.webgl2||(e._glDepthBuffer||(e._glDepthBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e._glDepthBuffer),e._stencil?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e._glDepthBuffer)):(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e._glDepthBuffer)),t.bindRenderbuffer(t.RENDERBUFFER,null))}this._checkFbo(),this.webgl2&&e._samples>1&&(e._glResolveFrameBuffer=e._glFrameBuffer,e._glFrameBuffer=t.createFramebuffer(),this.setFramebuffer(e._glFrameBuffer),s&&(e._glMsaaColorBuffer||(e._glMsaaColorBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e._glMsaaColorBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,e._samples,s._glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,e._glMsaaColorBuffer)),e._depth&&(e._glMsaaDepthBuffer||(e._glMsaaDepthBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e._glMsaaDepthBuffer),e._stencil?(t.renderbufferStorageMultisample(t.RENDERBUFFER,e._samples,t.DEPTH24_STENCIL8,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e._glMsaaDepthBuffer)):(t.renderbufferStorageMultisample(t.RENDERBUFFER,e._samples,t.DEPTH_COMPONENT32F,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e._glMsaaDepthBuffer))),this._checkFbo()),this.targets.push(e),this._renderTargetCreationTime+=pc.now()-i}else this.setFramebuffer(null)},updateEnd:function(){const t=this.gl,e=this.renderTarget;if(e){const i=e._colorBuffer;i&&i._glTexture&&i.mipmaps&&i._pot&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(i),t.generateMipmap(i._glTarget)),this.webgl2&&e._samples>1&&e.autoResolve&&e.resolve()}},initializeTexture:function(t){const e=this.gl;let i;switch(t._glTexture=e.createTexture(),t._levels&&t._levels[0]&&"VIDEO"===t._levels[0].tagName&&(t._needsUpdate=!0),t._glTarget=t._cubemap?e.TEXTURE_CUBE_MAP:t._volume?e.TEXTURE_3D:e.TEXTURE_2D,t._format){case pc.PIXELFORMAT_A8:t._glFormat=e.ALPHA,t._glInternalFormat=e.ALPHA,t._glPixelType=e.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8:t._glFormat=e.LUMINANCE,t._glInternalFormat=e.LUMINANCE,t._glPixelType=e.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8_A8:t._glFormat=e.LUMINANCE_ALPHA,t._glInternalFormat=e.LUMINANCE_ALPHA,t._glPixelType=e.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R5_G6_B5:t._glFormat=e.RGB,t._glInternalFormat=e.RGB,t._glPixelType=e.UNSIGNED_SHORT_5_6_5;break;case pc.PIXELFORMAT_R5_G5_B5_A1:t._glFormat=e.RGBA,t._glInternalFormat=e.RGBA,t._glPixelType=e.UNSIGNED_SHORT_5_5_5_1;break;case pc.PIXELFORMAT_R4_G4_B4_A4:t._glFormat=e.RGBA,t._glInternalFormat=e.RGBA,t._glPixelType=e.UNSIGNED_SHORT_4_4_4_4;break;case pc.PIXELFORMAT_R8_G8_B8:t._glFormat=e.RGB,t._glInternalFormat=this.webgl2?e.RGB8:e.RGB,t._glPixelType=e.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R8_G8_B8_A8:t._glFormat=e.RGBA,t._glInternalFormat=this.webgl2?e.RGBA8:e.RGBA,t._glPixelType=e.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_DXT1:i=this.extCompressedTextureS3TC,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case pc.PIXELFORMAT_DXT3:i=this.extCompressedTextureS3TC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case pc.PIXELFORMAT_DXT5:i=this.extCompressedTextureS3TC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case pc.PIXELFORMAT_ETC1:i=this.extCompressedTextureETC1,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB_ETC1_WEBGL;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:i=this.extCompressedTexturePVRTC,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1:i=this.extCompressedTexturePVRTC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:i=this.extCompressedTexturePVRTC,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1:i=this.extCompressedTexturePVRTC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case pc.PIXELFORMAT_ETC2_RGB:i=this.extCompressedTextureETC,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB8_ETC2;break;case pc.PIXELFORMAT_ETC2_RGBA:i=this.extCompressedTextureETC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA8_ETC2_EAC;break;case pc.PIXELFORMAT_RGB16F:i=this.extTextureHalfFloat,t._glFormat=e.RGB,this.webgl2?(t._glInternalFormat=e.RGB16F,t._glPixelType=e.HALF_FLOAT):(t._glInternalFormat=e.RGB,t._glPixelType=i.HALF_FLOAT_OES);break;case pc.PIXELFORMAT_RGBA16F:i=this.extTextureHalfFloat,t._glFormat=e.RGBA,this.webgl2?(t._glInternalFormat=e.RGBA16F,t._glPixelType=e.HALF_FLOAT):(t._glInternalFormat=e.RGBA,t._glPixelType=i.HALF_FLOAT_OES);break;case pc.PIXELFORMAT_RGB32F:t._glFormat=e.RGB,this.webgl2?t._glInternalFormat=e.RGB32F:t._glInternalFormat=e.RGB,t._glPixelType=e.FLOAT;break;case pc.PIXELFORMAT_RGBA32F:t._glFormat=e.RGBA,this.webgl2?t._glInternalFormat=e.RGBA32F:t._glInternalFormat=e.RGBA,t._glPixelType=e.FLOAT;break;case pc.PIXELFORMAT_R32F:t._glFormat=e.RED,t._glInternalFormat=e.R32F,t._glPixelType=e.FLOAT;break;case pc.PIXELFORMAT_DEPTH:this.webgl2?(t._glFormat=e.DEPTH_COMPONENT,t._glInternalFormat=e.DEPTH_COMPONENT32F,t._glPixelType=e.FLOAT):(t._glFormat=e.DEPTH_COMPONENT,t._glInternalFormat=e.DEPTH_COMPONENT,t._glPixelType=e.UNSIGNED_SHORT);break;case pc.PIXELFORMAT_DEPTHSTENCIL:t._glFormat=e.DEPTH_STENCIL,t._glInternalFormat=e.DEPTH24_STENCIL8,t._glPixelType=e.UNSIGNED_INT_24_8;break;case pc.PIXELFORMAT_111110F:t._glFormat=e.RGB,t._glInternalFormat=e.R11F_G11F_B10F,t._glPixelType=e.FLOAT;break;case pc.PIXELFORMAT_SRGB:t._glFormat=e.RGB,t._glInternalFormat=e.SRGB8,t._glPixelType=e.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_SRGBA:t._glFormat=e.RGBA,t._glInternalFormat=e.SRGB8_ALPHA8,t._glPixelType=e.UNSIGNED_BYTE}this.textures.push(t)},destroyTexture:function(t){if(t._glTexture){const e=this.textures.indexOf(t);-1!==e&&this.textures.splice(e,1);for(const e in this.scope.variables)if(this.scope.variables.hasOwnProperty(e)){const i=this.scope.variables[e];i.value===t&&(i.value=null)}for(let e=0;e<this.textureUnits.length;e++){const i=this.textureUnits[e];for(let e=0;e<i.length;e++)i[e]===t._glTexture&&(i[e]=null)}this.gl.deleteTexture(t._glTexture),delete t._glTexture,delete t._glTarget,delete t._glFormat,delete t._glInternalFormat,delete t._glPixelType,this._vram.tex-=t._gpuSize,t.profilerHint===pc.TEXHINT_SHADOWMAP?this._vram.texShadow-=t._gpuSize:t.profilerHint===pc.TEXHINT_ASSET?this._vram.texAsset-=t._gpuSize:t.profilerHint===pc.TEXHINT_LIGHTMAP&&(this._vram.texLightmap-=t._gpuSize)}},setUnpackFlipY:function(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}},setUnpackPremultiplyAlpha:function(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}},uploadCubemapFromAtlas:function(t){const e=t._atlas,i=this.gl,s=this.textureUnits[0],n=s?s[0]:null;e._glTexture||(this.setTexture(e,0),this.uploadTexture(e));const r=this.activeFramebuffer,o=i.createFramebuffer();this.setFramebuffer(o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e._glTexture,0),t._needsUpload=!1,t._needsMipmapsUpload=!1,this.setTexture(t,0);for(let s=0;s<t._rects.length;s+=4){const n=t._rects[s+0]*e._width,r=t._rects[s+1]*e._height,o=t._rects[s+2]*e._width-n,a=t._rects[s+3]*e._height-r,c=s/4|0,h=c/6|0,l=c%6|0;i.copyTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,h,t._glInternalFormat,n,r,o,a,0)}t._mipmaps&&24===t._rects.length&&i.generateMipmap(t._glTarget),this.setFramebuffer(r),n&&(i.bindTexture(i.TEXTURE_2D,n),this.textureUnits[0][0]=n)},uploadTexture:function(t){const e=this.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t._pot))return;let i,s,n=0;for(t._cubemap&&t._atlas&&t._rects&&this.uploadCubemapFromAtlas(t);t._levels[n]||0===n;)if(t._needsUpload||0!==n){if(n&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(i=t._levels[n],1!==n||t._compressed||(e.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._cubemap){let r;if(i[0]instanceof HTMLCanvasElement||i[0]instanceof HTMLImageElement||i[0]instanceof HTMLVideoElement)for(r=0;r<6;r++){if(!t._levelsUpdated[0][r])continue;let s=i[r];s instanceof HTMLImageElement&&(s.width>this.maxCubeMapSize||s.height>this.maxCubeMapSize)&&(s=a(s,this.maxCubeMapSize),0===n&&(t.width=s.width,t.height=s.height)),this.setUnpackFlipY(t._flipY),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,n,t._glInternalFormat,t._glFormat,t._glPixelType,s)}else for(this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s=1/Math.pow(2,n),r=0;r<6;r++){if(!t._levelsUpdated[0][r])continue;const o=i[r];t._compressed?e.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,o):(this.setUnpackFlipY(t._flipY),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,t._glFormat,t._glPixelType,o))}}else t._volume?(s=1/Math.pow(2,n),t._compressed?e.compressedTexImage3D(e.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage3D(e.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,t._glFormat,t._glPixelType,i))):(i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof HTMLVideoElement?(i instanceof HTMLImageElement&&(i.width>this.maxTextureSize||i.height>this.maxTextureSize)&&(i=a(i,this.maxTextureSize),0===n&&(t.width=i.width,t.height=i.height)),this.setUnpackFlipY(t._flipY),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,n,t._glInternalFormat,t._glFormat,t._glPixelType,i)):(s=1/Math.pow(2,n),t._compressed?e.compressedTexImage2D(e.TEXTURE_2D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,t._glFormat,t._glPixelType,i))),t._mipmapsUploaded=0!==n);n++}else n++;if(t._needsUpload)if(t._cubemap)for(let e=0;e<6;e++)t._levelsUpdated[0][e]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&t._mipmaps&&t._needsMipmapsUpload&&t._pot&&1===t._levels.length&&(e.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&(this._vram.tex-=t._gpuSize,t.profilerHint===pc.TEXHINT_SHADOWMAP?this._vram.texShadow-=t._gpuSize:t.profilerHint===pc.TEXHINT_ASSET?this._vram.texAsset-=t._gpuSize:t.profilerHint===pc.TEXHINT_LIGHTMAP&&(this._vram.texLightmap-=t._gpuSize)),t._gpuSize=t.gpuSize,this._vram.tex+=t._gpuSize,t.profilerHint===pc.TEXHINT_SHADOWMAP?this._vram.texShadow+=t._gpuSize:t.profilerHint===pc.TEXHINT_ASSET?this._vram.texAsset+=t._gpuSize:t.profilerHint===pc.TEXHINT_LIGHTMAP&&(this._vram.texLightmap+=t._gpuSize)},activeTexture:function(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)},bindTexture:function(t){const e=t._glTarget,i=t._glTexture,s=this.textureUnit,n=this.targetToSlot[e];this.textureUnits[s][n]!==i&&(this.gl.bindTexture(e,i),this.textureUnits[s][n]=i)},bindTextureOnUnit:function(t,e){const i=t._glTarget,s=t._glTexture,n=this.targetToSlot[i];this.textureUnits[e][n]!==s&&(this.activeTexture(e),this.gl.bindTexture(i,s),this.textureUnits[e][n]=s)},setTextureParameters:function(t){const e=this.gl,i=t._parameterFlags,s=t._glTarget;if(1&i){let i=t._minFilter;(!t._pot||!t._mipmaps||t._compressed&&1===t._levels.length)&&(i===pc.FILTER_NEAREST_MIPMAP_NEAREST||i===pc.FILTER_NEAREST_MIPMAP_LINEAR?i=pc.FILTER_NEAREST:i!==pc.FILTER_LINEAR_MIPMAP_NEAREST&&i!==pc.FILTER_LINEAR_MIPMAP_LINEAR||(i=pc.FILTER_LINEAR)),e.texParameteri(s,e.TEXTURE_MIN_FILTER,this.glFilter[i])}if(2&i&&e.texParameteri(s,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&i&&(this.webgl2?e.texParameteri(s,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]):e.texParameteri(s,e.TEXTURE_WRAP_S,this.glAddress[t._pot?t._addressU:pc.ADDRESS_CLAMP_TO_EDGE])),8&i&&(this.webgl2?e.texParameteri(s,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]):e.texParameteri(s,e.TEXTURE_WRAP_T,this.glAddress[t._pot?t._addressV:pc.ADDRESS_CLAMP_TO_EDGE])),16&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&i){const i=this.extTextureFilterAnisotropic;i&&e.texParameterf(s,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(t._anisotropy),this.maxAnisotropy)))}},setTexture:function(t,e){t._glTexture||this.initializeTexture(t),t._parameterFlags>0||t._needsUpload||t._needsMipmapsUpload?(this.activeTexture(e),this.bindTexture(t),t._parameterFlags&&(this.setTextureParameters(t),t._parameterFlags=0),(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadTexture(t),t!==this.grabPassTexture&&(t.markUploaded(),t._needsMipmapsUpload=!1))):this.bindTextureOnUnit(t,e)},setBuffers:function(r,o,a){o=o||[];const c=this.gl;let h,l,p,u,d,_;const f=this.shader.attributes;if(this.attributesInvalidated){for(let o=0,a=f.length;o<a;o++){h=f[o],_=h.locationId,l=h.scopeId.value;const a="TEXCOORD1"===h.scopeId.name&&this.activeDrawCall&&(this.activeDrawCall._shaderDefs&pc.SHADERDEF_LMUV0)>0;if(null===l||l.const||(p=this.vertexBuffers[l.stream],u=this.vbOffsets[l.stream]||0,!p||p.format.elementMap[l.name]||a||(c.disableVertexAttribArray(h.locationId),this.enabledAttributes[h.locationId]=!1,l=null)),null==l)c.disableVertexAttribArray(_),this.enabledAttributes[_]=!1,"POSITION"===h.scopeId.name?c.vertexAttrib4fv(_,i):"COLOR"===h.scopeId.name?c.vertexAttrib4fv(_,t):"TANGENT"===h.scopeId.name?c.vertexAttrib4fv(_,s):"NORMAL"===h.scopeId.name?c.vertexAttrib4fv(_,n):c.vertexAttrib4fv(_,e);else{if(void 0===p)continue;let t;if(d=p.bufferId,this.boundBuffer!==d&&(c.bindBuffer(c.ARRAY_BUFFER,d),this.attributePointers={},this.boundBuffer=d),this.enabledAttributes[_]||(c.enableVertexAttribArray(_),this.enabledAttributes[_]=!0),a)for(let e=0;e<f.length;e++){const i=f[e].scopeId;if("TEXCOORD0"===i.name){t=i.value;break}}else t=l;const e=(t.numComponents<<24)+(t.dataType<<21)+(t.normalize?1<<20:0)+(t.stride<<10)+(t.offset+u<<0);this.attributePointers[_]!==e&&(c.vertexAttribPointer(_,t.numComponents,this.glType[t.dataType],t.normalize,t.stride,t.offset+u),this.attributePointers[_]=e),1===l.stream&&r>0?this.instancedAttribs[_]||(c.vertexAttribDivisor(_,1),this.instancedAttribs[_]=!0):this.instancedAttribs[_]&&(c.vertexAttribDivisor(_,0),this.instancedAttribs[_]=!1)}}this.attributesInvalidated=!1}for(let t=0,e=f.length;t<e;t++){h=f[t];const e=o[h.scopeId.name];e&&(_=h.locationId,this.enabledAttributes[h.locationId]=!1,c.disableVertexAttribArray(h.locationId),c.vertexAttrib4fv(h.locationId,e))}d=this.indexBuffer?this.indexBuffer.bufferId:null,this.boundElementBuffer!==d&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,d),this.boundElementBuffer=d)},draw:function(t,e,i,s,n){const r=this.gl;let a,c,h,l,p,u,d,_,f,m,g,y;const E=this.shader,T=E.samplers,A=E.uniforms;if(0===e)return;this.activeDrawCall=n,e>0&&(this.boundBuffer=null,this.attributesInvalidated=!0),this.setBuffers(e,s);let b=0;for(a=0,h=T.length;a<h;a++)if(p=T[a],u=p.scopeId.value,l=p.scopeId.name,null==u&&(u=i[p.scopeId.name]||o[p.dataType]),p.meta||(p.meta={hdr:this.scope.resolve(l+"_HDR"),texels:this.scope.resolve(l+"_TexelSize")}),u instanceof pc.Texture)d=u,this.setTexture(d,b),d.rgbm?p.meta.hdr.setValue([5*d.intensity,1,0,1]):p.meta.hdr.setValue([1*d.intensity,1,0,0]),p.meta.texels.setValue([1/d.width,1/d.height,d.width,d.height]),this.renderTarget&&this.renderTarget._samples<2&&(this.renderTarget.colorBuffer&&this.renderTarget.colorBuffer===d?console.error("Trying to bind current color buffer as a texture"):this.renderTarget.depthBuffer&&this.renderTarget.depthBuffer===d&&console.error("Trying to bind current depth buffer as a texture")),p.slot!==b&&(r.uniform1i(p.locationId,b),p.slot=b),b++;else{for(p.array.length=0,_=u.length,c=0;c<_;c++)d=u[c],this.setTexture(d,b),p.array[c]=b,b++;r.uniform1iv(p.locationId,p.array)}for(a=0,h=A.length;a<h;a++)f=A[a],m=f.scopeId,g=f.version,y=m.versionObject.version,g.globalId===y.globalId&&g.revision===y.revision||(g.globalId=y.globalId,g.revision=y.revision,null==m.value?this.commitFunction[f.dataType](f,i[m.name]||o[f.dataType]):this.commitFunction[f.dataType](f,m.value));this.webgl2&&this.transformFeedbackBuffer&&(r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),r.beginTransformFeedback(r.POINTS));const S=this.glPrimitive[t.type],R=t.count;if(t.indexed){const i=this.indexBuffer,s=i.glFormat,n=t.base*i.bytesPerIndex;e>0?r.drawElementsInstanced(S,R,s,n,e):r.drawElements(S,R,s,n)}else{const i=t.base;e>0?r.drawArraysInstanced(S,i,R,e):r.drawArrays(S,i,R)}this.webgl2&&this.transformFeedbackBuffer&&(r.endTransformFeedback(),r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++,this._primsPerFrame[t.type]+=t.count*(e>0?e:1),this.activeDrawCall=null},clear:function(t){const e=this.defaultClearOptions,i=pc.CLEARFLAG_COLOR|pc.CLEARFLAG_STENCIL|pc.CLEARFLAG_DEPTH,s=void 0===(t=t||e).flags||null===t.flags?e.flags:t.flags;if(0!==s){const n=this.gl;if(s&pc.CLEARFLAG_COLOR){const i=t.color?t.color:e.color;this.setClearColor(i[0],i[1],i[2],i[3])}if(s&pc.CLEARFLAG_DEPTH){const i=void 0===t.depth||null===t.depth?e.depth:t.depth;this.setClearDepth(i),this.depthWrite||n.depthMask(!0)}if(s&pc.CLEARFLAG_STENCIL){const i=void 0===t.stencil||null===t.stencil?e.stencil:t.stencil;this.setClearStencil(i)}n.clear(this.glClearFlag[s&i]),s&pc.CLEARFLAG_DEPTH&&(this.depthWrite||n.depthMask(!1))}},readPixels:function(t,e,i,s,n){const r=this.gl;r.readPixels(t,e,i,s,r.RGBA,r.UNSIGNED_BYTE,n)},setClearDepth:function(t){t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t)},setClearColor:function(t,e,i,s){t===this.clearRed&&e===this.clearGreen&&i===this.clearBlue&&s===this.clearAlpha||(this.gl.clearColor(t,e,i,s),this.clearRed=t,this.clearGreen=e,this.clearBlue=i,this.clearAlpha=s)},setClearStencil:function(t){t!==this.clearStencil&&(this.gl.clearStencil(t),this.clearStencil=t)},setRenderTarget:function(t){this.renderTarget=t},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(t){if(this.depthTest!==t){const e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.depthTest=t}},setDepthFunc:function(t){this.depthFunc!==t&&(this.gl.depthFunc(this.glComparison[t]),this.depthFunc=t)},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(t){this.depthWrite!==t&&(this.gl.depthMask(t),this.depthWrite=t)},setColorWrite:function(t,e,i,s){this.writeRed===t&&this.writeGreen===e&&this.writeBlue===i&&this.writeAlpha===s||(this.gl.colorMask(t,e,i,s),this.writeRed=t,this.writeGreen=e,this.writeBlue=i,this.writeAlpha=s)},setAlphaToCoverage:function(t){this.webgl2&&this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},setTransformFeedbackBuffer:function(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}},setRaster:function(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},setDepthBias:function(t){this.depthBiasEnabled!==t&&(this.depthBiasEnabled=t,t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},setDepthBiasValues:function(t,e){this.gl.polygonOffset(e,t)},getBlending:function(){return this.blending},setBlending:function(t){if(this.blending!==t){const e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.blending=t}},setStencilTest:function(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}},setStencilFunc:function(t,e,i){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==i||this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==i){this.gl.stencilFunc(this.glComparison[t],e,i),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=i}},setStencilFuncFront:function(t,e,i){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==i){const s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[t],e,i),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=i}},setStencilFuncBack:function(t,e,i){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==i){const s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[t],e,i),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=i}},setStencilOperation:function(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=i),this.stencilWriteMaskFront===s&&this.stencilWriteMaskBack===s||(this.gl.stencilMask(s),this.stencilWriteMaskFront=s,this.stencilWriteMaskBack=s)},setStencilOperationFront:function(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=i),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s)},setStencilOperationBack:function(t,e,i,s){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=i),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s)},setBlendFunction:function(t,e){(this.blendSrc!==t||this.blendDst!==e||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[t],this.glBlendFunction[e]),this.blendSrc=t,this.blendDst=e,this.separateAlphaBlend=!1)},setBlendFunctionSeparate:function(t,e,i,s){this.blendSrc===t&&this.blendDst===e&&this.blendSrcAlpha===i&&this.blendDstAlpha===s&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[t],this.glBlendFunction[e],this.glBlendFunction[i],this.glBlendFunction[s]),this.blendSrc=t,this.blendDst=e,this.blendSrcAlpha=i,this.blendDstAlpha=s,this.separateAlphaBlend=!0)},setBlendEquation:function(t){(this.blendEquation!==t||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[t]),this.blendEquation=t,this.separateAlphaEquation=!1)},setBlendEquationSeparate:function(t,e){this.blendEquation===t&&this.blendAlphaEquation===e&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[t],this.glBlendEquation[e]),this.blendEquation=t,this.blendAlphaEquation=e,this.separateAlphaEquation=!0)},setCullMode:function(t){if(this.cullMode!==t){if(t===pc.CULLFACE_NONE)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===pc.CULLFACE_NONE&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(t){this.indexBuffer=t},setVertexBuffer:function(t,e,i){if(null!=t&&(this.vertexBuffers[e]!==t||this.vbOffsets[e]!==i)){this.vertexBuffers[e]=t,this.vbOffsets[e]=i;let s=0;const n=t.getFormat().elements,r=n.length;for(;s<r;){const t=n[s++];t.stream=e,t.scopeId.setValue(t)}this.attributesInvalidated=!0}},compileShaderSource:function(t,e){const i=this.gl;let s=e?this.vertexShaderCache[t]:this.fragmentShaderCache[t];if(!s){const n=pc.now();this.fire("shader:compile:start",{timestamp:n,target:this}),s=i.createShader(e?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(s,t),i.compileShader(s);const r=pc.now();this.fire("shader:compile:end",{timestamp:r,target:this}),this._shaderStats.compileTime+=r-n,e?(this.vertexShaderCache[t]=s,this._shaderStats.vsCompiled++):(this.fragmentShaderCache[t]=s,this._shaderStats.fsCompiled++)}return s},compileAndLinkShader:function(t){const e=this.gl,i=t.definition,s=this.compileShaderSource(i.vshader,!0),n=this.compileShaderSource(i.fshader,!1),o=e.createProgram();if(e.attachShader(o,s),e.attachShader(o,n),this.webgl2&&i.useTransformFeedback){const t=i.attributes,s=[];for(const e in t)t.hasOwnProperty(e)&&s.push("out_"+e);e.transformFeedbackVaryings(o,s,e.INTERLEAVED_ATTRIBS)}for(const t in i.attributes)if(i.attributes.hasOwnProperty(t)){const s=i.attributes[t],n=r[s];e.bindAttribLocation(o,n,t)}e.linkProgram(o),t._glVertexShader=s,t._glFragmentShader=n,t._glProgram=o,t._globalKeywordsVersion=pc.Shader._globalKeywordsVersion,t.ready=!1,this._shaderStats.linked++,i.tag===pc.SHADERTAG_MATERIAL&&this._shaderStats.materialShaders++},createShader:function(t){this.compileAndLinkShader(t),this.shaders.push(t)},destroyShader:function(t){const e=this.shaders.indexOf(t);-1!==e&&this.shaders.splice(e,1),t._glProgram&&(this.gl.deleteProgram(t._glProgram),t._glProgram=null,this.removeShaderFromCache(t))},_addLineNumbers:function(t){const e=t.split("\n");for(let t=0,i=e.length;t<i;t++)e[t]=t+1+":\t"+e[t];return e.join("\n")},postLink:function(t){const e=this.gl,i=t._glVertexShader,s=t._glFragmentShader,n=t._glProgram,r=t.definition,o=pc.now();if(this.fire("shader:link:start",{timestamp:o,target:this}),!e.getShaderParameter(i,e.COMPILE_STATUS))return console.error("Failed to compile vertex shader:\n\n"+this._addLineNumbers(r.vshader)+"\n\n"+e.getShaderInfoLog(i)),!1;if(!e.getShaderParameter(s,e.COMPILE_STATUS))return console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(r.fshader)+"\n\n"+e.getShaderInfoLog(s)),!1;if(!e.getProgramParameter(n,e.LINK_STATUS))return console.error("Failed to link shader program. Error: "+e.getProgramInfoLog(n)),!1;let a,c,h,l;a=0;const p=e.getProgramParameter(n,e.ACTIVE_ATTRIBUTES);for(;a<p;)c=e.getActiveAttrib(n,a++),h=e.getAttribLocation(n,c.name),void 0===r.attributes[c.name]&&console.error('Vertex shader attribute "'+c.name+'" is not mapped to a semantic in shader definition.'),l=new pc.ShaderInput(this,r.attributes[c.name],this.pcUniformType[c.type],h),t.attributes.push(l);t.samplers=[],t.uniforms=[],a=0;const u=e.getProgramParameter(n,e.ACTIVE_UNIFORMS);for(;a<u;)c=e.getActiveUniform(n,a++),h=e.getUniformLocation(n,c.name),l=new pc.ShaderInput(this,c.name,this.pcUniformType[c.type],h),c.type===e.SAMPLER_2D||c.type===e.SAMPLER_CUBE||this.webgl2&&(c.type===e.SAMPLER_2D_SHADOW||c.type===e.SAMPLER_CUBE_SHADOW||c.type===e.SAMPLER_3D)?t.samplers.push(l):t.uniforms.push(l);t.ready=!0;const d=pc.now();return this.fire("shader:link:end",{timestamp:d,target:this}),this._shaderStats.compileTime+=d-o,!0},setShader:function(t){if(t!==this.shader){if(t.needsCompilation&&this.compileAndLinkShader(t),!t.ready){if(!this.postLink(t))return!1;t.uniformsUsage=this.getUniformsInUse(t.uniforms)}this.shader=t,this.gl.useProgram(t._glProgram),this._shaderSwitchesPerFrame++,this.attributesInvalidated=!0}return!0},getHdrFormat:function(){return this.textureHalfFloatRenderable?pc.PIXELFORMAT_RGB16F:this.textureFloatRenderable?pc.PIXELFORMAT_RGB32F:pc.PIXELFORMAT_R8_G8_B8_A8},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(t){this.boneLimit=t},resizeCanvas:function(t,e){this._width=t,this._height=e;const i=Math.min(this._maxPixelRatio,window.devicePixelRatio);t*=i,e*=i,this.canvas.width=t,this.canvas.height=e,this.fire("resizecanvas",t,e,this._width,this._height)},setResolution:function(t,e){this._width=t,this._height=e,this.canvas.width=t,this.canvas.height=e,this.fire("resizecanvas",t,e,this._width,this._height)},clearShaderCache:function(){const t=this.gl;let e;for(e in this.fragmentShaderCache)this.fragmentShaderCache.hasOwnProperty(e)&&(t.deleteShader(this.fragmentShaderCache[e]),delete this.fragmentShaderCache[e]);for(e in this.vertexShaderCache)this.vertexShaderCache.hasOwnProperty(e)&&(t.deleteShader(this.vertexShaderCache[e]),delete this.vertexShaderCache[e]);this.programLib.clearCache()},removeShaderFromCache:function(t){this.programLib.removeFromCache(t)},destroy:function(){const t=this.gl;this.grabPassTexture.destroy(),this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.canvas=null,this.gl=null}}),Object.defineProperty(h.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}}),Object.defineProperty(h.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}}),Object.defineProperty(h.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(t){if(t){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}}),Object.defineProperty(h.prototype,"enableAutoInstancing",{get:function(){return this._enableAutoInstancing},set:function(t){this._enableAutoInstancing=t&&this.extInstancing}}),Object.defineProperty(h.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(t){this._maxPixelRatio=t,this.resizeCanvas(this._width,this._height)}}),{GraphicsDevice:h,ShaderAttributeSlots:r,UniformDefaultValues:o}}()),Object.assign(pc,function(){const t={},e={vertex_position:pc.SEMANTIC_POSITION,vertex_normal:pc.SEMANTIC_NORMAL,vertex_tangent:pc.SEMANTIC_TANGENT,vertex_texCoord0:pc.SEMANTIC_TEXCOORD0,vertex_texCoord1:pc.SEMANTIC_TEXCOORD1,vertex_texCoord2:pc.SEMANTIC_TEXCOORD2,vertex_texCoord3:pc.SEMANTIC_TEXCOORD3,vertex_texCoord4:pc.SEMANTIC_TEXCOORD4,vertex_texCoord5:pc.SEMANTIC_TEXCOORD5,vertex_texCoord6:pc.SEMANTIC_TEXCOORD6,vertex_texCoord7:pc.SEMANTIC_TEXCOORD7,vertex_color:pc.SEMANTIC_COLOR,vertex_boneIndices:pc.SEMANTIC_BLENDINDICES,vertex_boneWeights:pc.SEMANTIC_BLENDWEIGHT};return t.collectAttribs=function(t){const i={};let s=0,n=t.indexOf("attribute");for(;n>=0&&!(n>0&&"/"===t[n-1]);){const r=t.indexOf(";",n),o=t.lastIndexOf(" ",r),a=t.substr(o+1,r-(o+1)),c=e[a];void 0!==c?i[a]=c:(i[a]="ATTR"+s,s++),n=t.indexOf("attribute",n+1)}return i},t.createShader=function(e,i,s,n){let r=t[i],o=pc.programlib.precisionCode(e)+"\n"+t[s];o=pc.ensureExtensionsInTheBeginning(o);const a=this.collectAttribs(r);return e.webgl2&&(r=pc.programlib.versionCode(e)+this.gles3VS+r,o=pc.programlib.versionCode(e)+this.gles3PS+o),new pc.Shader(e,{attributes:a,vshader:r,fshader:o,useTransformFeedback:n})},t.createShaderFromCode=function(t,e,i,s,n){const r=t.programLib._cache,o=r[s];if(void 0!==o)return o;i=pc.programlib.precisionCode(t)+"\n"+(i||pc.programlib.dummyFragmentCode()),i=pc.ensureExtensionsInTheBeginning(i);const a=this.collectAttribs(e);return t.webgl2&&(e=pc.programlib.versionCode(t)+this.gles3VS+e,i=pc.programlib.versionCode(t)+this.gles3PS+i),r[s]=new pc.Shader(t,{attributes:a,vshader:e,fshader:i,useTransformFeedback:n}),r[s]},{shaderChunks:t}}()),Object.assign(pc,function(){let t=null;const e={type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1};return{drawQuadWithShader:function(i,s,n,r,o,a){if(null===t){const e=new pc.VertexFormat(i,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.TYPE_FLOAT32}]);t=new pc.VertexBuffer(i,e,4);const s=new pc.VertexIterator(t);s.element[pc.SEMANTIC_POSITION].set(-1,-1),s.next(),s.element[pc.SEMANTIC_POSITION].set(1,-1),s.next(),s.element[pc.SEMANTIC_POSITION].set(-1,1),s.next(),s.element[pc.SEMANTIC_POSITION].set(1,1),s.end()}const c=i.renderTarget;let h,l,p,u,d,_,f,m;i.setRenderTarget(s),i.updateBegin(),r?(h=r.x,l=r.y,p=r.z,u=r.w):(p=s?s.width:i.width,u=s?s.height:i.height,h=0,l=0),o?(d=o.x,_=o.y,f=o.z,m=o.w):(d=h,_=l,f=p,m=u),i.setViewport(h,l,p,u),i.setScissor(d,_,f,m);const g=i.getDepthTest(),y=i.getDepthWrite(),E=i.getCullMode();i.setDepthTest(!1),i.setDepthWrite(!1),i.setCullMode(pc.CULLFACE_NONE),a||i.setBlending(!1),i.setVertexBuffer(t,0),i.setShader(n),i.draw(e,1,{}),i.setDepthTest(g),i.setDepthWrite(y),i.setCullMode(E),i.updateEnd(),i.setRenderTarget(c),i.updateBegin()},destroyPostEffectQuad:function(){t&&(t.destroy(),t=null)}}}()),Object.assign(pc,function(){function t(t,e,i){const s=e._colorBuffer;if(s.format!==pc.PIXELFORMAT_R8_G8_B8_A8)return;const n=new Uint8Array(s.width*s.height*4),r=t.gl;t.setFramebuffer(e._glFrameBuffer),r.readPixels(0,0,s.width,s.height,r.RGBA,r.UNSIGNED_BYTE,n),s._levels||(s._levels=[]),s._levels[0]||(s._levels[0]=[]),s._levels[0][i]=n}function e(t,e){return Math.atan2(t*e,Math.sqrt(t*t+e*e+1))}function i(t,i,s){let n=2*(t+.5)/s-1,r=2*(i+.5)/s-1;n*=1-1/s,r*=1-1/s;const o=1/s,a=n-o,c=r-o,h=n+o,l=r+o;let p=e(a,c)-e(a,l)-e(h,c)+e(h,l);return 0===t&&0===i||t===s-1&&0===i||0===t&&i===s-1||t===s-1&&i===s-1?p/=3:0!==t&&0!==i&&t!==s-1&&i!==s-1||(p*=.5),p}return{prefilterCubemap:function(e){const i=e.device;let s=e.sourceCubemap;const n=e.method,r=e.samples,o=e.cpuSync;if(o&&!s._levels[0])return void console.error("ERROR: prefilter: cubemap must have _levels");const a=pc.shaderChunks,c=s.rgbm,h=a.createShaderFromCode(i,a.fullscreenQuadVS,a.rgbmPS+a.prefilterCubemapPS.replace(/\$METHOD/g,0===n?"cos":"phong").replace(/\$NUMSAMPLES/g,r).replace(/\$textureCube/g,c?"textureCubeRGBM":"textureCube"),"prefilter"+n+r+c),l=a.createShaderFromCode(i,a.fullscreenQuadVS,a.outputCubemapPS,"outputCubemap"),p=i.scope.resolve("source"),u=i.scope.resolve("params"),d=new pc.Vec4;let _=s.width,f=s.format;const m=[[],e.filteredFixed,e.filteredRgbm,e.filteredFixedRgbm],g=0===n?[.9,.85,.7,.4,.25]:[512,128,32,8,2],y=[64,32,16,8,4];let E,T,A,b;const S=f===pc.PIXELFORMAT_R8_G8_B8;let R,I,C=!1;if(o&&(C=s._levels[0][0]instanceof HTMLImageElement),(S||C)&&o){for(f=pc.PIXELFORMAT_R8_G8_B8_A8,R=new pc.Texture(i,{cubemap:!0,rgbm:c,format:f,width:_,height:_,mipmaps:!1}),A=0;A<6;A++)E=new pc.RenderTarget(i,R,{face:A,depth:!1}),d.x=A,d.y=0,p.setValue(s),u.setValue(d.data),pc.drawQuadWithShader(i,E,l),t(i,E,A);s=R}if(_>128){const e=Math.round(Math.log2(128)),r=Math.round(Math.log2(_))-e;for(T=0;T<r;T++){_=.5*s.width;const e=0===n?1:Math.pow(2,Math.round(Math.log2(g[0])+2*(r-T)));for(R=new pc.Texture(i,{cubemap:!0,rgbm:c,format:f,width:_,height:_,mipmaps:!1}),A=0;A<6;A++)E=new pc.RenderTarget(i,R,{face:A,depth:!1}),d.x=A,d.y=e,d.z=_,d.w=c?3:0,p.setValue(s),u.setValue(d.data),pc.drawQuadWithShader(i,E,l),T===r-1&&o&&t(i,E,A);s=R}}e.sourceCubemap=s;let M=null;if(!c&&e.filteredFixedRgbm){for(R=new pc.Texture(i,{cubemap:!0,rgbm:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:_,height:_,mipmaps:!1}),A=0;A<6;A++)E=new pc.RenderTarget(i,R,{face:A,depth:!1}),d.x=A,d.w=2,p.setValue(s),u.setValue(d.data),pc.drawQuadWithShader(i,E,l),t(i,E,A);M=R}const v=0===n?1:2048,P=0===n?0:-1;for(m[P]=[],T=0;T<5;T++)for(b=P;b<m.length;b++)null!=m[b]&&(m[b][T]=new pc.Texture(i,{cubemap:!0,rgbm:!(b<2)||c,format:b<2?f:pc.PIXELFORMAT_R8_G8_B8_A8,fixCubemapSeams:1===b||3===b,width:y[T],height:y[T],mipmaps:!1}));for(b=P;b<m.length;b++)if(null!=m[b]){if(b>1&&c){m[b]=m[b-2];continue}for(T=0;T<5;T++)for(A=0;A<6;A++)E=new pc.RenderTarget(i,m[b][T],{face:A,depth:!1}),d.x=A,d.y=b<0?v:g[T],d.z=y[T],d.w=c?3:b,p.setValue(0===T?s:0===n?m[0][T-1]:m[-1][T-1]),u.setValue(d.data),pc.drawQuadWithShader(i,E,h),o&&t(i,E,A)}let O;if(e.filtered=m[0],o&&e.singleFilteredFixed){for(O=[s,e.filteredFixed[0],e.filteredFixed[1],e.filteredFixed[2],e.filteredFixed[3],e.filteredFixed[4],e.filteredFixed[5]],I=new pc.Texture(i,{cubemap:!0,rgbm:c,fixCubemapSeams:!0,format:f,width:128,height:128,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE}),T=0;T<6;T++)I._levels[T]=O[T]._levels[0];I.upload(),I._prefilteredMips=!0,e.singleFilteredFixed=I}if(o&&e.singleFilteredFixedRgbm&&e.filteredFixedRgbm){for(O=[M,e.filteredFixedRgbm[0],e.filteredFixedRgbm[1],e.filteredFixedRgbm[2],e.filteredFixedRgbm[3],e.filteredFixedRgbm[4],e.filteredFixedRgbm[5]],I=new pc.Texture(i,{cubemap:!0,rgbm:!0,fixCubemapSeams:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:128,height:128,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE}),T=0;T<6;T++)I._levels[T]=O[T]._levels[0];I.upload(),I._prefilteredMips=!0,e.singleFilteredFixedRgbm=I}},shFromCubemap:function(t,e){let s;const n=t.width;let r,o;if(t.format!==pc.PIXELFORMAT_R8_G8_B8_A8)return console.error("ERROR: SH: cubemap must be RGBA8"),null;if(!t._levels[0])return console.error("ERROR: SH: cubemap must be synced to CPU"),null;if(!t._levels[0][0].length){if(!(t._levels[0][0]instanceof HTMLImageElement))return console.error("ERROR: SH: cubemap must be composed of arrays or images"),null;{const e=pc.Application.getApplication().graphicsDevice,i=e.gl,r=pc.shaderChunks,o=r.createShaderFromCode(e,r.fullscreenQuadVS,r.fullscreenQuadPS,"fsQuadSimple"),a=e.scope.resolve("source");for(s=0;s<6;s++){const r=t._levels[0][s],c=new pc.Texture(e,{cubemap:!1,rgbm:!1,format:t.format,width:n,height:n,mipmaps:!1});c._levels[0]=r,c.upload();const h=new pc.Texture(e,{cubemap:!1,rgbm:!1,format:t.format,width:n,height:n,mipmaps:!1}),l=new pc.RenderTarget(e,h,{depth:!1});a.setValue(c),pc.drawQuadWithShader(e,l,o);const p=new Uint8Array(n*n*4);i.bindFramebuffer(i.FRAMEBUFFER,l._glFrameBuffer),i.readPixels(0,0,c.width,c.height,i.RGBA,i.UNSIGNED_BYTE,p),t._levels[0][s]=p}}}const a=[];for(o=0;o<n;o++)for(r=0;r<n;r++){const t=r/(n-1)*2-1,e=o/(n-1)*2-1;a[o*n+r]=new pc.Vec3(t,e,1).normalize()}const c=new Float32Array(27);let h,l,p,u,d,_,f,m,g,y,E,T,A,b,S=0;for(s=0;s<6;s++)for(o=0;o<n;o++)for(r=0;r<n;r++)for(h=o*n+r,d=i(r,o,n),y=4*d/17,E=8*d/17,T=15*d/17,A=5*d/68,b=15*d/68,_=a[h],0===s?(f=_.z,m=-_.y,g=-_.x):1===s?(f=-_.z,m=-_.y,g=_.x):2===s?(f=_.x,m=_.z,g=_.y):3===s?(f=_.x,m=-_.z,g=-_.y):4===s?(f=_.x,m=-_.y,g=_.z):5===s&&(f=-_.x,m=-_.y,g=-_.z),e||(f=-f),p=t._levels[0][s][4*h+3]/255,l=0;l<3;l++)u=t._levels[0][s][4*h+l]/255,t.rgbm?(u*=8*p,u*=u):u=Math.pow(u,2.2),c[0+l]+=u*y,c[3+l]+=u*E*f,c[6+l]+=u*E*m,c[9+l]+=u*E*g,c[12+l]+=u*T*f*g,c[15+l]+=u*T*g*m,c[18+l]+=u*T*m*f,c[21+l]+=u*A*(3*g*g-1),c[24+l]+=u*b*(f*f-m*m),S+=d;for(l=0;l<c.length;l++)c[l]*=4*Math.PI/S;return c}}}()),Object.assign(pc,function(){const t=2;function e(t,e){t.x=.5*pc.math.clamp(e-2,0,1);const i=e-6*t.x,s=1-t.x;return t.y=Math.min(.5*i,.75)*s+t.x,t.z=(1-.5*pc.math.clamp(i,0,1))*s,t.w=.5*t.z,1/t.z}return{paraboloidFromCubemap:function(e,i,s,n){const r=pc.shaderChunks,o=r.createShaderFromCode(e,r.fullscreenQuadVS,(i.fixCubemapSeams?r.fixCubemapSeamsStretchPS:r.fixCubemapSeamsNonePS)+r.genParaboloidPS,"genParaboloid"),a=e.scope.resolve("source"),c=e.scope.resolve("params"),h=new pc.Vec4;let l=i.width;const p=i.rgbm,u=i.format;l=Math.max(l,8)*t;const d=new pc.Texture(e,{rgbm:p,format:u,width:2*l,height:l,mipmaps:!1}),_=new pc.RenderTarget(e,d,{depth:!1});return h.x=s,h.y=n?-1:1,a.setValue(i),c.setValue(h.data),pc.drawQuadWithShader(e,_,o),d},generateDpAtlas:function(i,s,n){let r;const o=new pc.Vec4,a=new pc.Vec4,c=2*s[0].width*t,h=pc.shaderChunks,l=h.createShaderFromCode(i,h.fullscreenQuadVS,h.dpAtlasQuadPS,"dpAtlasQuad"),p=i.scope.resolve("source"),u=i.scope.resolve("params"),d=new pc.Texture(i,{rgbm:s[0].rgbm,format:s[0].format,width:c,height:c,mipmaps:!1}),_=new pc.RenderTarget(i,d,{depth:!1}),f=(c+2)/c-1;let m;for(let t=0;t<6;t++)r=pc.paraboloidFromCubemap(i,s[t],t,n),p.setValue(r),m=e(o,t),a.x=m*f,a.y=2*a.x,a.x+=1,a.y+=1,u.setValue(a.data),o.x*=c,o.y*=c,o.z*=c,o.w*=c,pc.drawQuadWithShader(i,_,l,o);return d}}}()),pc.shaderChunks.convolveLastMipOfCubemapPS="#extension GL_EXT_shader_texture_lod : enable\nhighp vec4 sampleCubeLod(highp samplerCube sampler, highp vec3 coord, mediump float lod) {\n#if defined(GL_EXT_shader_texture_lod)\n    return textureCubeLodEXT( sampler, coord, lod );\n#else\n    return textureCube( sampler, coord, lod );\n#endif\n}\nuniform highp samplerCube _Cubemap_; \nuniform highp float _Level_; \nvoid main() { \n    // just sample all directions (+X, -X etc) and average the result\n    gl_FragColor = vec4(( \n        sampleCubeLod( _Cubemap_, vec3( 1.0, 0.0, 0.0 ),  _Level_ ) + \n        sampleCubeLod( _Cubemap_, vec3( -1.0, 0.0, 0.0 ), _Level_ ) + \n        sampleCubeLod( _Cubemap_, vec3( 0.0, 1.0, 0.0 ),  _Level_ ) + \n        sampleCubeLod( _Cubemap_, vec3( 0.0, -1.0, 0.0 ), _Level_ ) + \n        sampleCubeLod( _Cubemap_, vec3( 0.0, 0.0, 1.0 ),  _Level_ ) +\n        sampleCubeLod( _Cubemap_, vec3( 0.0, 0.0, -1.0 ), _Level_ ) \n    ) * 0.1666666667); \n}",pc.shaderChunks.convolveLastMipOfCubemapVS="attribute vec2 vertex_position; \nvoid main() { \n    gl_Position = vec4( vertex_position, 0.5, 1.0 ); \n}",pc.shaderChunks.fullscreenQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n",pc.shaderChunks.fullscreenQuadVS="attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n",pc.shaderChunks.gles3PS="#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",pc.shaderChunks.gles3VS="#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",pc.programlib={gammaCode:function(t){return t===pc.GAMMA_SRGB||t===pc.GAMMA_SRGBFAST?pc.shaderChunks.gamma2_2PS:t===pc.GAMMA_SRGBHDR?"#define HDR\n"+pc.shaderChunks.gamma2_2PS:pc.shaderChunks.gamma1_0PS},tonemapCode:function(t){return t===pc.TONEMAP_FILMIC?pc.shaderChunks.tonemappingFilmicPS:t===pc.TONEMAP_LINEAR?pc.shaderChunks.tonemappingLinearPS:t===pc.TONEMAP_HEJL?pc.shaderChunks.tonemappingHejlPS:t===pc.TONEMAP_ACES?pc.shaderChunks.tonemappingAcesPS:t===pc.TONEMAP_ACES2?pc.shaderChunks.tonemappingAces2PS:pc.shaderChunks.tonemappingNonePS},fogCode:function(t){return"linear"===t?pc.shaderChunks.fogLinearPS:"exp"===t?pc.shaderChunks.fogExpPS:"exp2"===t?pc.shaderChunks.fogExp2PS:pc.shaderChunks.fogNonePS},skinCode:function(t,e){return e||(e=pc.shaderChunks),t.supportsBoneTextures?e.skinTexVS:"#define BONE_LIMIT "+t.getBoneLimit()+"\n"+e.skinConstVS},precisionCode:function(t){let e="precision "+t.precision+" float;\n";return t.webgl2&&(e+="#ifdef GL2\nprecision "+t.precision+" sampler2DShadow;\n#endif\n"),e},versionCode:function(t){return t.webgl2?"#version 300 es\n":""},dummyFragmentCode:function(){return"void main(void) {gl_FragColor = vec4(0.0);}"},begin:function(){return"void main(void)\n{\n"},end:function(){return"}\n"}},Object.assign(pc,function(){const t={type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1},e=function(t){this.device=t,this.shader=null,this.depthMap=null,this.vertexBuffer=pc.createFullscreenQuad(t),this.needsDepthBuffer=!1};return Object.assign(e.prototype,{render:function(t,e,i){}}),{PostEffect:e,createFullscreenQuad:function(t){const e=new pc.VertexFormat(t,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.TYPE_FLOAT32}]),i=new pc.VertexBuffer(t,e,4),s=new pc.VertexIterator(i);return s.element[pc.SEMANTIC_POSITION].set(-1,-1),s.next(),s.element[pc.SEMANTIC_POSITION].set(1,-1),s.next(),s.element[pc.SEMANTIC_POSITION].set(-1,1),s.next(),s.element[pc.SEMANTIC_POSITION].set(1,1),s.end(),i},drawFullscreenQuad:function(e,i,s,n,r){e.setRenderTarget(i),e.updateBegin();let o=null!==i?i.width:e.width,a=null!==i?i.height:e.height,c=0,h=0;r&&(c=r.x*o,h=r.y*a,o*=r.z,a*=r.w),e.setViewport(c,h,o,a),e.setScissor(c,h,o,a);const l=e.getBlending(),p=e.getDepthTest(),u=e.getDepthWrite(),d=e.getCullMode(),_=e.writeRed,f=e.writeGreen,m=e.writeBlue,g=e.writeAlpha;e.setBlending(!1),e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(pc.CULLFACE_BACK),e.setColorWrite(!0,!0,!0,!0),e.setVertexBuffer(s,0),e.setShader(n),e.draw(t),e.setBlending(l),e.setDepthTest(p),e.setDepthWrite(u),e.setCullMode(d),e.setColorWrite(_,f,m,g),e.updateEnd()}}}()),function(){const t={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,BLEND_ADDITIVEALPHA:6,BLEND_MULTIPLICATIVE2X:7,BLEND_SCREEN:8,BLEND_MIN:9,BLEND_MAX:10,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2",FRESNEL_NONE:0,FRESNEL_SCHLICK:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:15,LAYERID_WORLD:0,LAYERID_DEPTH:1,LAYERID_SKYBOX:2,LAYERID_IMMEDIATE:3,LAYERID_UI:4,LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,SHADOW_PCF3:0,SHADOW_DEPTH:0,SHADOW_VSM8:1,SHADOW_VSM16:2,SHADOW_VSM32:3,SHADOW_PCF5:4,BLUR_BOX:0,BLUR_GAUSSIAN:1,PARTICLESORT_NONE:0,PARTICLESORT_DISTANCE:1,PARTICLESORT_NEWER_FIRST:2,PARTICLESORT_OLDER_FIRST:3,PARTICLEMODE_GPU:0,PARTICLEMODE_CPU:1,EMITTERSHAPE_BOX:0,EMITTERSHAPE_SPHERE:1,PROJECTION_PERSPECTIVE:0,PROJECTION_ORTHOGRAPHIC:1,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,CUBEPROJ_NONE:0,CUBEPROJ_BOX:1,SPECULAR_PHONG:0,SPECULAR_BLINN:1,GAMMA_NONE:0,GAMMA_SRGB:1,GAMMA_SRGBFAST:2,GAMMA_SRGBHDR:3,TONEMAP_LINEAR:0,TONEMAP_FILMIC:1,TONEMAP_HEJL:2,TONEMAP_ACES:3,TONEMAP_ACES2:4,SPECOCC_NONE:0,SPECOCC_AO:1,SPECOCC_GLOSSDEPENDENT:2,SHADERDEF_NOSHADOW:1,SHADERDEF_SKIN:2,SHADERDEF_UV0:4,SHADERDEF_UV1:8,SHADERDEF_VCOLOR:16,SHADERDEF_INSTANCING:32,SHADERDEF_LM:64,SHADERDEF_DIRLM:128,SHADERDEF_SCREENSPACE:256,SHADERDEF_TANGENTS:512,SHADERDEF_LMUV0:1024,SHADERDEF_LM_DLDR:2048,SHADERDEF_LM_BAKED_AMBIENT:4096,SHADERDEF_LIGHTPROBES:8192,SHADERDEF_BLEND_REFLECTION_PROBES:16384,SHADERDEF_RENDERTYPE_BACKGROUND:32768,SHADERDEF_PARTICLES_INSTANCING:65536,SHADERDEF_UI_MASK:1<<17,SHADERDEF_REVERT_STENCIL:1<<18,MASK_DYNAMIC:1,MASK_BAKED:2,MASK_LIGHTMAP:4,LINEBATCH_WORLD:0,LINEBATCH_OVERLAY:1,LINEBATCH_GIZMO:2,LINEBATCH_SCREEN:3,SHADOWUPDATE_NONE:0,SHADOWUPDATE_THISFRAME:1,SHADOWUPDATE_REALTIME:2,SORTKEY_FORWARD:0,SORTKEY_DEPTH:1,SHADER_FORWARD:0,SHADER_FORWARDHDR:1,SHADER_DEPTH:2,SHADER_SHADOW:3,SHADER_PICK:18,BAKE_COLOR:0,BAKE_COLORDIR:1,VIEW_CENTER:0,VIEW_LEFT:1,VIEW_RIGHT:2,SORTMODE_NONE:0,SORTMODE_MANUAL:1,SORTMODE_MATERIALMESH:2,SORTMODE_BACK2FRONT:3,SORTMODE_FRONT2BACK:4,SORTMODE_CUSTOM:5,COMPUPDATED_INSTANCES:1,COMPUPDATED_LIGHTS:2,COMPUPDATED_CAMERAS:4,COMPUPDATED_BLEND:8,ASPECT_AUTO:0,ASPECT_MANUAL:1,ORIENTATION_HORIZONTAL:0,ORIENTATION_VERTICAL:1};Object.assign(pc,t),pc.scene={},Object.assign(pc.scene,t)}(),Object.assign(pc,function(){const t=function(){this.root=null,this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this._statsUpdated=!1,this.meshInstancesCount=0,this._meshInstances=new Array(1e3),this._renderers=new Set,this._cameras=new pc.IndexedList,this._lights=new pc.IndexedList,this._overlayScreensDirty=!1,this._overlayScreens=new pc.IndexedList,this._worldScreens=new pc.IndexedList,this.activeUiMasks={},this.dirtyEntities=new Set,pc.events.attach(this)};return t.prototype.addDirty=function(t){this.dirtyEntities.add(t)},t.prototype.syncHierarchy=function(t){const e=[...this.dirtyEntities];for(const t of e)t.syncHierarchy();this.dirtyEntities.clear()},t.prototype.destroy=function(){this.root=null,this.defaultMaterial.destroy(),this.defaultMaterial=null,this.off()},t.prototype.addRenderer=function(t){this._renderers.add(t)},t.prototype.removeRenderer=function(t){this._renderers.delete(t)},t.prototype.getMeshInstances=function(){for(let t=0;t<this.meshInstancesCount;t++)this._meshInstances[t]=null;this.meshInstancesCount=0;for(const t of this._renderers){const e=t.getMeshInstancesForRender();for(let t=0;t<e.length;t++){const i=e[t];i.isIndexBufferEmpty&&!i.isCanvas||(this._meshInstances.length===this.meshInstancesCount?this._meshInstances.push(i):this._meshInstances[this.meshInstancesCount]=i,this.meshInstancesCount++)}}return this._meshInstances},t.prototype.getMeshInstancesCached=function(){return this._meshInstances},t.prototype.addCamera=function(t){this._cameras.has(t)||this._cameras.push(t)},t.prototype.removeCamera=function(t){this._cameras.remove(t)},t.prototype.addLight=function(t){this._lights.has(t)||this._lights.push(t)},t.prototype.removeLight=function(t){this._lights.remove(t)},t.prototype.addScreen=function(t){const e=t.screenType===pc.SCREEN_TYPE_SCREEN?this._overlayScreens:this._worldScreens;e.has(t)||(e.push(t),e===this._overlayScreens&&(this._overlayScreensDirty=!0))},t.prototype.removeScreen=function(t){const e=t.screenType===pc.SCREEN_TYPE_SCREEN?this._overlayScreens:this._worldScreens;e.has(t)&&e.remove(t)},Object.defineProperty(t.prototype,"overlayScreens",{get:function(){return this._overlayScreensDirty&&(this._overlayScreensDirty=!1,this._overlayScreens.sort(pc.SortUtils.sortOverlayCanvases)),this._overlayScreens.list()}}),Object.defineProperty(t.prototype,"worldScreens",{get:function(){return this._worldScreens.list()}}),{Scene:t}}()),pc.extend(pc,function(){const t=/void\s+main\s*\(\s*(void)?\s*\)\s*{/,e="attribute\\s+(highp\\s*|lowp\\s*|mediump\\s*)?vec[2|3|4]\\s+",i=/\s*vec(2|3|4)\s*/,s=/uniform mat4 matrix_viewProjection;/,n=/texture2D\s*\(\s*unity_Lightmap\s*,/,r="  ",o="attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nmat4 skinnedMatrix;\n\nmat4 getSkinnedModelMatrix() {\n    return (\n    getBoneMatrix( vertex_boneIndices.x ) * vertex_boneWeights.x +\n    getBoneMatrix( vertex_boneIndices.y ) * vertex_boneWeights.y +\n    getBoneMatrix( vertex_boneIndices.z ) * vertex_boneWeights.z +\n    getBoneMatrix( vertex_boneIndices.w ) * vertex_boneWeights.w );\n}\n\nvec4 get_POSITION( vec4 pos )\n{\n    return skinnedMatrix * pos;\n}\n\nvec4 get_NORMAL( vec4 normal )\n{\n    return skinnedMatrix * normal;\n}\n\nvec4 get_TANGENT( vec4 tangent )\n{\n    return skinnedMatrix * tangent;\n}\n",a=function(t,e,i,s){return t.substring(0,e)+s+t.substring(e+i)},c=function(t,e,i,s){let n=t,r=e[0].search(i);return r+=e.index,n=a(n,r,i.length,s),n},h=function(t,e){let i=t;return i=a(i,e.index,e[0].length,""),i},l=function(t,s,n,o,a){let h=t;const l=new RegExp(e+n+"\\s*;"),p=h.match(l);if(null!=p){const t=p[0].match(i)[0].trim();h=c(h,p,"attribute","");const e="_patched_"+s;if(a.defines+="attribute "+t+" "+e+";\n","vec4"===t)a.main+=r+n+" = get_"+s+"( "+e+" );\n";else{let i="",o="";"vec2"===t?(i=".xy",o=", 0, 0"):"vec3"===t&&(i=".xyz",o=", 0"),a.main+=r+n+" = get_"+s+"( vec4( "+e+o+") )"+i+";\n"}}return h},p=function(t,i,s){let n=null;for(const r in i){if(i[r]!==s)continue;const o=new RegExp(e+r+"\\s*;");if(null!=t.match(o)){n=r;break}}return n},u=function(t,e,i,s){let n=t;for(let t=0;t<e.length;t++){const r=e[t],o=p(n,i,r);if(null!==o){n=l(n,r,o,0,s)}}return n},d=function(t,e){const i=t.match("\\s*#version [0-9]+\\s*");if(null==i)return t;const s=i[0].trim(),n=h(t,i);return e.defines=s+"\n\n"+e.defines,n};function _(t,e){this.baseShader=t,this.patchShader=e,this.defines="",this.main="",this.getMain=function(){return"void main() {\n"+this.main+r+"_main(); // Initial main function call\n}\n"},this.combine=function(){return"\n// Patched defines\n"+this.defines+"\n// Patch shader\n"+this.patchShader+"\n\n// Base shader\n"+this.baseShader+"\n\n// Partched main\n"+this.getMain()}}const f=/^#extension.*$/gm;return{ShaderPatches:{patchParticlesVertexShader:function(e,i){const n=new _(e,"// Instancing attributes\nattribute vec3 instancing_translation;\nattribute vec4 instancing_rotation;\nattribute vec3 instancing_scale;\nattribute vec4 instancing_color;\nattribute vec4 instancing_st;\n\n// Uniforms\nuniform highp mat4 matrix_viewInverse;\nuniform highp mat4 matrix_viewProjection;\nuniform highp mat4 matrix_modelRotation;\nuniform highp mat4 matrix_modelTranslation;\nuniform highp mat4 matrix_modelRotationInverse;\nuniform highp vec3 system_scale;\nuniform int renderer_alignment;\nuniform float worldSimulationSpace;\n\n// Quaternion multiplication\n// http://mathworld.wolfram.com/Quaternion.html\nvec4 quaternion_multiply( vec4 lhs, vec4 rhs ) {\n    return vec4(\n    rhs.xyz * lhs.w + lhs.xyz * rhs.w + cross( lhs.xyz, rhs.xyz ),\n    lhs.w * rhs.w - dot( lhs.xyz, rhs.xyz )\n    );\n}\n\n// Vector rotation with a quaternion\n// http://mathworld.wolfram.com/Quaternion.html\nvec3 quaternion_rotate_vector( vec3 vector, vec4 quaternion ) {\n    vec4 quaternion_conjugate = quaternion * vec4( -1, -1, -1, 1 );\n    return quaternion_multiply( quaternion, quaternion_multiply( vec4( vector, 0 ), quaternion_conjugate ) ).xyz;\n}\n\nmat4 transpose( mat4 m ) {\n    return mat4(\n    m[ 0 ][ 0 ], m[ 1 ][ 0 ], m[ 2 ][ 0 ], m[ 3 ][ 0 ],\n    m[ 0 ][ 1 ], m[ 1 ][ 1 ], m[ 2 ][ 1 ], m[ 3 ][ 1 ],\n    m[ 0 ][ 2 ], m[ 1 ][ 2 ], m[ 2 ][ 2 ], m[ 3 ][ 2 ],\n    m[ 0 ][ 3 ], m[ 1 ][ 3 ], m[ 2 ][ 3 ], m[ 3 ][ 3 ]);\n}\n\nmat4 getFacingAlignmentRotation( vec4 particlePosition ) {\n    vec3 eye = matrix_viewInverse[ 3 ].xyz;\n    vec3 pivot = particlePosition.xyz;\n\n    // Find desired rotation between two vectors\n    vec4 cameraZ = vec4( normalize( pivot - eye ), 0 );\n    vec4 cameraY = matrix_viewInverse * vec4( 0, 1, 0, 0 );\n    vec4 cameraX = vec4( cross(cameraY.xyz, cameraZ.xyz), 0 );\n    cameraY = vec4( cross(cameraZ.xyz, cameraX.xyz), 0 );\n\n    mat4 extraRotation = mat4( 0.0 );\n    extraRotation[ 0 ] = cameraX;\n    extraRotation[ 1 ] = cameraY;\n    extraRotation[ 2 ] = cameraZ;\n    extraRotation[ 3 ][ 3 ] = 1.0;\n\n    return extraRotation;\n}\n\n// Applies rotation, then scale, then translate to the\n// vertex coordinates.\n\n#define VIEW_ALIGNMENT      0\n#define WORLD_ALIGNMENT     1\n#define LOCAL_ALIGNMENT     2\n#define FACING_ALIGNMENT    3\n\nmat4 alignment_rotation;\nmat4 simulationSpace_rotation;\nmat4 simulationSpace_translation;\n\nvec4 transform_vertex( vec4 vertex, mat4 matrix_scale ) {\n    vec4 v = matrix_scale * vertex;\n    v = vec4( quaternion_rotate_vector( v.xyz, instancing_rotation ), 1.0 );\n    v = alignment_rotation * v;\n\n    v += vec4( instancing_translation, 0 );\n\n    v = simulationSpace_rotation * v;\n    v = simulationSpace_translation * v;\n\n    return v;\n}\n\n\nvec4 get_POSITION( vec4 position ) {\n    if ( worldSimulationSpace > 0.0 ) {\n        simulationSpace_rotation = mat4( 1.0 );\n        simulationSpace_translation = mat4( 1.0 );\n    } else {\n        simulationSpace_rotation = matrix_modelRotation;\n        simulationSpace_translation = mat4( 1.0 );\n        simulationSpace_translation[ 3 ] = matrix_modelTranslation[ 3 ];\n    }\n\n    if ( LOCAL_ALIGNMENT == renderer_alignment ) {\n        // local alignment means rotation starts with hierarchy rotation\n        alignment_rotation = matrix_modelRotation;\n    } else if ( WORLD_ALIGNMENT ==  renderer_alignment ) {\n        // world alignment means rotation starts with E\n        alignment_rotation = mat4( 1.0 );\n    } else if ( ( VIEW_ALIGNMENT == renderer_alignment ) || ( FACING_ALIGNMENT == renderer_alignment ) ) {\n        // view alignment means rotation starts with camera rotation\n        // Assume scales are 0\n        alignment_rotation = matrix_viewInverse;\n        alignment_rotation[ 3 ] = vec4( 0, 0, 0, 1 );\n    }\n\n    alignment_rotation = transpose( simulationSpace_rotation ) * alignment_rotation;\n\n    mat4 scale;\n    scale[ 0 ] = vec4( system_scale.x * instancing_scale.x, 0, 0, 0 );\n    scale[ 1 ] = vec4( 0, system_scale.y * instancing_scale.y, 0, 0 );\n    scale[ 2 ] = vec4( 0, 0, system_scale.z * instancing_scale.z, 0 );\n    scale[ 3 ] = vec4( 0, 0, 0, 1 );\n\n    vec4 vertex = vec4( position.xyz, 1 );\n    vec4 vertexPosition = transform_vertex( vertex, scale );\n\n    if ( FACING_ALIGNMENT == renderer_alignment ) {\n        vec4 pivot_vertex = vec4( 0, 0, 0, 1 );\n        vec4 pivot = transform_vertex( pivot_vertex, scale );\n\n        alignment_rotation = transpose( simulationSpace_rotation ) * getFacingAlignmentRotation( pivot );\n        vertexPosition = transform_vertex( vertex, scale );\n    }\n\n    return vertexPosition;\n}\n\nvec4 get_COLOR( vec4 color ) {\n    return color * instancing_color;\n}\n\nvec4 get_TEXCOORD0( vec4 texcoord ) {\n    return vec4( ( texcoord.xy + instancing_st.zw ) * instancing_st.xy, texcoord.zw );\n}\n\nvec4 get_NORMAL( vec4 normal ) {\n    normal = vec4( quaternion_rotate_vector( normal.xyz, instancing_rotation ), 0 );\n    normal = alignment_rotation * normal;\n    normal = simulationSpace_rotation * normal;\n    return normal;\n}\n\nvec4 get_TANGENT( vec4 tangent ) {\n    tangent = vec4( quaternion_rotate_vector( tangent.xyz, instancing_rotation ), 0 );\n    tangent = alignment_rotation * tangent;\n    tangent = simulationSpace_rotation * tangent;\n    return tangent;\n}");n.baseShader=function(t){const e=new RegExp(s),i=t.match(e);return null===i?t:h(t,i)}(n.baseShader);const r=[pc.SEMANTIC_POSITION,pc.SEMANTIC_COLOR,pc.SEMANTIC_TEXCOORD0,pc.SEMANTIC_NORMAL,pc.SEMANTIC_TANGENT];n.baseShader=d(n.baseShader,n),n.baseShader=u(n.baseShader,r,i,n);const o=new RegExp(t),a=n.baseShader.match(o);return null===a?(console.error("Shader patching error. Main function not found\n"+e),null):(n.baseShader=c(n.baseShader,a,"main","_main"),n.combine())},patchSkinningVertexShader:function(e,i){const s=pc.Application.getApplication().graphicsDevice;let n;s.supportsBoneTextures?n=new _(e,"uniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n\n"+o):(n=new _(e,"// #define BONE_LIMIT 128 // will be added in code\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i) {\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n\n"+o),n.defines+="#define BONE_LIMIT "+s.getBoneLimit()+"\n"),n.main+=r+"skinnedMatrix = getSkinnedModelMatrix();\n";const a=[pc.SEMANTIC_POSITION,pc.SEMANTIC_NORMAL,pc.SEMANTIC_TANGENT];n.baseShader=d(n.baseShader,n),n.baseShader=u(n.baseShader,a,i,n);const h=new RegExp(t),l=n.baseShader.match(h);if(null===l)return console.error("Shader patching error. Main function not found\n"+e),null;n.baseShader=c(n.baseShader,l,"main","_main");let p=n.combine();const f=new RegExp("vec3 _patched_POSITION;");return n.defines.match(f)&&(p=p.replace("vec3 _patched_POSITION;","vec4 _patched_POSITION;"),p=p.replace("vec4( _patched_POSITION, 0)","_patched_POSITION")),p},patchTexture2DLightmap:function(e){const i=new RegExp(n),s=e.match(i);if(!s)return e;return e=function(e,i){const s=e.match(t);return null==s?e:(n=e,r=s.index,o=i,n.substring(0,r)+o+n.substring(r));var n,r,o}(e=c(e,s,"texture2D","texture2D_LM"),"// Patched method to support RGBm decoding\nuniform mediump vec4 unity_Lightmap_HDR;\nmediump vec4 texture2D_LM( sampler2D texture, mediump vec2 uv ) {\n    mediump vec4 rgbmColor = texture2D( texture, uv );    mediump vec4 color = vec4( rgbmColor.rgb * ( rgbmColor.w * unity_Lightmap_HDR.x ), rgbmColor.w );    return color;\n}\n\n")}},ensureExtensionsInTheBeginning:function(t){const e=new RegExp(f),i=t.match(e);return i?(t=t.replace(e,""),t=i[0]+"\n"+t):t},_createMissingShader:function(t,e){return console.error('Shader "'+t+'" with id #'+e+" is replaced as missing shader."),new pc.Shader(pc.Application.getApplication().graphicsDevice,{attributes:{_glesVertex:pc.SEMANTIC_POSITION,_glesNormal:pc.SEMANTIC_NORMAL,_glesTangent:pc.SEMANTIC_TANGENT,_glesMultiTexCoord0:pc.SEMANTIC_TEXCOORD0,_glesMultiTexCoord1:pc.SEMANTIC_TEXCOORD1,_glesMultiTexCoord2:pc.SEMANTIC_TEXCOORD2,_glesMultiTexCoord3:pc.SEMANTIC_TEXCOORD3,_glesColor:pc.SEMANTIC_COLOR},vshader:"// This is a VP stub for shader #"+e+" \n attribute vec3 _glesVertex; varying highp vec2 xlv_TEXCOORD0; uniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvoid main() { gl_Position = matrix_viewProjection * matrix_model * vec4(_glesVertex, 1.0); }",fshader:"// This is a FP stub for shader #"+e+" \n uniform sampler2D _MainTex; void main(void) { gl_FragColor = vec4(1, 0, 0.5, 1); }"})}}}()),pc.extend(pc,function(){let t,e;return{SortUtils:{genericSort:function(t,e,i){const s=t._material,n=e._material;if(!s||!n)return 0;if(s.renderQueue!==n.renderQueue)return s.renderQueue-n.renderQueue;if(t.sortingLayerIndex!==e.sortingLayerIndex)return t.sortingLayerIndex-e.sortingLayerIndex;if(t.sortingOrder!==e.sortingOrder)return t.sortingOrder-e.sortingOrder;if(t.drawOrder!==e.drawOrder)return t.drawOrder-e.drawOrder;const r=s.renderQueue>2500?-1:1;return t.zdist&&e.zdist&&t.zdist!==e.zdist?(t.zdist-e.zdist)*r:s.id!==n.id?s.id-n.id:t.mesh.id-e.mesh.id},uiElementsSort:function(t,e,i){return t.drawOrder-e.drawOrder},calculateSortDistances:function(t,e,i){for(let s=0;s<t.length;s++){const n=t[s];if(n.command)continue;const r=n.aabb.center;n.zdist=(r.x-e.x)*i.x+(r.y-e.y)*i.y+(r.z-e.z)*i.z}},autoInstancingSort:function(t,e){const i=t._material,s=e._material;if(!i||!s)return 0;if(i.renderQueue!==s.renderQueue)return i.renderQueue-s.renderQueue;if(t.sortingLayerIndex!==e.sortingLayerIndex)return t.sortingLayerIndex-e.sortingLayerIndex;if(t.sortingOrder!==e.sortingOrder)return t.sortingOrder-e.sortingOrder;if(t.drawOrder!==e.drawOrder)return t.drawOrder-e.drawOrder;let n=i.renderQueue>2500?-1:1;return i.renderQueue<=2500&&i.enableAutoInstancing!==s.enableAutoInstancing?i.enableAutoInstancing?-1:1:(i.renderQueue<=2500&&i.enableAutoInstancing&&s.enableAutoInstancing&&(n=0),0!==n&&t.zdist&&e.zdist&&t.zdist!==e.zdist?(t.zdist-e.zdist)*n:i.id!==s.id?i.id-s.id:t.mesh.id-e.mesh.id)},depthSortCompare:function(i,s){return t=i._key[pc.SORTKEY_DEPTH],e=s._key[pc.SORTKEY_DEPTH],t===e&&i.mesh&&s.mesh?s.mesh.id-i.mesh.id:e-t},lightCompare:function(t,e){return t.key-e.key},cameraCompare:function(t,e){return t.priority-e.priority},sortOverlayCanvases:function(t,e){return t.sortingOrder!==e.sortingOrder?t.sortingOrder-e.sortingOrder:t.$id-e.$id}}}}()),pc.extend(pc,function(){const t={},e=function(t,e){return Math.exp(-t*t/(2*e*e))},i=function(t){t>25&&(t=25);const i=(t-1)/6,s=.5*(t-1),n=new Array(t);let r=0;for(let o=0;o<t;++o)n[o]=e(o-s,i),r+=n[o];for(let e=0;e<t;++e)n[e]/=r;return n};return{Gauss:{gauss:e,gaussWeights:function(e){let s=t[e];return void 0===s?(s=i(e),t[e]=s,s):s},calculateGaussWeights:i}}}()),pc.extend(pc,function(){const t=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];let e=3;const i=[pc.STENCILOP_KEEP,pc.STENCILOP_ZERO,pc.STENCILOP_REPLACE,pc.STENCILOP_INCREMENT,pc.STENCILOP_INCREMENT,pc.STENCILOP_DECREMENT,pc.STENCILOP_INVERT,pc.STENCILOP_INCREMENTWRAP,pc.STENCILOP_DECREMENTWRAP],s=[pc.CULLFACE_NONE,pc.CULLFACE_FRONT,pc.CULLFACE_BACK],n=[pc.BLENDMODE_ZERO,pc.BLENDMODE_ONE,pc.BLENDMODE_DST_COLOR,pc.BLENDMODE_SRC_COLOR,pc.BLENDMODE_ONE_MINUS_DST_COLOR,pc.BLENDMODE_SRC_ALPHA,pc.BLENDMODE_ONE_MINUS_SRC_COLOR,pc.BLENDMODE_DST_ALPHA,pc.BLENDMODE_ONE_MINUS_DST_ALPHA,pc.BLENDMODE_SRC_ALPHA_SATURATE,pc.BLENDMODE_ONE_MINUS_SRC_ALPHA],r=function(t,e){return e._priority-t._priority},o=new pc.Vec3,a=[];return{RenderingUtils:{_getFrustumPoints:function(t,e,i){const s=t._nearClip,n=t._fov*Math.PI/180,r=t._aspect,o=t._projection;let a,c;return c=o===pc.PROJECTION_PERSPECTIVE?Math.tan(n/2)*s:t._orthoHeight,a=c*r,i[0].x=a,i[0].y=-c,i[0].z=-s,i[1].x=a,i[1].y=c,i[1].z=-s,i[2].x=-a,i[2].y=c,i[2].z=-s,i[3].x=-a,i[3].y=-c,i[3].z=-s,o===pc.PROJECTION_PERSPECTIVE&&(c=Math.tan(n/2)*e,a=c*r),i[4].x=a,i[4].y=-c,i[4].z=-e,i[5].x=a,i[5].y=c,i[5].z=-e,i[6].x=-a,i[6].y=c,i[6].z=-e,i[7].x=-a,i[7].y=-c,i[7].z=-e,i},pointLightRotations:[(new pc.Quat).setFromEulerAngles(0,90,180),(new pc.Quat).setFromEulerAngles(0,-90,180),(new pc.Quat).setFromEulerAngles(90,0,0),(new pc.Quat).setFromEulerAngles(-90,0,0),(new pc.Quat).setFromEulerAngles(0,180,180),(new pc.Quat).setFromEulerAngles(0,0,180)],opacityMapChannelIDs:{r:1,g:2,b:3,a:4},_getZFromAABBSimple:function(e,i,s,n,r,o,a){t[0].x=t[1].x=t[2].x=t[3].x=i.x,t[1].y=t[3].y=t[7].y=t[5].y=i.y,t[2].z=t[3].z=t[6].z=t[7].z=i.z,t[4].x=t[5].x=t[6].x=t[7].x=s.x,t[0].y=t[2].y=t[4].y=t[6].y=s.y,t[0].z=t[1].z=t[4].z=t[5].z=s.z;let c,h=Number.MAX_VALUE,l=Number.MIN_VALUE;for(let i=0;i<8;++i)e.transformPoint(t[i],t[i]),c=t[i].z,c<h&&(h=c),c>l&&(l=c);return{min:h,max:l}},getLightsData:function(t,i,s){if(s.reset(),a.length=0,0===i.length)return;let n=-1;const c=t.node,h=1<<c.cullingLayer,l=c.getPosition(),p=t.aabb,u=p.getMax(),d=p.getMin(),_=(u.x-d.x)*(u.y-d.y)*(u.z-d.z);e=UnityEngine.RenderSettings._pixelLightCount;for(let t=0;t<i.length;t++){const e=i[t];if(0==(e._cullingMask&h))continue;if(0==(e._mask&pc.MASK_DYNAMIC))continue;const r=e._aabb.getMax(),c=e._aabb.getMin();let f=Math.max(0,Math.min(u.x,r.x)-Math.max(d.x,c.x))*Math.max(0,Math.min(u.y,r.y)-Math.max(d.y,c.y))*Math.max(0,Math.min(u.z,r.z)-Math.max(d.z,c.z));if(0===_)f=e._aabb.intersects(p)?1:0;else if(f<=0)continue;if(e._type===pc.LIGHTTYPE_DIRECTIONAL&&!e._cookie&&e._renderMode!==UnityEngine.LightRenderMode.ForceVertex){const t=s.mainLight;null===t?s.mainLight=e:t._luminance<e._luminance?s.mainLight=e:t._luminance===e._luminance&&e._renderMode===UnityEngine.LightRenderMode.ForcePixel&&t._renderMode!==UnityEngine.LightRenderMode.ForcePixel&&(s.mainLight=e)}if(e._effectiveLuminance=e._luminance,e._type!==pc.LIGHTTYPE_DIRECTIONAL){o.sub2(e._position,l),e._directionToLight.copy(o);const t=o.length()/e.attenuationEnd;e._effectiveLuminance*=pc.math.clamp(1/(1+25*t*t)*pc.math.clamp(5*(1-t),0,1),0,1),e._range=t}a.push(e),e===s.mainLight&&(n=a.length-1),e._priority=f/(0===_?1:_),e._renderMode===UnityEngine.LightRenderMode.ForcePixel&&(e._priority+=1e4),e._renderMode===UnityEngine.LightRenderMode.Auto&&(e._priority+=100)}n>=0&&(a[n]=a[a.length-1],a.length-=1),a.sort(r);let f=0;for(f=0;f<a.length;f++){const t=a[f];if(s.pixelLights.length>=e)break;if(t._renderMode===UnityEngine.LightRenderMode.ForceVertex)break;s.pixelLights.push(t)}for(;f<a.length;f++){const t=a[f];if(!(t._effectiveLuminance<1e-4)){if(s.vertexLights.length>=4)break;t._type===pc.LIGHTTYPE_DIRECTIONAL?s.otherLights.push(t):s.vertexLights.push(t)}}for(;f<a.length;f++)s.otherLights.push(a[f]);s.combineAllLights()},unityCompareFunctionToPlaycanvas:function(t){return t-1},unityStencilOpToPlaycanvas:function(t){return i[t]},unityBlendModeToPlaycanvas:function(t){return n[t]},unityCullModeToPlaycanvas:function(t){return s[t]},unityBlendOpToPlaycanvas:function(t){return t<=UnityEngine.Rendering.BlendOp.Max?t:null}}}}()),pc.extend(pc,function(){const t=[{},{},{},{},{}],e={},i=function(t,e){return e===pc.SHADOW_VSM32?pc.PIXELFORMAT_RGBA32F:e===pc.SHADOW_VSM16?pc.PIXELFORMAT_RGBA16F:e===pc.SHADOW_PCF5?pc.PIXELFORMAT_DEPTH:e===pc.SHADOW_PCF3&&t.webgl2?pc.PIXELFORMAT_DEPTH:pc.PIXELFORMAT_R8_G8_B8_A8},s=function(t,e){return e!==pc.SHADOW_PCF3||t.webgl2?e===pc.SHADOW_VSM32?t.extTextureFloatLinear?pc.FILTER_LINEAR:pc.FILTER_NEAREST:e===pc.SHADOW_VSM16?t.extTextureHalfFloatLinear?pc.FILTER_LINEAR:pc.FILTER_NEAREST:pc.FILTER_LINEAR:pc.FILTER_NEAREST},n=function(t,e,n,r){const o=i(t,r),a=s(t,r),c=new pc.Texture(t,{profilerHint:pc.TEXHINT_SHADOWMAP,format:o,width:e,height:n,mipmaps:!1,minFilter:a,magFilter:a,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});return r===pc.SHADOW_PCF5||r===pc.SHADOW_PCF3&&t.webgl2?(c.compareOnRead=!0,c.compareFunc=pc.FUNC_LESS,new pc.RenderTarget({depthBuffer:c})):new pc.RenderTarget({colorBuffer:c,depth:!0})},r=function(t,e){const i=new pc.Texture(t,{profilerHint:pc.TEXHINT_SHADOWMAP,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE}),s=[];let n;for(let t=0;t<6;t++)n=new pc.RenderTarget({colorBuffer:i,face:t,depth:!0}),s.push(n);return s},o=function(e,i,s,r){r||(r=0);const o=1e4*r+i;let a=t[s][o];return a||(a=n(e,i,i,s||pc.SHADOW_PCF3),t[s][o]=a),a};return{ShadowMapping:{createShadowCamera:function(t,e,i){let s=pc.CLEARFLAG_DEPTH,n=e===pc.SHADOW_PCF5||e===pc.SHADOW_PCF3&&t.webgl2;i===pc.LIGHTTYPE_POINT&&(n=!1),n||(s|=pc.CLEARFLAG_COLOR);const r=new pc.Camera;return e>=pc.SHADOW_VSM8&&e<=pc.SHADOW_VSM32?(r.clearColor[0]=0,r.clearColor[1]=0,r.clearColor[2]=0,r.clearColor[3]=0):(r.clearColor[0]=1,r.clearColor[1]=1,r.clearColor[2]=1,r.clearColor[3]=1),r.clearDepth=1,r.clearFlags=s,r.clearStencil=null,r._node=new pc.GraphNode,r},createShadowMap:n,createShadowCubeMap:r,createShadowBuffer:function(t,i){let s;i._type===pc.LIGHTTYPE_POINT?(i._shadowType>pc.SHADOW_PCF3&&(i._shadowType=pc.SHADOW_PCF3),i._cacheShadowMap?(s=e[i._shadowResolution],s||(s=r(t,i._shadowResolution),e[i._shadowResolution]=s)):s=r(t,i._shadowResolution),i._shadowCamera.renderTarget=s[0],i._shadowCubeMap=s):(s=i._cacheShadowMap?o(t,i._shadowResolution,i._shadowType):n(t,i._shadowResolution,i._shadowResolution,i._shadowType),i._shadowCamera.renderTarget=s),i._isCachedShadowMap=i._cacheShadowMap},getShadowFormat:i,getShadowFiltering:s,getShadowMapFromCache:o,getDepthKey:function(t){const e=t.material,i=t.skinInstance?10:0;let s=0;if(e.opacityMap){const t=e.opacityMapChannel;t&&(s=pc.RenderingUtils.opacityMapChannelIDs[t])}return i+s}}}}()),pc.extend(pc,function(){const t=new Float32Array(2),e={x:1,y:1,z:0,w:0};return{Vsm:{doVsm:function(i,s,n,r,o){const a=r.renderTarget,c=pc.ShadowMapping.getShadowMapFromCache(i,o._shadowResolution,o._shadowType,1),h=o._shadowType===pc.SHADOW_VSM8,l=o.vsmBlurMode;let p=(h?s.blurPackedVsmShader:s.blurVsmShader)[l][n];if(!p){s.blurVsmWeights[n]=pc.Gauss.gaussWeights(n);const t=pc.shaderChunks.fullscreenQuadVS;let e="#define SAMPLES "+n+"\n";e+=h?s.blurPackedVsmShaderCode[l]:s.blurVsmShaderCode[l];const i="blurVsm"+l+n+h;p=pc.shaderChunks.createShaderFromCode(s.device,t,e,i),h?s.blurPackedVsmShader[l][n]=p:s.blurVsmShader[l][n]=p}e.z=o._shadowResolution-2,e.w=e.z,s.sourceId.setValue(a.colorBuffer),t[0]=1/o._shadowResolution,t[1]=0,s.pixelOffsetId.setValue(t),l===pc.BLUR_GAUSSIAN&&s.weightId.setValue(s.blurVsmWeights[n]),pc.drawQuadWithShader(i,c,p,null,e),s.sourceId.setValue(c.colorBuffer),t[1]=t[0],t[0]=0,s.pixelOffsetId.setValue(t),pc.drawQuadWithShader(i,a,p,null,e)}}}}()),pc.extend(pc,function(){const t={radius:null,center:null},e=function(e,i){return t.center=i.center,t.radius=i.halfExtents.length(),e.containsSphere(t)};return{Culling:{cull:function(t,i,s,n){const r=pc.now();let o=0,a=0,c=0;const h=void 0===t.cullingMask?4294967295:t.cullingMask,l=[],p=t.frustum;for(let t=0;t<s;t++){const e=i[t],s=!0;if(e.material&&(e._mesh._refCount!==-1/0&&e.visible))if(!e.command&&e.cull){if(s){const t=e.node.cullingLayer||0,i=1<<t;if(t<0)continue;if(0==(i&h))continue}l[c++]=e,e.visibleThisFrame=!0}else l[c++]=e,e.visibleThisFrame=!0}if(!t.frustumCulling)return n.length=0,n.concat(l),c;for(let t=0;t<l.length;t++){const i=l[t];let s=!0;i.cull&&(s=e(p,i.aabb),o++),s?(n[a++]=i,i.visibleThisFrame=!0):i.visibleThisFrame=!1}return this._cullTime+=pc.now()-r,this._numDrawCallsCulled+=o,a},cullUi:function(t,i,s){const n=pc.now();let r=0,o=0,a=0;const c=i.length,h=[],l=t.frustum;for(let t=0;t<c;t++){const e=i[t];e&&(e.material&&(e._mesh&&e._mesh._refCount===-1/0||e.visible&&(!e.command&&e.cull,h[a++]=e,e.visibleThisFrame=!0)))}if(!t.frustumCulling)return s.length=0,s.concat(h),a;for(let t=0;t<h.length;t++){const i=h[t];let n=!0;const a=!i._nearestScreen;i.cull&&a&&(n=e(l,i.aabb),r++),n?(s[o++]=i,i.visibleThisFrame=!0):i.visibleThisFrame=!1}return this._cullTime+=pc.now()-n,this._numDrawCallsCulled+=r,o},reset:function(t,e){for(let i=0;i<e;i++)t[i].visibleThisFrame=!1},isAABBVisibleInFrustum:e}}}()),pc.extend(pc,function(){const t=new pc.Vec3,e=function(){this.mainLight=null,this.pixelLights=[],this.vertexLights=[],this.otherLights=[],this.allLights=[]};return Object.assign(e.prototype,{reset:function(){this.mainLight=null,this.pixelLights.length=0,this.vertexLights.length=0,this.otherLights.length=0,this.allLights.length=0},addOtherLights:function(e){for(let i=0;i<this.otherLights.length;i++){const s=this.otherLights[i];t.copy(s._directionToLight),s._type===pc.LIGHTTYPE_DIRECTIONAL?e.addDirectionalLight(t,s._color,s._intensity,1):s._type===pc.LIGHTTYPE_POINT&&e.addPointLight(t,s._color,s._intensity,s.attenuationEnd),s._type===pc.LIGHTTYPE_SPOT&&e.addSpotLight(t,s._color,s._intensity,s.attenuationEnd,s._outerConeAngle)}},combineAllLights:function(){this.allLights.length=0,this.mainLight&&this.allLights.push(this.mainLight);for(let t=0;t<this.pixelLights.length;t++)this.allLights.push(this.pixelLights[t]);for(let t=0;t<this.vertexLights.length;t++)this.allLights.push(this.vertexLights[t]);for(let t=0;t<this.otherLights.length;t++)this.allLights.push(this.otherLights[t])},toString:function(){return"{ "+(this.mainLight?this.mainLight._node.name:"<NONE>")+", Pixel = ["+this.pixelLights.map(t=>t._node.name).join(", ")+"], Vertex = ["+this.vertexLights.map(t=>t._node.name).join(", ")+"], SH = ["+this.otherLights.map(t=>t._node.name).join(", ")+"] }"}}),{LightData:e}}()),pc.extend(pc,function(){const t=new pc.LightData,e=new pc.KeywordSet,i=new pc.SphericalHarmonicsL2,s=new Float32Array([0,0,0,0]),n=new Float32Array(4),r=new Float32Array(4),o=new Float32Array(4),a=new Float32Array(4),c=new Float32Array(4),h=new Float32Array(16),l=new Float32Array(16),p=new Float32Array(4),u=new Float32Array(4),d=new pc.KeywordSet,_=[],f=[],m=[],g=[],y=[],E=[],T={};let A={},b={},S=null,R=!1;return{BuiltInForwardRenderer:{renderMeshInstance:function(t,e,i,s,n){const r=this.device,o=s.material,a=s.mesh,c=(s._shaderDefs&pc.SHADERDEF_LM)>0;if(S=i,!o||0===s.mesh.primitive.count)return;o.getPass(pc.SHADER_PASS_ALWAYS,_),o.getPass(pc.SHADER_PASS_FORWARD_BASE,f),o.getPass(pc.SHADER_PASS_FORWARD_ADD,m),o.getPass(pc.SHADER_PASS_VERTEX,g),o.getPass(pc.SHADER_PASS_VERTEX_LM,y),o.getPass(pc.SHADER_PASS_GRAB_PASS,E);const h=f.length>0||m.length,l=g.length>0;if(0!==_.length||!h||!l){for(let t=0;t<E.length;t++){const e=E[t];b[e.grabPassTextureName]=e,R=!0}c&&s.configureLightmap(),u[0]=this.device.sx,u[1]=this.device.sy,u[2]=this.device.sw,u[3]=this.device.sh,r.setVertexBuffer(s.morphInstance&&s.morphInstance._vertexBuffer?s.morphInstance._vertexBuffer:a.vertexBuffer,0),r.setIndexBuffer(a.indexBuffer[0]),this.setSkinning(r,s,o),this.setMaterial(r,o),this.pushUniforms(r,s.parameters),this.setDrawCall(r,s),r.setDepthRange((s._shaderDefs&pc.SHADERDEF_RENDERTYPE_BACKGROUND)>0?1:0,1),t.merge(o.keywords),c&&t.enableKeywordId(pc.Keywords.LIGHTMAP_ON),(s._shaderDefs&pc.SHADERDEF_DIRLM)>0&&t.enableKeywordId(pc.Keywords.DIRLIGHTMAP_COMBINED);for(let e=0;e<_.length;e++){const i=_[e];this.renderMeshInstancePass(i,t,s)}if(!h&&!l)return this.popUniforms(r,s.parameters),void this.setDrawCall(r,null);h?this.drawForwardPasses(f,m,s,n,t,c,e,i):this.drawVertexPasses(g,y,s,n,t,c,e,i),this.restoreScissorTest(),this.popUniforms(r,s.parameters),this.setDrawCall(r,null)}},drawForwardPasses:function(s,n,r,o,a,c,h,l){pc.RenderingUtils.getLightsData(r,o,t),e.copy(a),!c&&h?i.copy(h):i.clear(),t.addOtherLights(i),this.dispatchLightProbe(i,e,c),this.dispatchVertexLights(t.vertexLights,e),this.dispatchMainLight(l,t.mainLight,e),this.renderMeshInstancePasses(s,e,r);for(let i=0;i<t.pixelLights.length;i++){const s=t.pixelLights[i];e.copy(a),this.dispatchMainLight(l,s,e),this.renderMeshInstancePasses(n,e,r)}},drawVertexPasses:function(i,s,n,r,o,a,c,h){pc.RenderingUtils.getLightsData(n,r,t),e.copy(o),this.dispatchVertexLights(t.allLights,e);const l=a?s:i;this.renderMeshInstancePasses(l,e,n)},renderMeshInstancePasses:function(t,e,i){for(let s=0;s<t.length;s++){const n=t[s];this.renderMeshInstancePass(n,e,i)}},renderGrabPass:function(t,e){const i=this.device,s=e.grabPassTextureName,n=this.initializeGrabPassTexture(t,s);i.setTexture(n,0),i.gl.copyTexSubImage2D(i.gl.TEXTURE_2D,0,0,0,0,0,n._width,n._height),i.scope.resolve(s).setValue(n)},initializeGrabPassTexture:function(t,e){let i=T[e];const s=t?t._screenParams:[this.device.width,this.device.height];return i&&i._width===s[0]&&i._height===s[1]||(i=new pc.Texture(this,{format:pc.PIXELFORMAT_R8_G8_B8,autoMipmap:!0,mipmaps:!1,width:s[0],height:s[1],minFilter:pc.FILTER_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,levels:[null]}),this.device.initializeTexture(i),T[e]=i),i},restoreScissorTest:function(){this.device.setScissor(u[0],u[1],u[2],u[3])},dispatchMainLight:function(t,e,i){e?(s.set(e._finalColor),e._type===pc.LIGHTTYPE_DIRECTIONAL?(n[0]=e._directionToLight.x,n[1]=e._directionToLight.y,n[2]=e._directionToLight.z,n[3]=0):(n[0]=e._position.x,n[1]=e._position.y,n[2]=e._position.z,n[3]=1),this.lightIds.matrix.setValue(e._worldToLightMatrix.data)):(s[0]=0,s[1]=0,s[2]=0,s[3]=0,n[0]=0,n[1]=0,n[2]=0,n[3]=0),this.lightIds.color.setValue(s),this.lightIds.position.setValue(n),e&&e._type===pc.LIGHTTYPE_POINT?e._cookie?(i.enableKeywordId(pc.Keywords.POINT_COOKIE),this.lightIds.attenuationTexture.setValue(e._cookie||UnityEngine.Texture2D.spotTexture.handle),this.lightIds.fallOffTexture.setValue(UnityEngine.Texture2D.attenuationTexture.handle)):(i.enableKeywordId(pc.Keywords.POINT),this.lightIds.attenuationTexture.setValue(UnityEngine.Texture2D.attenuationTexture.handle)):e&&e._type===pc.LIGHTTYPE_SPOT?(i.enableKeywordId(pc.Keywords.SPOT),this.lightIds.attenuationTexture.setValue(e._cookie||UnityEngine.Texture2D.spotTexture.handle),this.lightIds.fallOffTexture.setValue(UnityEngine.Texture2D.attenuationTexture.handle)):e&&e._cookie?(i.enableKeywordId(pc.Keywords.DIRECTIONAL_COOKIE),this.lightIds.attenuationTexture.setValue(e._cookie)):i.enableKeywordId(pc.Keywords.DIRECTIONAL)},dispatchVertexLights:function(t,e){if(0===t.length)e.disableKeywordId(pc.Keywords.VERTEXLIGHT_ON);else{e.enableKeywordId(pc.Keywords.VERTEXLIGHT_ON);for(let e=0;e<4;e++)if(e<t.length){const i=t[e],s=i._type===pc.LIGHTTYPE_DIRECTIONAL?i._directionToLight:i._position,n=i._finalColor,p=i._range;r[e]=s.x,o[e]=s.y,a[e]=s.z,h[4*e+0]=n[0],h[4*e+1]=n[1],h[4*e+2]=n[2],h[4*e+3]=n[3],l[4*e+0]=s.x,l[4*e+1]=s.y,l[4*e+2]=-s.z,l[4*e+3]=i._type===pc.LIGHTTYPE_DIRECTIONAL?0:1,c[e]=25/(p*p)}else r[e]=0,o[e]=0,a[e]=0,h[4*e+0]=0,h[4*e+1]=0,h[4*e+2]=0,h[4*e+3]=0,l[4*e+0]=0,l[4*e+1]=0,l[4*e+2]=0,l[4*e+3]=0,c[e]=0;this.lightIds.vertexX.setValue(r),this.lightIds.vertexY.setValue(o),this.lightIds.vertexZ.setValue(a),this.lightIds.vertexAttenuation.setValue(c),this.lightIds.vertexLightColors.setValue(h),this.lightIds.vertexLightPositions.setValue(l)}},dispatchLightProbe:function(t,e,i){if(i)e.disableKeywordId(pc.Keywords.LIGHTPROBE_SH);else{e.enableKeywordId(pc.Keywords.LIGHTPROBE_SH),t.updateUniforms();for(let e=0;e<this.unityIds.lightProbeIds.length;e++)this.unityIds.lightProbeIds[e].setValue(t.uniforms[e]._data)}},renderMeshInstancePass:function(t,e,i){const s=this.device,n=i.material,r=i.mesh;if(!r||!r.indexBuffer[0])return;if(window.spector&&i.node){const e=i.node._unityComponents,s=e&&e.canvasRenderer&&e.canvasRenderer[0]?e.canvasRenderer[0]._parentCanvas.entity.name:"",n=""===s?i.node.name:s+" - "+i.node.name;window.spector.setMarker(n+": "+pc.LIGHT_MODE_NAMES[t.lightMode])}t.updateRenderState(n),this.updateRenderState(i,t,e);let o=t.getVariant(e);o||(o=t.applyMissingVariant(e));let a=o.getShader(i._shaderDefs);if(!s.setShader(a))return a=o.applyMissingShader(i._shaderDefs),void s.setShader(a);if(R)for(let t=0;t<a.samplers.length;t++){const e=a.samplers[t].scopeId.name,i=b[e];!i||"_GrabTexture"!==e&&A[e]||(this.renderGrabPass(S,i),A[e]=!0)}if(window.spector){const e=o.keywords.getEnabledKeywords().join(" "),s=i.node._unityComponents,n=s&&s.canvasRenderer&&s.canvasRenderer[0]?s.canvasRenderer[0]._parentCanvas.entity.fullname:"";a._glProgram.__SPECTOR_Metadata={Material:"["+i.material.$id+"] "+i.material.name,Shader:"["+t.sourceShader.$id+"] "+t.sourceShader.name,RenderType:pc.RENDER_TYPE_NAMES[t.renderType],LightMode:pc.LIGHT_MODE_NAMES[t.lightMode],Keywords:0===o.keywords.cardinality?"<none>":e,RenderQueue:i.material.renderQueue,SortingLayerIndex:i.sortingLayerIndex,SortingOrder:i.sortingOrder,DrawOrder:i.drawOrder,ZDist:i.zdist,ParentCanvas:n}}this.drawInstance(s,i,r,0,!0)},setMaterial:function(t,e,i){this._material&&(i||this._material!==e)&&this.popUniforms(t,this._material.parameters),(this._material!==e||i)&&this.pushUniforms(t,e.parameters),this._material=e},pushUniforms:function(t,e){for(const i in e)if(e.hasOwnProperty(i)){const s=e[i];s.scopeId||(s.scopeId=t.scope.resolve(i)),s.scopeId.pushValue(s.data)}t.scope.resolve("_ClipRect").setValue([Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY])},popUniforms:function(t,e){for(const t in e)if(e.hasOwnProperty(t)){e[t].scopeId.popValue()}},setDrawCall:function(t,e){null!==e&&(p[3]=e._flipFaces?-1:1,this.unityIds.worldTransformParamsId.setValue(p))},setPass:function(t,e){e.updateRenderState(t);const i=this.device,s=e,n=pc.RenderingUtils.unityCullModeToPlaycanvas(0|s.culling.val);i.setCullMode(n);const r=pc.RenderingUtils.unityCompareFunctionToPlaycanvas(0|s.zTest.val),o=r>=0&&r<=7,a=s.zWrite.val>0;i.setBlending(!0),i.setDepthTest(o),i.setDepthWrite(a);const c=s.offsetUnits.val,h=s.offsetFactor.val;c||h?(i.setDepthBias(!0),i.setDepthBiasValues(c,h)):i.setDepthBias(!1),this.setBlendFunctionAndEquation(s),o&&i.setDepthFunc(r);const l=s.colorWriteMask.val,p=(8&l)>0,u=(4&l)>0,_=(2&l)>0,f=(1&l)>0;i.setColorWrite(p,u,_,f);const m=this.device;d.copy(this.keywords),d.merge(t.keywords);let g=e.getVariant(d);g||(g=e.applyMissingVariant(d));let y=g.getShader(0);if(!m.setShader(y))return y=g.applyMissingShader(0),void m.setShader(y);this.setMaterial(m,t,!0)},renderForward:function(t,e,i,s,n){const r=this.device,o=pc.now();r._enableAutoInstancing&&this.prepareAutoInstancing(e,i),A={},b={},R=!1;for(let n=0;n<i;n++){const i=e[n],r=i._lightProbe||this._ambientProbe;d.copy(this.keywords),i.isCanvas?i.render(d,r,t,i,s):this.renderMeshInstance(d,r,t,i,s)}r.updateEnd(),this._forwardTime+=pc.now()-o}}}}()),Object.assign(pc,function(){const t=[];for(let e=0;e<8;e++)t.push(new pc.Vec3);const e=new pc.Mat4,i=new pc.Mat4,s=new pc.Mat4,n=new pc.Mat4,r=new pc.Mat4,o=new pc.Mat4,a=new pc.Mat4,c=new pc.Mat4,h=new pc.Mat4,l=[0,0,0,0],p=new Float32Array(4),u=new pc.Mat4,d=new pc.Mat4,_=[0,0];let f,m;const g=new Float32Array(24),y=pc.Mat4.IDENTITY.clone(),E=["unity_SHAr","unity_SHAg","unity_SHAb","unity_SHBr","unity_SHBg","unity_SHBb","unity_SHC"],T=["unity_SpecCube0","unity_SpecCube0_BoxMin","unity_SpecCube0_BoxMax","unity_SpecCube0_ProbePosition","unity_SpecCube1","unity_SpecCube1_BoxMin","unity_SpecCube1_BoxMax","unity_SpecCube1_ProbePosition"],A={min0:[-1/0,-1/0,-1/0,0],max0:[1/0,1/0,1/0,1],position0:[0,0,0,0],min1:[-1/0,-1/0,-1/0,1],max1:[1/0,1/0,1/0,1],position1:[0,0,0,0]};let b=null,S=null;const R=new pc.SphericalHarmonicsL2(null),I=new pc.BoundingBox,C=function(t){return!(0===t.comp.val||8===t.comp.val&&0===t.pass.val&&0===t.fail.val&&0===t.zFail.val)},M=pc.RenderingUtils.unityCompareFunctionToPlaycanvas,v=pc.RenderingUtils.unityStencilOpToPlaycanvas,P=pc.RenderingUtils.unityBlendModeToPlaycanvas,O=pc.RenderingUtils.unityCullModeToPlaycanvas,x=pc.RenderingUtils.unityBlendOpToPlaycanvas;function w(t,e){return e?"hlslcc_mtx4x4"+t+"[0]":t}function L(t){this.device=t;const e=this.device;S=new pc.StencilParameters({}),b=new pc.StencilParameters({}),this._shadowDrawCalls=0,this._forwardDrawCalls=0,this._skinDrawCalls=0,this._camerasRendered=0,this._materialSwitches=0,this._shadowMapUpdates=0,this._shadowMapTime=0,this._depthMapTime=0,this._forwardTime=0,this._cullTime=0,this._sortTime=0,this._skinTime=0,this._morphTime=0,this._instancingTime=0,this.clearMaskStencil=new pc.StencilParameters({});const i=e.getProgramLibrary();this.library=i;const s=e.scope;this.viewProjId=s.resolve("matrix_viewProjection"),this.viewInvId=s.resolve("matrix_viewInverse"),this.modelMatrixId=s.resolve("matrix_model"),this.poseMatrixId=s.resolve("matrix_pose[0]"),this.boneTextureId=s.resolve("texture_poseMap"),this.boneTextureSizeId=s.resolve("texture_poseMapSize");const n=UnityEngine.UnityVersion.IsOrNewer("2018.3");this.needsMatrixVectorization=n,this.unityIds={modelViewProjId:s.resolve(w("unity_MatrixMVP",n)),modelViewId:s.resolve(w("unity_MatrixMV",n)),viewProjId:s.resolve(w("unity_MatrixVP",n)),viewId:s.resolve(w("unity_MatrixV",n)),invViewId:s.resolve(w("unity_MatrixInvV",n)),legacyProjId:s.resolve(w("glstate_matrix_projection",n)),transposeModelViewId:s.resolve(w("unity_MatrixTMV",n)),inverseTransposeModelViewId:s.resolve(w("unity_MatrixITMV",n)),modelMatrixId:s.resolve(w("unity_ObjectToWorld",n)),modelMatrixInvId:s.resolve(w("unity_WorldToObject",n)),cameraProjectionId:s.resolve(w("unity_CameraProjection",n)),cameraInvProjectionId:s.resolve(w("unity_CameraInvProjection",n)),worldSpaceCameraPos:s.resolve("_WorldSpaceCameraPos"),projectionParamsId:s.resolve("_ProjectionParams"),screenParamsId:s.resolve("_ScreenParams"),zbufferParams:s.resolve("_ZBufferParams"),cameraOrthoParamsId:s.resolve("unity_OrthoParams"),cameraWorldClipPlanesId:s.resolve("unity_CameraWorldClipPlanes[0]"),time:s.resolve("_Time"),sinTime:s.resolve("_SinTime"),cosTime:s.resolve("_CosTime"),deltaTime:s.resolve("unity_DeltaTime"),timeParameters:s.resolve("_TimeParameters"),ambientSky:s.resolve("unity_AmbientSky"),ambientEquator:s.resolve("unity_AmbientEquator"),ambientGround:s.resolve("unity_AmbientGround"),glstateLightModelAmbient:s.resolve("glstate_lightmodel_ambient"),fogParamsId:s.resolve("unity_FogParams"),fogColorId:s.resolve("unity_FogColor"),indirectSpecularId:s.resolve("unity_IndirectSpecColor"),lightProbeIds:new Array(E.length),reflectionProbeIds:new Array(T.length),worldTransformParamsId:s.resolve("unity_WorldTransformParams"),roughness:s.resolve("unity_NHxRoughness")},this.lightIds={color:s.resolve("_LightColor0"),position:s.resolve("_WorldSpaceLightPos0"),vertexX:s.resolve("unity_4LightPosX0"),vertexY:s.resolve("unity_4LightPosY0"),vertexZ:s.resolve("unity_4LightPosZ0"),vertexAttenuation:s.resolve("unity_4LightAtten0"),vertexLightColors:s.resolve("unity_LightColor[0]"),vertexLightPositions:s.resolve("unity_LightPosition[0]"),attenuationTexture:s.resolve("_LightTexture0"),fallOffTexture:s.resolve("_LightTextureB0"),matrix:s.resolve(w("unity_WorldToLight",n))};for(let t=0;t<E.length;t++)this.unityIds.lightProbeIds[t]=s.resolve(E[t]);for(let t=0;t<T.length;t++)this.unityIds.reflectionProbeIds[t]=s.resolve(T[t]);this.ambientId=s.resolve("light_globalAmbient"),this.exposureId=s.resolve("exposure"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowMatrixVsId=[],this.lightShadowParamsVsId=[],this.lightDirVs=[],this.lightDirVsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightPosVsId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]");const r=pc.shaderChunks;this.blurVsmShaderCode=[r.blurVSMPS,"#define GAUSS\n"+r.blurVSMPS];this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.fogColor=new Float32Array(4),this.fogParams=new Float32Array(4),this.ambientSky=new Float32Array(4),this.lightmodel_ambient=new Float32Array(4),this.removeShadows=!1,this.keywords=new pc.KeywordSet,Object.assign(this,pc.BuiltInForwardRenderer)}return Object.assign(L.prototype,{updateRenderState:function(t,e,i){const s=this.device;let n=O(0|e.culling.val);t._flipFaces&&(n===pc.CULLFACE_BACK?n=pc.CULLFACE_FRONT:n===pc.CULLFACE_FRONT&&(n=pc.CULLFACE_BACK)),s.setCullMode(n);const r=M(0|e.zTest.val),o=r>=0&&r<=7,a=e.zWrite.val>0;s.setBlending(!0),s.setDepthTest(o),o&&s.setDepthFunc(r),s.setDepthWrite(a);const c=e.offsetUnits.val,h=e.offsetFactor.val;if(c||h?(s.setDepthBias(!0),s.setDepthBiasValues(c,h)):s.setDepthBias(!1),this.setBlendFunctionAndEquation(e),(t._shaderDefs&pc.SHADERDEF_REVERT_STENCIL)>0){const e=t.stencilFront.ref,i=1===e;this.clearMaskStencil.func=i?pc.FUNC_ALWAYS:pc.FUNC_EQUAL,this.clearMaskStencil.zpass=i?pc.STENCILOP_ZERO:pc.STENCILOP_REPLACE,this.clearMaskStencil.ref=e>>1,this.clearMaskStencil.readMask=i?255:e>>1,this.clearMaskStencil.writeMask=i?255:e,s.applyStencilState(this.clearMaskStencil,this.clearMaskStencil,!0)}else{const i=this.isUiStencil(t),n=C(e.stencilOp),r=C(e.stencilOpFront)||C(e.stencilOpBack);i&&t.stencilFront&&t.stencilBack?(t.node.element&&(this._materialToStencilState(t.material,t.stencilFront),this._materialToStencilState(t.material,t.stencilBack)),s.applyStencilState(t.stencilFront,t.stencilBack,!0)):n?(this._renderStateToStencilState(e,e.stencilOp,b),t.stencilFront&&(b=t.stencilFront),s.applyStencilState(b,b,!0)):r?(this._renderStateToStencilState(e,e.stencilOpFront,b),this._renderStateToStencilState(e,e.stencilOpBack,S),s.applyStencilState(b,S,!0)):s.applyStencilState(null,null,!0)}let l=t.parameters.hasOwnProperty("_ColorMask")?t.parameters._ColorMask.data:e.colorWriteMask.val;(t._shaderDefs&pc.SHADERDEF_REVERT_STENCIL)>0&&(l=0);const p=(8&l)>0,u=(4&l)>0,d=(2&l)>0,_=(1&l)>0;s.setColorWrite(p,u,d,_),t.parameters.hasOwnProperty("UNITY_UI_ALPHACLIP")&&0!==t.parameters.UNITY_UI_ALPHACLIP.data&&i.enableKeyword("UNITY_UI_ALPHACLIP")},setBlendFunctionAndEquation(t){const e=P(0|t.blending.src.val),i=P(0|t.blending.dst.val),s=x(0|t.blending.op.val),n=P(0|t.alphaBlending.src.val),r=P(0|t.alphaBlending.dst.val),o=x(0|t.alphaBlending.op.val);this.device.setBlendFunctionSeparate(e,i,n,r),this.device.setBlendEquationSeparate(s,o)},isUiStencil:function(t){return!!(t.material.parameters._Stencil&&t.material.parameters._StencilOp&&t.material.parameters._StencilComp&&t.material.parameters._StencilReadMask&&t.material.parameters._StencilWriteMask&&t.material.parameters._ColorMask)},_renderStateToStencilState:function(t,e,i){i.func=M(0|e.comp.val),i.ref=0|t.stencilRef.val,i.readMask=0|t.stencilReadMask.val,i.writeMask=0|t.stencilWriteMask.val,i.fail=v(0|e.fail.val),i.zfail=v(0|e.zFail.val),i.zpass=v(0|e.pass.val)},_materialToStencilState:function(t,e){e.func=M(0|t.parameters._StencilComp.data),e.ref=0|t.parameters._Stencil.data,e.readMask=0|t.parameters._StencilReadMask.data,e.writeMask=0|t.parameters._StencilWriteMask.data,e.fail=v(0|t.parameters._StencilZFail),e.zfail=v(0|t.parameters._StencilZPass),e.zpass=v(0|t.parameters._StencilOp.data)},updateCameraFrustum:function(t){t.updateVP(),t.frustum.update(t._projMat,t._viewMat)},setCamera:function(t,o,a,c){const h=UnityEngine.Object.FromHandle(UnityEngine.Camera,t._component);UnityEngine.Camera.TriggerOnPreRender(h),UnityEngine.Canvas.TriggerWillRenderCanvases(),t.updateVP(),i.copy(t._viewMat),e.copy(t._viewInvMat),n.copy(t._projMat),r.copy(t._projInvMat),s.copy(t._viewProjMat),this.viewInvId.setValue(e.data),this.unityIds.invViewId.setValue(e.data),this.unityIds.viewId.setValue(i.data),this.unityIds.viewProjId.setValue(s.data),this.unityIds.legacyProjId.setValue(n.data),this.unityIds.cameraProjectionId.setValue(n.data),this.unityIds.cameraInvProjectionId.setValue(r.data);const l=t.projection===pc.PROJECTION_ORTHOGRAPHIC?t.frustum.unityPlanesOrthographic:t.frustum.unityPlanesPerspective;for(let t=0,e=0;t<l.length;t++,e+=4)g[e]=l[t][0],g[e+1]=l[t][1],g[e+2]=l[t][2],g[e+3]=l[t][3];this.unityIds.cameraWorldClipPlanesId.setValue(g);const u=t._node.getPosition();p[0]=u.x,p[1]=u.y,p[2]=u.z,p[3]=0,t._screenParams[0]=t.renderTarget?t.renderTarget.width:this.device.width,t._screenParams[1]=t.renderTarget?t.renderTarget.height:this.device.height,t._screenParams[2]=1+1/t._screenParams[0],t._screenParams[3]=1+1/t._screenParams[1],this.unityIds.worldSpaceCameraPos.setValue(p),this.unityIds.projectionParamsId.setValue(t._projectionParams),this.unityIds.cameraOrthoParamsId.setValue(t._orthoParams),this.unityIds.screenParamsId.setValue(t._screenParams),this.unityIds.zbufferParams.setValue(t._zbufferParams),t.frustum.update(n,i);const d=this.device;d.setRenderTarget(o),d.updateBegin();let _=t.getRect();const f=o?o.width:d.width,m=o?o.height:d.height;let y=Math.floor(_.x*f),E=Math.floor(_.y*m),T=Math.floor(_.width*f),A=Math.floor(_.height*m);d.setViewport(y,E,T,A),d.setScissor(y,E,T,A),a&&d.clear(t._clearOptions),_=t._scissorRect,y=Math.floor(_.x*f),E=Math.floor(_.y*m),T=Math.floor(_.width*f),A=Math.floor(_.height*m),d.setScissor(y,E,T,A),c&&d.setScissor(1,1,f-2,m-2),this.viewProjId.setValue(s.data),UnityEngine.Camera.TriggerOnPostRender(h)},dispatchGlobalLights:function(t){if(this.ambientSky=UnityEngine.RenderSettings.ambientSkyColor.data,this.lightmodel_ambient[0]=this.ambientSky[0]/2,this.lightmodel_ambient[1]=this.ambientSky[1]/2,this.lightmodel_ambient[2]=this.ambientSky[2]/2,this.lightmodel_ambient[3]=this.ambientSky[3]/2,this.unityIds.glstateLightModelAmbient.setValue(this.lightmodel_ambient),this.unityIds.ambientSky.setValue(this.ambientSky),this.unityIds.ambientEquator.setValue(UnityEngine.RenderSettings.ambientEquatorColor.data),this.unityIds.ambientGround.setValue(UnityEngine.RenderSettings.ambientGroundColor.data),t.skyboxHelper){const e=t.skyboxHelper.indirectSpecular;this.unityIds.indirectSpecularId.setValue(e.data)}this._ambientProbe=UnityEngine.RenderSettings.ambientProbe||R;const e=UnityEngine.LightmapSettings.reflectionProbes,i=e&&e.environmentProbe?e.environmentProbe:null;null!=i?(this.unityIds.reflectionProbeIds[0].setValue(i.cubemap),this.unityIds.reflectionProbeIds[1].setValue(A.min0),this.unityIds.reflectionProbeIds[2].setValue(A.max0),this.unityIds.reflectionProbeIds[3].setValue(A.position0),this.unityIds.reflectionProbeIds[4].setValue(i.cubemap),this.unityIds.reflectionProbeIds[5].setValue(A.min1),this.unityIds.reflectionProbeIds[6].setValue(A.max1),this.unityIds.reflectionProbeIds[7].setValue(A.position1)):(this.unityIds.reflectionProbeIds[0].setValue(null),this.unityIds.reflectionProbeIds[1].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[2].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[3].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[4].setValue(null),this.unityIds.reflectionProbeIds[5].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[6].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[7].setValue(pc.Vec4.ZERO.data))},updateCpuSkinMatrices:function(t,e){if(0===e)return;const i=pc.now();let s,n,r;for(let i=0;i<e;i++)if(s=t[i],r=s.skinInstance,r){r._dirty=!1;for(let t=0;t<r.bones.length&&(n=r.bones[t],r._dirty=n._aabbVer!==r.bonesAabbVersions[t],!r._dirty);t++);if(r._dirty){for(let t=0;t<r.bones.length;t++)r.bonesAabbVersions[t]=r.bones[t];r.updateMatrices(t[i].node)}}this._skinTime+=pc.now()-i},updateGpuSkinMatrices:function(t,e,i){const s=pc.now();let n,r,o,a,c,h=!1;for(n=0;n<e;n++)if(o=t[n],h=!1,a=o.skinInstance,a&&a._dirty){if(c=a.skin,c.updateWhenOffscreen)h=!0;else{const t=a.skin.rootBone?a.skin.rootBone:o.node;for(r=0;r<i.length;r++)I.center=t.transformPoint(c.localBounds.center,I.center),I.halfExtents.copy(t.getLossyScale()),I.halfExtents.mul(c.localBounds.halfExtents),h=h||!!pc.Culling.isAABBVisibleInFrustum(i[r].frustum,I)}h&&(a.updateMatrixPalette(),a._dirty=!1)}this._skinTime+=pc.now()-s},updateMorphedBounds:function(t,e){const i=pc.now();let s,n;for(s=0;s<e;s++)n=t[s].morphInstance,n&&n._dirty&&n.updateBounds(t[s].mesh);this._morphTime+=pc.now()-i},updateMorphing:function(t,e){const i=pc.now();let s,n;for(s=0;s<e;s++)t[s].visibleThisFrame&&(n=t[s].morphInstance,n&&n._dirty&&(n.update(t[s].mesh),n._dirty=!1));this._morphTime+=pc.now()-i},setSkinning:function(t,e){e.skinInstance&&(this._skinDrawCalls++,t.supportsBoneTextures?(f=e.skinInstance.boneTexture,this.boneTextureId.setValue(f),_[0]=f.width,_[1]=f.height,this.boneTextureSizeId.setValue(_)):this.poseMatrixId.setValue(e.skinInstance.matrixPalette))},setMatrix:function(t,e){this.device.scope.resolve(w(t,this.needsMatrixVectorization)).setValue(e)},drawInstance:function(t,e,s,r,l){const p=t.shader.uniformsUsage;let _=e.node.worldTransform,f=e.node.worldTransformInverse;return e.parameters.localToWorldMatrix&&(_=u.set(e.parameters.localToWorldMatrix.data),0!=(p&pc.UNIFORMS_USAGE_MAP.unity_WorldToObject)&&(f=e.parameters.worldToLocalMatrix?d.set(e.parameters.worldToLocalMatrix.data):d.copy(_).invert())),this.modelMatrixId.setValue(_.data),this.unityIds.modelMatrixId.setValue(_.data),this.unityIds.modelMatrixInvId.setValue(f.data),0!=(p&pc.UNIFORMS_USAGE_MAP.unity_MatrixMVP)&&(o.copy(n),o.mul2(o,i),o.mul2(o,_),this.unityIds.modelViewProjId.setValue(o.data)),0!=(p&pc.UNIFORMS_USAGE_MAP.unity_MatrixMV)&&(a.copy(i),a.mul2(a,_),this.unityIds.modelViewId.setValue(a.data)),0!=(p&pc.UNIFORMS_USAGE_MAP.unity_MatrixTMV)&&(c.copy(a),c.transpose(),this.unityIds.transposeModelViewId.setValue(c.data)),0!=(p&pc.UNIFORMS_USAGE_MAP.unity_MatrixITMV)&&(0==(p&pc.UNIFORMS_USAGE_MAP.unity_MatrixTMV)&&(c.copy(a),c.transpose()),h.copy(c),h.invert(),this.unityIds.inverseTransposeModelViewId.setValue(h.data)),m=e.instancingData,m?(this._instancedDrawCalls++,this._removedByInstancing+=m.count,t.setVertexBuffer(m._buffer,1,m.offset),t.draw(s.primitive[r],m.count,e.material._shader.defaultParameters,e.constAttributes),m._buffer===pc._autoInstanceBuffer?(e.instancingData=null,m.count-1):0):(t.draw(s.primitive[r],null,e.material._shader.defaultParameters,e.constAttributes,e),0)},prepareAutoInstancing:function(t,e){const i=pc.time.now();pc._autoInstanceBuffer||this.setupInstancing(this.device);let s=0,n=0;const r=pc._autoInstanceBufferData;for(let i=0;i<e;i++){const o=i,a=t[i],c=a.material,h=a.mesh;if(!c||!h||!c.enableAutoInstancing)continue;if(null!==a.instancingData)continue;let l=0;for(l=i+1;l<e;l++){const e=t[l],i=e.material,s=e.mesh;if(i!==c||s!==h)break}if(l-o>1){for(a.instancingData={count:l-o,offset:4*s,_buffer:pc._autoInstanceBuffer},a._shaderDefs|=pc.SHADERDEF_INSTANCING,n=o;n<l;n++){const e=t[n].node.getWorldTransform().data;r.set(e,s),s+=16}i=l-1}else i=o,a._shaderDefs&=~pc.SHADERDEF_INSTANCING,a.instancingData=null}this._instancingTime+=(pc.time.now()-i)/1e3,pc._autoInstanceBuffer.unlock()},switchRenderingToScreenSpace:function(t){if(t!==this.renderingAsScreenSpace)if(this.renderingAsScreenSpace=t,t){const t=pc.Mat4.IDENTITY.data,e=this.device;y.setOrtho(0,e._width,0,e._height,-1e3,1e3),this.unityIds.viewId.pushValue(t),this.unityIds.legacyProjId.pushValue(y.data),this.viewProjId.pushValue(y.data),this.unityIds.viewProjId.pushValue(y.data)}else this.unityIds.viewId.popValue(),this.unityIds.legacyProjId.popValue(),this.viewProjId.popValue(),this.unityIds.viewProjId.popValue()},setupInstancing:function(t){if(!pc._instanceVertexFormat){const e=[{semantic:pc.SEMANTIC_TEXCOORD2,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD3,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD4,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD5,components:4,type:pc.TYPE_FLOAT32}];pc._instanceVertexFormat=new pc.VertexFormat(t,e)}pc._autoInstanceBuffer||(pc._autoInstanceBuffer=new pc.VertexBuffer(t,pc._instanceVertexFormat,t.autoInstancingMaxObjects,pc.BUFFER_DYNAMIC),pc._autoInstanceBufferData=new Float32Array(pc._autoInstanceBuffer.lock()))},clearTarget:function(t,e){window.spector&&window.spector.setMarker("Clear RT");const i=this.device,s=i.renderTarget;i.setRenderTarget(t),i.updateBegin(),i.setColorWrite(!0,!0,!0,!0),i.setDepthWrite(!0),this.setupViewport({x:0,y:0,width:1,height:1},t.width,t.height),this.device.clear(e),i.setRenderTarget(s)},clearView:function(t,e){window.spector&&window.spector.setMarker("Clear");const i=t.camera,s=i.renderTarget,n=this.device;n.setRenderTarget(s),n.updateBegin(),n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0);const r=i.getRect(),o=s?s.width:n.width,a=s?s.height:n.height;this.setupViewport(r,o,a),n.clear(e||i._clearOptions)},setupViewport:function(t,e,i){const s=this.device,n=Math.floor(t.x*e),r=Math.floor(t.y*i),o=Math.floor(t.width*e),a=Math.floor(t.height*i);s.setViewport(n,r,o,a),s.setScissor(n,r,o,a)},setSceneConstants:function(){const t=this.device,e=this.scene;this.keywords.copy(pc.UnityShader.globalKeywords),this.dispatchGlobalLights(e);const i=UnityEngine.RenderSettings;i.fog&&(l[2]=0,l[3]=0,i.fogMode===UnityEngine.FogMode.Exponential?this.keywords.enableKeywordId(pc.Keywords.FOG_EXP):i.fogMode===UnityEngine.FogMode.ExponentialSquared?this.keywords.enableKeywordId(pc.Keywords.FOG_EXP2):(this.keywords.enableKeywordId(pc.Keywords.FOG_LINEAR),l[2]=-1/(i.fogEnd-i.fogStart),l[3]=i.fogEnd/(i.fogEnd-i.fogStart)),l[0]=i.fogDensity/Math.sqrt(Math.log(2)),l[1]=i.fogDensity/Math.log(2),this.unityIds.fogColorId.setValue(i.fogColor.data),this.unityIds.fogParamsId.setValue(l));const s=UnityEngine.Time.time,n=UnityEngine.Time.deltaTime,r=UnityEngine.Time.smoothDeltaTime;this.unityIds.time.setValue([s/20,s,2*s,3*s]),this.unityIds.sinTime.setValue([Math.sin(s/8),Math.sin(s/4),Math.sin(s/2),Math.sin(s)]),this.unityIds.cosTime.setValue([Math.cos(s/8),Math.cos(s/4),Math.cos(s/2),Math.cos(s)]),this.unityIds.deltaTime.setValue([n,1/n,r,1/r]),this.unityIds.timeParameters.setValue([s,Math.sin(s),Math.cos(s),0]),UnityEngine.Texture2D.nhxRoughnessTexture&&this.unityIds.roughness.setValue(UnityEngine.Texture2D.nhxRoughnessTexture.handle);for(const e in pc.UnityShader.globalUniforms){if(!pc.UnityShader.globalUniforms.hasOwnProperty(e))continue;const i=pc.UnityShader.globalUniforms[e];i.scopeId=i.scopeId||t.scope.resolve(e),i.scopeId.setValue(i.value)}},renderComposition:function(){window.spector&&window.spector.clearMarker();const t=this.device,e=this.scene.getMeshInstances(),i=this.scene.meshInstancesCount;this.updateCpuSkinMatrices(e,i),this.updateMorphedBounds(e,i),this.setSceneConstants(),pc.Culling.reset(this.scene._meshInstances._list);const s=this.scene._cameras;s.sort(pc.SortUtils.cameraCompare),this.updateGpuSkinMatrices(e,i,s._list),this.updateMorphing(e,i);for(let t=0;t<s._list.length;t++)this.renderCamera(s._list[t]);const n=this.scene.overlayScreens;if(n.length>0){t.setRenderTarget(null),t.updateBegin();const e=[this.device.width,this.device.height,1+1/this.device.width,1+1/this.device.height];this.unityIds.screenParamsId.setValue(e),this.setupViewport({x:0,y:0,width:1,height:1},t.width,t.height),t.clear({flags:pc.CLEARFLAG_STENCIL}),this.switchRenderingToScreenSpace(!0);for(let t=0;t<n.length;t++){n[t].canvasMeshInstance.render(this.keywords,null,null,null,this.scene._lights._list)}this.switchRenderingToScreenSpace(!1)}},updateLights:function(t,e){const i=[];for(let s=0;s<e.length;s++){const n=e[s];n.update(t)&&i.push(n)}return i},setupWorldScreensVisibility:function(t,e){const i=t._worldScreens.list();for(let t=0;t<i.length;t++){const s=i[t];s.screenType===pc.SCREEN_TYPE_CAMERA?s.canvasMeshInstance.visible=s.camera===e:s.canvasMeshInstance.visible=!0}},renderCamera:function(t){const e=t.camera,i=t.camera.renderTarget,s=pc.Application.getApplication();t.frameBegin(i),this.updateCameraFrustum(t.camera);const n=[];this.scene.skyboxHelper.updateSkyDrawCall(e),this.scene.skyboxHelper.setSkyboxEnabled((e._clearOptions.flags&pc.CLEARFLAG_USE_SKYBOX)>0),UnityEngine.Camera.TriggerOnPreCull(UnityEngine.Object.FromHandle(UnityEngine.Camera,e._component)),this.setupWorldScreensVisibility(this.scene,e);const r=this.scene.getMeshInstancesCached(),o=this.scene.meshInstancesCount;pc.Culling.cull(e,r,o,n),pc.SortUtils.calculateSortDistances(n,e._node.getPosition(),e._node.forward),n.sort(pc.SortUtils.genericSort);let a=this.scene._lights._list;a=this.updateLights(e,a),this.clearView(t),this.setCamera(e,e.renderTarget),s.counters.recordDrawCalls(n.length),this.renderForward(e,n,n.length,a),t.frameEnd()}}),{ForwardRenderer:L,lightProbeUniforms:E,reflectionProbeUniforms:T}}()),Object.assign(pc,function(){const t=new pc.Quat,e=new pc.Quat,i=new pc.Mat4,s=new pc.Mat4,n=new pc.Vec3,r=new pc.Vec3,o=new pc.Vec3,a=new pc.Vec3,c={invRotation:new pc.Quat,invScale:new pc.Vec3,invRotationMatrix:new pc.Mat4,invScaleMatrix:new pc.Mat4},h={parentLocalRotation:new pc.Quat,rotationMultiplier:new pc.Vec3},l={newLocalRotation:new pc.Quat},p={invLocalRotation:new pc.Quat,rotationMultiplier:new pc.Vec3},u={currentRSInverse:new pc.Mat4},d={newLocalRotation:new pc.Quat},_={tempVector:new pc.Vec3},f={tmpVector:new pc.Vec3},m={tmpVector:new pc.Vec3,tmpMatrix:new pc.Mat4,desiredLocalScale:new pc.Vec3,desiredWorldPosition:new pc.Vec3},g=function(t="Untitled"){this.name=t,this.tag=null,this._localPosition=new pc.Vec3(0,0,0),this._localRotation=new pc.Quat(0,0,0,1),this._localScale=new pc.Vec3(1,1,1),this._localEulerAngles=new pc.Vec3(0,0,0),this._localTransform=new pc.Mat4,this._position=new pc.Vec3(0,0,0),this._rotation=new pc.Quat(0,0,0,1),this._eulerAngles=new pc.Vec3(0,0,0),this._lossyScale=new pc.Vec3(1,1,1),this._worldTransform=new pc.Mat4,this._worldTransformInverse=new pc.Mat4,this._hijackedLocalPosition=new pc.Vec3,this._hijackedLocalScale=new pc.Vec3,this._hijackedLocalEulerAngles=new pc.Vec3,this._hijackedLocalRotation=new pc.Quat,this._aabbVer=0,this._right=null,this._up=null,this._forward=null,this._static=!1,this._parent=null,this._children=[],this._graphDepth=0,this._cullingLayer=0,this.layerMask=0,this._activeSelf=!0,this._enabledInHierarchy=!1,this._beingEnabled=!1,this.hasChanged=!0,this._layoutElements=[],this._layoutControllers=[],this._layoutSelfControllers=[],this._dimensionListeners=[],this._aspectRatioFitters=[],this._canvasElements=[],this._canvasGroups=[],this._meshModifiers=[],this.element=null,this.isPrefab=!1,this._app=null,pc.events.attach(this),this._unityComponents=null,this.flags=0};return g.Flags={LocalEulersAnglesDirty:1,RotationDirty:2,EulerAnglesDirty:4,LossyScaleDirty:8,PositionDirty:16,LocalTransformDirty:32,WorldTransformDirty:64,WorldTransformInverseDirty:128,TransformModificationCallbackMuted:256,TransformModificationCallbackRequested:512,LocalPositionHijacked:1024,LocalScaleHijacked:2048,LocalEulerAnglesHijacked:4096,LocalRotationHijacked:8192,HijackedByElementComponent:16384},g.prototype={get static(){return this._static},set static(t){this._static=t},get right(){return this._right||(this._right=new pc.Vec3),this.getWorldTransform().getX(this._right).normalize()},get up(){return this._up||(this._up=new pc.Vec3),this.getWorldTransform().getY(this._up).normalize()},get forward(){return this._forward||(this._forward=new pc.Vec3),this.getWorldTransform().getZ(this._forward).normalize()},get aabbVersion(){return this._aabbVer},get enabled(){return this._activeSelf&&this._enabledInHierarchy},set enabled(t){this._activeSelf!==t&&(this._activeSelf=t,t&&this._app.scene.addDirty(this),this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,t))},get activeSelf(){return this._activeSelf},get parent(){return this._parent},get root(){let t=this._parent;if(!t)return this;for(;t._parent;)t=t._parent;return t},get children(){return this._children},get graphDepth(){return this._graphDepth},get cullingLayer(){return this._cullingLayer},set cullingLayer(t){this._cullingLayer=t,this.layerMask=1<<t},removeOrReparent(t,e=!1){t?this.parent.removeChild(this):this.reparent(t)},destroy(){this.removeOrReparent(null)},getLossyScale(){return this.flags&g.Flags.LossyScaleDirty?(this.flags&=~g.Flags.LossyScaleDirty,t.copy(this.getRotation()),s.setTRS(pc.Vec3.ZERO,t.invert(),pc.Vec3.ONE),this.getWorldRotationAndScale(i),s.mul2(s,i),this._lossyScale.set(s.data[0],s.data[5],s.data[10]),this._lossyScale):this._lossyScale},get lossyScale(){return this.getLossyScale()},_onInsertChild(t){t._parent=this,t.element&&(this.setupCanvasGroups(t),t.notifyCanvasGroupChanged(t)),t.notifyScreenHierarchyChanged();const e=t._activeSelf&&this.enabled;if(t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t.onParentChanged(),t.fire&&t.fire("insert",this),this.fire("childinsert",t),!t.element)for(let e=0;e<t._children.length;e++){const i=t._children[e].element;i&&i._onInsert(t)}this.notifyTransformChildrenChanged(),t.notifyTransformParentChanged();const i=this._app.systems;i.physics.syncHierarchy(t),i.physics2D.syncHierarchy(t)},muteTransformModificationCallback(){this.flags|=g.Flags.TransformModificationCallbackMuted},unmuteTransformModificationCallback(){this.flags&=~g.Flags.TransformModificationCallbackMuted,this.flags&g.Flags.TransformModificationCallbackRequested&&(this._onModifyTransform(),this.flags&=~g.Flags.TransformModificationCallbackRequested)},_onModifyTransform(){if(this.flags&g.Flags.TransformModificationCallbackMuted)return void(this.flags|=g.Flags.TransformModificationCallbackRequested);if(!this._app)return;const t=this._app.systems;t.physics.syncTransforms(this),t.physics2D.syncTransforms(this)},lookAt(e,s,o,a,c,h){if(e instanceof pc.Vec3)n.copy(e),s instanceof pc.Vec3?r.copy(s):r.copy(pc.Vec3.UP);else{if(void 0===o)return;n.set(e,s,o),void 0!==a?r.set(a,c,h):r.copy(pc.Vec3.UP)}i.setLookAt(this.getPosition(),n,r),t.setFromMat4(i),this.setRotation(t)},translate(t,e,i){t instanceof pc.Vec3?n.copy(t):n.set(t,e,i),n.add(this.getPosition()),this.setPosition(n)},translateLocal(t,e,i){t instanceof pc.Vec3?n.copy(t):n.set(t,e,i),this.getLocalRotation().transformVector(n,n),n.add(this.getLocalPosition()),this.setLocalPosition(n)},rotate(i,s,n){if(i instanceof pc.Vec3?t.setFromEulerAngles(i.x,i.y,i.z):t.setFromEulerAngles(i,s,n),null===this._parent)e.mul2(t,this.getLocalRotation()),this.setLocalRotation(e);else{const i=this.getRotation(),s=this._parent.getRotation();e.copy(s).invert().mul2(e,t).mul2(t,i),this.setLocalRotation(e)}},rotateLocal(e,i,s){e instanceof pc.Vec3?t.setFromEulerAngles(e.x,e.y,e.z):t.setFromEulerAngles(e,i,s),t.mul2(this.getLocalRotation(),t),this.setLocalRotation(t)},_isOddlyScaled(){const t=this.getWorldTransform().data,e=t[0],i=t[1],s=t[2],n=t[4],r=t[5],o=t[6],a=t[8],c=t[9],h=t[10];return e*(r*h-o*c)-n*(i*h-s*c)+a*(i*o-s*r)<0},_sync(){this.flags&g.Flags.HijackedByElementComponent?this._syncElementComponent():this._syncGraphNode()},_syncElementComponent:function(){const{tmpVector:t}=f;this.parent&&this.parent._sync();const e=this.element,i=e._dirtyRect,s=e._dirtyScreen;let n=this.element._lastSyncAABBVersion!==this.aabbVersion;if(!i&&!s&&!n)return;this.hasChanged=!0,this.flags&=~pc.GraphNode.Flags.HijackedByElementComponent;const r=e._width,o=e._height;if(i||n){const i=e._findParentElement();if(i){const s=i.element;if(e._width=(e._anchors.z-e._anchors.x)*s._width+e._sizeDelta.x,e._height=(e._anchors.w-e._anchors.y)*s._height+e._sizeDelta.y,this._parent===i){const i=s._width*e._anchors.x,n=s._width*e._anchors.z,r=s._height*e._anchors.y,o=s._height*e._anchors.w;t.set(pc.math.lerp(i,n,e._pivot.x)+e._anchoredPosition.x,pc.math.lerp(r,o,e._pivot.y)+e._anchoredPosition.y,0),this.setLocalPosition(t.x-s._pivotPoint.x,t.y-s._pivotPoint.y,this.getLocalPosition().z)}else this.setLocalPosition(e._anchoredPosition.x,e._anchoredPosition.y,this.getLocalPosition().z)}else e._width=e._sizeDelta.x,e._height=e._sizeDelta.y,this.setLocalPosition(e._anchoredPosition.x,e._anchoredPosition.y,this.getLocalPosition().z)}if(n=this.element._lastSyncAABBVersion!==this.aabbVersion,n||s||i){e._pivotPoint.set(e._width*e._pivot.x,e._height*e._pivot.y,0),this._tryResizeScreen(e);const t=e.cachedRect;t.m_XMin=-e._pivotPoint.x,t.m_YMin=-e._pivotPoint.y,t.m_Width=e._width,t.m_Height=e._height,t.m_XMax=t.m_XMin+t.m_Width,t.m_YMax=t.m_YMin+t.m_Height,e.fire("resize",e._width,e._height)}e._lastSyncAABBVersion=this.aabbVersion,e._dirtyRect=!1,e._dirtyScreen=!1,this.flags|=pc.GraphNode.Flags.HijackedByElementComponent;const a=e._width!==r,c=e._height!==o;i||!a&&!c||e.triggerOnElementDimesionsChange(a,c)},_tryResizeScreen(){const t=this.element,{tmpMatrix:e,tmpVector:i,desiredLocalScale:s,desiredWorldPosition:n}=m,r=this.screen;if(!(r&&!r._findParentScreen()))return;const o=r.resolution;switch(r.screenType){case pc.SCREEN_TYPE_SCREEN:{t._width=o.x/r.scale,t._height=o.y/r.scale,n.set(.5*o.x,.5*o.y,0),this.setPosition(n),i.set(r.scale,r.scale,r.scale),e.setTRS(pc.Vec3.ZERO,this.getRotation(),i),this.setWorldRotationAndScale(e);const s=this.getLocalPosition();t._anchoredPosition.set(s.x,s.y),t._pivotPoint.set(.5*t._width,.5*t._height,0);break}case pc.SCREEN_TYPE_CAMERA:{const e=r.camera._component.entity;t._width=o.x/r.scale,t._height=o.y/r.scale,t._sizeDelta.copy(o),s.set(1,1,1),s.scale(r._planeHeight/t._height),i.set(0,0,r._screenDistance),e.transformPoint(i,i,!0),this.setPosition(i),this.setRotation(e.getRotation()),this.setLocalScale(s);const n=this.getLocalPosition();t._anchoredPosition.set(n.x,n.y),t._pivotPoint.set(.5*t._width,.5*t._height,0);break}case pc.SCREEN_TYPE_WORLD:t._width=t._sizeDelta.x,t._height=t._sizeDelta.y,this.setLocalPosition(t._anchoredPosition.x,t._anchoredPosition.y,this.getLocalPosition().z)}t._sizeDelta.set(t._width,t._height)},_syncGraphNode(){this.parent&&this.parent._sync()},findByNameImmediate(t){for(let e=0;e<this._children.length;e++){const i=this._children[e];if(i.name===t)return i}return null},findByNameEnabled(t){return t?this.findByNamesEnabledInternal(t.split("/"),0):null},findByNamesEnabledInternal(t,e){if(!this.enabled)return null;if(this.scene||this.name!==t[e])e=0;else{if(e===t.length-1)return this;e++}for(let i=0;i<this._children.length;i++){const s=this._children[i].findByNamesEnabledInternal(t,e);if(null!==s)return s}return null},getWorldRotationAndScale(t=new pc.Mat4){if(t.setTRS(pc.Vec3.ZERO,this.getLocalRotation(),this.getLocalScale()),this.parent){const e=this.parent.getWorldRotationAndScale();t.mul2(e,t)}return t},getWorldRotationAndScaleInverse(t=new pc.Mat4,e=null){const{invRotation:i,invRotationMatrix:s,invScale:n,invScaleMatrix:r}=c;if(i.copy(this.getLocalRotation()).invert(),s.setRotation(i),n.copy(e||this.getLocalScale()).invertSafe(),r.setScale(n.x,n.y,n.z),t.mul2(r,s),this.parent){const e=this.parent.getWorldRotationAndScaleInverse();t.mul2(t,e)}return t},setWorldRotationAndScale(t){const{currentRSInverse:e}=u;this.getWorldRotationAndScaleInverse(e,pc.Vec3.ONE),e.mul2(e,t),this.setLocalScale(e.data[0],e.data[5],e.data[10])},getLocalRotationAndScale(t=new pc.Mat4){return t.setTRS(pc.Vec3.ZERO,this.getLocalRotation(),this.getLocalScale()),t},setParent(t,e){if(e){const e=this.getPosition().clone(),i=this.getRotation().clone(),s=this.getWorldRotationAndScale();this.removeOrReparent(t,!0),this.muteTransformModificationCallback(),this.setPosition(e),this.setRotation(i),this.setWorldRotationAndScale(s),this.unmuteTransformModificationCallback()}else{const e=this.getLocalScale().clone(),i=this.getLocalPosition(),s=this.getLocalRotation().clone();this.removeOrReparent(t,!0),this.muteTransformModificationCallback(),this.setLocalScale(e),this.setLocalPosition(i),this.setLocalRotation(s),this.unmuteTransformModificationCallback()}if(this.element){const t=pc.UIUtils.findParentScreen(this);this.reparentElementRecursive(t)}},reparentElementRecursive(t){if(this.element){const e=this._unityComponents?this._unityComponents.canvasRenderer[0]:null;e&&e.reparentCanvas(t)}const e=this.children;for(let i=0;i<e.length;i++){e[i].reparentElementRecursive(t)}},isParentOf(t){const e=t._graphDepth-this._graphDepth;if(e<=0||e>=t._graphDepth||null===t.parent)return!1;let i=t;for(let t=0;t<e;t++)i=i.parent;return i===this},isChildOf(t){return t.isParentOf(this)},_notifyHierarchyStateChanged(t,e){t._onHierarchyStateChanged(e);const i=t._children;for(let t=0,s=i.length;t<s;t++)i[t]._activeSelf&&this._notifyHierarchyStateChanged(i[t],e)},_elementDimesionsChange(){},_onHierarchyStateChanged(t){this._enabledInHierarchy=t},findByTag(t){return this._findByTag(t)},_findByTag(t){const e=[];for(let i=0;i<this._children.length;i++){const s=this._children[i];if(!s._enabledInHierarchy)continue;s.tag===t&&e.push(s);const n=s._findByTag(t);n.length&&e.push(...n)}return e},findByName(t){if(this.name===t)return this;for(let e=0;e<this._children.length;e++){const i=this._children[e].findByName(t);if(null!==i)return i}return null},getRoot(){return this.root},getParent(){return this._parent},isDescendantOf(t){let e=this._parent;for(;e;){if(e===t)return!0;e=e._parent}return!1},isAncestorOf(t){return t.isDescendantOf(this)},getChildren(){return this._children},getEulerAngles(){return this.flags&g.Flags.EulerAnglesDirty&&(this.getRotation().getEulerAngles_Unity(this._eulerAngles),this.flags&=~g.Flags.EulerAnglesDirty),this._eulerAngles},setEulerAngles(e,i,s){e instanceof pc.Vec3?t.setFromEulerAngles_Unity(e.x,e.y,e.z):t.setFromEulerAngles_Unity(e,i,s),this.setRotation(t)},get eulerAngles(){return this.getEulerAngles()},set eulerAngles(t){this.setEulerAngles(t)},getLocalEulerAngles(){return this.flags&g.Flags.LocalEulersAnglesDirty&&(this.getLocalRotation().getEulerAngles_Unity(this._localEulerAngles),this.flags&=~g.Flags.LocalEulersAnglesDirty),this._localEulerAngles},setLocalEulerAngles(t,e,i){const{newLocalRotation:s}=d;t instanceof pc.Vec3?s.setFromEulerAngles_Unity(t.x,t.y,t.z):s.setFromEulerAngles_Unity(t,e,i),this.setLocalRotation(s)},get localEulerAngles(){return this.getLocalEulerAngles()},set localEulerAngles(t){this.setLocalEulerAngles(t)},getLocalPosition(){return this.flags&g.Flags.HijackedByElementComponent?this.getLocalPositionElementComponent():this.getLocalPositionGraphNode()},getLocalPositionGraphNode(){return this._localPosition},getLocalPositionElementComponent(){return this.element.getRect(),this.getLocalPositionGraphNode()},setLocalPosition(t,e,i){this.flags&g.Flags.HijackedByElementComponent?this.setLocalPositionElementComponent(t,e,i):this.setLocalPositionGraphNode(t,e,i)},setLocalPositionGraphNode(t,e,i){t instanceof pc.Vec3?r.copy(t):r.set(t,e,i),this._localPosition.approximatelyEquals(r,Number.EPSILON)||(this._localPosition.copy(r),this.onLocalPositionChanged(),this._onModifyTransform())},setLocalPositionElementComponent:function(t,e,i){const{tempVector:s}=_;s.copy(this.getLocalPositionElementComponent()),t instanceof pc.Vec3?(this.setLocalPositionGraphNode(s.x,s.y,t.z),s.sub2(t,s)):(this.setLocalPositionGraphNode(s.x,s.y,i),s.x=t-s.x,s.y=e-s.y),this.element._anchoredPosition.add(s),this.element.dirtifyRect()},get localPosition(){return this.getLocalPosition()},set localPosition(t){this.setLocalPosition(t)},getLocalRotation(){return this._localRotation},setLocalRotation(e,i,s,n){e instanceof pc.Quat?t.copy(e):t.set(e,i,s,n),t.normalize(),this._localRotation.approximatelyEquals(t,Number.EPSILON)||(this._localRotation.copy(t),this.onLocalRotationChanged(),this._onModifyTransform())},get localRotation(){return this.getLocalRotation()},set localRotation(t){this.setLocalRotation(t)},getLocalScale(){return this._localScale},setLocalScale(t,e,i){t instanceof pc.Vec3?n.copy(t):n.set(t,e,i),this._localScale.approximatelyEquals(n,Number.EPSILON)||(this._localScale.copy(n),this.onLocalScaleChanged(),this._onModifyTransform())},get localScale(){return this.getLocalScale()},set localScale(t){this.setLocalScale(t)},getLocalScaleSign(t){const e=this.getLocalScale();t.set(Math.sign(e.x)||1,Math.sign(e.y)||1,Math.sign(e.z)||1)},getLocalScaleRotationMultipliers(t){this.getLocalScaleSign(t);const e=t.x,i=t.y,s=t.z,n=i*s,r=e*s,o=e*i;t.set(n,r,o)},getLocalTransform(){return this.flags&g.Flags.LocalTransformDirty?(this.flags&=~g.Flags.LocalTransformDirty,this._localTransform.setTRS(this.getLocalPosition(),this.getLocalRotation(),this.getLocalScale()),this._localTransform):this._localTransform},setLocalTransform(t){this.muteTransformModificationCallback(),this.setLocalPosition(t.getTranslation()),this.setLocalRotation(t.getRotation()),this.setLocalScale(t.getScale()),this.unmuteTransformModificationCallback()},get localTransform(){return this.getLocalTransform()},set localTransform(t){this.setLocalTransform(t)},getName(){return this.name},getPosition(){if(!(this.flags&g.Flags.PositionDirty))return this._position;this.flags&=~g.Flags.PositionDirty,this._position.copy(this.getLocalPosition());let t=this.parent;for(;t;)this._position.mul(t.getLocalScale()),t.getLocalRotation().transformVector(this._position,this._position),this._position.add(t.getLocalPosition()),t=t.parent;return this._position},setPosition(t,e,i){t instanceof pc.Vec3?o.copy(t):o.set(t,e,i),this.parent&&this.parent.transformPointInverse(o,o),this.setLocalPosition(o)},get position(){return this.getPosition()},set position(t){this.setPosition(t)},getRotation(){if(!(this.flags&g.Flags.RotationDirty))return this._rotation;this.flags&=~g.Flags.RotationDirty;const{parentLocalRotation:t,rotationMultiplier:e}=h;this._rotation.copy(this.getLocalRotation());let i=this.parent;for(;i;){i.getLocalScaleRotationMultipliers(e);const s=e.x,n=e.y,r=e.z;t.copy(i.getLocalRotation()),t.x*=s,t.y*=n,t.z*=r,this._rotation.mul2(t,this._rotation),this._rotation.x*=s,this._rotation.y*=n,this._rotation.z*=r,i=i.parent}return this._rotation},setRotation(t,e,i,s){const{newLocalRotation:n}=l;t instanceof pc.Quat?n.copy(t):n.set(t,e,i,s),this.parent?this.setLocalRotation(this.parent.transformQuaternionInverse(n)):this.setLocalRotation(n)},get rotation(){return this.getRotation()},set rotation(t){this.setRotation(t)},getWorldTransform(){return this.flags&g.Flags.WorldTransformDirty?(this.flags&=~g.Flags.WorldTransformDirty,this.parent?this._worldTransform.mul2(this._parent.getWorldTransform(),this.getLocalTransform()):this._worldTransform.copy(this.getLocalTransform()),this._worldTransform):this._worldTransform},setWorldTransform(t){this.muteTransformModificationCallback(),this.setPosition(t.getTranslation()),this.setRotation(t.getRotation());const e=t.clone();e.data[12]=e.data[13]=e.data[14]=0,this.setWorldRotationAndScale(e),this.unmuteTransformModificationCallback()},get worldTransform(){return this.getWorldTransform()},set worldTransform(t){this.setWorldTransform(t)},getWorldTransformInverse(){return this.flags&g.Flags.WorldTransformInverseDirty?(this.flags&=~g.Flags.WorldTransformInverseDirty,this._worldTransformInverse.copy(this.getWorldTransform()).invert(),this._worldTransformInverse):this._worldTransformInverse},get worldTransformInverse(){return this.getWorldTransformInverse()},transformPoint(t,e=new pc.Vec3,i=!1){e.copy(t);let s=this;for(;s;)i||e.mul(s.getLocalScale()),s.getLocalRotation().transformVector(e,e),e.add(s.getLocalPosition()),s=s.parent;return e},transformPointInverse(e,i=new pc.Vec3){return this.parent?this.parent.transformPointInverse(e,i):i.copy(e),i.sub(this.getLocalPosition()),t.copy(this.getLocalRotation()).invert().transformVector(i,i),i.mul(r.copy(this.getLocalScale()).invertSafe()),i},transformVector(t,e=new pc.Vec3){e.copy(t);let i=this;for(;i;)e.mul(i.getLocalScale()),i.getLocalRotation().transformVector(e,e),i=i.parent;return e},transformVectorInverse(e,i=new pc.Vec3){return this.parent?this.parent.transformVectorInverse(e,i):i.copy(e),t.copy(this.getLocalRotation()).invert().transformVector(i,i),i.mul(r.copy(this.getLocalScale()).invertSafe()),i},transformDirection(t,e=new pc.Vec3){e.copy(t),this.getLocalRotation().transformVector(e,e);let i=this.parent;for(;i;)i.getLocalScaleSign(a),e.x*=a.x,e.y*=a.y,e.z*=a.z,i.getLocalRotation().transformVector(e,e),i=i.parent;return e},transformDirectionInverse(e,i=new pc.Vec3,s=!1){if(this.parent?this.parent.transformDirectionInverse(e,i,!0):i.copy(e),t.copy(this.getLocalRotation()).invert().transformVector(i,i),s){const t=this.getLocalScale(),e=Math.sign(t.x)||1,s=Math.sign(t.y)||1,n=Math.sign(t.z)||1;i.x*=e,i.y*=s,i.z*=n}return i},transformQuaternionInverse(t,e=new pc.Quat){const{invLocalRotation:i,rotationMultiplier:s}=p;return this.parent?this.parent.transformQuaternionInverse(t,e):e.copy(t),i.copy(this.getLocalRotation()).invert(),e.mul2(i,e),this.getLocalScaleRotationMultipliers(s),e.x*=s.x,e.y*=s.y,e.z*=s.z,e},hijackLocalPosition(){return this.flags&g.Flags.LocalPositionHijacked?this._hijackedLocalPosition:(this.flags|=g.Flags.LocalPositionHijacked,this._hijackedLocalPosition.copy(this.getLocalPosition()),this._hijackedLocalPosition)},hijackLocalScale(){return this.flags&g.Flags.LocalScaleHijacked?this._hijackedLocalScale:(this.flags|=g.Flags.LocalScaleHijacked,this._hijackedLocalScale.copy(this.getLocalScale()),this._hijackedLocalScale)},hijackLocalEulerAngles(){return this.flags&g.Flags.LocalEulerAnglesHijacked?this._hijackedLocalEulerAngles:(this.flags|=g.Flags.LocalEulerAnglesHijacked,this._hijackedLocalEulerAngles.copy(this.getEulerAngles()),this._hijackedLocalEulerAngles)},hijackLocalRotation(){return this.flags&g.Flags.LocalRotationHijacked?this._hijackedLocalRotation:(this.flags|=g.Flags.LocalRotationHijacked,this._hijackedLocalRotation.copy(this.getLocalRotation()),this._hijackedLocalRotation)},releaseHijackedProperties(){this.flags&g.Flags.LocalPositionHijacked&&(this.flags&=~g.Flags.LocalPositionHijacked,this.setLocalPosition(this._hijackedLocalPosition)),this.flags&g.Flags.LocalScaleHijacked&&(this.flags&=~g.Flags.LocalScaleHijacked,this.setLocalScale(this._hijackedLocalScale)),this.flags&g.Flags.LocalRotationHijacked&&(this.flags&=~g.Flags.LocalRotationHijacked,this.setLocalRotation(this._hijackedLocalRotation)),this.flags&g.Flags.LocalEulerAnglesHijacked&&(this.flags&=~g.Flags.LocalEulerAnglesHijacked,this.setLocalEulerAngles(this._hijackedLocalEulerAngles))},reparent(t,e){this.notifyBeforeTransformParentChanged();const i=this._parent;if(this.element&&this.element._nearestScreen&&(this.element._nearestScreen.canvasMeshInstance.renderersDirty=!0),i)if(i!==t)i.removeChild(this,!0),i.notifyTransformChildrenChanged();else if(t)return void t.moveChildIndex(this,e);t&&(e>=0?t.insertChild(this,e):t.addChild(this)),this._app.scene.addDirty(this)},addChild(t){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.push(t),this._onInsertChild(t)},insertChild(t,e){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.splice(e,0,t),this._onInsertChild(t)},moveChildIndex(t,e){if(e<0){const e=this._children.indexOf(t);this._children.push(this._children.splice(e,1)[0])}else{const i=this._children.indexOf(t);this._children.splice(i,1),this._children.splice(e,0,t)}t.onParentChanged(),this.element&&this.element.triggerOnElementDimesionsChange(!0,!0)},setName(t){this.name=t},setupCanvasGroups(t){let e=t.parent;for(;e&&e.element&&0===t._parent.element._canvasGroups.length;)e=e.parent;e&&e.element&&t._parent.element._canvasGroups.length>0&&(t.element._canvasGroups=t._parent.element._canvasGroups.slice()),this.setupCanvasGroupsInChildren(t,t.element._canvasGroups)},setupCanvasGroupsInChildren(t,e){if(t.element){t.element._canvasGroups=e.slice();for(let e=0;e<t._canvasGroups.length;e++)t.element._canvasGroups.unshift(t._canvasGroups[e]);for(let e=0;e<t.children.length;e++)this.setupCanvasGroupsInChildren(t.children[e],t.element._canvasGroups)}},notifyScreenHierarchyChanged(){const t=pc.UIUtils.findParentScreen(this.parent);this.notifyScreenChanged(t),this.tryReparentScreen(t,this.children)},tryReparentScreen(t,e){for(let i=0;i<e.length;i++){const s=e[i];s.screen?s.screen.setParentScreen(t,!0):s.tryReparentScreen(t,s.children)}},_updateGraphDepth(){this._parent?this._graphDepth=this._parent._graphDepth+1:this._graphDepth=0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()},removeChild(t,e=!1){t.notifyScreenHierarchyChanged(),e||t._notifyHierarchyStateChanged(t,!1);for(let e=0;e<this._children.length;++e)if(this._children[e]===t)return this._children.splice(e,1),t._parent=null,this.fire("childremove",t),void t.notifyScreenHierarchyChanged()},syncHierarchy(){if(!this.enabled)return;this._sync();const t=this._children;for(let e=0,i=t.length;e<i;e++)t[e].syncHierarchy()},notifyCanvasGroupChanged(t){if(this.isPrefab)return;const e=t._unityComponents.monoBehaviour,i=t._unityComponents.canvasRenderer[0];for(let t=0;t<e.length;t++){e[t].onCanvasGroupChanged()}i&&i.onCanvasGroupChanged();const s=t.children;for(let t=0;t<s.length;t++)this.notifyCanvasGroupChanged(s[t])},notifyScreenChanged(t){if(this.isPrefab)return;this.screen&&(t=this.screen);const e=this._unityComponents.canvasRenderer[0];e&&e.onScreenChanged(t);const i=this.children;for(let e=0;e<i.length;e++)i[e].notifyScreenChanged(t)},notifyBeforeTransformParentChanged(){if(this.isPrefab)return;const t=this._unityComponents.monoBehaviour;for(let e=0;e<t.length;e++){t[e].onBeforeTransformParentChanged()}},notifyTransformParentChanged(){if(this.isPrefab)return;const t=this._unityComponents.monoBehaviour;for(let e=0;e<t.length;e++){t[e].onTransformParentChanged()}},notifyTransformChildrenChanged(){if(this.isPrefab)return;const t=this._unityComponents.monoBehaviour;for(let e=0;e<t.length;e++){t[e].onTransformChildrenChanged()}},onLocalRotationChanged(){this.flags|=g.Flags.LocalEulersAnglesDirty,this.flags|=g.Flags.LossyScaleDirty,this.flags&g.Flags.LocalTransformDirty||(this.flags|=g.Flags.LocalTransformDirty,this.onLocalTransformChanged()),this.flags&g.Flags.RotationDirty||(this.flags|=g.Flags.RotationDirty,this.onRotationChanged());for(const t of this.children)t.onParentLocalRotationChanged();this.increaseTransformVersion()},onLocalScaleChanged(){this.flags|=g.Flags.LossyScaleDirty,this.flags&g.Flags.LocalTransformDirty||(this.flags|=g.Flags.LocalTransformDirty,this.onLocalTransformChanged());for(const t of this.children)t.onParentLocalScaleChanged();this.increaseTransformVersion()},onLocalPositionChanged(){this.flags|=g.Flags.PositionDirty,this.flags&g.Flags.LocalTransformDirty||(this.flags|=g.Flags.LocalTransformDirty,this.onLocalTransformChanged());for(const t of this.children)t.onParentLocalPositionChanged();this.increaseTransformVersion()},onRotationChanged(){this.flags|=g.Flags.EulerAnglesDirty,this.flags|=g.Flags.LossyScaleDirty,this.increaseTransformVersion()},onLocalTransformChanged(){this.flags&g.Flags.WorldTransformDirty||(this.flags|=g.Flags.WorldTransformDirty,this.onWorldTransformChanged()),this.increaseTransformVersion()},onWorldTransformChanged(){this.flags|=g.Flags.WorldTransformInverseDirty;for(const t of this.children)t.onParentWorldTransformChanged();this.increaseTransformVersion()},onParentLocalRotationChanged(){this.flags|=g.Flags.LossyScaleDirty,this.flags|=g.Flags.PositionDirty,this.flags&g.Flags.RotationDirty||(this.flags|=g.Flags.RotationDirty,this.onRotationChanged());for(const t of this.children)t.onParentLocalRotationChanged();this.increaseTransformVersion()},onParentLocalScaleChanged(){this.flags|=g.Flags.LossyScaleDirty,this.flags|=g.Flags.PositionDirty,this.flags&g.Flags.RotationDirty||(this.flags|=g.Flags.RotationDirty,this.onRotationChanged());for(const t of this.children)t.onParentLocalScaleChanged();this.increaseTransformVersion()},onParentLocalPositionChanged(){this.flags|=g.Flags.PositionDirty;for(const t of this.children)t.onParentLocalPositionChanged();this.increaseTransformVersion()},onParentWorldTransformChanged(){this.flags&g.Flags.WorldTransformDirty||(this.flags|=g.Flags.WorldTransformDirty,this.onWorldTransformChanged()),this.increaseTransformVersion()},onParentChanged(){this.onParentLocalPositionChanged(),this.onParentLocalRotationChanged(),this.onParentLocalScaleChanged(),this.onParentWorldTransformChanged()},increaseTransformVersion(){this._aabbVer++,this.flags&g.Flags.HijackedByElementComponent&&this._app.scene.addDirty(this)}},{GraphNode:g}}()),Object.assign(pc,function(){const t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3,s=new pc.Vec3,n=function(){this._projection=pc.PROJECTION_PERSPECTIVE,this._nearClip=.1,this._farClip=1e4,this._fov=45,this._orthoHeight=10,this._aspect=16/9,this._aspectRatioMode=pc.ASPECT_AUTO,this._horizontalFov=!1,this.frustumCulling=!1,this.cullingMask=4294967295,this._renderDepthRequests=0,this._projMatDirty=!0,this._vpDirty=!0,this._vMatrixVersion=-1,this._projMat=new pc.Mat4,this._projInvMat=new pc.Mat4,this._viewMat=new pc.Mat4,this._viewInvMat=new pc.Mat4,this._viewProjMat=new pc.Mat4,this._invViewProjMat=new pc.Mat4,this._projMatOverride=null,this.vrDisplay=null,this._rect={x:0,y:0,width:1,height:1},this._scissorRect={x:0,y:0,width:1,height:1},this.frustum=new pc.Frustum(this._projMat,this._viewMat),this.renderTarget=null,this._depthTarget=null,this._clearOptions={color:[.5,.5,.5,1],depth:1,stencil:0,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH|pc.CLEARFLAG_STENCIL|pc.CLEARFLAG_USE_SKYBOX},this._node=null,this.calculateTransform=null,this.overrideCalculateTransform=!1,this.calculateProjection=null,this.overrideCalculateProjection=!1,this._cullFaces=!0,this._component=null,this._shaderParams=new Float32Array(4),this._zbufferParams=new Float32Array(4),this._screenParams=new Float32Array(4),this._orthoParams=new Float32Array(4),this._projectionParams=new Float32Array(4)};return n.CameraDefaults={frustumCulling:!0},Object.assign(n.prototype,{clone:function(){const t=new pc.Camera;return t.projection=this._projection,t.nearClip=this._nearClip,t.farClip=this._farClip,t._shaderParams=this._shaderParams.slice(),t.fov=this._fov,t.aspectRatio=this._aspect,t._aspectRatioMode=this._aspectRatioMode,t.renderTarget=this.renderTarget,t.setClearOptions(this.getClearOptions()),t.frustumCulling=this.frustumCulling,t.cullingMask=this.cullingMask,t},worldToScreen:function(t,e,i,n){return void 0===n&&(n=new pc.Vec3),this.updateVP(),this._viewProjMat.multiplyPoint(t,n),n.x=.5*(n.x+1)*e,n.y=.5*(n.y+1)*i,s.sub2(t,this._node.getPosition()),n.z=s.dot(this._node.forward),n},screenToWorld:function(s,n,r,o,a,c){void 0===c&&(c=new pc.Vec3),this.updateVP();const h=this._node.getPosition();if(this._projection===pc.PROJECTION_PERSPECTIVE){e.set(s/o*2-1,n/a*2-1,1),this._invViewProjMat.transformPoint(e,i);const t=e.x*this._invViewProjMat.data[3]+e.y*this._invViewProjMat.data[7]+e.z*this._invViewProjMat.data[11]+this._invViewProjMat.data[15];i.scale(1/t);const l=r/this._farClip;c.lerp(h,i,l)}else{const e=this._farClip-this._nearClip;t.set(s/o,n/a,(r-this._nearClip)/e),t.scale(2),t.sub(pc.Vec3.ONE),this._invViewProjMat.transformPoint(t,c)}return c},getClearOptions:function(){return this._clearOptions},getProjectionMatrix:function(){return this._projMatDirty&&this.resetProjectionMatrix(),this._projMat},getRect:function(){return this._rect},setClearOptions:function(t){this._clearOptions.color[0]=t.color[0],this._clearOptions.color[1]=t.color[1],this._clearOptions.color[2]=t.color[2],this._clearOptions.color[3]=t.color[3],this._clearOptions.depth=t.depth,this._clearOptions.stencil=t.stencil,this._clearOptions.flags=t.flags},setRect:function(t,e,i,s){this._rect.x=t,this._rect.y=e,this._rect.width=i,this._rect.height=s,this._projMatDirty=!0,this._vpDirty=!0},setScissorRect:function(t,e,i,s){this._scissorRect.x=t,this._scissorRect.y=e,this._scissorRect.width=i,this._scissorRect.height=s},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--},resetProjectionMatrix:function(){if(this._projection===pc.PROJECTION_PERSPECTIVE)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip,this._horizontalFov);else{const t=this._orthoHeight,e=t*this._aspect;this._projMat.setOrtho(-e,e,-t,t,this._nearClip,this._farClip)}const t=this._nearClip,e=this._farClip;this._shaderParams[0]=1/e,this._shaderParams[1]=e,this._shaderParams[2]=(1-e/t)/2,this._shaderParams[3]=(1+e/t)/2,this._projMatOverride=null,this._projMatDirty=!1,this._vpDirty=!0},updateVP:function(){const t=this._node;if(this._vMatrixVersion=t.aabbVersion,this._vpDirty=!1,this.overrideCalculateTransform)this.calculateTransform(this._viewInvMat,pc.VIEW_CENTER);else{const e=t.getPosition(),i=t.getRotation();this._viewInvMat.setTRS(e,i,pc.Vec3.REVERSED_Z)}this._viewMat.copy(this._viewInvMat).invert(),this.overrideCalculateProjection?this.calculateProjection(this._projMat,pc.VIEW_CENTER):this.getProjectionMatrix(),this._projInvMat.copy(this._projMat).invert(),this._viewProjMat.mul2(this._projMat,this._viewMat),this._invViewProjMat.copy(this._viewProjMat).invert();const e=t.getLossyScale();0!==e.x&&0!==e.y&&0!==e.z||console.warn("Camera world transform matrix has 0 scale. That leads to losing rotation data")}}),Object.defineProperty(n.prototype,"aspectRatio",{get:function(){return this._aspect},set:function(t){this._aspect!==t&&(this._aspect=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"projection",{get:function(){return this._projection},set:function(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"nearClip",{get:function(){return this._nearClip},set:function(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"farClip",{get:function(){return this._farClip},set:function(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"fov",{get:function(){return this._fov},set:function(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"horizontalFov",{get:function(){return this._horizontalFov},set:function(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"orthoHeight",{get:function(){return this._orthoHeight},set:function(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"clearColor",{get:function(){return this._clearOptions.color},set:function(t){this._clearOptions.color[0]=t[0],this._clearOptions.color[1]=t[1],this._clearOptions.color[2]=t[2],this._clearOptions.color[3]=t[3]}}),Object.defineProperty(n.prototype,"clearDepth",{get:function(){return this._clearOptions.depth},set:function(t){this._clearOptions.depth=t}}),Object.defineProperty(n.prototype,"clearSkybox",{get:function(){return this._clearOptions.skybox},set:function(t){this._clearOptions.skybox=t}}),Object.defineProperty(n.prototype,"clearStencil",{get:function(){return this._clearOptions.stencil},set:function(t){this._clearOptions.stencil=t}}),Object.defineProperty(n.prototype,"clearFlags",{get:function(){return this._clearOptions.flags},set:function(t){this._clearOptions.flags=t}}),{Camera:n}}()),Object.assign(pc,function(){const t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3,s=new pc.Mat4,n=new pc.Mat4,r=new pc.Mat4,o=(new pc.Mat4).setTRS(new pc.Vec3(-.5,-.5,0),pc.Quat.IDENTITY,pc.Vec3.ONE),a={r:0,g:1,b:2,a:3};let c=0;const h=function(){this.id=c++,this._type=pc.LIGHTTYPE_DIRECTIONAL,this._color=new pc.Color(.8,.8,.8),this._intensity=1,this._castShadows=!1,this._enabled=!1,this._mask=1,this._cullingMask=-1,this._renderMode=0,this._nodeAabbVer=0,this.isStatic=!1,this.key=0,this.bakeDir=!0,this._aabb=new pc.BoundingBox,this._cameraAABB=new pc.BoundingBox,this._scissor=new Float32Array(4),this._scissorSize=new pc.Vec3,this.attenuationStart=10,this._attenuationEnd=10,this._falloffMode=0,this._shadowType=pc.SHADOW_PCF3,this._vsmBlurSize=11,this.vsmBlurMode=pc.BLUR_GAUSSIAN,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._cookieScale=new pc.Vec2(1,1),this._innerConeAngle=40,this._outerConeAngle=45,this._finalColor=new Float32Array([.8,.8,.8,1]);const t=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([t,t,t,t]),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowCamera=null,this._shadowMatrix=new pc.Mat4,this._worldToLightMatrix=new pc.Mat4,this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=pc.SHADOWUPDATE_REALTIME,this._scene=null,this._node=null,this._rendererParams=[],this._isVsm=!1,this._isPcf=!0,this._cacheShadowMap=!1,this._isCachedShadowMap=!1,this._luminance=0,this._effectiveIntensity=0,this._priority=0,this._directionToLight=new pc.Vec3,this._position=new pc.Vec3,this._visibleLength=[0],this._visibleList=[[]],this._visibleCameraSettings=[]};return h.LightDefaults={type:"point",color:new pc.Color(1,1,1,1),cookieScale:pc.Vec2.ONE,intensity:1,range:10,cullingMask:-1},Object.assign(h.prototype,{destroy:function(){this._destroyShadowMap()},update:function(t){if(!this._node)return!1;if(this._nodeAabbVer===this._node.aabbVersion)return pc.Culling.isAABBVisibleInFrustum(t.frustum,this._aabb);const e=this._node.worldTransformInverse,a=1/this._attenuationEnd;return this._position.copy(this._node.getPosition()),this._type===pc.LIGHTTYPE_POINT?(this._worldToLightMatrix.copy(e).scale(a),this._worldToLightMatrix.data[15]=1):this._type===pc.LIGHTTYPE_SPOT?(s.setIdentity(),s.data[11]=2*Math.tan(pc.math.DEG_TO_RAD*this._outerConeAngle*.5),s.data[15]=0,n.setScale(a,a,a),n.data[15]=a,this._worldToLightMatrix.mul2(n,s),this._worldToLightMatrix.mul2(this._worldToLightMatrix,e)):(i.set(this._cookieScale.x,this._cookieScale.x,this._cookieScale.x),r.setTRS(this._node.getPosition(),this._node.getRotation(),i),this._worldToLightMatrix.mul2(r,o).invert(),this._worldToLightMatrix.data[2]=0,this._worldToLightMatrix.data[6]=0,this._worldToLightMatrix.data[10]=0,this._worldToLightMatrix.data[14]=0,this._directionToLight.copy(this._node.forward).scale(-1)),this._nodeAabbVer=this._node.aabbVersion,this.getBoundingBox(this._aabb),pc.Culling.isAABBVisibleInFrustum(t.frustum,this._aabb)},clone:function(){const t=new pc.Light;return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.castShadows=this.castShadows,t.enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this._mask,t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t.cullingMask=this.cullingMask,t.cookie=this._cookie,t},getColor:function(){return this._color},getBoundingSphere:function(s){if(this._type===pc.LIGHTTYPE_SPOT){const n=this.attenuationEnd,r=this._outerConeAngle,o=Math.cos(r*pc.math.DEG_TO_RAD),a=this._node;t.copy(a.up),t.scale(.5*-n*o),t.add(a.getPosition()),s.center=t,e.copy(a.up),e.scale(-n),i.copy(a.right),i.scale(Math.sin(r*pc.math.DEG_TO_RAD)*n),e.add(i),s.radius=.5*e.length()}else this._type===pc.LIGHTTYPE_POINT?(s.center=this._node.getPosition(),s.radius=this.attenuationEnd):this._type===pc.LIGHTTYPE_DIRECTIONAL&&(s.center=this._node.getPosition(),s.radius=1/0)},getBoundingBox:function(t){if(this._type===pc.LIGHTTYPE_SPOT){const e=this.attenuationEnd,i=this._outerConeAngle,s=this._node,n=Math.abs(Math.tan(i*pc.math.DEG_TO_RAD*.5)*e);t.center.set(0,0,.5*e),t.halfExtents.set(n,n,.5*e),t.setFromTransformedAabb(t,s.getWorldTransform())}else this._type===pc.LIGHTTYPE_POINT?(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd)):this._type===pc.LIGHTTYPE_DIRECTIONAL&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(1/0,1/0,1/0))},_updateFinalColor:function(){const t=this._color,e=t.r,i=t.g,s=t.b,n=t.a,r=this._intensity,o=this._finalColor,a=this._linearFinalColor;o[0]=e*r,o[1]=i*r,o[2]=s*r,o[3]=n*r,r>=1?(a[0]=Math.pow(e,2.2)*r,a[1]=Math.pow(i,2.2)*r,a[2]=Math.pow(s,2.2)*r,a[3]=Math.pow(n,2.2)*r):(a[0]=Math.pow(o[0],2.2),a[1]=Math.pow(o[1],2.2),a[2]=Math.pow(o[2],2.2),a[3]=Math.pow(o[3],2.2)),this._luminance=(.3*e+.59*i+.11*s)*r},setColor:function(...t){let e,i,s;1===arguments.length?(e=t[0].r,i=t[0].g,s=t[0].b):3===arguments.length&&(e=t[0],i=t[1],s=t[2]),this._color.set(e,i,s),this._updateFinalColor()},_destroyShadowMap:function(){if(this._shadowCamera){if(!this._isCachedShadowMap){const t=this._shadowCamera.renderTarget;let e;if(t)if(t.length)for(e=0;e<t.length;e++)t[e].colorBuffer&&t[e].colorBuffer.destroy(),t[e].destroy();else t.colorBuffer&&t.colorBuffer.destroy(),t.depthBuffer&&t.depthBuffer.destroy(),t.destroy()}this._shadowCamera.renderTarget=null,this._shadowCamera=null,this._shadowCubeMap=null,this.shadowUpdateMode===pc.SHADOWUPDATE_NONE&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)}},updateShadow:function(){this.shadowUpdateMode!==pc.SHADOWUPDATE_REALTIME&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)},updateKey:function(){let t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|a[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12;3===this._cookieChannel.length&&(t|=a[this._cookieChannel.charAt(1)]<<16,t|=a[this._cookieChannel.charAt(2)]<<14),this.key=t}}),Object.defineProperty(h.prototype,"enabled",{get:function(){return this._type},set:function(t){this._type!==t&&(this._enabled=t)}}),Object.defineProperty(h.prototype,"type",{get:function(){return this._type},set:function(t){if(this._type===t)return;this._type=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}}),Object.defineProperty(h.prototype,"mask",{get:function(){return this._mask},set:function(t){this._mask!==t&&(this._mask=t)}}),Object.defineProperty(h.prototype,"renderMode",{get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t)}}),Object.defineProperty(h.prototype,"cullingMask",{get:function(){return this._cullingMask},set:function(t){this._cullingMask!==t&&(this._cullingMask=t)}}),Object.defineProperty(h.prototype,"shadowType",{get:function(){return this._shadowType},set:function(t){if(this._shadowType===t)return;const e=pc.Application.getApplication().graphicsDevice;this._type===pc.LIGHTTYPE_POINT&&(t=pc.SHADOW_PCF3),t!==pc.SHADOW_PCF5||e.webgl2||(t=pc.SHADOW_PCF3),t!==pc.SHADOW_VSM32||e.textureFloatRenderable||(t=pc.SHADOW_VSM16),t!==pc.SHADOW_VSM16||e.textureHalfFloatRenderable||(t=pc.SHADOW_VSM8),this._isVsm=t>=pc.SHADOW_VSM8&&t<=pc.SHADOW_VSM32,this._isPcf=t===pc.SHADOW_PCF5||t===pc.SHADOW_PCF3,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}}),Object.defineProperty(h.prototype,"castShadows",{get:function(){return this._castShadows&&this._mask!==pc.MASK_LIGHTMAP&&0!==this._mask},set:function(t){this._castShadows!==t&&(this._castShadows=t,this.updateKey())}}),Object.defineProperty(h.prototype,"shadowResolution",{get:function(){return this._shadowResolution},set:function(t){if(this._shadowResolution===t)return;const e=pc.Application.getApplication().graphicsDevice;t=this._type===pc.LIGHTTYPE_POINT?Math.min(t,e.maxCubeMapSize):Math.min(t,e.maxTextureSize),this._shadowResolution=t}}),Object.defineProperty(h.prototype,"vsmBlurSize",{get:function(){return this._vsmBlurSize},set:function(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}}),Object.defineProperty(h.prototype,"normalOffsetBias",{get:function(){return this._normalOffsetBias},set:function(t){this._normalOffsetBias!==t&&((!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)&&this.updateKey(),this._normalOffsetBias=t)}}),Object.defineProperty(h.prototype,"falloffMode",{get:function(){return this._falloffMode},set:function(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey())}}),Object.defineProperty(h.prototype,"innerConeAngle",{get:function(){return this._innerConeAngle},set:function(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180))}}),Object.defineProperty(h.prototype,"outerConeAngle",{get:function(){return this._outerConeAngle},set:function(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._outerConeAngleCos=Math.cos(t*Math.PI/180),this._nodeAabbVer=-1)}}),Object.defineProperty(h.prototype,"intensity",{get:function(){return this._intensity},set:function(t){this._intensity!==t&&(this._intensity=t,this._updateFinalColor())}}),Object.defineProperty(h.prototype,"cookie",{get:function(){return this._cookie},set:function(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}}),Object.defineProperty(h.prototype,"cookieScale",{get:function(){return this._cookieScale},set:function(t){this._cookieScale=t,this._nodeAabbVer=-1}}),Object.defineProperty(h.prototype,"attenuationEnd",{get:function(){return this._attenuationEnd},set:function(t){this._attenuationEnd=t,this._nodeAabbVer=-1}}),Object.defineProperty(h.prototype,"cookieFalloff",{get:function(){return this._cookieFalloff},set:function(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}}),Object.defineProperty(h.prototype,"cookieChannel",{get:function(){return this._cookieChannel},set:function(t){if(this._cookieChannel!==t){if(t.length<3){const e=t.charAt(t.length-1),i=3-t.length;for(let s=0;s<i;s++)t+=e}this._cookieChannel=t,this.updateKey()}}}),Object.defineProperty(h.prototype,"cookieTransform",{get:function(){return this._cookieTransform},set:function(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new pc.Vec2,this._cookieOffsetSet=!1),this.updateKey())}}),Object.defineProperty(h.prototype,"cookieOffset",{get:function(){return this._cookieOffset},set:function(t){if(this._cookieOffset===t)return;!(!this._cookieTransformSet&&!t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new pc.Vec4(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}}),{Light:h}}()),Object.assign(pc,function(){let t=0;const e=function(){this.name="Untitled",this.id=t++,this._shader=null,this.parameters={},this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0,this.enableAutoInstancing=!1};Object.defineProperty(e.prototype,"shader",{get:function(){return this._shader},set:function(t){this._shader&&this._shader._refCount--,this._shader=t,t&&t._refCount++}}),e.prototype._cloneInternal=function(t){t.name=this.name,t.shader=this.shader;const e={};for(const t in this.parameters)this.parameters.hasOwnProperty(t)&&(e[t]=Object.assign({},this.parameters[t]));t.parameters=e},e.prototype.clone=function(){const t=new pc.Material;return this._cloneInternal(t),t},e.prototype._updateMeshInstanceKeys=function(){let t;const e=this.meshInstances;for(t=0;t<e.length;t++)e[t].updateKey()},e.prototype.updateUniforms=function(){},e.prototype.updateShader=function(t,e,i){},e.prototype.update=function(){this.dirty=!0},e.prototype.clearParameters=function(){this.parameters={}},e.prototype.getParameters=function(){return this.parameters},e.prototype.getParameter=function(t){const e=this.parameters[t];return e?e.data:null};const i=function(t,e,i){this.scopeId=t,this.data=e,this.passFlags=i};return e.prototype.setParameter=function(t,e,s){if(void 0===s&&(s=-524285),void 0===e&&"object"==typeof t){const i=t;if(i.length){for(let t=0;t<i.length;t++)this.setParameter(i[t]);return}t=i.name,e=i.value}const n=this.parameters[t];n?(n.data=e,n.passFlags=s):this.parameters[t]=new i(null,e,s)},e.prototype.deleteParameter=function(t){this.parameters[t]&&delete this.parameters[t]},e.prototype.setParameters=function(){for(const t in this.parameters)if(this.parameters.hasOwnProperty(t)){const e=this.parameters[t];e.scopeId.setValue(e.data)}},e.prototype.update=function(){},e.prototype.init=function(t){throw Error("Not Implemented in base class")},e.prototype.getName=function(){return this.name},e.prototype.setName=function(t){this.name=t},e.prototype.getShader=function(){return this.shader},e.prototype.setShader=function(t){this._shader&&this._shader._refCount--,this._shader=t,t&&t._refCount++},e.prototype.destroy=function(){let t,e,i;this.shader&&(this.shader._refCount--,this.shader._refCount<1&&this.shader.destroy());for(const e in this.variants)if(this.variants.hasOwnProperty(e)){if(t=this.variants[e],t===this.shader)continue;t._refCount--,t._refCount<1&&t.destroy()}this.variants={},this.shader=null;for(let t=0;t<this.meshInstances.length;t++){for(e=this.meshInstances[t],i=0;i<e._shader.length;i++)e._shader[i]=null;e._material=null;const s=pc.getDefaultMaterial();this!==s&&(e.material=s)}},{Material:e}}()),Object.assign(pc,function(){const t=new pc.BoundingBox;function e(t,e,i,s){return(15&t)<<27|(e===pc.BLEND_NONE?1:0)<<26|(i?1:0)<<25|(33554431&s)<<0}const i=function(t){this.name="",this._refCount=0,this.id=i.id++,this.vertexBuffer=t?null:this.defaultVertexBuffer(this.defaultStreams,0,new Float32Array),this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this.morph=null,this.meshInstance=null,this._aabb=new pc.BoundingBox,this.bindposes=[],this.subMeshes=[],this.boneAabb=null,this.version=0};i.id=0,Object.defineProperty(i.prototype,"aabb",{get:function(){return this.morph?this.morph.aabb:this._aabb},set:function(t){this.morph?(this._aabb=this.morph._baseAabb=t,this.morph._calculateAabb()):this._aabb=t,this.version++}});const s=function(t,e,s){this._key=[0,0],this._shader=[null,null,null],this.id=i.id++,this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=t,this._mesh=e,e._refCount++,e.meshInstance=this,this.material=s,this._shaderDefs=0,this._shaderDefs|=e.vertexBuffer.format.hasUv0?pc.SHADERDEF_UV0:0,this._shaderDefs|=e.vertexBuffer.format.hasUv1?pc.SHADERDEF_UV1:0,this._shaderDefs|=e.vertexBuffer.format.hasColor?pc.SHADERDEF_VCOLOR:0,this._shaderDefs|=e.vertexBuffer.format.hasTangents?pc.SHADERDEF_TANGENTS:0,this._lightHash=0,this.visible=!0,this.layer=pc.LAYER_WORLD,this.renderStyle=pc.RENDERSTYLE_SOLID,this.castShadow=!1,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this.drawOrder=0,this.sortingLayerIndex=0,this.sortingOrder=0,this._updateAabb=!0,this._updateAabbFunc=null,this.updateKey(),this._skinInstance=null,this.morphInstance=null,this.instancingData=null,this.aabb=new pc.BoundingBox,this._boneAabb=null,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=0,this.isVisibleFunc=null,this.parameters={},this._lightProbe=null,this.stencilFront=null,this.stencilBack=null,this.lightmapIndex=-1,this.lightmapSceneIndex=-1,this.isCanvas=!1};Object.defineProperty(s.prototype,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh&&this._mesh._refCount--,this._mesh=t,t&&t._refCount++}}),Object.defineProperty(s.prototype,"aabb",{get:function(){if(this.worldAabbOverride)return this.worldAabbOverride;let e;if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){const i=this.mesh.skin.boneNames.length+5;let s,n;if(!this.mesh.boneAabb){this.mesh.boneAabb=[],this.mesh.boneUsed=[];const t=this.mesh.vertexBuffer.format.elements,r=this.mesh.vertexBuffer.numVertices,o=this.mesh.vertexBuffer.format.size;let a,c,h,l,p,u,d;for(n=0;n<t.length;n++)t[n].name===pc.SEMANTIC_POSITION?c=t[n].offset:t[n].name===pc.SEMANTIC_BLENDINDICES?h=t[n].offset:t[n].name===pc.SEMANTIC_BLENDWEIGHT&&(l=t[n].offset);const _=new Float32Array(this.mesh.vertexBuffer.storage),f=new Float32Array(this.mesh.vertexBuffer.storage),m=c/4,g=l/4,y=h/4,E=o/4;let T,A,b,S,R;const I=[],C=[];for(s=this.mesh.boneUsed,n=0;n<i;n++)I[n]=new pc.Vec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),C[n]=new pc.Vec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(p=0;p<r;p++)for(u=0;u<4;u++)f[p*E+g+u]>0&&(a=_[p*E+y+u],b=f[p*E+m],S=f[p*E+m+1],R=f[p*E+m+2],T=C[a],A=I[a],A.x>b&&(A.x=b),A.y>S&&(A.y=S),A.z>R&&(A.z=R),T.x<b&&(T.x=b),T.y<S&&(T.y=S),T.z<R&&(T.z=R),s[a]=!0);if(this.morphInstance){let t;const e=this.morphInstance.morph._targets,i=new Float32Array(3*r),s=new Float32Array(3*r);let n,o,a,c,h,l,_;for(p=0;p<r;p++)i[3*p]=s[3*p]=f[p*E+m],i[3*p+1]=s[3*p+1]=f[p*E+m+1],i[3*p+2]=s[3*p+2]=f[p*E+m+2];for(d=0;d<e.length;d++){c=e[d];for(let e=0;e<c.frames.length;e++)for(h=c.frames[e].indices,l=h.length,_=c.frames[e].deltaPositions,u=0;u<l;u++)t=h[u],n=_[3*u],o=_[3*u+1],a=_[3*u+2],n<0?i[3*t]+=n:s[3*t]+=n,o<0?i[3*t+1]+=o:s[3*t+1]+=o,a<0?i[3*t+2]+=a:s[3*t+2]+=a}}for(n=0;n<i;n++)e=new pc.BoundingBox,e.setMinMax(I[n],C[n]),this.mesh.boneAabb.push(e)}if(!this._boneAabb)for(this._boneAabb=[],n=0;n<this.mesh.boneAabb.length;n++)this._boneAabb[n]=new pc.BoundingBox;for(s=this.mesh.boneUsed,n=0;n<this.mesh.boneAabb.length;n++)s[n]&&this._boneAabb[n].setFromTransformedAabb(this.mesh.boneAabb[n],this.skinInstance.matrices[n]);const r=this.node.getWorldTransform();let o=!0;for(n=0;n<this.mesh.boneAabb.length;n++)s[n]&&(o?(t.center.copy(this._boneAabb[n].center),t.halfExtents.copy(this._boneAabb[n].halfExtents),o=!1):t.add(this._boneAabb[n]));this._aabb.setFromTransformedAabb(t,r)}else this.node._aabbVer!==this._aabbVer&&(e=this.mesh?this.mesh.aabb:this._aabb,this.mesh||e.setToInfinity(),this._aabb.setFromTransformedAabb(e,this.parameters.localToWorldMatrix||this.node.getWorldTransform()),this._aabbVer=this.node._aabbVer);return this._aabb},set:function(t){this._aabb=t}}),Object.defineProperty(s.prototype,"worldAabbOverride",{get:function(){return this._worldAabbOverride},set:function(t){this._worldAabbOverride=t}}),Object.defineProperty(s.prototype,"material",{get:function(){return this._material},set:function(t){if(t===this._material)return;let e;for(e=0;e<this._shader.length;e++)this._shader[e]=null;const i=!!this._material&&this._material.blendType!==pc.BLEND_NONE,s=this._material;if(this._material=t,t&&t.blendType!==pc.BLEND_NONE!==i){let e=t._scene;!e&&s&&s._scene&&(e=s._scene),e?e.layers._dirtyBlend=!0:t._dirtyBlend=!0}}}),Object.defineProperty(s.prototype,"layer",{get:function(){return this._layer},set:function(t){this._layer=t,this.updateKey()}}),Object.defineProperty(s.prototype,"receiveShadow",{get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t,this._shaderDefs=t?this._shaderDefs&~pc.SHADERDEF_NOSHADOW:this._shaderDefs|pc.SHADERDEF_NOSHADOW,this._shader[pc.SHADER_FORWARD]=null,this._shader[pc.SHADER_FORWARDHDR]=null}}),Object.defineProperty(s.prototype,"skinInstance",{get:function(){return this._skinInstance},set:function(t){this._skinInstance=t,this._shaderDefs=t?this._shaderDefs|pc.SHADERDEF_SKIN:this._shaderDefs&~pc.SHADERDEF_SKIN;for(let t=0;t<this._shader.length;t++)this._shader[t]=null}}),Object.defineProperty(s.prototype,"morphInstance",{get:function(){return this._morphInstance},set:function(t){this._morphInstance=t}}),Object.defineProperty(s.prototype,"screenSpace",{get:function(){return this._screenSpace},set:function(t){this._screenSpace=t,this._shaderDefs=t?this._shaderDefs|pc.SHADERDEF_SCREENSPACE:this._shaderDefs&~pc.SHADERDEF_SCREENSPACE,this._shader[pc.SHADER_FORWARD]=null}}),Object.defineProperty(s.prototype,"key",{get:function(){return this._key[pc.SORTKEY_FORWARD]},set:function(t){this._key[pc.SORTKEY_FORWARD]=t}}),Object.assign(s.prototype,{syncAabb:function(){},updateKey:function(){const t=this.material;this._key[pc.SORTKEY_FORWARD]=e(this.layer,t.alphaToCoverage||t.alphaTest?pc.BLEND_NORMAL:t.blendType,!1,t.id)},setParameter:pc.Material.prototype.setParameter,setParameters:pc.Material.prototype.setParameters,deleteParameter:pc.Material.prototype.deleteParameter,getParameter:pc.Material.prototype.getParameter,getParameters:pc.Material.prototype.getParameters,clearParameters:pc.Material.prototype.clearParameters});const n=function(t,i,s){this._key=[],this._key[pc.SORTKEY_FORWARD]=e(t,i,!0,0),this.command=s};Object.defineProperty(n.prototype,"key",{get:function(){return this._key[pc.SORTKEY_FORWARD]},set:function(t){this._key[pc.SORTKEY_FORWARD]=t}});const r=function(t,e,i){i=i||16,this.buffer=new Float32Array(t*i),this.count=t,this.offset=0,this.usage=e?pc.BUFFER_DYNAMIC:pc.BUFFER_STATIC,this._buffer=null};return Object.assign(r.prototype,{update:function(){this._buffer&&this._buffer.setData(this.buffer)}}),{Command:n,Mesh:i,MeshInstance:s,InstancingData:r,_getDrawcallSortKey:e}}()),Object.assign(pc,function(){const t=new pc.Mat4,e=function(t){this.skin=t,this._dirty=!0,this.bones=[];const e=t.inverseBindPose.length,i=t.device;if(i.supportsBoneTextures){let t;t=e>256?64:e>64?32:e>16?16:8,this.boneTexture=new pc.Texture(i,{width:t,height:t,format:pc.PIXELFORMAT_RGBA32F,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(16*e);this.matrices=[],this.bonesAabbVersions=[];for(let t=0;t<e;t++)this.matrices[t]=new pc.Mat4,this.bonesAabbVersions[t]=-1};return Object.assign(e.prototype,{updateMatrices:function(e){t.copy(e.getWorldTransform()).invert();for(let e=this.bones.length-1;e>=0;e--)this.matrices[e].mul2(t,this.bones[e].getWorldTransform()),this.matrices[e].mul2(this.matrices[e],this.skin.inverseBindPose[e])},updateMatrixPalette:function(){let t;const e=this.matrixPalette;let i;for(let s=this.bones.length-1;s>=0;s--)t=this.matrices[s].data,i=16*s,e[i]=t[0],e[i+1]=t[1],e[i+2]=t[2],e[i+3]=t[3],e[i+4]=t[4],e[i+5]=t[5],e[i+6]=t[6],e[i+7]=t[7],e[i+8]=t[8],e[i+9]=t[9],e[i+10]=t[10],e[i+11]=t[11],e[i+12]=t[12],e[i+13]=t[13],e[i+14]=t[14],e[i+15]=t[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}}),{Skin:function(t,e,i){this.device=t,this.inverseBindPose=e,this.boneNames=i},SkinInstance:e}}()),Object.assign(pc,function(){function t(){this.index=0,this.boneIndices=[0,0,0,0]}function e(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={}}return Object.assign(e.prototype,{addVertex:function(t,e,i){let s=-1;if(void 0!==this.indexMap[e])s=this.indexMap[e],this.indices.push(s);else{for(let s=0;s<4;s++){if(0===i.blendWeight.data[4*e+s])continue;const n=i.blendIndices.data[4*t.index+s];t.boneIndices[s]=this.getBoneRemap(n)}s=this.vertices.length,this.indices.push(s),this.vertices.push(t),this.indexMap[e]=s}},addPrimitive:function(t,e,i,s){let n,r;const o=[];let a=0;const c=t.length;for(n=0;n<c;n++){const e=t[n].index;for(let t=0;t<4;t++)if(i.blendWeight.data[4*e+t]>0){const s=i.blendIndices.data[4*e+t];let n=!0;for(r=0;r<a;r++)if(o[r]===s){n=!1;break}if(n){o[a]=s,a+=-1===this.getBoneRemap(s)?1:0}}}if(this.boneIndices.length+a>s)return!1;for(n=0;n<a;n++)this.boneIndices.push(o[n]);for(n=0;n<c;n++)this.addVertex(t[n],e[n],i);return!0},getBoneRemap:function(t){for(let e=0;e<this.boneIndices.length;e++)if(this.boneIndices[e]===t)return e;return-1}}),{partitionSkin:function(i,s,n){let r,o,a,c;!function(t){let e;const i=t.vertices,s=t.skins,n=t.meshes,r=t.meshInstances;for(e=0;e<n.length;e++)n[e].vertices=i[n[e].vertices],void 0!==n[e].skin&&(n[e].skin=s[n[e].skin]);for(e=0;e<r.length;e++)r[e].mesh=n[r[e].mesh]}(i);const h=i.vertices,l=i.skins;let p;const u=i.meshes,d=i.meshInstances,_=function(e){const i=new t;return i.index=e,i};for(r=l.length-1;r>=0;r--)if(l[r].boneNames.length>n){const t=l.splice(r,1)[0],i=[];for(o=0;o<u.length;o++)u[o].skin===t&&i.push(u[o]);for(o=0;o<i.length;o++)c=u.indexOf(i[o]),-1!==c&&u.splice(c,1);if(0===i.length)throw new Error("partitionSkin: There should be at least one mesh that references a skin");const f=i[0].vertices;for(o=1;o<i.length;o++)if(i[o].vertices!==f)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");let m;const g=[],y=[],E=[];let T=0;for(o=0;o<i.length;o++){p=i[o];const t=p.indices;for(let i=p.base;i<p.base+p.count;){c=t[i++],y[0]=_(c),E[0]=c,c=t[i++],y[1]=_(c),E[1]=c,c=t[i++],y[2]=_(c),E[2]=c;let s=!1;for(let t=T;t<g.length;t++)if(m=g[t],m.addPrimitive(y,E,f,n)){s=!0;break}s||(m=new e,m.originalMesh=p,m.addPrimitive(y,E,f,n),g.push(m))}T=g.length}const A=[],b=[];for(o=0;o<g.length;o++)if(m=g[o],m.vertices.length&&m.indices.length){const t=A.length,e=m.vertices.length,i=b.length,s=m.indices.length;let n,r;for(m.partition=o,m.vertexStart=t,m.vertexCount=e,m.indexStart=i,m.indexCount=s,n=0,r=t;n<e;)A[r++]=m.vertices[n++];for(n=0,r=i;n<s;)b[r++]=m.indices[n++]+t}const S=[];for(o=0;o<g.length;o++){m=g[o];const e=[],i=[];for(a=0;a<m.boneIndices.length;a++)e.push(t.inverseBindMatrices[m.boneIndices[a]]),i.push(t.boneNames[m.boneIndices[a]]);const s={inverseBindMatrices:e,boneNames:i};S.push(s),l.push(s)}let R,I,C;const M={};for(const t in f)f.hasOwnProperty(t)&&(M[t]={components:f[t].components,data:[],type:f[t].type});for(const t in f)if("blendIndices"===t){const e=M[t].data;for(o=0;o<A.length;o++){const t=A[o].boneIndices;e.push(t[0],t[1],t[2],t[3])}}else for(R=f[t],I=R.data,C=R.components,o=0;o<A.length;o++)for(c=A[o].index,a=0;a<C;a++)M[t].data.push(I[c*C+a]);for(h[h.indexOf(f)]=M,o=0;o<g.length;o++)for(m=g[o],p={aabb:{min:[0,0,0],max:[0,0,0]},vertices:M,skin:S[o],indices:b.splice(0,m.indexCount),type:"triangles",base:0,count:m.indexCount},u.push(p),a=d.length-1;a>=0;a--)d[a].mesh===m.originalMesh&&(d.push({mesh:p,node:d[a].node}),s&&s.push({material:s[a].material,path:s[a].path}));for(o=0;o<g.length;o++)for(m=g[o],a=d.length-1;a>=0;a--)d[a].mesh===m.originalMesh&&(d.splice(a,1),s&&s.splice(a,1))}!function(t){let e;const i=t.vertices,s=t.skins,n=t.meshes,r=t.meshInstances;for(e=0;e<n.length;e++)n[e].vertices=i.indexOf(n[e].vertices),void 0!==n[e].skin&&(n[e].skin=s.indexOf(n[e].skin));for(e=0;e<r.length;e++)r[e].mesh=n.indexOf(r[e].mesh)}(i)}}}()),Object.assign(pc,function(){const t=new pc.Vec3,e=new pc.Vec3,i=function(t){this.frames=t?t.frames:[],this.name=t?t.name:"",this.aabb=t?t.aabb:void 0};i.prototype=new i,Object.defineProperty(i.prototype,"indices",{get:function(){return this.frames[0].indices}});const s=function(t){this.aabb=new pc.BoundingBox,this._baseBuffer=null,this._baseAabb=null,this._targets=t,this._dirty=!0,this._aabbDirty=!0,this._baseData=null,this._offsetPF=0,this._offsetNF=0,this._offsetTF=0,this._vertSizeF=0};Object.assign(s.prototype,{_setBaseMesh:function(t){this._baseBuffer=t.vertexBuffer,this._baseAabb=t._aabb,this._baseData=new Float32Array(this._baseBuffer.storage);let e=-1,i=-1,s=-1;const n=this._baseBuffer.format.elements,r=this._baseBuffer.format.size;for(let t=0;t<n.length;t++)n[t].name===pc.SEMANTIC_POSITION?e=n[t].offset:n[t].name===pc.SEMANTIC_NORMAL?i=n[t].offset:n[t].name===pc.SEMANTIC_TANGENT&&(s=n[t].offset);this._offsetPF=e/4,this._offsetNF=i/4,this._offsetTF=s/4,this._vertSizeF=r/4,this._dirty=!0},_calculateAabb:function(){if(!this._baseBuffer)return;let i,s,n,r,o,a,c,h,l;this.aabb.copy(this._baseAabb);const p=this._vertSizeF,u=this._offsetPF,d=this._baseData;for(s=0;s<this._targets.length;s++){if(r=this._targets[s],!r.aabb&&r.indices.length>0){r.aabb=this.aabb.clone(),t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i=r.indices.length;for(let s=0;s<r.frames.length;s++){const _=r.frames[s];for(n=0;n<i;n++)o=r.indices[n],a=o*p+u,c=d[a]+_[3*n],h=d[a+1]+_[3*n+1],l=d[a+2]+_[3*n+2],t.x>c&&(t.x=c),t.y>h&&(t.y=h),t.z>l&&(t.z=l),e.x<c&&(e.x=c),e.y<h&&(e.y=h),e.z<l&&(e.z=l)}r.aabb.setMinMax(t,e)}r.aabb&&this.aabb.add(r.aabb)}this._aabbDirty=!1},addTarget:function(t){this._targets.push(t),this._aabbDirty=!0},removeTarget:function(t){const e=this._targets.indexOf(t);-1!==e&&(this._targets.splice(e,1),this._aabbDirty=!0)},getTarget:function(t){return this._targets[t]}});const n=function(t){this.morph=t,this._vertexBuffer=null,this._vertexData=null,this._weights=[],this._dirty=!0};return Object.assign(n.prototype,{_setBaseMesh:function(t){this.destroy(),this._vertexBuffer=new pc.VertexBuffer(this.morph._baseBuffer.device,this.morph._baseBuffer.format,this.morph._baseBuffer.numVertices,pc.BUFFER_DYNAMIC,this.morph._baseBuffer.storage.slice(0)),this._vertexData=new Float32Array(this._vertexBuffer.storage),this._weights=[],this._weights.length=this.morph._targets.length;for(let t=0;t<this.morph._targets.length;t++)this._weights[t]=0;this._dirty=!0},destroy:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._vertexBuffer=null)},getWeight:function(t){return this._weights[t]},setWeight:function(t,e){this._weights[t]=e,this._dirty=!0},updateBounds:function(t){this.morph._baseBuffer!==t.vertexBuffer&&this.morph._setBaseMesh(t),this._vertexData||this._setBaseMesh(t),this.morph._aabbDirty&&this.morph._calculateAabb()},update:function(t){this.morph._baseBuffer!==t.vertexBuffer&&this.morph._setBaseMesh(t),this._vertexData||this._setBaseMesh(t);const e=this.morph._targets,i=this._weights;let s,n;this._vertexData.set(this.morph._baseData);for(let t=0;t<e.length;t++){if(n=i[t],0===n)continue;s=e[t];const r=s.frames;if(1===r.length&&this._applyFrame(r[0],n,s),r.length>1){if(n<r[0].weight){const t=r[0],e=n/t.weight;this._applyFrame(t,e,s);continue}if(n>r[r.length-1].weight){const t=r[r.length-1],e=n/t.weight;this._applyFrame(t,e,s);continue}if(2===r.length){const t=r[0],e=r[1];this._applyFrame(t,1,s);const i=(n-t.weight)/(e.weight-t.weight);this._applyFrame(e,i,s);continue}let t,e;for(let i=0;i<r.length-1&&(t=i,e=i+1,!(r[t].weight<n&&n<r[e].weight));i++);const i=(n-r[t].weight)/(r[e].weight-r[t].weight);this._applyFrame(r[t],1-i,s),this._applyFrame(r[e],i,s)}}this._vertexBuffer.unlock()},_applyFrame:function(t,e,i){const s=t.indices.length,n=this.morph._vertSizeF,r=this.morph._offsetPF,o=this.morph._offsetNF,a=this.morph._offsetTF,c=this._vertexData;for(let o=0;o<s;o++){const s=t.deltaPositions,a=3*o,h=i.indices[o]*n+r;c[h]+=s[a]*e,c[h+1]+=s[a+1]*e,c[h+2]+=s[a+2]*e}if(t.deltaNormals){const r=t.deltaNormals;for(let t=0;t<s;t++){const s=3*t,a=i.indices[t]*n+o;c[a]+=r[s]*e,c[a+1]+=r[s+1]*e,c[a+2]+=r[s+2]*e}}if(t.deltaTangents){const r=t.deltaTangents;for(let t=0;t<s;t++){const s=4*t,o=i.indices[t]*n+a;c[o]+=r[s]*e,c[o+1]+=r[s+1]*e,c[o+2]+=r[s+2]*e,c[o+3]+=r[s+3]*e,c[o+3]=c[o+3]>0?1:-1}}}}),{MorphTarget:i,MorphTargetFrame:function(t){if(t.indices)this.indices=t.indices;else{const e=t.deltaPositions;this.indices=[],this.indices.length=e.length;for(let t=0;t<e.length;t++)this.indices[t]=t}this.deltaPositions=t.deltaPositions,this.deltaNormals=t.deltaNormals,this.deltaTangents=t.deltaTangents,this.weight=t.weight},Morph:s,MorphInstance:n}}()),Object.assign(pc,function(){const t=function(){this.meshInstances=[],this.skinInstances=[],this.morphInstance=null,this._materials=[],this._mesh=null,this._skin=null,this._bones=null,this._sortingLayerIndex=0,this._sortingOrder=0,this._cullingLayer=0,this._entity=null,this.cameras=[],this.lights=[],this._shadersVersion=0};return Object.assign(t.prototype,{getGraph:function(){return this.graph},setGraph:function(t){},getCameras:function(){return this.cameras},setCameras:function(t){this.cameras=t},getLights:function(){return this.lights},setLights:function(t){this.lights=t},getMaterials:function(){let t;this.update();const e=[];for(t=0;t<this.meshInstances.length;t++){const i=this.meshInstances[t];-1===e.indexOf(i.material)&&e.push(i.material)}return e},clone:function(){let t,e;this.update();const i=[],s=[],n=function(t){const e=t.clone();i.push(t),s.push(e);for(let i=0;i<t._children.length;i++)e.addChild(n(t._children[i]));return e},r=n(this.graph),o=[],a=[];for(t=0;t<this.skinInstances.length;t++){const i=this.skinInstances[t].skin,s=new pc.SkinInstance(i),n=[];for(e=0;e<i.boneNames.length;e++){const t=i.boneNames[e],s=r.findByName(t);n.push(s)}s.bones=n,a.push(s)}const c=this.morphInstances.morph,h=new pc.MorphInstance(c);for(t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t],n=i.indexOf(e.node),r=new pc.MeshInstance(s[n],e.mesh,e.material);if(e.skinInstance){const t=this.skinInstances.indexOf(e.skinInstance);r.skinInstance=a[t]}e.morphInstance&&(r.morphInstance=h),o.push(r)}const l=new pc.Model;return l.meshInstances=o,l.skinInstances=a,l.morphInstance=h,l.getGraph().syncHierarchy(),l},destroy:function(){const t=this.meshInstances;let e,i,s,n,r,o,a,c;for(let h=0;h<t.length;h++){if(e=t[h],i=e.mesh,i&&(i._refCount--,i._refCount<1)){for(i.vertexBuffer&&(c=c||i.vertexBuffer.device,i.vertexBuffer.destroy(),i.vertexBuffer=null),a=0;a<i.indexBuffer.length;a++)c=c||i.indexBuffer.device,r=i.indexBuffer[a],r&&r.destroy();i.indexBuffer.length=0}s=e.skinInstance,s&&(o=s.boneTexture,o&&o.destroy()),e.skinInstance=null,n=e.morphInstance,n&&n.destroy(),e.morphInstance=null,e.material=null}},generateWireframe:function(){let t,e,i,s,n,r,o,a,c,h,l,p;const u=[];for(t=0;t<this.meshInstances.length;t++)r=this.meshInstances[t].mesh,-1===u.indexOf(r)&&u.push(r);const d=[[0,1],[1,2],[2,0]];for(t=0;t<u.length;t++){r=u[t],o=r.primitive[pc.RENDERSTYLE_SOLID].base,a=r.primitive[pc.RENDERSTYLE_SOLID].count,c=r.indexBuffer[pc.RENDERSTYLE_SOLID],l=new Uint16Array(c.lock());const _={},f=[];for(e=o;e<o+a;e+=3)for(i=0;i<3;i++){s=l[e+d[i][0]],n=l[e+d[i][1]];const t=s>n?n<<16|s:s<<16|n;void 0===_[t]&&(_[t]=0,f.push(s,n))}c.unlock(),h=new pc.IndexBuffer(c.device,pc.INDEXFORMAT_UINT16,f.length),p=new Uint16Array(h.lock()),p.set(f),h.unlock(),r.primitive[pc.RENDERSTYLE_WIREFRAME]={type:pc.PRIMITIVE_LINES,base:0,count:f.length,indexed:!0},r.indexBuffer[pc.RENDERSTYLE_WIREFRAME]=h}}}),{Model:t}}());const primitiveUv1Padding=4/64,primitiveUv1PaddingScale=.875;pc.calculateNormals=function(t,e){const i=e.length/3,s=t.length/3;let n,r,o,a;const c=new pc.Vec3,h=new pc.Vec3,l=new pc.Vec3,p=new pc.Vec3,u=new pc.Vec3,d=new pc.Vec3,_=[];for(a=0;a<t.length;a++)_[a]=0;for(a=0;a<i;a++)n=e[3*a],r=e[3*a+1],o=e[3*a+2],c.set(t[3*n],t[3*n+1],t[3*n+2]),h.set(t[3*r],t[3*r+1],t[3*r+2]),l.set(t[3*o],t[3*o+1],t[3*o+2]),p.sub2(h,c),u.sub2(l,c),d.cross(p,u).normalize(),_[3*n]+=d.x,_[3*n+1]+=d.y,_[3*n+2]+=d.z,_[3*r]+=d.x,_[3*r+1]+=d.y,_[3*r+2]+=d.z,_[3*o]+=d.x,_[3*o+1]+=d.y,_[3*o+2]+=d.z;for(a=0;a<s;a++){const t=_[3*a],e=_[3*a+1],i=_[3*a+2],s=1/Math.sqrt(t*t+e*e+i*i);_[3*a]*=s,_[3*a+1]*=s,_[3*a+2]*=s}return _},pc.calculateTangents=function(t,e,i,s){const n=s.length/3,r=t.length/3;let o,a,c,h,l,p,u,d,_,f,m,g,y,E;const T=new pc.Vec3,A=new pc.Vec3,b=new pc.Vec3,S=new pc.Vec3,R=new pc.Vec3,I=new pc.Vec2,C=new pc.Vec2,M=new pc.Vec2;let v;const P=new Float32Array(3*r),O=new Float32Array(3*r),x=[];let w=0;for(v=0;v<n;v++)o=s[3*v],a=s[3*v+1],c=s[3*v+2],b.set(t[3*o],t[3*o+1],t[3*o+2]),S.set(t[3*a],t[3*a+1],t[3*a+2]),R.set(t[3*c],t[3*c+1],t[3*c+2]),I.set(i[2*o],i[2*o+1]),C.set(i[2*a],i[2*a+1]),M.set(i[2*c],i[2*c+1]),h=S.x-b.x,l=R.x-b.x,p=S.y-b.y,u=R.y-b.y,d=S.z-b.z,_=R.z-b.z,f=C.x-I.x,m=M.x-I.x,g=C.y-I.y,y=M.y-I.y,w=f*y-m*g,0===w?(T.set(0,1,0),A.set(1,0,0)):(E=1/w,T.set((y*h-g*l)*E,(y*p-g*u)*E,(y*d-g*_)*E),A.set((f*l-m*h)*E,(f*u-m*p)*E,(f*_-m*d)*E)),P[3*o+0]+=T.x,P[3*o+1]+=T.y,P[3*o+2]+=T.z,P[3*a+0]+=T.x,P[3*a+1]+=T.y,P[3*a+2]+=T.z,P[3*c+0]+=T.x,P[3*c+1]+=T.y,P[3*c+2]+=T.z,O[3*o+0]+=A.x,O[3*o+1]+=A.y,O[3*o+2]+=A.z,O[3*a+0]+=A.x,O[3*a+1]+=A.y,O[3*a+2]+=A.z,O[3*c+0]+=A.x,O[3*c+1]+=A.y,O[3*c+2]+=A.z;g=new pc.Vec3,y=new pc.Vec3;const L=new pc.Vec3,F=new pc.Vec3;for(v=0;v<r;v++){L.set(e[3*v],e[3*v+1],e[3*v+2]),g.set(P[3*v],P[3*v+1],P[3*v+2]),y.set(O[3*v],O[3*v+1],O[3*v+2]);const t=L.dot(g);F.copy(L).scale(t),F.sub2(g,F).normalize(),x[4*v]=F.x,x[4*v+1]=F.y,x[4*v+2]=F.z,F.cross(L,g),x[4*v+3]=F.dot(y)<0?-1:1}return x},pc.createMesh=function(t,e,i){const s=i&&void 0!==i.normals?i.normals:null,n=i&&void 0!==i.tangents?i.tangents:null,r=i&&void 0!==i.colors?i.colors:null,o=i&&void 0!==i.uvs?i.uvs:null,a=i&&void 0!==i.uvs1?i.uvs1:null,c=i&&void 0!==i.indices?i.indices:null,h=i&&void 0!==i.blendIndices?i.blendIndices:null,l=i&&void 0!==i.blendWeights?i.blendWeights:null,p=[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32}];null!==s&&p.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.TYPE_FLOAT32}),null!==n&&p.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.TYPE_FLOAT32}),null!==r&&p.push({semantic:pc.SEMANTIC_COLOR,components:4,type:pc.TYPE_UINT8,normalize:!0}),null!==o&&p.push({semantic:pc.SEMANTIC_TEXCOORD0,components:2,type:pc.TYPE_FLOAT32}),null!==a&&p.push({semantic:pc.SEMANTIC_TEXCOORD1,components:2,type:pc.TYPE_FLOAT32}),null!==h&&p.push({semantic:pc.SEMANTIC_BLENDINDICES,components:2,type:pc.TYPE_UINT8}),null!==l&&p.push({semantic:pc.SEMANTIC_BLENDWEIGHT,components:2,type:pc.TYPE_FLOAT32});const u=new pc.VertexFormat(t,p),d=e.length/3,_=new pc.VertexBuffer(t,u,d),f=new pc.VertexIterator(_);for(let t=0;t<d;t++)f.element[pc.SEMANTIC_POSITION].set(e[3*t],e[3*t+1],e[3*t+2]),null!==s&&f.element[pc.SEMANTIC_NORMAL].set(s[3*t],s[3*t+1],s[3*t+2]),null!==n&&f.element[pc.SEMANTIC_TANGENT].set(n[4*t],n[4*t+1],n[4*t+2],n[4*t+3]),null!==r&&f.element[pc.SEMANTIC_COLOR].set(r[4*t],r[4*t+1],r[4*t+2],r[4*t+3]),null!==o&&f.element[pc.SEMANTIC_TEXCOORD0].set(o[2*t],o[2*t+1]),null!==a&&f.element[pc.SEMANTIC_TEXCOORD1].set(a[2*t],a[2*t+1]),null!==h&&f.element[pc.SEMANTIC_BLENDINDICES].set(h[2*t],h[2*t+1]),null!==l&&f.element[pc.SEMANTIC_BLENDWEIGHT].set(l[2*t],l[2*t+1]),f.next();f.end();let m=null;const g=null!==c;if(g){m=new pc.IndexBuffer(t,pc.INDEXFORMAT_UINT16,c.length),new Uint16Array(m.lock()).set(c),m.unlock()}const y=new pc.BoundingBox;y.compute(e);const E=new pc.Mesh;return E.vertexBuffer=_,E.indexBuffer[0]=m,E.primitive[0].type=pc.PRIMITIVE_TRIANGLES,E.primitive[0].base=0,E.primitive[0].count=g?c.length:d,E.primitive[0].indexed=g,E.aabb=y,E},pc.createTorus=function(t,e){const i=e&&void 0!==e.tubeRadius?e.tubeRadius:.2,s=e&&void 0!==e.ringRadius?e.ringRadius:.3,n=e&&void 0!==e.segments?e.segments:30,r=e&&void 0!==e.sides?e.sides:20,o=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;let a,c,h,l,p,u,d,_,f,m;const g=[],y=[],E=[],T=[];for(a=0;a<=r;a++)for(c=0;c<=n;c++)if(h=Math.cos(2*Math.PI*c/n)*(s+i*Math.cos(2*Math.PI*a/r)),l=Math.sin(2*Math.PI*a/r)*i,p=Math.sin(2*Math.PI*c/n)*(s+i*Math.cos(2*Math.PI*a/r)),u=Math.cos(2*Math.PI*c/n)*Math.cos(2*Math.PI*a/r),d=Math.sin(2*Math.PI*a/r),_=Math.sin(2*Math.PI*c/n)*Math.cos(2*Math.PI*a/r),f=a/r,m=1-c/n,g.push(h,l,p),y.push(u,d,_),E.push(f,m),a<r&&c<n){const t=a*(n+1)+c,e=(a+1)*(n+1)+c,i=a*(n+1)+(c+1),s=(a+1)*(n+1)+(c+1);T.push(t,e,i),T.push(e,s,i)}const A={normals:y,uvs:E,indices:T};return o&&(A.tangents=pc.calculateTangents(g,y,E,T)),pc.createMesh(t,g,A)},pc._createConeData=function(t,e,i,s,n,r){let o,a,c,h,l,p,u;const d=new pc.Vec3,_=new pc.Vec3,f=new pc.Vec3;let m,g,y;const E=[],T=[],A=[],b=[],S=[];let R,I,C,M,v,P,O,x,w,L,F;if(i>0)for(o=0;o<=s;o++)for(a=0;a<=n;a++){R=a/n*2*Math.PI-Math.PI,C=Math.sin(R),I=Math.cos(R),g=new pc.Vec3(C*t,-i/2,I*t),m=new pc.Vec3(C*e,i/2,I*e),d.lerp(g,m,o/s),_.sub2(m,g).normalize(),y=new pc.Vec3(I,0,-C),f.cross(y,_).normalize(),E.push(d.x,d.y,d.z),T.push(f.x,f.y,f.z),p=a/n,u=o/s,A.push(p,u);const r=u;u=p,p=r,p/=3,p=.875*p+4/64,u=.875*u+4/64,b.push(p,u),o<s&&a<n&&(O=o*(n+1)+a,x=o*(n+1)+(a+1),w=(o+1)*(n+1)+a,L=(o+1)*(n+1)+(a+1),S.push(O,x,w),S.push(x,L,w))}if(r){let t,r;const o=Math.floor(n/2),a=n,d=i/2;for(t=0;t<=o;t++)for(R=t*Math.PI*.5/o,C=Math.sin(R),I=Math.cos(R),r=0;r<=a;r++)M=2*r*Math.PI/a-Math.PI/2,v=Math.sin(M),P=Math.cos(M),c=P*C,h=I,l=v*C,p=1-r/a,u=1-t/o,E.push(c*e,h*e+d,l*e),T.push(c,h,l),A.push(p,u),p/=3,u/=3,p=.875*p+4/64,u=.875*u+4/64,p+=1/3,b.push(p,u);for(F=(s+1)*(n+1),t=0;t<o;++t)for(r=0;r<a;++r)O=t*(a+1)+r,x=O+a+1,S.push(F+O+1,F+x,F+O),S.push(F+O+1,F+x+1,F+x);for(t=0;t<=o;t++)for(R=.5*Math.PI+t*Math.PI*.5/o,C=Math.sin(R),I=Math.cos(R),r=0;r<=a;r++)M=2*r*Math.PI/a-Math.PI/2,v=Math.sin(M),P=Math.cos(M),c=P*C,h=I,l=v*C,p=1-r/a,u=1-t/o,E.push(c*e,h*e-d,l*e),T.push(c,h,l),A.push(p,u),p/=3,u/=3,p=.875*p+4/64,u=.875*u+4/64,p+=2/3,b.push(p,u);for(F=(s+1)*(n+1)+(a+1)*(o+1),t=0;t<o;++t)for(r=0;r<a;++r)O=t*(a+1)+r,x=O+a+1,S.push(F+O+1,F+x,F+O),S.push(F+O+1,F+x+1,F+x)}else{if(F=(s+1)*(n+1),t>0)for(o=0;o<n;o++)R=o/n*2*Math.PI,c=Math.sin(R),h=-i/2,l=Math.cos(R),p=1-(c+1)/2,u=(l+1)/2,E.push(c*t,h,l*t),T.push(0,-1,0),A.push(p,u),p/=3,u/=3,p=.875*p+4/64,u=.875*u+4/64,p+=1/3,b.push(p,u),o>1&&S.push(F,F+o,F+o-1);if(F+=n,e>0)for(o=0;o<n;o++)R=o/n*2*Math.PI,c=Math.sin(R),h=i/2,l=Math.cos(R),p=1-(c+1)/2,u=(l+1)/2,E.push(c*e,h,l*e),T.push(0,1,0),A.push(p,u),p/=3,u/=3,p=.875*p+4/64,u=.875*u+4/64,p+=2/3,b.push(p,u),o>1&&S.push(F,F+o-1,F+o)}return{positions:E,normals:T,uvs:A,uvs1:b,indices:S}},pc.createCylinder=function(t,e){e&&e.hasOwnProperty("baseRadius")&&!e.hasOwnProperty("radius")&&console.warn('DEPRECATED: "baseRadius" in arguments, use "radius" instead');let i=e&&(e.radius||e.baseRadius);i=void 0!==i?i:.5;const s=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:5,r=e&&void 0!==e.capSegments?e.capSegments:20,o=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,a=pc._createConeData(i,i,s,n,r,!1);return o&&(a.tangents=pc.calculateTangents(a.positions,a.normals,a.uvs,a.indices)),pc.createMesh(t,a.positions,a)},pc.createCapsule=function(t,e){const i=e&&void 0!==e.radius?e.radius:.3,s=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:1,r=e&&void 0!==e.sides?e.sides:20,o=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,a=pc._createConeData(i,i,s-2*i,n,r,!0);return o&&(a.tangents=pc.calculateTangents(a.positions,a.normals,a.uvs,a.indices)),pc.createMesh(t,a.positions,a)},pc.createCone=function(t,e){const i=e&&void 0!==e.baseRadius?e.baseRadius:.5,s=e&&void 0!==e.peakRadius?e.peakRadius:0,n=e&&void 0!==e.height?e.height:1,r=e&&void 0!==e.heightSegments?e.heightSegments:5,o=e&&void 0!==e.capSegments?e.capSegments:18,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,c=pc._createConeData(i,s,n,r,o,!1);return a&&(c.tangents=pc.calculateTangents(c.positions,c.normals,c.uvs,c.indices)),pc.createMesh(t,c.positions,c)},pc.createSphere=function(t,e){const i=e&&void 0!==e.radius?e.radius:.5,s=e&&void 0!==e.latitudeBands?e.latitudeBands:16,n=e&&void 0!==e.longitudeBands?e.longitudeBands:16,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;let o,a,c,h,l,p,u,d,_,f,m,g,y,E,T;const A=[],b=[],S=[],R=[];for(a=0;a<=s;a++)for(c=a*Math.PI/s,h=Math.sin(c),l=Math.cos(c),o=0;o<=n;o++)p=2*o*Math.PI/n-Math.PI/2,u=Math.sin(p),d=Math.cos(p),m=d*h,g=l,y=u*h,E=1-o/n,T=1-a/s,A.push(m*i,g*i,y*i),b.push(m,g,y),S.push(E,T);for(a=0;a<s;++a)for(o=0;o<n;++o)_=a*(n+1)+o,f=_+n+1,R.push(_+1,f,_),R.push(_+1,f+1,f);const I={normals:b,uvs:S,uvs1:S,indices:R};return r&&(I.tangents=pc.calculateTangents(A,b,S,R)),pc.createMesh(t,A,I)},pc.createPlane=function(t,e){const i=e&&void 0!==e.halfExtents?e.halfExtents:new pc.Vec2(.5,.5),s=e&&void 0!==e.widthSegments?e.widthSegments:5,n=e&&void 0!==e.lengthSegments?e.lengthSegments:5,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;let o,a,c,h,l,p,u;const d=[],_=[],f=[],m=[];let g=0;for(o=0;o<=s;o++)for(a=0;a<=n;a++)c=(-i.x+2*i.x*o)/s,h=0,l=-(-i.y+2*i.y*a)/n,p=o/s,u=a/n,d.push(c,0,l),_.push(0,1,0),f.push(p,u),o<s&&a<n&&(m.push(g+n+1,g+1,g),m.push(g+n+1,g+n+2,g+1)),g++;const y={normals:_,uvs:f,uvs1:f,indices:m};return r&&(y.tangents=pc.calculateTangents(d,_,f,m)),pc.createMesh(t,d,y)},pc.createBox=function(t,e){const i=e&&void 0!==e.halfExtents?e.halfExtents:new pc.Vec3(.5,.5,.5),s=e&&void 0!==e.widthSegments?e.widthSegments:1,n=e&&void 0!==e.lengthSegments?e.lengthSegments:1,r=e&&void 0!==e.heightSegments?e.heightSegments:1,o=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,a=[new pc.Vec3(-i.x,-i.y,i.z),new pc.Vec3(i.x,-i.y,i.z),new pc.Vec3(i.x,i.y,i.z),new pc.Vec3(-i.x,i.y,i.z),new pc.Vec3(i.x,-i.y,-i.z),new pc.Vec3(-i.x,-i.y,-i.z),new pc.Vec3(-i.x,i.y,-i.z),new pc.Vec3(i.x,i.y,-i.z)],c=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],h=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],l=1,p=2,u=3,d=4,_=5,f=[],m=[],g=[],y=[],E=[];let T=0;const A=function(t,e,i){let s,n,r,o;for(r=0;r<=e;r++)for(o=0;o<=i;o++){const l=new pc.Vec3,p=new pc.Vec3,u=new pc.Vec3,d=new pc.Vec3;l.lerp(a[c[t][0]],a[c[t][1]],r/e),p.lerp(a[c[t][0]],a[c[t][2]],o/i),u.sub2(p,a[c[t][0]]),d.add2(l,u),s=r/e,n=o/i,f.push(d.x,d.y,d.z),m.push(h[t][0],h[t][1],h[t][2]),g.push(s,n),s/=3,n/=3,s=.875*s+4/64,n=.875*n+4/64,s+=t%3/3,n+=Math.floor(t/3)/3,y.push(s,n),r<e&&o<i&&(E.push(T+i+1,T+1,T),E.push(T+i+1,T+i+2,T+1)),T++}};A(0,s,r),A(l,s,r),A(p,s,n),A(u,s,n),A(d,n,r),A(_,n,r);const b={normals:m,uvs:g,uvs1:y,indices:E};return o&&(b.tangents=pc.calculateTangents(f,m,g,E)),pc.createMesh(t,f,b)},pc.getDefaultMaterial=function(){return pc.Application.getApplication().scene.defaultMaterial},Object.assign(pc,function(){const t=function(t){this.func=void 0===t.func?pc.FUNC_ALWAYS:t.func,this.ref=t.ref||0,this.readMask=void 0===t.readMask?255:t.readMask,this.writeMask=void 0===t.writeMask?255:t.writeMask,this.fail=t.fail||pc.STENCILOP_KEEP,this.zfail=t.zfail||pc.STENCILOP_KEEP,this.zpass=t.zpass||pc.STENCILOP_KEEP};return t.prototype.clone=function(){return new pc.StencilParameters({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})},{StencilParameters:t}}()),Object.assign(pc,function(){const t=function(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}};return t.prototype.getDuration=function(){return this.duration},t.prototype.getName=function(){return this.name},t.prototype.getNode=function(t){return this._nodeDict[t]},Object.defineProperty(t.prototype,"nodes",{get:function(){return this._nodes}}),t.prototype.getNodes=function(){return this._nodes},t.prototype.setDuration=function(t){this.duration=t},t.prototype.setName=function(t){this.name=t},t.prototype.addNode=function(t){this._nodes.push(t),this._nodeDict[t._name]=t},{Animation:t,Key:function(t,e,i,s){this.time=t,this.position=e,this.rotation=i,this.scale=s},Node:function(){this._name="",this._keys=[]}}}()),Object.assign(pc,function(){function t(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new pc.Quat,this._pos=new pc.Vec3,this._scale=new pc.Vec3,this._targetNode=null}Object.assign(t.prototype,{getTarget:function(){return this._targetNode},setTarget:function(t){this._targetNode=t}});const e=function(e){this._animation=null,this._time=0,this.looping=!0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={};const i=this;!function e(s){const n=new t;n._name=s.name,i._interpolatedKeys.push(n),i._interpolatedKeyDict[s.name]=n,i._currKeyIndices[s.name]=0;for(let t=0;t<s._children.length;t++)e(s._children[t])}(e)};return e.prototype.addTime=function(t){if(null!==this._animation){let e,i,s,n,r,o,a,c;const h=this._animation._nodes,l=this._animation.duration;if(this._time===l&&!this.looping)return;if(this._time+=t,this._time>l)for(this._time=this.looping?0:l,e=0;e<h.length;e++)i=h[e],s=i._name,this._currKeyIndices[s]=0;else if(this._time<0)for(this._time=this.looping?l:0,e=0;e<h.length;e++)i=h[e],s=i._name,this._currKeyIndices[s]=i._keys.length-2;const p=t>=0?1:-1;let u;for(e=0;e<h.length;e++){if(i=h[e],s=i._name,n=i._keys,r=this._interpolatedKeyDict[s],u=!1,1!==n.length)for(let t=this._currKeyIndices[s];t<n.length-1&&t>=0;t+=p)if(o=n[t],a=n[t+1],o.time<=this._time&&a.time>=this._time){c=(this._time-o.time)/(a.time-o.time),r._pos.lerp(o.position,a.position,c),r._quat.slerp(o.rotation,a.rotation,c),r._scale.lerp(o.scale,a.scale,c),r._written=!0,this._currKeyIndices[s]=t,u=!0;break}(1===n.length||!u&&0===this._time&&this.looping)&&(r._pos.copy(n[0].position),r._quat.copy(n[0].rotation),r._scale.copy(n[0].scale),r._written=!0)}}},e.prototype.blend=function(t,e,i){const s=this._interpolatedKeys.length;for(let n=0;n<s;n++){const s=t._interpolatedKeys[n],r=e._interpolatedKeys[n],o=this._interpolatedKeys[n];s._written&&r._written?(o._quat.slerp(s._quat,e._interpolatedKeys[n]._quat,i),o._pos.lerp(s._pos,e._interpolatedKeys[n]._pos,i),o._scale.lerp(s._scale,r._scale,i),o._written=!0):s._written?(o._quat.copy(s._quat),o._pos.copy(s._pos),o._scale.copy(s._scale),o._written=!0):r._written&&(o._quat.copy(r._quat),o._pos.copy(r._pos),o._scale.copy(r._scale),o._written=!0)}},Object.defineProperty(e.prototype,"animation",{get:function(){return this._animation},set:function(t){this._animation=t,this.currentTime=0}}),e.prototype.getAnimation=function(){return this._animation},Object.defineProperty(e.prototype,"currentTime",{get:function(){return this._time},set:function(t){this._time=t;const e=this._interpolatedKeys.length;for(let t=0;t<e;t++){const e=this._interpolatedKeys[t]._name;this._currKeyIndices[e]=0}this.addTime(0),this.updateGraph()}}),e.prototype.getCurrentTime=function(){return this._time},e.prototype.setCurrentTime=function(t){this.currentTime=t},Object.defineProperty(e.prototype,"numNodes",{get:function(){return this._interpolatedKeys.length}}),e.prototype.getNumNodes=function(){return this._interpolatedKeys.length},e.prototype.setAnimation=function(t){this.animation=t},e.prototype.setGraph=function(t){let e;if(t)for(e=0;e<this._interpolatedKeys.length;e++){const i=this._interpolatedKeys[e],s=t.findByName(i._name);this._interpolatedKeys[e].setTarget(s)}else for(e=0;e<this._interpolatedKeys.length;e++)this._interpolatedKeys[e].setTarget(null)},e.prototype.updateGraph=function(){if(this.graph)for(let t=0;t<this._interpolatedKeys.length;t++){const e=this._interpolatedKeys[t];if(e._written){const t=e.getTarget();t.localPosition.copy(e._pos),t.localRotation.copy(e._quat),t.localScale.copy(e._scale),t._dirtifyLocal(),e._written=!1}}},e.prototype.setLooping=function(t){this.looping=t},e.prototype.getLooping=function(){return this.looping},{Skeleton:e}}()),Object.assign(pc,function(){function t(){return"undefined"!=typeof Audio}function e(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}const i=function(i){if(e()||i.forceWebAudioApi){if("undefined"!=typeof AudioContext?this.context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context){const t=this.context;if(this.resumeContext=function(){this.context.resume(),window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext)}.bind(this),window.addEventListener("mousedown",this.resumeContext),window.addEventListener("touchend",this.resumeContext),pc.platform.ios){const e=function(){const s=t.createBuffer(1,1,44100),n=t.createBufferSource();n.buffer=s,n.connect(t.destination),n.start(0),n.disconnect(),i.canvas.removeEventListener("touchstart",e)};i.canvas.addEventListener("touchstart",e)}}}else console.warn("No support for 3D audio found");t()||console.warn("No support for 2D audio found"),this.listener=new pc.Listener(this),this._volume=1,this.suspended=!1,pc.events.attach(this)};return i.hasAudio=t,i.hasAudioContext=e,Object.assign(i.prototype,{suspend:function(){this.suspended=!0,this.fire("suspend")},resume:function(){this.suspended=!1,this.fire("resume")},destroy:function(){window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext),this.fire("destroy"),this.context&&this.context.close&&(this.context.close(),this.context=null)},getListener:function(){return console.warn('DEPRECATED: getListener is deprecated. Get the "listener" field instead.'),this.listener},getVolume:function(){return console.warn('DEPRECATED: getVolume is deprecated. Get the "volume" property instead.'),this.volume},setVolume:function(t){console.warn('DEPRECATED: setVolume is deprecated. Set the "volume" property instead.'),this.volume=t},playSound:function(t,e){e=e||{};let i=null;return pc.Channel&&(i=new pc.Channel(this,t,e),i.play()),i},playSound3d:function(t,e,i){i=i||{};let s=null;return pc.Channel3d&&(s=new pc.Channel3d(this,t,i),s.setPosition(e),i.volume&&s.setVolume(i.volume),i.loop&&s.setLoop(i.loop),i.maxDistance&&s.setMaxDistance(i.maxDistance),i.minDistance&&s.setMinDistance(i.minDistance),i.rollOffFactor&&s.setRollOffFactor(i.rollOffFactor),i.distanceModel&&s.setDistanceModel(i.distanceModel),s.play()),s}}),Object.defineProperty(i.prototype,"volume",{get:function(){return this._volume},set:function(t){t=pc.math.clamp(t,0,1),this._volume=t,this.fire("volumechange",t)}}),pc.AudioManager=i,{SoundManager:i}}()),Object.assign(pc,function(){const t=function(t){t instanceof Audio?this.audio=t:this.buffer=t};return Object.defineProperty(t.prototype,"duration",{get:function(){let t=0;return this.buffer?t=this.buffer.duration:this.audio&&(t=this.audio.duration),t||0}}),{Sound:t}}()),Object.assign(pc,function(){const t=function(t){this.position=new pc.Vec3,this.velocity=new pc.Vec3,this.orientation=new pc.Mat4,pc.AudioManager.hasAudioContext()&&(this.listener=t.context.listener)};return Object.assign(t.prototype,{getPosition:function(){return this.position},setPosition:function(t){this.position.copy(t),this.listener&&this.listener.setPosition(t.x,t.y,t.z)},getVelocity:function(){return this.velocity},setVelocity:function(t){this.velocity.copy(t),this.listener&&this.listener.setPosition(t.x,t.y,t.z)},setOrientation:function(t){this.orientation.copy(t),this.listener&&this.listener.setOrientation(-t.data[8],-t.data[9],-t.data[10],t.data[4],t.data[5],t.data[6])},getOrientation:function(){return this.orientation}}),{Listener:t}}()),Object.assign(pc,function(){let t;const e=function(t,e){return t%e||0};return pc.SoundManager.hasAudioContext()?(t=function(t,e,i){pc.events.attach(this),i=i||{},this._volume=void 0!==i.volume?pc.math.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=e,this._state=2,this._suspended=!1,this._suspendEndEvent=!1,this._suspendInstanceEvents=!1,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startedAt=0,this._startOffset=null,this._currentTime=0,this._currentOffset=0,this._playWhenLoaded=!0,this._manager=t,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._initializeNodes(),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this._endedHandler=this._onEnded.bind(this),this.source=null},Object.assign(t.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)},play:function(){"running"!==this._manager.context.state&&this._manager.context.resume(),2!==this._state&&this.stop(),this.source||this._createSource();let t=e(this._startOffset,this.duration);return t=e(this._startTime+t,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=t,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0},pause:function(){return!(0!==this._state||!this.source)&&(this._updateCurrentTime(),this._state=1,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._playWhenLoaded=!1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();let t=this.currentTime;return null!==this._startOffset&&(t=e(this._startOffset,this.duration),t=e(this._startTime+t,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=t,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0},stop:function(){return!(2===this._state||!this.source)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._playWhenLoaded=!1,this._suspendEndEvent=!0,0===this._state&&this.source.stop(0),this.source.removeEventListener("ended",this._endedHandler),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(t,e){if(!t)return void console.error("The firstNode must be a valid Audio Node");e||(e=t);const i=this._manager.context.destination;this._firstNode!==t&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(i),this._firstNode=t,this._connectorNode.connect(t)),this._lastNode!==e&&(this._lastNode&&this._lastNode.disconnect(i),this._lastNode=e,this._lastNode.connect(i))},clearExternalNodes:function(){const t=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(t),this._lastNode=null),this._connectorNode.connect(t)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;const t=this._manager.context;return this._sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.addEventListener("ended",this._endedHandler),this.source.loopStart=e(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,e(this._startTime+this._duration,this.source.buffer.duration)))),this.source},_updateCurrentTime:function(){this._currentTime=e((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){t=pc.math.clamp(t,0,1),this._volume=t,this.gain&&(this.gain.gain.value=t*this._manager.volume)}}),Object.defineProperty(t.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(t.prototype,"sound",{get:function(){return this._sound},set:function(t){this._sound=t,2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(t){if(!(t<0))if(0===this._state){this.stop();const e=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this._startOffset=t,this.play(),this._suspendInstanceEvents=e}else this._startOffset=t,this._currentTime=t}})):pc.SoundManager.hasAudio()?(t=function(t,e,i){pc.events.attach(this),i=i||{},this._volume=void 0!==i.volume?pc.math.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=e,this._state=2,this._suspended=!1,this._suspendEndEvent=!1,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startOffset=null,this._isReady=!1,this._manager=t,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this.source=null,this._createSource()},Object.assign(t.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let t=e(this._startOffset,this.duration);t=e(this._startTime+t,this._sound.duration),this._startOffset=null,this.source.currentTime=t},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>e(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=e(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){t=pc.math.clamp(t,0,1),this._volume=t,this.source&&(this.source.volume=t*this._manager.volume)}}),Object.defineProperty(t.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(t.prototype,"sound",{get:function(){return this._sound},set:function(t){this.stop(),this._sound=t}}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(t){t<0||(this._startOffset=t,this.source&&this._isReady&&(this.source.currentTime=e(this._startTime+e(t,this.duration),this._sound.duration),this._startOffset=null))}})):t=function(){},Object.assign(t.prototype,{_onPlay:function(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)},_onPause:function(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)},_onResume:function(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)},_onStop:function(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)},_onEnded:function(){pc.SoundInstance.doNotSuspendEndEvent||!this._suspendEndEvent?(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop()):this._suspendEndEvent=!1},_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this._startTime},set:function(t){this._startTime=Math.max(0,Number(t)||0);const e=0===this._state;this.stop(),e&&this.play()}}),Object.defineProperty(t.prototype,"duration",{get:function(){return this._sound?this._duration?e(this._duration,this._sound.duration):this._sound.duration:0},set:function(t){this._duration=Math.max(0,Number(t)||0);const e=0===this._state;this.stop(),e&&this.play()}}),Object.defineProperty(t.prototype,"isPlaying",{get:function(){return 0===this._state}}),Object.defineProperty(t.prototype,"isPaused",{get:function(){return 1===this._state}}),Object.defineProperty(t.prototype,"isStopped",{get:function(){return 2===this._state}}),Object.defineProperty(t.prototype,"isSuspended",{get:function(){return this._suspended}}),{SoundInstance:t}}()),Object.assign(pc,function(){let t;if(pc.SoundManager.hasAudioContext())t=function(t,e,i){pc.SoundInstance.call(this,t,e,i),i=i||{},this._position=new pc.Vec3,i.position&&(this.position=i.position),this._velocity=new pc.Vec3,i.velocity&&(this.velocity=i.velocity),this.maxDistance=void 0!==i.maxDistance?Number(i.maxDistance):1e4,this.refDistance=void 0!==i.refDistance?Number(i.refDistance):1,this.rollOffFactor=void 0!==i.rollOffFactor?Number(i.rollOffFactor):1,this.distanceModel=void 0!==i.distanceModel?i.distanceModel:pc.DISTANCE_LINEAR},t.prototype=Object.create(pc.SoundInstance.prototype),t.prototype.constructor=t,Object.assign(t.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position.copy(t),this.panner.setPosition(t.x,t.y,t.z)}}),Object.defineProperty(t.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)}}),Object.defineProperty(t.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(t){this.panner.maxDistance=t}}),Object.defineProperty(t.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(t){this.panner.refDistance=t}}),Object.defineProperty(t.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(t){this.panner.rolloffFactor=t}}),Object.defineProperty(t.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(t){this.panner.distanceModel=t}});else if(pc.SoundManager.hasAudio()){let e=new pc.Vec3;const i=function(t,i,s,n,r,o){e=e.sub2(t,i);const a=e.length();if(a<s)return 1;if(a>n)return 0;let c=0;return o===pc.DISTANCE_LINEAR?c=1-r*(a-s)/(n-s):o===pc.DISTANCE_INVERSE?c=s/(s+r*(a-s)):o===pc.DISTANCE_EXPONENTIAL&&(c=Math.pow(a/s,-r)),pc.math.clamp(c,0,1)};t=function(t,e,i){pc.SoundInstance.call(this,t,e,i),i=i||{},this._position=new pc.Vec3,i.position&&(this.position=i.position),this._velocity=new pc.Vec3,i.velocity&&(this.velocity=i.velocity),this._maxDistance=void 0!==i.maxDistance?Number(i.maxDistance):1e4,this._refDistance=void 0!==i.refDistance?Number(i.refDistance):1,this._rollOffFactor=void 0!==i.rollOffFactor?Number(i.rollOffFactor):1,this._distanceModel=void 0!==i.distanceModel?i.distanceModel:pc.DISTANCE_LINEAR},t.prototype=Object.create(pc.SoundInstance.prototype),t.prototype.constructor=t,Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){const t=this._manager.listener.getPosition(),e=i(t,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),s=this.volume;this.source.volume=s*e*this._manager.volume}}}),Object.defineProperty(t.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t)}}),Object.defineProperty(t.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty(t.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty(t.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty(t.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}else t=function(){};return{SoundInstance3d:t}}()),Object.assign(pc,function(){let t;return pc.AudioManager.hasAudioContext()?(t=function(t,e,i){i=i||{},this.volume=void 0===i.volume?1:i.volume,this.loop=void 0!==i.loop&&i.loop,this.pitch=void 0===i.pitch?1:i.pitch,this.sound=e,this.paused=!1,this.suspended=!1,this.startTime=0,this.startOffset=0,this.manager=t,this.source=null;const s=t.context;this.gain=s.createGain()},Object.assign(t.prototype,{play:function(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){!this.source&&this.paused?(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)):console.warn("Call pause() before unpausing.")},stop:function(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setLoop:function(t){this.loop=t,this.source&&(this.source.loop=t)},setVolume:function(t){t=pc.math.clamp(t,0,1),this.volume=t,this.gain&&(this.gain.gain.value=t*this.manager.volume)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate.value=t)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){const t=this.manager.context;this.sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this)))}})):pc.AudioManager.hasAudio()?(t=function(t,e,i){this.volume=i.volume||1,this.loop=i.loop||!1,this.sound=e,this.pitch=void 0!==i.pitch?i.pitch:1,this.paused=!1,this.suspended=!1,this.manager=t,e.audio&&(this.source=e.audio.cloneNode(!1),this.source.pause())},Object.assign(t.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(t){t=pc.math.clamp(t,0,1),this.volume=t,this.source&&(this.source.volume=t*this.manager.volume)},setLoop:function(t){this.loop=t,this.source&&(this.source.loop=t)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate=t)},getDuration:function(){return this.source&&!Number.isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}})):t=function(){},Object.assign(t.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}}),{Channel:t}}()),Object.assign(pc,function(){let t;if(pc.AudioManager.hasAudioContext())t=function(t,e,i){pc.Channel.call(this,t,e,i),this.position=new pc.Vec3,this.velocity=new pc.Vec3;const s=t.context;this.panner=s.createPanner()},t.prototype=Object.create(pc.Channel.prototype),t.prototype.constructor=t,Object.assign(t.prototype,{getPosition:function(){return this.position},setPosition:function(t){this.position.copy(t),this.panner.setPosition(t.x,t.y,t.z)},getVelocity:function(){return this.velocity},setVelocity:function(t){this.velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(t){this.panner.maxDistance=t},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(t){this.panner.refDistance=t},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(t){this.panner.rolloffFactor=t},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(t){this.panner.distanceModel=t},_createSource:function(){const t=this.manager.context;this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this))}});else if(pc.AudioManager.hasAudio()){let e=new pc.Vec3;const i=function(t,i,s,n,r,o){e=e.sub2(t,i);const a=e.length();if(a<s)return 1;if(a>n)return 0;let c=0;return o===pc.DISTANCE_LINEAR?c=1-r*(a-s)/(n-s):o===pc.DISTANCE_INVERSE?c=s/(s+r*(a-s)):o===pc.DISTANCE_EXPONENTIAL&&(c=Math.pow(a/s,-r)),pc.math.clamp(c,0,1)};t=function(t,e){pc.Channel.call(this,t,e),this.position=new pc.Vec3,this.velocity=new pc.Vec3,this.maxDistance=1e4,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=pc.DISTANCE_INVERSE},t.prototype=Object.create(pc.Channel.prototype),t.prototype.constructor=t,Object.assign(t.prototype,{getPosition:function(){return this.position},setPosition:function(t){if(this.position.copy(t),this.source){const t=this.manager.listener.getPosition(),e=i(t,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),s=this.getVolume();this.source.volume=s*e}},getVelocity:function(){return this.velocity},setVelocity:function(t){this.velocity.copy(t)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(t){this.maxDistance=t},getMinDistance:function(){return this.minDistance},setMinDistance:function(t){this.minDistance=t},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(t){this.rollOffFactor=t},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(t){this.distanceModel=t}})}else t=function(){};return{Channel3d:t}}()),function(){const t={ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:13,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224,MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2,PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3};Object.assign(pc,t),pc.input={},Object.assign(pc.input,t)}(),Object.assign(pc,function(){const t=function(t,e){e?(this.key=e.keyCode,this.element=e.target,this.event=e):(this.key=null,this.element=null,this.event=null)},e=new t;function i(t){return e.key=t.keyCode,e.element=t.target,e.event=t,e}function s(t){return"string"==typeof t?t.toUpperCase().charCodeAt(0):t}const n={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},r=function(t,e){e=e||{},this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),pc.events.attach(this),this._keymap={},this._lastmap={},t&&this.attach(t),this.preventDefault=e.preventDefault||!1,this.stopPropagation=e.stopPropagation||!1};return r.prototype.attach=function(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1)},r.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null},r.prototype.toKeyIdentifier=function(t){let e,i;t=s(t);const r=n[t.toString()];if(r)return r;i=t.toString(16).toUpperCase();const o=i.length;for(e=0;e<4-o;e++)i="0"+i;return"U+"+i},r.prototype._handleKeyDown=function(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);this._keymap[s]=!0,this.fire("keydown",i(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()},r.prototype._handleKeyUp=function(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);delete this._keymap[s],this.fire("keyup",i(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()},r.prototype._handleKeyPress=function(t){this.fire("keypress",i(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()},r.prototype.update=function(){let t;for(t in this._lastmap)this._lastmap.hasOwnProperty(t)&&delete this._lastmap[t];for(t in this._keymap)this._keymap.hasOwnProperty(t)&&(this._lastmap[t]=this._keymap[t])},r.prototype.isPressed=function(t){const e=s(t),i=this.toKeyIdentifier(e);return!!this._keymap[i]},r.prototype.wasPressed=function(t){const e=s(t),i=this.toKeyIdentifier(e);return!!this._keymap[i]&&!this._lastmap[i]},r.prototype.wasReleased=function(t){const e=s(t),i=this.toKeyIdentifier(e);return!this._keymap[i]&&!!this._lastmap[i]},r.prototype.anyKey=function(){return Object.keys(this._keymap).length>0},r.prototype.anyKeyDown=function(){for(const t in this._keymap)if(this._keymap.hasOwnProperty(t)&&!this._lastmap.hasOwnProperty(t))return!0;return!1},{Keyboard:r,KeyboardEvent:t}}()),Object.assign(pc,function(){const t=function(e,i){let s={x:0,y:0};if(i){if(i instanceof t)throw Error("Expected MouseEvent");s=e._getTargetCoords(i)}else i={};if(s)this.x=s.x,this.y=s.y;else{if(!pc.Mouse.isPointerLocked())return;this.x=0,this.y=0}i.detail?this.wheel=-1*i.detail:i.wheelDelta?this.wheel=i.wheelDelta/120:this.wheel=0,pc.Mouse.isPointerLocked()?(this.dx=i.movementX||i.webkitMovementX||i.mozMovementX||0,this.dy=i.movementY||i.webkitMovementY||i.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),"mousedown"===i.type||"mouseup"===i.type?this.button=i.button:this.button=pc.MOUSEBUTTON_NONE,this.buttons=e._buttons.slice(0),this.element=i.target,this.ctrlKey=i.ctrlKey||!1,this.altKey=i.altKey||!1,this.shiftKey=i.shiftKey||!1,this.metaKey=i.metaKey||!1,this.event=i},e=function(t){this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=function(t){t.preventDefault()},this._target=null,this._attached=!1,this.attach(t),pc.events.attach(this)};return e.isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},Object.assign(e.prototype,{attach:function(t){this._target=t,this._attached||(this._attached=!0,window.addEventListener("mouseup",this._upHandler,!1),window.addEventListener("mousedown",this._downHandler,!1),window.addEventListener("mousemove",this._moveHandler,!1),window.addEventListener("mousewheel",this._wheelHandler,!1),window.addEventListener("DOMMouseScroll",this._wheelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,this._target=null,window.removeEventListener("mouseup",this._upHandler),window.removeEventListener("mousedown",this._downHandler),window.removeEventListener("mousemove",this._moveHandler),window.removeEventListener("mousewheel",this._wheelHandler),window.removeEventListener("DOMMouseScroll",this._wheelHandler))},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(t,e){if(!document.body.requestPointerLock)return void(e&&e());const i=function(){t(),document.removeEventListener("pointerlockchange",i)},s=function(){e(),document.removeEventListener("pointerlockerror",s)};t&&document.addEventListener("pointerlockchange",i,!1),e&&document.addEventListener("pointerlockerror",s,!1),document.body.requestPointerLock()},disablePointerLock:function(t){if(!document.exitPointerLock)return;const e=function(){t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()},update:function(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]},isPressed:function(t){return this._buttons[t]},wasPressed:function(t){return this._buttons[t]&&!this._lastbuttons[t]},wasReleased:function(t){return!this._buttons[t]&&this._lastbuttons[t]},_handleUp:function(e){this._buttons[e.button]=!1;const i=new t(this,e);i.event&&this.fire(pc.EVENT_MOUSEUP,i)},_handleDown:function(e){this._buttons[e.button]=!0;const i=new t(this,e);i.event&&this.fire(pc.EVENT_MOUSEDOWN,i)},_handleMove:function(e){const i=new t(this,e);i.event&&(this.fire(pc.EVENT_MOUSEMOVE,i),this._lastX=i.x,this._lastY=i.y)},_handleWheel:function(e){const i=new t(this,e);i.event&&this.fire(pc.EVENT_MOUSEWHEEL,i)},_getTargetCoords:function(t){const e=this._target.getBoundingClientRect(),i=Math.floor(e.left),s=Math.floor(e.top);return t.clientX<i||t.clientX>=i+this._target.clientWidth||t.clientY<s||t.clientY>=s+this._target.clientHeight?null:{x:t.clientX-i,y:t.clientY-s}}}),{Mouse:e,MouseEvent:t}}()),Object.assign(pc,function(){const t=function(t,e){const i=pc.getTouchTargetCoords(t,e);this.id=t.identifier,this.x=i.x,this.y=i.y,this.target=e||t.target,this.touch=t},e=function(e,i,s){if(this.element=s||i.target,this.event=i,this.touches=[],this.changedTouches=[],i){let e,s=i.touches.length;for(e=0;e<s;e++)this.touches.push(new t(i.touches[e],this.element));for(s=i.changedTouches.length,e=0;e<s;e++)this.changedTouches.push(new t(i.changedTouches[e],this.element))}};Object.assign(e.prototype,{getTouchById:function(t,e){let i;const s=e.length;for(i=0;i<s;i++)if(e[i].id===t)return e[i];return null}});const i=function(t){this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(t),pc.events.attach(this)};return Object.assign(i.prototype,{attach:function(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null},_handleTouchStart:function(t){this.fire("touchstart",new e(this,t))},_handleTouchEnd:function(t){this.fire("touchend",new e(this,t))},_handleTouchMove:function(t){t.preventDefault(),this.fire("touchmove",new e(this,t))},_handleTouchCancel:function(t){this.fire("touchcancel",new e(this,t))}}),{getTouchTargetCoords:function(t,e){let i=0,s=0;for(e=e||t.target;!(e instanceof HTMLElement);)e=e.parentNode;let n=e;do{i+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent}while(n);return{x:t.pageX-i,y:t.pageY-s}},TouchDevice:i,TouchEvent:e}}()),Object.assign(pc,function(){const t=function(){};return t.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream"},t.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document"},t.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds"],Object.assign(t.prototype,{ContentType:t.ContentType,ResponseType:t.ResponseType,binaryExtensions:t.binaryExtensions,get:function(t,e,i){return"function"==typeof e&&(i=e,e={}),this.request("GET",t,e,i)},post:function(t,e,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=e,this.request("POST",t,i,s)},put:function(t,e,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=e,this.request("PUT",t,i,s)},del:function(t,e,i){return"function"==typeof e&&(i=e,e={}),this.request("DELETE",t,e,i)},request:function(e,i,s,n){let r,o,a,c,h,l=!1;if("function"==typeof s&&(n=s,s={}),s.callback=n,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)c=s.postdata;else if(s.postdata instanceof FormData)c=s.postdata;else if(s.postdata instanceof Object){let e=s.headers["Content-Type"];switch(void 0===e&&(s.headers["Content-Type"]=t.ContentType.FORM_URLENCODED,e=s.headers["Content-Type"]),e){case t.ContentType.FORM_URLENCODED:{c="";let t=!0;for(const e in s.postdata)s.postdata.hasOwnProperty(e)&&(t?t=!1:c+="&",c+=escape(e)+"="+escape(s.postdata[e]));break}default:case t.ContentType.JSON:null==e&&(s.headers["Content-Type"]=t.ContentType.JSON),c=JSON.stringify(s.postdata)}}else c=s.postdata;h||(h=new XMLHttpRequest),!1===s.cache&&(a=pc.time.now(),r=new pc.URI(i),r.query?r.query=r.query+"&ts="+a:r.query="ts="+a,i=r.toString()),s.query&&(r=new pc.URI(i),o=pc.extend(r.getQuery(),s.query),r.setQuery(o),i=r.toString()),h.open(e,i,s.async),h.withCredentials=void 0!==s.withCredentials&&s.withCredentials,h.responseType=s.responseType||this._guessResponseType(i);for(const t in s.headers)s.headers.hasOwnProperty(t)&&h.setRequestHeader(t,s.headers[t]);h.onreadystatechange=function(){this._onReadyStateChange(e,i,s,h)}.bind(this),h.onerror=function(){this._onError(e,i,s,h),l=!0}.bind(this);try{h.send(c)}catch(t){l||s.error(h.status,h,t)}return h},_guessResponseType:function(e){const i=new pc.URI(e),s=pc.path.getExtension(i.path);return t.binaryExtensions.indexOf(s)>=0?t.ResponseType.ARRAY_BUFFER:".xml"===s?t.ResponseType.DOCUMENT:t.ResponseType.TEXT},_isBinaryContentType:function(e){return[t.ContentType.MP4,t.ContentType.WAV,t.ContentType.OGG,t.ContentType.MP3,t.ContentType.BIN,t.ContentType.DDS].indexOf(e)>=0},_onReadyStateChange:function(t,e,i,s){if(4===s.readyState)switch(s.status){case 0:"/"!==e[0]&&this._onSuccess(t,e,i,s);break;case 200:case 201:case 206:case 304:this._onSuccess(t,e,i,s);break;default:this._onError(t,e,i,s)}},_onSuccess:function(e,i,s,n){let r,o,a;const c=n.getResponseHeader("Content-Type");c&&(a=c.split(";"),o=a[0].trim()),o===this.ContentType.JSON||i.split("?")[0].endsWith(".json")?r=JSON.parse(n.responseText):this._isBinaryContentType(o)?r=n.response:n.responseType===t.ResponseType.ARRAY_BUFFER?(console.warn(pc.string.format("responseType: {0} being served with Content-Type: {1}",t.ResponseType.ARRAY_BUFFER,o)),r=n.response):r=n.responseType===t.ResponseType.DOCUMENT||o===this.ContentType.XML?n.responseXML:n.responseText,s.callback(null,r)},_onError:function(t,e,i,s){i.callback(s.status,null)}}),{Http:t,http:new t}}()),Object.assign(pc,function(){const t=function(e,s){s=s||{},pc.events.attach(this),t._applications[e.id]=this,t._currentApplication=this,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=!1,this._librariesLoaded=!1,this._fillMode=pc.FILLMODE_KEEP_ASPECT,this._resolutionMode=pc.RESOLUTION_FIXED,this._allowResize=!0,this.context=this,this.paused=!1,this.graphicsDevice=new pc.GraphicsDevice(e,s.graphicsDeviceOptions),this.counters=new pc.Counters(this.graphicsDevice),s.canvas=e,this._audioManager=new pc.SoundManager(s),this._entityIndex={},this.scene=new pc.Scene,this.root=new pc.Entity(this),this.root._enabledInHierarchy=!0,this._enableList=[],this._enableList.size=0,this._sceneRegistry=new pc.SceneRegistry(this),this.renderer=new pc.ForwardRenderer(this.graphicsDevice),this.renderer.scene=this.scene,this.keyboard=s.keyboard||null,this.mouse=s.mouse||null,this.touch=s.touch||null,this.gamepads=s.gamepads||null,this.elementInput=s.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.vr=null,s.vr&&this._onVrChange(s.vr),this._inTools=!1,this._targetAspect=null,this._skyboxLast=0,this._scriptPrefix=s.scriptPrefix||"",this.systems=new pc.ComponentSystemRegistry;const n=[{class:pc.AnimationComponentSystem,args:[this]},{class:pc.CameraComponentSystem,args:[this]},{class:pc.LightComponentSystem,args:[this]},{class:pc.AudioSourceComponentSystem,args:[this,this._audioManager]},{class:pc.SoundComponentSystem,args:[this,this._audioManager]},{class:pc.AudioListenerComponentSystem,args:[this,this._audioManager]},{class:pc.ScreenComponentSystem,args:[this]},{class:pc.ElementComponentSystem,args:[this]},{class:pc.UnityComponentSystemManagerSystem,args:[this]},{class:pc.UnityComponentSystem,args:[this]},{class:pc.MeshFilterComponentSystem,args:[this]},{class:pc.RendererComponentSystem,args:[this]},{class:pc.AudioSourceUnitySystem,args:[this]},{class:pc.MonoBehaviourSystem,args:[this]},{class:pc.PhysicsSystem,args:[this]},{class:pc.RigidbodySystem,args:[this]},{class:pc.ColliderSystem,args:[this]},{class:pc.JointSystem,args:[this]},{class:pc.Physics2DSystem,args:[this]},{class:pc.Rigidbody2DSystem,args:[this]},{class:pc.Collider2DSystem,args:[this]},{class:pc.Joint2DSystem,args:[this]},{class:pc.Effector2DSystem,args:[this]},{class:pc.ParticleSystemSystem,args:[this]},{class:pc.ParticleSystemRendererSystem,args:[this]},{class:pc.AnimatorSystem,args:[this]},{class:pc.ReflectionProbeSystem,args:[this]},{class:pc.AnimationSystem,args:[this]},{class:pc.VideoPlayerSystem,args:[this]},{class:pc.CanvasRendererSystem,args:[this]}];for(let t=0;t<n.length;t++){const e=n[t].class;if(e){const i=n[t].args;this.systems.add(new e(i[0],i[1]))}}this._visibilityChangeHandler=this.onVisibilityChange.bind(this),void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this.tick=i(this)};t._currentApplication=null,t._applications={},t.getApplication=function(e){return e?t._applications[e]:t._currentApplication},Object.assign(t.prototype,{getSceneUrl:function(t){const e=this._sceneRegistry.find(t);return e?e.url:null},loadSceneHierarchy:function(t,e){this._sceneRegistry.loadSceneHierarchy(t,e)},loadSceneSettings:function(t,e){this._sceneRegistry.loadSceneSettings(t,e)},loadScene:function(t,e){this._sceneRegistry.loadScene(t,e)},_preloadScripts:function(t,e){e()},start:function(){this.frame=0,this.fire("start",{timestamp:pc.now(),target:this}),pc.ComponentSystem.initialize(this.root),this.fire("initialize"),pc.ComponentSystem.postInitialize(this.root),this.fire("postinitialize"),this.tick()},update:function(t){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),pc.ComponentSystem.update(t,this._inTools),pc.ComponentSystem.postUpdate(t,this._inTools),this.fire("update",t),this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(t),this.keyboard&&this.keyboard.update(t),this.gamepads&&this.gamepads.update(t),UnityEngine.Input.Update(),UnityEngine.SceneManagement.SceneManager.ProcessAsync()},render:function(){const t=this.graphicsDevice;t._drawCallsPerFrame=0,t._verticesPerFrame=0,t._primsPerFrame[pc.PRIMITIVE_TRIANGLES]=0,this.fire("prerender"),this.scene.syncHierarchy(this.root),pc._skipRenderCounter=0,this.renderer.renderComposition(),this.fire("postrender")},syncHierarchy:function(){this.scene.syncHierarchy(this.root)},setCanvasFillMode:function(t,e,i){this._fillMode=t;const s=this.resizeCanvas(e,i);this.graphicsDevice.resizeCanvas(s.width,s.height)},setCanvasResolution:function(t,e,i){this._resolutionMode=t,t===pc.RESOLUTION_AUTO&&void 0===e&&(e=this.graphicsDevice.canvas.clientWidth,i=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,i)},isFullscreen:function(){return!!document.fullscreenElement},enableFullscreen:function(t,e,i){t=t||this.graphicsDevice.canvas;const s=function(){e(),document.removeEventListener("fullscreenchange",s)},n=function(){i(),document.removeEventListener("fullscreenerror",n)};e&&document.addEventListener("fullscreenchange",s,!1),i&&document.addEventListener("fullscreenerror",n,!1),t.requestFullscreen?t.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i()},disableFullscreen:function(t){const e=function(){t(),document.removeEventListener("fullscreenchange",e)};t&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._audioManager.suspend():this._audioManager.resume()},resizeCanvas:function(t,e){if(!this._allowResize)return{};const i=window.innerWidth,s=window.innerHeight;if(navigator.isCocoonJS)t=i,e=s,this.graphicsDevice.resizeCanvas(t,e);else{if(this._fillMode===pc.FILLMODE_KEEP_ASPECT){const n=this._targetAspect||this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>i/s?e=(t=i)/n:t=(e=s)*n,this.minimumResolution&&(t<this.minimumResolution.x||e<this.minimumResolution.y)&&(t=this.minimumResolution.x,e=this.minimumResolution.y)}else this._fillMode===pc.FILLMODE_FILL_WINDOW&&(t=i,e=s);this.graphicsDevice.canvas.style.width=t+"px",this.graphicsDevice.canvas.style.height=e+"px",this._resolutionMode===pc.RESOLUTION_AUTO&&this.setCanvasResolution(pc.RESOLUTION_AUTO)}return{width:t,height:e}},applySceneSettings:function(t){let e;this.scene.applySettings(t),t.render.hasOwnProperty("skybox")&&(t.render.skybox?(e=this.assets.get(t.render.skybox),e?this.setSkybox(e):this.assets.once("add:"+t.render.skybox,this.setSkybox,this)):this.setSkybox(null))},setSkybox:function(t){if(t){if(this._skyboxLast===t.id)return void(0!==this.scene.skyboxMip||t.loadFaces?this._onSkyboxChange(t):this._skyboxLoad(t));this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=t.id,this.assets.on("load:"+t.id,this._onSkyboxChange,this),this.assets.once("remove:"+t.id,this._skyboxRemove,this),t.resource&&this.scene.setSkybox(t.resources),this._skyboxLoad(t)}else{if(!this._skyboxLast)return;this._skyboxRemove({id:this._skyboxLast})}},_onVrChange:function(t){t?this.vr||(this.vr=new pc.VrManager(this)):this.vr&&(this.vr.destroy(),this.vr=null)},_onSkyboxChange:function(t){this.scene.setSkybox(t.resources)},_skyboxLoad:function(t){0===this.scene.skyboxMip&&(t.loadFaces=!0),this.assets.load(t),this._onSkyboxChange(t)},_skyboxRemove:function(t){this._skyboxLast&&(this.assets.off("add:"+t.id,this.setSkybox,this),this.assets.off("load:"+t.id,this._onSkyboxChange,this),this.assets.off("remove:"+t.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},destroy:function(){let e,i;t._applications[this.graphicsDevice.canvas.id]=null,t._currentApplication===this&&(t._currentApplication=null),this.off("librariesloaded"),document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1),this._visibilityChangeHandler=null,this.onVisibilityChange=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null);const s=this.systems.list;for(e=0,i=s.length;e<i;e++)s[e].destroy();pc.ComponentSystem.destroy();const n=this.assets.list();for(e=0;e<n.length;e++)n[e].unload(),n[e].off();this.assets.off();for(const t in this.loader.getHandler("script")._cache){const e=this.loader.getHandler("script")._cache[t],i=e.parentNode;i&&i.removeChild(e)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=[],this.context=null,this.scripts.destroy(),this.scripts=null,this._sceneRegistry.destroy(),this._sceneRegistry=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,pc.destroyPostEffectQuad(),this.graphicsDevice.destroy(),this.graphicsDevice=null,this.renderer=null,this.tick=null,this.off(),this._audioManager&&(this._audioManager.destroy(),this._audioManager=null),pc.http=new pc.Http,pc.ParticleEmitter.DEFAULT_PARAM_TEXTURE=null}}),Object.defineProperty(t.prototype,"targetAspect",{get:function(){return this._targetAspect},set:function(t){this._targetAspect=t,this.setCanvasFillMode(this._fillMode,window.innerWidth,window.innerHeight)}});const e={},i=function(i){const s=i;return function(i){if(!s.graphicsDevice)return;t._currentApplication=s,pc.app=s;const n=pc.now();let r=(n-(s._time||n))/1e3;r=pc.math.clamp(r,0,s.maxDeltaTime),r*=s.timeScale,s._time=n,UnityEngine.Time.Update(r),window.requestAnimationFrame(s.tick),s.graphicsDevice.contextLost||s.paused||(s.counters.startSection(pc.Counters.FRAME),s.update(r),s.counters.startSection(pc.Counters.RENDER),(s.autoRender||s.renderNextFrame)&&(s.render(),s.renderNextFrame=!1),s.counters.endSection(pc.Counters.RENDER),e.timestamp=pc.now(),e.target=s,s.fire("frameend",e),s.fire("frameEnd",e),s.vr&&s.vr.display&&s.vr.display.presenting&&s.vr.display.submitFrame(),s.counters.endSection(pc.Counters.FRAME),s.counters.tick())}};return{FILLMODE_NONE:"NONE",FILLMODE_FILL_WINDOW:"FILL_WINDOW",FILLMODE_KEEP_ASPECT:"KEEP_ASPECT",RESOLUTION_AUTO:"AUTO",RESOLUTION_FIXED:"FIXED",Application:t}}()),pc.extend(pc,function(){const t=function(){this.scriptsTimestamp=0,this.animationsTimestamp=0,this.animatorsTimestamp=0,this.physics2dTimestamp=0,this.physicsTimestamp=0,this.renderTimestamp=0,this.frameTimestamp=0,this.scriptsTime=0,this.animationsTime=0,this.animatorsTime=0,this.physics2dTime=0,this.physicsTime=0,this.renderTime=0,this.frameTime=0,this.drawCalls=0,this.frames=0};t.prototype.reset=function(){this.scriptsTime=0,this.animationsTime=0,this.animatorsTime=0,this.physics2dTime=0,this.physicsTime=0,this.renderTime=0,this.frameTime=0,this.drawCalls=0,this.frames=0};const e=function(e){this.sample=new t,this.current=new t,this.webglVersion=window.WebGL2RenderingContext?2:1,this.webglExtensions=e.gl.getSupportedExtensions()};return e.SCRIPTS="scripts",e.ANIMATIONS="animations",e.ANIMATORS="animators",e.PHYSICS2D="physics2d",e.PHYSICS="physics",e.RENDER="render",e.FRAME="frame",e.prototype.getSnapshot=function(){const t=this.sample,e=Math.max(1,t.frames),i={scriptsTime:t.scriptsTime/e,animationsTime:t.animationsTime/e,animatorsTime:t.animatorsTime/e,physics2dTime:t.physics2dTime/e,physicsTime:t.physicsTime/e,renderTime:t.renderTime/e,frameTime:t.frameTime/e,drawCalls:t.drawCalls/e,webglVersion:this.webglVersion,webglExtensions:this.webglExtensions};return t.reset(),i},e.prototype.tick=function(){this.sample.frames++,this.sample.scriptsTime+=this.current.scriptsTime,this.sample.animationsTime+=this.current.animationsTime,this.sample.animatorsTime+=this.current.animatorsTime,this.sample.physics2dTime+=this.current.physics2dTime,this.sample.physicsTime+=this.current.physicsTime,this.sample.renderTime+=this.current.renderTime,this.sample.frameTime+=this.current.frameTime,this.sample.drawCalls+=this.current.drawCalls,this.current.reset()},e.prototype.recordDrawCalls=function(t){this.current.drawCalls+=t},e.prototype.startSection=function(t){this.current[t+"Timestamp"]=pc.time.now()},e.prototype.endSection=function(t){this.current[t+"Time"]+=pc.time.now()-this.current[t+"Timestamp"]},{Counters:e}}()),Object.assign(pc,function(){const t=function(t){this._app=t,this._list=[],this._index={},this._urlIndex={}};return t.prototype.destroy=function(){this._app=null},t.prototype.list=function(){return this._list},t.prototype.add=function(t,e){if(this._index.hasOwnProperty(t))return console.warn("pc.SceneRegistry: trying to add more than one scene called: "+t),!1;const i=new pc.SceneRegistryItem(t,e),s=this._list.push(i);return this._index[i.name]=s-1,this._urlIndex[i.url]=s-1,!0},t.prototype.find=function(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null},t.prototype.findByUrl=function(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null},t.prototype.remove=function(t){if(this._index.hasOwnProperty(t)){let e=this._index[t],i=this._list[e];for(delete this._urlIndex[i.url],delete this._index[t],this._list.splice(e,1),e=0;e<this._list.length;e++)i=this._list[e],this._index[i.name]=e,this._urlIndex[i.url]=e}},t.prototype.loadSceneHierarchy=function(t,e){const i=this,s=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!pc.ABSOLUTE_URL.test(t)&&(t=pc.path.join(this._app.assets.prefix,t)),s.load(t,(n,r)=>{if(n)return void(e&&e(n));i._app._preloadScripts(r,(function(){i._app.systems.script.preloading=!0;const o=s.open(t,r);i._app.systems.script.preloading=!1,i._app.loader.clearCache(t,"hierarchy"),i._app.root.addChild(o),pc.ComponentSystem.initialize(o),pc.ComponentSystem.postInitialize(o),e&&e(n,o)}))})},t.prototype.loadSceneSettings=function(t,e){const i=this;this._app.assets&&this._app.assets.prefix&&!pc.ABSOLUTE_URL.test(t)&&(t=pc.path.join(this._app.assets.prefix,t)),this._app.loader.load(t,"scenesettings",(t,s)=>{t?e&&e(t):(i._app.applySceneSettings(s),e&&e(null))})},t.prototype.loadScene=function(t,e){const i=this,s=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!pc.ABSOLUTE_URL.test(t)&&(t=pc.path.join(this._app.assets.prefix,t)),s.load(t,(n,r)=>{if(n)e&&e(n);else{const n=function(){i._app.systems.script.preloading=!0;const n=s.open(t,r);i._app.systems.script.preloading=!1,i._app.loader.clearCache(t,"scene"),i._app.loader.patch({resource:n,type:"scene"},i._app.assets),i._app.root.addChild(n.root),i._app.systems.rigidbody&&"undefined"!=typeof Ammo&&i._app.systems.rigidbody.setGravity(n._gravity.x,n._gravity.y,n._gravity.z),e&&e(null,n)};i._app._preloadScripts(r,n)}})},{SceneRegistry:t,SceneRegistryItem:function(t,e){this.name=t,this.url=e}}}()),Object.assign(pc,function(){const t=function(){this.list=[]};return Object.assign(t.prototype,{add:function(t){const e=t.id;if(this[e])throw new Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed",e));this[e]=t,this.list.push(t)},remove:function(t){const e=t.id;if(!this[e])throw new Error(pc.string.format("No ComponentSystem named '{0}' registered",e));this[e]=null;const i=this.list.indexOf(this[e]);-1!==i&&this.list.splice(i,1)}}),{ComponentSystemRegistry:t}}()),Object.assign(pc,function(){function t(t,e){if(!t)return t;switch(t=t&&t.data?t.data:t,e){case"rgb":return new pc.Color(t[0],t[1],t[2]);case"rgba":return new pc.Color(t[0],t[1],t[2],t[3]);case"vec2":return new pc.Vec2(t[0],t[1]);case"vec3":return new pc.Vec3(t[0],t[1],t[2]);case"vec4":return new pc.Vec4(t[0],t[1],t[2],t[3]);case"boolean":case"number":case"string":case"entity":return t;default:throw new Error("Could not convert unhandled type: "+e)}}const e=function(t){this.app=t,this.store={},this.schema=[],pc.events.attach(this)};return Object.assign(e,{initialize:function(t){e.fire("initialize",t)},postInitialize:function(t){e.fire("postInitialize",t)},update:function(t,i){e.fire(i?"toolsUpdate":"update",t)},fixedUpdate:function(t,i){e.fire("fixedUpdate",t)},postUpdate:function(t,i){e.fire("postUpdate",t)}}),e.prototype={addComponent:function(t,e){const i=new this.ComponentType(this,t);return e=e||{},this.store[t.getGuid()]={entity:t,data:i.data},t[this.id]=i,t.c[this.id]=i,t.$prefab&&"element"!==this.id||this.initializeComponentData(i,e,[]),this.fire("add",t,i),i},removeComponent:function(t){const e=this.store[t.getGuid()],i=t.c[this.id];this.fire("beforeremove",t,i),delete this.store[t.getGuid()],t[this.id]=null,delete t.c[this.id],this.fire("remove",t,e.data)},cloneComponent:function(t,e){const i=t[this.id];return this.addComponent(e,i.data)},initializeComponentData:function(e,i,s){let n,r,o,a;i=i||{};for(let c=0,h=s.length;c<h;c++)n=s[c],"object"==typeof n?(r=n.name,o=n.type):(r=n,o=void 0),a=i[r],void 0!==a&&(void 0!==o&&(a=t(a,o)),e[r]=a);e.enabled&&e.entity.enabled&&e.onEnable()},getPropertiesOfType:function(t){const e=[];return(this.schema||[]).forEach(i=>{i&&"object"==typeof i&&i.type===t&&e.push(i)}),e},destroy:function(){this.off()},findComponentsOnActiveEntities:function(t,e){const i=t?null:[];for(const s in this.store)if(this.store.hasOwnProperty(s)){const n=this.store[s].entity;if(!n.enabled)continue;const r=n.c[this.id];if(e&&!e(r))continue;if(t)return r;i.push(r)}return t?null:i}},pc.events.attach(e),e.destroy=function(){e.off("initialize"),e.off("postInitialize"),e.off("toolsUpdate"),e.off("update"),e.off("fixedUpdate"),e.off("postUpdate")},{ComponentSystem:e}}()),Object.assign(pc,function(){let t=0;const e=function(e,i){this.id=t++,this.system=e,this.entity=i,this.data=new e.DataType,pc.events.attach(this),this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(t,e,i){this.fire("set_"+t,t,e,i)})),this.on("set_enabled",this.onSetEnabled,this)};return e._buildAccessors=function(t,e){e.forEach(e=>{const i="object"==typeof e?e.name:e;Object.defineProperty(t,i,{get:function(){return this.data[i]},set:function(t){const e=this.data,s=e[i];e[i]=t,this.fire("set",i,s,t)},configurable:!0})}),t._accessorsBuilt=!0},e.prototype={buildAccessors:function(t){e._buildAccessors(this,t)},onSetEnabled:function(t,e,i){e!==i&&this.entity.enabled&&(i?this.onEnable():this.onDisable())},onEnable:function(){},onDisable:function(){},destroy:function(){this.system&&this.entity&&this.system.removeComponent(this.entity)},onPostStateChange:function(){},toUnityObject:function(){return this.unityClass?UnityEngine.Object.FromHandle(this.unityClass,this):null}},{Component:e}}()),Object.assign(pc,{ComponentData:function(){}}),Object.assign(pc,function(){const t=new pc.Vec4(0,0,1,1),e=new pc.Vec2,i=function(t,e){pc.Component.call(this,t,e),this.on("set_aspectRatioMode",this.onSetAspectRatioMode,this),this.on("set_aspectRatio",this.onSetAspectRatio,this),this.on("set_camera",this.onSetCamera,this),this.on("set_clearColor",this.onSetClearColor,this),this.on("set_fov",this.onSetFov,this),this.on("set_orthoHeight",this.onSetOrthoHeight,this),this.on("set_nearClip",this.onSetNearClip,this),this.on("set_farClip",this.onSetFarClip,this),this.on("set_projection",this.onSetProjection,this),this.on("set_clearColorBuffer",this.updateClearFlags,this),this.on("set_clearDepthBuffer",this.updateClearFlags,this),this.on("set_clearStencilBuffer",this.updateClearFlags,this),this.on("set_clearSkybox",this.updateClearFlags,this),this.on("set_renderTarget",this.onSetRenderTarget,this),this.on("set_rect",this.onSetRect,this),this.on("set_scissorRect",this.onSetScissorRect,this),this.on("set_horizontalFov",this.onSetHorizontalFov,this),this.on("set_frustumCulling",this.onSetFrustumCulling,this),this.on("set_calculateTransform",this.onSetCalculateTransform,this),this.on("set_calculateProjection",this.onSetCalculateProjection,this),this.on("set_cullFaces",this.onSetCullFaces,this),this.on("set_cullingMask",this.onSetCullingMask,this),this.device=pc.Application.getApplication().graphicsDevice};return(i.prototype=Object.create(pc.Component.prototype)).constructor=i,Object.defineProperty(i.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()},set:function(t){this.data.camera.setProjectionMatrix(t)}}),Object.defineProperty(i.prototype,"viewMatrix",{get:function(){return this.data.camera._node.getWorldTransform().clone().invert()}}),Object.defineProperty(i.prototype,"frustum",{get:function(){return this.data.camera.frustum}}),Object.defineProperty(i.prototype,"vrDisplay",{get:function(){return this.data.camera.vrDisplay},set:function(t){this.data.camera.vrDisplay=t,t&&(t._camera=this.data.camera)}}),Object.defineProperty(i.prototype,"node",{get:function(){return this.data.camera._node}}),Object.assign(i.prototype,{screenToWorld:function(t,e,i,s){const n=this.system.app.graphicsDevice;return this.data.camera.screenToWorld(t,e,i,n.clientRect.width,n.clientRect.height,s)},worldToScreen:function(t,e){const i=this.system.app.graphicsDevice;return this.data.camera.worldToScreen(t,i.clientRect.width,i.clientRect.height,e)},onSetAspectRatioMode:function(t,e,i){this.data.camera.aspectRatioMode=i},onSetAspectRatio:function(t,e,i){this.data.camera.aspectRatio=i},onSetCamera:function(t,e,i){e&&(e._node=null),i._node=this.entity},onSetClearColor:function(t,e,i){const s=this.data.camera.clearColor;s[0]=i.r,s[1]=i.g,s[2]=i.b,s[3]=i.a},onSetFov:function(t,e,i){this.data.camera.fov=i},onSetCullingMask:function(t,e,i){this.data.camera.cullingMask=i},onSetOrthoHeight:function(t,e,i){this.data.camera.orthoHeight=i},onSetNearClip:function(t,e,i){this.data.camera.nearClip=i},onSetFarClip:function(t,e,i){this.data.camera.farClip=i},onSetHorizontalFov:function(t,e,i){this.data.camera.horizontalFov=i},onSetFrustumCulling:function(t,e,i){this.data.camera.frustumCulling=i},onSetCalculateTransform:function(t,e,i){this._calculateTransform=i,this.camera._vpDirty=this.camera.overrideCalculateTransform!==!!i,this.camera.overrideCalculateTransform=!!i},onSetCalculateProjection:function(t,e,i){this._calculateProjection=i,this.camera._projMatDirty=!0,this.camera.overrideCalculateProjection=!!i,this.camera._vpDirty=this.camera.overrideCalculateProjection!==!!i},onSetCullFaces:function(t,e,i){this.camera._cullFaces=i},onSetProjection:function(t,e,i){this.data.camera.projection=i},addCameraToScene:function(){this.system.app.scene.addCamera(this)},removeCameraFromScene:function(){this.system.app.scene.removeCamera(this)},updateClearFlags:function(){let t=0;this.clearColorBuffer&&(t|=pc.CLEARFLAG_COLOR),this.clearDepthBuffer&&(t|=pc.CLEARFLAG_DEPTH),this.clearStencilBuffer&&(t|=pc.CLEARFLAG_STENCIL),this.clearSkybox&&(t|=pc.CLEARFLAG_USE_SKYBOX),this.data.camera.clearFlags=t},onSetRenderTarget:function(t,e,i){this.data.camera.renderTarget=i},onSetRect:function(t,e,i){this.data.camera.setRect(i.x,i.y,i.z,i.w)},onSetScissorRect:function(t,e,i){this.data.camera.setScissorRect(i.x,i.y,i.z,i.w)},onEnable:function(){this.system.addCamera(this),this.enabled&&this.entity.enabled&&this.addCameraToScene(),this.postEffects.enable()},onDisable:function(){this.postEffects.disable(),this.removeCameraFromScene(),this.system.removeCamera(this)},calculateAspectRatio:function(t){const e=t||this.system.app.graphicsDevice,i=this.rect;return e.width*i.z/(e.height*i.w)},frameBegin:function(t){this.aspectRatioMode===pc.ASPECT_AUTO&&(this.aspectRatio=this.calculateAspectRatio(t)),this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1},resetProjectionMatrix:function(){this.camera.resetProjectionMatrix()},changeAspectRatio:function(t){this.aspectRatioMode=pc.ASPECT_MANUAL,this.aspectRatio=t},resetAspect:function(){this.aspectRatioMode=pc.ASPECT_AUTO}}),Object.defineProperty(i.prototype,"unityRect",{get:function(){return this.rect},set:function(t){this.rect=t}}),Object.defineProperty(i.prototype,"unityPixelRect",{get:function(){const i=this.renderTarget;return i?(e.x=i.width,e.y=i.height):(e.x=this.device.width,e.y=this.device.height),t.copy(this.rect),t.x*=e.x,t.y*=e.y,t.z*=e.x,t.w*=e.y,t},set:function(t){const i=this.renderTarget;i?(e.x=i.width,e.y=i.height):(e.x=this.device.width,e.y=this.device.height),this.rect=new pc.Vec4(t.x/e.x,t.y/e.y,t.z/e.x,t.w/e.y)}}),{CameraComponent:i}}()),Object.assign(pc,function(){const t=["enabled","clearColorBuffer","clearColor","clearDepthBuffer","clearSkybox","clearStencilBuffer","frustumCulling","projection","fov","orthoHeight","nearClip","farClip","priority","rect","scissorRect","camera","aspectRatio","aspectRatioMode","horizontalFov","model","renderTarget","calculateTransform","calculateProjection","cullFaces","flipFaces","layers","cullingMask"],e=function(e){pc.ComponentSystem.call(this,e),this.id="camera",this.description="Renders the scene from the location of the Entity.",this.ComponentType=pc.CameraComponent,this.DataType=pc.CameraComponentData,this.schema=t,this.cameras=[],this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this),pc.ComponentSystem.on("update",this.onUpdate,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.CameraComponent.prototype,t),Object.assign(e.prototype,{initializeComponentData:function(t,e,i){const s={};for(let t=0,n=(i=["postEffects","enabled","model","camera","aspectRatio","aspectRatioMode","horizontalFov","renderTarget","clearColor","fov","orthoHeight","nearClip","farClip","projection","priority","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","clearSkybox","frustumCulling","rect","scissorRect","calculateTransform","calculateProjection","cullFaces","flipFaces","layers","cullingMask"]).length;t<n;t++){const n=i[t];s[n]=e[n]}if(s.layers&&"array"===pc.type(s.layers)&&(s.layers=s.layers.slice(0)),s.clearColor&&"array"===pc.type(s.clearColor)){const t=s.clearColor;s.clearColor=new pc.Color(t[0],t[1],t[2],t[3])}if(s.rect&&"array"===pc.type(s.rect)){const t=s.rect;s.rect=new pc.Vec4(t[0],t[1],t[2],t[3])}if(s.scissorRect&&"array"===pc.type(s.scissorRect)){const t=s.scissorRect;s.scissorRect=new pc.Vec4(t[0],t[1],t[2],t[3])}s.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),s.enabled=s.activate),s.camera=new pc.Camera,s._node=t.entity,s.camera._component=t;const n=t;s.camera.calculateTransform=function(t,e){return n._calculateTransform?n._calculateTransform(t,e):null},s.camera.calculateProjection=function(t,e){return n._calculateProjection?n._calculateProjection(t,e):null},s.postEffects=new pc.PostEffectQueue(this.app,t),pc.ComponentSystem.prototype.initializeComponentData.call(this,t,s,i)},onBeforeRemove:function(t,e){this.removeCamera(e)},onRemove:function(t,e){e.camera=null},onUpdate:function(t){},addCamera:function(t){this.cameras.push(t),this.sortCamerasByPriority()},removeCamera:function(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort((t,e)=>t.priority-e.priority)}}),{CameraComponentSystem:e}}()),Object.assign(pc,{CameraComponentData:function(){this.clearColor=new pc.Color(.722,.722,.722,1),this.clearColorBuffer=!0,this.clearDepthBuffer=!0,this.clearStencilBuffer=!0,this.clearSkybox=!0,this.nearClip=.1,this.farClip=1e3,this.fov=45,this.orthoHeight=100,this.projection=pc.PROJECTION_PERSPECTIVE,this.priority=0,this.rect=new pc.Vec4(0,0,1,1),this.scissorRect=new pc.Vec4(0,0,1,1),this.enabled=!0,this.frustumCulling=!1,this.cullFaces=!0,this.flipFaces=!1,this.layers=[pc.LAYERID_WORLD,pc.LAYERID_DEPTH,pc.LAYERID_SKYBOX,pc.LAYERID_UI,pc.LAYERID_IMMEDIATE],this.camera=null,this.aspectRatio=16/9,this.aspectRatioMode=pc.ASPECT_AUTO,this.renderTarget=null,this.postEffects=null,this.isRendering=!1,this.calculateTransform=null,this.calculateProjection=null}}),Object.assign(pc,function(){function t(t,e){const i=this;this.app=t,this.camera=e,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=function(){i.resizeRenderTargets()},e.on("set_rect",this.onCameraRectChanged,this),this._origOverrideClear=!1,this._origClearColorBuffer=!1,this._origDepthColorBuffer=!1,this._origStencilColorBuffer=!1}return Object.assign(t.prototype,{_createOffscreenTarget:function(t,e){const i=this.camera.rect,s=Math.floor(i.z*this.app.graphicsDevice.width*this.renderTargetScale),n=Math.floor(i.w*this.app.graphicsDevice.height*this.renderTargetScale),r=this.app.graphicsDevice,o=e?r.getHdrFormat():pc.PIXELFORMAT_R8_G8_B8_A8,a=new pc.Texture(r,{format:o,width:s,height:n});return a.minFilter=pc.FILTER_NEAREST,a.magFilter=pc.FILTER_NEAREST,a.addressU=pc.ADDRESS_CLAMP_TO_EDGE,a.addressV=pc.ADDRESS_CLAMP_TO_EDGE,new pc.RenderTarget(this.app.graphicsDevice,a,{depth:t})},_resizeOffscreenTarget:function(t){const e=this.camera.rect,i=Math.floor(e.z*this.app.graphicsDevice.width*this.renderTargetScale),s=Math.floor(e.w*this.app.graphicsDevice.height*this.renderTargetScale),n=this.app.graphicsDevice,r=t.colorBuffer.format;t._colorBuffer.destroy();const o=new pc.Texture(n,{format:r,width:i,height:s});o.minFilter=pc.FILTER_NEAREST,o.magFilter=pc.FILTER_NEAREST,o.addressU=pc.ADDRESS_CLAMP_TO_EDGE,o.addressV=pc.ADDRESS_CLAMP_TO_EDGE,t._colorBuffer=o,t.destroy()},setRenderTargetScale:function(t){this.renderTargetScale=t,this.resizeRenderTargets()},addEffect:function(t){const e=0===this.effects.length,i=this.effects,s={effect:t,inputTarget:this._createOffscreenTarget(e,t.hdr),outputTarget:null};if(!this.layer){this.layer=new pc.Layer({opaqueSortMode:pc.SORTMODE_NONE,transparentSortMode:pc.SORTMODE_NONE,passThrough:!0,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(let t=0;t<this._commandList.length;t++)this._commandList[t]()}});const t=this.app.scene.layers.layerList;let e,i=0,n=t.length-1;for(e=n;e>=0;e--)if(t[e].id===pc.LAYERID_UI){n=e-1,this._origOverrideClear=t[e].overrideClear,this._origClearColorBuffer=t[e].clearColorBuffer,this._origDepthColorBuffer=t[e].clearDepthBuffer,this._origStencilColorBuffer=t[e].clearStencilBuffer,t[e].overrideClear=!0,t[e].clearColorBuffer=!1,t[e].clearDepthBuffer=this.camera.clearDepthBuffer,t[e].clearStencilBuffer=this.camera.clearStencilBuffer;break}for(e=n;e>=0;e--)t[e].cameras.indexOf(this.camera)>=0&&(0===i&&(i=e+1),t[e].renderTarget=s.inputTarget);this.app.scene.layers.insertOpaque(this.layer,i),this.layer._commandList=[],this.layer.isPostEffect=!0}i.push(s);const n=i.length;n>1&&(i[n-2].outputTarget=s.inputTarget),this.enable()},removeEffect:function(t){let e=-1;for(let i=0,s=this.effects.length;i<s;i++)if(this.effects[i].effect===t){e=i;break}e>=0&&(e>0?this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this.effects[1].inputTarget.destroy(),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr)),this.camera.renderTarget=this.effects[1].inputTarget),this.effects[e].inputTarget.destroy(),this.effects.splice(e,1)),this.enabled&&t.needsDepthBuffer&&this.camera.releaseDepthMap(),0===this.effects.length&&this.disable()},requestDepthMap:function(){for(let t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this.camera.camera.requestDepthMap()}},releaseDepthMap:function(){for(let t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this.camera.releaseDepthMap()}},destroy:function(){for(let t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;const t=this;this.requestDepthMap(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.command=function(){if(t.enabled){let e=null;const i=t.effects.length;if(i){t.layer.renderTarget=t.effects[0].inputTarget;for(let s=0;s<i;s++){const n=t.effects[s];s===i-1&&(e=t.camera.rect),n.effect.render(n.inputTarget,n.outputTarget,e)}}}},this.layer._commandList.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this.camera.renderTarget=null,this.releaseDepthMap();let t=this.layer._commandList.indexOf(this.command);t>=0&&this.layer._commandList.splice(t,1);const e=this.app.scene.layers.layerList;let i=e.length-1;for(t=0;t<=e.length;t++)if(e[t].id===pc.LAYERID_UI){i=t-1,e[t].overrideClear=this._origOverrideClear,e[t].clearColorBuffer=this._origClearColorBuffer,e[t].clearDepthBuffer=this._origDepthColorBuffer,e[t].clearStencilBuffer=this._origStencilColorBuffer;break}for(t=i;t>=0;t--)e[t].cameras.indexOf(this.camera)>=0&&(e[t].renderTarget=void 0);this.app.scene.layers.removeOpaque(this.layer),this.layer=null}},_onCanvasResized:function(t,e){const i=this.camera.rect,s=this.app.graphicsDevice;this.camera.camera.aspectRatio=s.width*i.z/(s.height*i.w),this.resizeTimeout||(pc.now()-this.resizeLast>100?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},resizeRenderTargets:function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=pc.now();const t=this.camera.rect,e=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale),i=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale),s=this.effects;for(let t=0,n=s.length;t<n;t++){const n=s[t];n.inputTarget.width===e&&n.inputTarget.height===i||this._resizeOffscreenTarget(n.inputTarget)}},onCameraRectChanged:function(t,e,i){this.enabled&&this.resizeRenderTargets()}}),{PostEffectQueue:t}}()),Object.assign(pc,function(){const t=[null,null];let e,i=null;const s=new pc.Vec4,n=new Float32Array(4),r=[];let o=!1,a=!1,c=!1;const h=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*;/g,l=/\S+[ \t\n\r]*;/,p=/[ \t\n\r]*;/,u=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,d=/(float|int|bool|vec2|vec3|vec4|struct|,|;|\{|\})/g,_=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,f=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|,|;|\{|\})/g,m=/#version/g,g=/out highp vec4 pc_fragColor;/g,y=/#define gl_FragColor/g,E=/gl_FragColor/g,T=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,A=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,b=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,S=/void[ \t\n\r]+main/g,R=function(e,i,s){const n=new pc.Texture(i,{format:s,width:i.width,height:i.height});n.minFilter=pc.FILTER_NEAREST,n.magFilter=pc.FILTER_NEAREST,n.addressU=pc.ADDRESS_CLAMP_TO_EDGE,n.addressV=pc.ADDRESS_CLAMP_TO_EDGE,t[e]._colorBuffer=n},I=function(e){t[e].colorBuffer.destroy(),t[e].destroy()},C=function(t){const e=t.match(h)||[];let i,s,n;const r=[];for(let t=0;t<e.length;t++)i=e[t].search(l),s=e[t].search(p),n=e[t].substr(i,s-i),"uColorBuffer"!==n&&r.push(n);return r},M=function(t,e,i,s){const n=C(s.definition.fshader);if(0===n.length)return!1;let r,o,a,c,h;for(r=0;r<i;r++)for(o=0;o<n.length;o++)for(h=n[o],c=C(t[e[r]].shader.definition.fshader),a=0;a<c.length;a++)if(c[a]===h)return!0;return!1},v=function(t,e){const i=t.length;let s,n,r,o=0,a=0,c=0,h=0,l="";for(n=0;n<i;n++)s=t.charAt(n),"{"===s?(0===c&&(o=n),c++):"}"===s&&(1===c&&(a=n,l+=t.substr(h,o-h+1),h=a),c--);l+=t.substr(h,t.length-h+1);let p=null;const m=l.match(u)||[];let g,y;for(n=0;n<m.length;n++)for(g=m[n].split(","),r=0;r<g.length;r++)y=g[r].replace(d,"").trim(),e.indexOf(y)>=0?(p||(p=[]),p.push(y)):e.push(y);const E=l.match(_)||[];let T;for(n=0;n<E.length;n++)for(g=E[n].split(","),r=0;r<g.length;r++)y=g[r].replace(f,"").trim(),T=e.indexOf(y),T>=0&&e.splice(T,1);return p};function P(h,l){this.app=h,this.srcRenderTarget=l.srcRenderTarget,this.hdr=l.hdr,this.blending=l.blending,this.shader=l.shader,this.setup=l.setup;const p=this,u=h.graphicsDevice;if(this.layer=new pc.Layer({opaqueSortMode:pc.SORTMODE_NONE,transparentSortMode:pc.SORTMODE_NONE,passThrough:!0,name:l.name,onPostRender:function(){if(p.srcRenderTarget?(s.x=p.srcRenderTarget.width,s.y=p.srcRenderTarget.height,s.z=1/p.srcRenderTarget.width,s.w=1/p.srcRenderTarget.height):(s.x=u.width,s.y=u.height,s.z=1/u.width,s.w=1/u.height),n[0]=s.x,n[1]=s.y,n[2]=s.z,n[3]=s.w,e.setValue(n),this._postEffectCombined&&this._postEffectCombined<0)return void(p.setup&&p.setup(u,p,s,null,this.renderTarget));let r;r=this._postEffectCombinedSrc?this._postEffectCombinedSrc:p.srcRenderTarget?p.srcRenderTarget:t[this._backbufferRtId],r._samples>1&&r.resolve(!0,!1);const o=r._colorBuffer;o.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?pc.FILTER_LINEAR:pc.FILTER_NEAREST,i.setValue(o),p.setup&&p.setup(u,p,s,r,this.renderTarget);const a=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader;if(a&&pc.drawQuadWithShader(u,this.renderTarget,a,null,null,p.blending),p.srcRenderTarget)return;const c=h.scene.layers.layerList;for(let e=0;e<c.length&&c[e]!==p.layer;e++)c[e].renderTarget!==t[0]&&c[e].renderTarget!==t[1]||(c[e].renderTarget=null)}}),this.layer._generateCameraHash(),this.layer.isPostEffect=!0,this.layer.unmodifiedUvs=l.unmodifiedUvs,this.layer.postEffectBilinear=l.bilinear,this.layer.postEffect=this,this.layer.shader=l.shader,this.layer.renderTarget=l.destRenderTarget,!i){i=u.scope.resolve("uColorBuffer"),e=u.scope.resolve("uScreenSize");const s=u.supportsMsaa?4:1;for(let e=0;e<2;e++)t[e]=new pc.RenderTarget({depth:!0,stencil:u.supportsStencil,samples:s,autoResolve:!1}),t[e].name="backbuffer"+e;h.on("prerender",()=>{const e=h.scene.layers.layerList;let i,s,n=0,l=0;o=!1,a=!1,c=!1;let p=pc.PIXELFORMAT_R8_G8_B8_A8;if(h.scene.layers._dirty){console.log("Trying to combine shaders...");let t,n,o=0,a=!1;for(i=0;i<e.length;i++)if(a=!1,e[i].isPostEffect&&(0===o||e[i].unmodifiedUvs&&e[i].shader&&!M(e,r,o,e[i].shader))?(r[o]=i,o++,i===e.length-1&&(a=!0)):o>0&&(a=!0),a){if(o>1){let i,a="post_";for(s=0;s<o;s++)i=e[r[s]],a+=i.name?i.name:i.id,s<o-1&&(a+="_");let c=u.programLib._cache[a];if(!c){let i,h="vec4 shaderOutput;\n",l="void main() {\n";const p=[];for(s=0;s<o;s++){if(i=e[r[s]].shader.definition.fshader+"\n",i=i.replace(m,"//").replace(g,"//").replace(y,"//").replace(E,"shaderOutput"),s>0&&(i=i.replace(T,"//").replace(A,"//").replace(b,"shaderOutput;//")),i=i.replace(S,"void main"+s),t=v(i,p),t)for(n=0;n<t.length;n++)i=i.replace(new RegExp("\\b"+t[n]+"\\b","g"),t[n]+"NNNN"+s);h+=i,l+="main"+s+"();\n"}l+="gl_FragColor = shaderOutput;\n}\n",c=pc.shaderChunks.createShaderFromCode(u,pc.shaderChunks.fullscreenQuadVS,h+l,a),console.log("Combined "+a)}for(s=0;s<o;s++)e[r[s]]._postEffectCombined=s===o-1?1:-1;e[r[o-1]]._postEffectCombinedShader=c,e[r[o-1]]._postEffectCombinedBilinear=e[r[0]].postEffectBilinear,e[r[o-1]]._postEffectCombinedSrc=e[r[0]].postEffect.srcRenderTarget}r[0]=i,o=1}}for(i=0;i<e.length;i++){if(e[i].isPostEffect&&(!e[i].postEffect.srcRenderTarget&&!e[i]._postEffectCombined||!e[i].postEffect._postEffectCombinedSrc&&e[i]._postEffectCombined>=0)){for(s=i-1;s>=n;s--)e[s].renderTarget||(e[s].renderTarget=t[l]);e[i]._backbufferRtId=l,n=i,o=!0,1===l&&(a=!0),e[i].postEffect.hdr&&(p=u.webgl2&&u.textureFloatRenderable?pc.PIXELFORMAT_111110F:u.extTextureHalfFloatLinear&&u.textureHalfFloatRenderable?pc.PIXELFORMAT_RGBA16F:pc.PIXELFORMAT_R8_G8_B8_A8),e[i].postEffect.shader&&!e[i].renderTarget&&(l=1-l)}else e[i].isPostEffect||e[i].renderTarget||!o||(e[i].renderTarget=t[l]);e[i].isPostEffect&&!e[i].renderTarget&&(c=!0)}o&&(t[0].colorBuffer?t[0].width===u.width&&t[0].height===u.height&&t[0]._colorBuffer._format===p||(I(0),R(0,u,p)):R(0,u,p)),a&&(t[1].colorBuffer?t[1].width===u.width&&t[1].height===u.height&&t[1]._colorBuffer._format===p||(I(1),R(1,u,p)):R(1,u,p))},this),h.on("postrender",()=>{const e=h.graphicsDevice;if(o&&!c){const i=h.scene.layers.layerList;let s;for(let e=i.length-1;e>=0&&(s=i[e].renderTarget,s!==t[0]&&s!==t[1]);e--);s&&(s._samples>1&&s.resolve(!0,!1),e.copyRenderTarget(s,null,!0,!1))}},this)}}return P.prototype.addToComposition=function(t){this.app.scene.layers.insertTransparent(this.layer,t)},{PostEffectPass:P}}()),Object.assign(pc,function(){const t=function(t,e){pc.Component.call(this,t,e),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null};(t.prototype=Object.create(pc.Component.prototype)).constructor=t;const e=[],i=[],s=function(s,n,r,o){const a=t.prototype;e.push(s),i.push(n),Object.defineProperty(a,s,{get:function(){return this.data[s]},set:function(t){const e=this.data,i=e[s];(o||i!==t)&&(e[s]=t,r&&r.call(this,t,i))},configurable:!0})};return s("enabled",!0,(function(t,e){this.onSetEnabled(null,e,t)})),s("light",null),s("type","directional",(function(t,e){this.system.changeType(this,e,t),this.refreshProperties()})),s("color",new pc.Color(1,1,1),(function(t,e){this.light.setColor(t)}),!0),s("intensity",1,(function(t,e){this.light.intensity=t})),s("castShadows",!1,(function(t,e){this.light.castShadows=t})),s("shadowDistance",40,(function(t,e){this.light.shadowDistance=t})),s("shadowResolution",1024,(function(t,e){this.light.shadowResolution=t})),s("shadowBias",.05,(function(t,e){this.light.shadowBias=-.01*t})),s("normalOffsetBias",0,(function(t,e){this.light.normalOffsetBias=t})),s("range",10,(function(t,e){this.light.attenuationEnd=t})),s("innerConeAngle",40,(function(t,e){this.light.innerConeAngle=t})),s("outerConeAngle",45,(function(t,e){this.light.outerConeAngle=t})),s("falloffMode",pc.LIGHTFALLOFF_LINEAR,(function(t,e){this.light.falloffMode=t})),s("shadowType",pc.SHADOW_PCF3,(function(t,e){this.light.shadowType=t})),s("vsmBlurSize",11,(function(t,e){this.light.vsmBlurSize=t})),s("vsmBlurMode",pc.BLUR_GAUSSIAN,(function(t,e){this.light.vsmBlurMode=t})),s("vsmBias",.0025,(function(t,e){this.light.vsmBias=t})),s("cookieAsset",null,(function(t,e){if(!this._cookieAssetId||!(t instanceof pc.Asset&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof pc.Asset)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;const e=this.system.app.assets.get(t);e?this.onCookieAssetAdd(e):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),s("cookie",null,(function(t,e){t&&(t.minFilter=pc.FILTER_LINEAR),this.light.cookie=t})),s("cookieIntensity",1,(function(t,e){this.light.cookieIntensity=t})),s("cookieFalloff",!0,(function(t,e){this.light.cookieFalloff=t})),s("cookieChannel","rgb",(function(t,e){this.light.cookieChannel=t})),s("cookieAngle",0,(function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new pc.Vec4);let e=1,i=1;this.cookieScale&&(e=this.cookieScale.x,i=this.cookieScale.y);const s=Math.cos(t*pc.math.DEG_TO_RAD),n=Math.sin(t*pc.math.DEG_TO_RAD);this._cookieMatrix.set(s/e,-n/e,n/i,s/i),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),s("cookieScale",null,(function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new pc.Vec4);const e=t.x,i=t.y,s=Math.cos(this.cookieAngle*pc.math.DEG_TO_RAD),n=Math.sin(this.cookieAngle*pc.math.DEG_TO_RAD);this._cookieMatrix.set(s/e,-n/e,n/i,s/i),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null;this.light.cookieScale=t}),!0),s("cookieOffset",null,(function(t,e){this.light.cookieOffset=t}),!0),s("shadowUpdateMode",pc.SHADOWUPDATE_REALTIME,(function(t,e){this.light.shadowUpdateMode=t})),s("mask",1,(function(t,e){this.light.mask=t})),s("cullingMask",1,(function(t,e){this.light.cullingMask=t})),s("affectDynamic",!0,(function(t,e){t?this.light.mask|=pc.MASK_DYNAMIC:this.light.mask&=~pc.MASK_DYNAMIC,this.light.mask=this.light._mask})),s("affectLightmapped",!1,(function(t,e){t?(this.light.mask|=pc.MASK_BAKED,this.bake&&(this.light.mask&=~pc.MASK_LIGHTMAP)):(this.light.mask&=~pc.MASK_BAKED,this.bake&&(this.light.mask|=pc.MASK_LIGHTMAP)),this.light.mask=this.light._mask})),s("bake",!1,(function(t,e){t?(this.light.mask|=pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask&=~pc.MASK_BAKED)):(this.light.mask&=~pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask|=pc.MASK_BAKED)),this.light.mask=this.light._mask})),s("bakeDir",!0,(function(t,e){this.light.bakeDir=t})),s("isStatic",!1,(function(t,e){this.light.isStatic=t})),s("layers",[pc.LAYERID_WORLD],(t,e)=>{console.warn(".layers property does nothing!")}),s("renderMode",0,(function(t,e){this.light.renderMode=t})),Object.defineProperty(t.prototype,"enable",{get:function(){return console.warn("WARNING: enable: Property is deprecated. Query enabled property instead."),this.enabled},set:function(t){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),this.enabled=t}}),Object.assign(t.prototype,{addLightToScene:function(){this.system.app.scene.addLight(this.light)},removeLightFromScene:function(){this.system.app.scene.removeLight(this.light)},refreshProperties:function(){let t;for(let i=0;i<e.length;i++)t=e[i],this[t]=this[t];this.enabled&&this.entity.enabled&&this.onEnable()},updateShadow:function(){this.light.updateShadow()},onCookieAssetSet:function(){let t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()},onCookieAssetAdd:function(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light._enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))},onCookieAssetLoad:function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},onCookieAssetRemove:function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},onEnable:function(){this.light.enabled=!0,this.enabled&&this.entity.enabled&&this.addLightToScene(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()},onDisable:function(){this.light.enabled=!1,this.removeLightFromScene()}}),{LightComponent:t,_lightProps:e,_lightPropsDefault:i}}()),Object.assign(pc,function(){const t={directional:pc.LIGHTTYPE_DIRECTIONAL,point:pc.LIGHTTYPE_POINT,spot:pc.LIGHTTYPE_SPOT},e=function(t){pc.ComponentSystem.call(this,t),this.id="light",this.description="Enables the Entity to emit light.",this.ComponentType=pc.LightComponent,this.DataType=pc.LightComponentData};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,Object.assign(e.prototype,{initializeComponentData:function(e,i){const s=pc._lightProps,n={};for(let t=0,e=s.length;t<e;t++){const e=s[t];n[e]=i[e]}n.type||(n.type=e.data.type),e.data.type=n.type,n.layers&&"array"===pc.type(n.layers)&&(n.layers=n.layers.slice(0)),n.color&&"array"===pc.type(n.color)&&(n.color=new pc.Color(n.color[0],n.color[1],n.color[2])),n.cookieOffset&&n.cookieOffset instanceof Array&&(n.cookieOffset=new pc.Vec2(n.cookieOffset[0],n.cookieOffset[1])),n.cookieScale&&n.cookieScale instanceof Array&&(n.cookieScale=new pc.Vec2(n.cookieScale[0],n.cookieScale[1])),n.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),n.enabled=n.enable);const r=new pc.Light;r.type=t[n.type],r._node=e.entity,r._scene=this.app.scene,e.data.light=r,r.renderMode=i.renderMode,r.range=i.range,pc.ComponentSystem.prototype.initializeComponentData.call(this,e,n,s)},removeComponent:function(t){t.light.data.light.destroy(),pc.ComponentSystem.prototype.removeComponent.call(this,t)},cloneComponent:function(t,e){const i=t.light,s=[];let n;const r=pc._lightProps;for(let t=0;t<r.length;t++)n=r[t],"light"!==n&&(i[n]&&i[n].clone?s[n]=i[n].clone():s[n]=i[n]);this.addComponent(e,s)},changeType:function(e,i,s){i!==s&&(e.light.type=t[s])}}),{LightComponentSystem:e}}()),Object.assign(pc,{LightComponentData:function(){const t=pc._lightProps,e=pc._lightPropsDefault;let i;for(let s=0;s<t.length;s++)i=e[s],i&&i.clone?this[t[s]]=i.clone():this[t[s]]=i}}),Object.assign(pc,{DISTANCE_LINEAR:"linear",DISTANCE_INVERSE:"inverse",DISTANCE_EXPONENTIAL:"exponential"}),Object.assign(pc,function(){const t={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new pc.Vec3,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},e=function(t,e,i){i=i||{},this._component=t,this._assets=t.system.app.assets,this._manager=t.system.manager,this._name=e||"Untitled",this._volume=void 0!==i.volume?pc.math.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._duration=i.duration>0?i.duration:null,this._startTime=Math.max(0,Number(i.startTime)||0),this._overlap=!!i.overlap,this._autoPlay=!!i.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=i.asset,this._asset instanceof pc.Asset&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this),this.instances=[],pc.events.attach(this)};return Object.assign(e.prototype,{play:function(){this.overlap||!this.isPlaying&&!this.isPaused||this.stop();const t=this._createInstance();if(this.instances.push(t),this.isLoaded)t.play();else{const e=function(e){const i=t._playWhenLoaded;t.sound=e,i&&t.play()};this.off("load",e),this.once("load",e),this.load()}return t},pause:function(){let t=!1;const e=this.instances;for(let i=0,s=e.length;i<s;i++)e[i].pause()&&(t=!0);return t},resume:function(){let t=!1;const e=this.instances;for(let i=0,s=e.length;i<s;i++)e[i].resume()&&(t=!0);return t},stop:function(){let t=!1;const e=this.instances;for(let i=0,s=e.length;i<s;i++)e[i].stop()&&(t=!0);return e.length=0,t},load:function(){if(!this._hasAsset())return;const t=this._assets.get(this._asset);return t?(t.off("remove",this._onAssetRemoved,this),t.on("remove",this._onAssetRemoved,this),t.resource?void this.fire("load",t.resource):(t.off("load",this._onAssetLoad,this),t.once("load",this._onAssetLoad,this),void this._assets.load(t))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this))},setExternalNodes:function(t,e){if(t){if(e||(e=t),this._firstNode=t,this._lastNode=e,!this._overlap){const i=this.instances;for(let s=0,n=i.length;s<n;s++)i[s].setExternalNodes(t,e)}}else console.error("The firstNode must have a valid AudioNode")},clearExternalNodes:function(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const t=this.instances;for(let e=0,i=t.length;e<i;e++)t[e].clearExternalNodes()}},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){let e=null;const i=this._component;let s=null;if(this._hasAsset()){const t=this._assets.get(this._asset);t&&(s=t.resource)}const n=t;return n.volume=this._volume*i.volume,n.pitch=this._pitch*i.pitch,n.loop=this._loop,n.startTime=this._startTime,n.duration=this._duration,n.onPlay=this._onInstancePlayHandler,n.onPause=this._onInstancePauseHandler,n.onResume=this._onInstanceResumeHandler,n.onStop=this._onInstanceStopHandler,n.onEnd=this._onInstanceEndHandler,i.positional?(n.position.copy(i.entity.getPosition()),n.maxDistance=i.maxDistance,n.refDistance=i.refDistance,n.rollOffFactor=i.rollOffFactor,n.distanceModel=i.distanceModel,e=new pc.SoundInstance3d(this._manager,s,n)):e=new pc.SoundInstance(this._manager,s,n),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e},_onInstancePlay:function(t){this.fire("play",t),this._component.fire("play",this,t)},_onInstancePause:function(t){this.fire("pause",t),this._component.fire("pause",this,t)},_onInstanceResume:function(t){this.fire("resume",t),this._component.fire("resume",this,t)},_onInstanceStop:function(t){this.fire("stop",t),this._component.fire("stop",this,t)},_onInstanceEnd:function(t){const e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("end",t),this._component.fire("end",this,t)},_onAssetAdd:function(t){this.load()},_onAssetLoad:function(t){this.load()},_onAssetRemoved:function(t){t.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+t.id,this._onAssetAdd,this),this.stop()},updatePosition:function(t){const e=this.instances;for(let i=0,s=e.length;i<s;i++)e[i].position=t}}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},set:function(t){this._name=t}}),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(t){if(this._volume=pc.math.clamp(Number(t)||0,0,1),!this._overlap){const t=this.instances;for(let e=0,i=t.length;e<i;e++)t[e].volume=this._volume*this._component.volume}}}),Object.defineProperty(e.prototype,"pitch",{get:function(){return this._pitch},set:function(t){if(this._pitch=Math.max(Number(t)||0,.01),!this._overlap){const t=this.instances;for(let e=0,i=t.length;e<i;e++)t[e].pitch=this.pitch*this._component.pitch}}}),Object.defineProperty(e.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=!!t;const e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].loop=this._loop}}),Object.defineProperty(e.prototype,"autoPlay",{get:function(){return this._autoPlay},set:function(t){this._autoPlay=!!t}}),Object.defineProperty(e.prototype,"overlap",{get:function(){return this._overlap},set:function(t){this._overlap=!!t}}),Object.defineProperty(e.prototype,"startTime",{get:function(){return this._startTime},set:function(t){if(this._startTime=Math.max(0,Number(t)||0),!this._overlap){const t=this.instances;for(let e=0,i=t.length;e<i;e++)t[e].startTime=this._startTime}}}),Object.defineProperty(e.prototype,"duration",{get:function(){let t=0;if(this._hasAsset()){const e=this._assets.get(this._asset);t=e.resource?e.resource.duration:0}return null!=this._duration?this._duration%(t||1):t},set:function(t){if(this._duration=Math.max(0,Number(t)||0)||null,!this._overlap){const t=this.instances;for(let e=0,i=t.length;e<i;e++)t[e].duration=this._duration}}}),Object.defineProperty(e.prototype,"asset",{get:function(){return this._asset},set:function(t){const e=this._asset;if(e){this._assets.off("add:"+e,this._onAssetAdd,this);const t=this._assets.get(e);t&&t.off("remove",this._onAssetRemoved,this)}this._asset=t,this._asset instanceof pc.Asset&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}}),Object.defineProperty(e.prototype,"isLoaded",{get:function(){if(this._hasAsset()){const t=this._assets.get(this._asset);if(t)return!!t.resource}return!1}}),Object.defineProperty(e.prototype,"isPlaying",{get:function(){const t=this.instances;for(let e=0,i=t.length;e<i;e++)if(t[e].isPlaying)return!0;return!1}}),Object.defineProperty(e.prototype,"isPaused",{get:function(){const t=this.instances,e=t.length;if(0===e)return!1;for(let i=0;i<e;i++)if(!t[i].isPaused)return!1;return!0}}),Object.defineProperty(e.prototype,"isStopped",{get:function(){const t=this.instances;for(let e=0,i=t.length;e<i;e++)if(!t[e].isStopped)return!1;return!0}}),{SoundSlot:e}}()),Object.assign(pc,function(){const t=function(t,e){pc.Component.call(this,t,e),this.on("set_slots",this.onSetSlots,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_refDistance",this.onSetRefDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_positional",this.onSetPositional,this)};return(t.prototype=Object.create(pc.Component.prototype)).constructor=t,Object.assign(t.prototype,{onSetSlots:function(t,e,i){let s;if(e)for(s in e)e[s].stop();const n={};for(s in i)i[s]instanceof pc.SoundSlot?n[i[s].name]=i[s]:i[s].name&&(n[i[s].name]=new pc.SoundSlot(this,i[s].name,i[s]));this.data.slots=n,this.enabled&&this.entity.enabled&&this.onEnable()},onSetVolume:function(t,e,i){const s=this.data.slots;for(const t in s){const e=s[t];if(!e.overlap){const t=e.instances;for(let s=0,n=t.length;s<n;s++)t[s].volume=e.volume*i}}},onSetPitch:function(t,e,i){const s=this.data.slots;for(const t in s){const e=s[t];if(!e.overlap){const t=e.instances;for(let s=0,n=t.length;s<n;s++)t[s].pitch=e.pitch*i}}},onSetRefDistance:function(t,e,i){const s=this.data.slots;for(const t in s){const e=s[t];if(!e.overlap){const t=e.instances;for(let e=0,s=t.length;e<s;e++)t[e].refDistance=i}}},onSetMaxDistance:function(t,e,i){const s=this.data.slots;for(const t in s){const e=s[t];if(!e.overlap){const t=e.instances;for(let e=0,s=t.length;e<s;e++)t[e].maxDistance=i}}},onSetRollOffFactor:function(t,e,i){const s=this.data.slots;for(const t in s){const e=s[t];if(!e.overlap){const t=e.instances;for(let e=0,s=t.length;e<s;e++)t[e].rollOffFactor=i}}},onSetDistanceModel:function(t,e,i){const s=this.data.slots;for(const t in s){const e=s[t];if(!e.overlap){const t=e.instances;for(let e=0,s=t.length;e<s;e++)t[e].distanceModel=i}}},onSetPositional:function(t,e,i){const s=this.data.slots;for(const t in s){const e=s[t];if(!e.overlap){const t=e.instances;for(let i=0,s=t.length;i<s;i++){const s=t[i].isPlaying||t[i].isSuspended,n=t[i].currentTime;s&&t[i].stop(),t[i]=e._createInstance(),s&&(t[i].play(),t[i].currentTime=n)}}}},onEnable:function(){if(this.system._inTools)return;const t=this.data.slots,e=this.data.playingBeforeDisable;for(const i in t){const s=t[i];s.autoPlay&&s.isStopped?s.play():e[i]?s.resume():s.isLoaded||s.load()}},onDisable:function(){const t=this.data.slots,e={};for(const i in t)t[i].overlap||t[i].isPlaying&&(t[i].pause(),e[i]=!0);this.data.playingBeforeDisable=e},addSlot:function(t,e){const i=this.data.slots;if(i[t])return console.warn("A sound slot with name "+t+" already exists on Entity "+this.entity.getPath()),null;const s=new pc.SoundSlot(this,t,e);return i[t]=s,s.autoPlay&&this.enabled&&this.entity.enabled&&s.play(),s},removeSlot:function(t){const e=this.data.slots;e[t]&&(e[t].stop(),delete e[t])},slot:function(t){return this.data.slots[t]},play:function(t){if(!this.enabled||!this.entity.enabled)return null;const e=this.slots[t];return e?e.play():(console.warn("Trying to play sound slot with name "+t+" which does not exist"),null)},pause:function(t){let e;const i=this.data.slots;if(t){if(e=i[t],!e)return void console.warn("Trying to pause sound slot with name "+t+" which does not exist");e.pause()}else for(const t in i)i[t].pause()},resume:function(t){let e;const i=this.data.slots;if(t){if(e=i[t],!e)return void console.warn("Trying to resume sound slot with name "+t+" which does not exist");e.isPaused&&e.resume()}else for(const t in i)i[t].resume()},stop:function(t){let e;const i=this.data.slots;if(t){if(e=i[t],!e)return void console.warn("Trying to stop sound slot with name "+t+" which does not exist");e.stop()}else for(const t in i)i[t].stop()}}),{SoundComponent:t}}()),Object.assign(pc,function(){const t=["enabled","volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"],e=function(e,i){pc.ComponentSystem.call(this,e),this.id="sound",this.description="Allows an Entity to play sounds",this.ComponentType=pc.SoundComponent,this.DataType=pc.SoundComponentData,this.schema=t,this.manager=i,pc.ComponentSystem.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.SoundComponent.prototype,t),Object.assign(e.prototype,{initializeComponentData:function(t,e,i){i=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots","enabled"],pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i)},cloneComponent:function(t,e){let i;const s=t.sound.data,n={};for(i in s)s.hasOwnProperty(i)&&(n[i]=s[i]);for(i in n.slots={},s.slots){const t=s.slots[i];t instanceof pc.SoundSlot?n.slots[i]={name:t.name,volume:t.volume,pitch:t.pitch,loop:t.loop,duration:t.duration,startTime:t.startTime,overlap:t.overlap,autoPlay:t.autoPlay,asset:t.asset}:n.slots[i]=t}return n.playingBeforeDisable={},this.addComponent(e,n)},onUpdate:function(t){const e=this.store;for(const t in e)if(e.hasOwnProperty(t)){const i=e[t],s=i.entity,n=i.data;if(n.enabled&&s.enabled&&n.positional){const t=s.getPosition(),e=n.slots;for(const i in e)e[i].updatePosition(t)}}},onBeforeRemove:function(t,e){const i=e.slots;for(const t in i)i[t].overlap||i[t].stop()}}),Object.defineProperty(e.prototype,"volume",{get:function(){return this.manager.volume},set:function(t){this.manager.volume=t}}),Object.defineProperty(e.prototype,"context",{get:function(){return pc.SoundManager.hasAudioContext()?this.manager.context:(console.warn("WARNING: Audio context is not supported on this browser"),null)}}),{SoundComponentSystem:e}}()),pc.SoundComponentData=function(){this.enabled=!0,this.volume=1,this.pitch=1,this.positional=!0,this.refDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=pc.DISTANCE_LINEAR,this.slots={},this.playingBeforeDisable={}},Object.assign(pc,function(){const t=function(t,e){pc.Component.call(this,t,e),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)};return(t.prototype=Object.create(pc.Component.prototype)).constructor=t,Object.assign(t.prototype,{play:function(t){if(!this.enabled||!this.entity.enabled)return;let e;this.channel&&this.stop();const i=this.data;if(i.sources[t])if(i["3d"]){const s=this.entity.getPosition();e=this.system.manager.playSound3d(i.sources[t],s,i),i.currentSource=t,i.channel=e}else e=this.system.manager.playSound(i.sources[t],i),i.currentSource=t,i.channel=e},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=null)},onSetAssets:function(t,e,i){const s=[];let n;const r=i.length;if(e&&e.length)for(n=0;n<e.length;n++)if(e[n]){const t=this.system.app.assets.get(e[n]);t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this),this.currentSource===t.name&&this.stop())}if(r)for(n=0;n<r;n++)e.indexOf(i[n])<0&&(i[n]instanceof pc.Asset?s.push(i[n].id):s.push(i[n]));!this.system._inTools&&s.length&&this.loadAudioSourceAssets(s)},onAssetChanged:function(t,e,i,s){if("resource"===e){this.data.sources&&(this.data.sources[t.name]=i,this.data.currentSource===t.name&&this.channel&&(this.channel.paused?(this.play(t.name),this.pause()):this.play(t.name)))}},onAssetRemoved:function(t){t.off("remove",this.onAssetRemoved,this),this.data.sources[t.name]&&(delete this.data.sources[t.name],this.data.currentSource===t.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(t,e,i){e!==i&&this.channel&&this.channel.setLoop(i)},onSetVolume:function(t,e,i){e!==i&&this.channel&&this.channel.setVolume(i)},onSetPitch:function(t,e,i){e!==i&&this.channel&&this.channel.setPitch(i)},onSetMaxDistance:function(t,e,i){e!==i&&this.channel instanceof pc.Channel3d&&this.channel.setMaxDistance(i)},onSetMinDistance:function(t,e,i){e!==i&&this.channel instanceof pc.Channel3d&&this.channel.setMinDistance(i)},onSetRollOffFactor:function(t,e,i){e!==i&&this.channel instanceof pc.Channel3d&&this.channel.setRollOffFactor(i)},onSetDistanceModel:function(t,e,i){e!==i&&this.channel instanceof pc.Channel3d&&this.channel.setDistanceModel(i)},onSet3d:function(t,e,i){if(e!==i&&this.system.initialized&&this.currentSource){let t=!1,e=!1;this.channel&&(t=this.channel.paused,e=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=t,this.channel.suspended=e)}},onEnable:function(){const t=this.data.assets;if(t){const e=this.system.app.assets;for(let i=0,s=t.length;i<s;i++){let s=t[i];s instanceof pc.Asset||(s=e.get(s)),s&&!s.resource&&e.load(s)}}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){this.pause()},loadAudioSourceAssets:function(t){const e=this,i=t.map((function(t){return this.system.app.assets.get(t)}),this),s={};let n=null,r=i.length;const o=function(t){r--},a=function(){this.data.sources=s,this.data.currentSource=n,this.enabled&&this.activate&&n&&this.onEnable()}.bind(this);i.forEach((function(i,c){i?(n=n||i.name,i.off("change",this.onAssetChanged,this),i.on("change",this.onAssetChanged,this),i.off("remove",this.onAssetRemoved,this),i.on("remove",this.onAssetRemoved,this),i.off("error",o,this),i.on("error",o,this),i.ready(t=>{s[t.name]=t.resource,r--,0===r&&a()}),!i.resource&&e.enabled&&e.entity.enabled&&this.system.app.assets.load(i)):(r--,0===r&&a(),this.system.app.assets.on("add:"+t[c],t=>{t.ready(t=>{e.data.sources[t.name]=t.resource}),t.resource||e.system.app.assets.load(t)}))}),this)}}),{AudioSourceComponent:t}}()),Object.assign(pc,function(){const t=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"],e=function(e,i){pc.ComponentSystem.call(this,e),this.id="audiosource",this.description="Specifies audio assets that can be played at the position of the Entity.",this.ComponentType=pc.AudioSourceComponent,this.DataType=pc.AudioSourceComponentData,this.schema=t,this.manager=i,this.initialized=!1,pc.ComponentSystem.on("initialize",this.onInitialize,this),pc.ComponentSystem.on("update",this.onUpdate,this),this.on("remove",this.onRemove,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.AudioSourceComponent.prototype,t),Object.assign(e.prototype,{initializeComponentData:function(t,e,i){i=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i),t.paused=!(t.enabled&&t.activate)},onInitialize:function(t){t.audiosource&&t.enabled&&t.audiosource.enabled&&t.audiosource.activate&&t.audiosource.play(t.audiosource.currentSource);const e=t._children;let i;const s=e.length;for(i=0;i<s;i++)e[i]instanceof pc.Entity&&this.onInitialize(e[i]);this.initialized=!0},onUpdate:function(t){const e=this.store;for(const t in e)if(e.hasOwnProperty(t)){const i=e[t],s=i.entity,n=i.data;if(n.enabled&&s.enabled&&n.channel instanceof pc.Channel3d){const t=s.getPosition();n.channel.setPosition(t)}}},onRemove:function(t,e){e.channel&&(e.channel.stop(),e.channel=null)},setVolume:function(t){this.manager.setVolume(t)}}),{AudioSourceComponentSystem:e}}()),pc.AudioSourceComponentData=function(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=pc.DISTANCE_INVERSE,this.paused=!0,this.sources={},this.currentSource=null,this.channel=null},Object.assign(pc,function(){const t=function(t,e){pc.Component.call(this,t,e)};return(t.prototype=Object.create(pc.Component.prototype)).constructor=t,Object.assign(t.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const t=this.system.current.getPosition();this.system.manager.listener.setPosition(t)}},onEnable:function(){this.setCurrentListener()},onDisable:function(){this.system.current===this.entity&&(this.system.current=null)}}),{AudioListenerComponent:t}}()),Object.assign(pc,function(){const t=["enabled"],e=function(e,i){pc.ComponentSystem.call(this,e),this.id="audiolistener",this.description="Specifies the location of the listener for 3D audio playback.",this.ComponentType=pc.AudioListenerComponent,this.DataType=pc.AudioListenerComponentData,this.schema=t,this.manager=i,this.current=null,pc.ComponentSystem.on("update",this.onUpdate,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.AudioListenerComponent.prototype,t),Object.assign(e.prototype,{initializeComponentData:function(t,e,i){i=["enabled"],pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i)},onUpdate:function(t){if(this.current){const t=this.current.getPosition();this.manager.listener.setPosition(t);const e=this.current.getWorldTransform();this.manager.listener.setOrientation(e)}}}),{AudioListenerComponentSystem:e}}()),Object.assign(pc,{AudioListenerComponentData:function(){this.enabled=!0}}),pc.extend(pc,function(){const t=function(t,e){pc.Component.call(this,t,e),this._resolution=new pc.Vec2(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this._referenceResolution=new pc.Vec2(640,320),this._offset=new pc.Vec2(0,0),this._scaleMode=pc.ScreenComponent.SCALEMODE_NONE,this.scale=1,this._scaleBlend=.5,this._scaleFactor=1,this._planeHeight=0,this._screenType=pc.SCREEN_TYPE_SCREEN,this._screenDistance=1,this.parentScreen=null,this.childrenScreen=new pc.IndexedList,this._isFallbackOverlay=!1,this.canvasMeshInstance=new pc.CanvasMeshInstance(this),this.registered=!1,this.meshInstances=[this.canvasMeshInstance]};return(t.prototype=Object.create(pc.Component.prototype)).constructor=t,t.SCALEMODE_NONE="none",t.SCALEMODE_BLEND="blend",t.SCALEMODE_EXPAND="expand",t.SCALEMODE_SHRINK="shrink",pc.extend(t.prototype,{_updateScreenInChildren:function(){for(let t=0;t<this.entity._children.length;t++){const e=this.entity._children[t].element;e&&e._updateScreen(e._findScreen(),!0)}this.syncDrawOrder()},syncDrawOrder:function(){const t=pc.Application.getApplication().systems.screen;t&&(t._dirtyOrder=!0)},_calcProjectionMatrix:function(){const t=this._screenType,e=this.camera;t===pc.SCREEN_TYPE_CAMERA&&(e.projection===pc.PROJECTION_PERSPECTIVE?this._planeHeight=Math.tan(e.fov/2*(Math.PI/180))*Math.abs(2*this._screenDistance):this._planeHeight=2*e.orthoHeight),this.entity.element.dirtifyScreen()},_findParentScreen:function(){return pc.UIUtils.findParentScreen(this.entity.parent)},onRemove:function(){this.reparentChildrenToNewCanvas()},reparentChildrenToNewCanvas:function(){const t=pc.UIUtils.findParentScreen(this.entity.parent),e=this.canvasMeshInstance.renderers._list;for(let i=0;i<e.length;i++){e[i].reparentCanvas(t)}},_updateScale:function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_calcScale:function(e,i){if(this._scaleMode===t.SCALEMODE_NONE)return this.scaleFactor;if(this._scaleMode===t.SCALEMODE_EXPAND)return Math.min(e.x/i.x,e.y/i.y);if(this._scaleMode===t.SCALEMODE_SHRINK)return Math.max(e.x/i.x,e.y/i.y);{const t=Math.log2(e.x/i.x),s=Math.log2(e.y/i.y),n=pc.math.lerp(t,s,this.scaleBlend);return Math.pow(2,n)}},_onResize:function(t,e,i,s){const n=this.camera;let r=i,o=s;n&&n.renderTarget&&(r=n.renderTarget.width,o=n.renderTarget.height),this._screenType!==pc.SCREEN_TYPE_WORLD&&(this._resolution.set(r,o),this.resolution=this._resolution),this.entity.element&&this.entity.element.triggerOnElementDimesionsChange(!0,!0)},_updateStencilRecursive:function(t,e){const i=t.element,s=!!i,n=s&&(i._image&&i._image.masksChildren||i._text&&i._text.masksChildren);s&&(i._masked=e.maskingDepth>0,n&&(i._topMostMask=0===e.maskingDepth,e.maskingDepth++,e.ref=(1<<e.maskingDepth)-1),i.stencilLayer=e.ref);for(let i=0;i<t._children.length;i++)this._updateStencilRecursive(t._children[i],e);s&&n&&(e.maskingDepth--,e.ref=(1<<e.maskingDepth)-1)},_updateStencilParameters:function(){if(!this.entity)return;this._updateStencilRecursive(this.entity,{ref:0,maskingDepth:0})},addScreenToScene:function(){this.screenType!==pc.SCREEN_TYPE_SCREEN&&this.system.app.scene.addRenderer(this),this.system.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.system.app.scene.addScreen(this)},removeScreenFromScene:function(){this.screenType!==pc.SCREEN_TYPE_SCREEN&&this.system.app.scene.removeRenderer(this),this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.system.app.scene.removeScreen(this)},onEnable:function(){this.registered=!0;const t=pc.UIUtils.findParentScreen(this.entity.parent);this.setParentScreen(t,!0);const e=this.system.app.graphicsDevice;this._onResize(e.width,e.height,e._width,e._height)},onDisable:function(){this.setParentScreen(null,!1),this.registered=!1},onDestroy:function(){this.reparentChildrenToNewCanvas()},getMeshInstancesForRender:function(){return this.meshInstances},setParentScreen(t,e){e=!!e,this.registered&&(this.parentScreen?(this.parentScreen.childrenScreen.remove(this),this.parentScreen.canvasMeshInstance.removeRenderer(this.canvasMeshInstance)):this.removeScreenFromScene()),this.parentScreen=t,this.registered&&e&&(this.parentScreen?(this.parentScreen.childrenScreen.push(this),this.parentScreen.canvasMeshInstance.addRenderer(this.canvasMeshInstance)):this.addScreenToScene())}}),Object.defineProperty(t.prototype,"resolution",{set:function(t){const e=this.camera;e&&e.renderTarget||(this._screenType!==pc.SCREEN_TYPE_SCREEN?0!==t.x&&0!==t.y&&this._resolution.set(t.x,t.y):e&&e.renderTarget||this._resolution.set(this.system.app.graphicsDevice._width,this.system.app.graphicsDevice._height),this._scaleMode===pc.ScreenComponent.SCALEMODE_NONE&&this.referenceResolution.copy(this._resolution),this._updateScale(),this._calcProjectionMatrix(),this.fire("set:resolution",this._resolution))},get:function(){return this._resolution}}),Object.defineProperty(t.prototype,"offset",{set:function(t){this._offset.set(t.x,t.y),this._calcProjectionMatrix()},get:function(){return this._offset}}),Object.defineProperty(t.prototype,"referenceResolution",{set:function(t){this._referenceResolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.fire("set:referenceresolution",this._resolution)},get:function(){return this._scaleMode===pc.ScreenComponent.SCALEMODE_NONE?this._resolution:this._referenceResolution}}),Object.defineProperty(t.prototype,"screenType",{set:function(t){if(this._screenType===t)return;this.registered&&this.enabled&&this.removeScreenFromScene(),this._screenType=t;const e=this.screenType;if(this._isFallbackOverlay=!1,e===pc.SCREEN_TYPE_CAMERA)if(this._camera){const t=this._camera._node.getPosition();this.entity.element.anchoredPosition.set(t.x,t.y)}else this._isFallbackOverlay=!0,this._screenType=pc.SCREEN_TYPE_SCREEN;e===pc.SCREEN_TYPE_SCREEN&&(this.canvasMeshInstance.visible=!0),this._resolution.set(this.system.app.graphicsDevice._width,this.system.app.graphicsDevice._height),this.resolution=this._resolution,this.fire("set:screentype",e),this.registered&&this.enabled&&this.addScreenToScene()},get:function(){return this.parentScreen?this.parentScreen.screenType:this._screenType}}),Object.defineProperty(t.prototype,"screenDistance",{set:function(t){this._screenDistance=t,this._calcProjectionMatrix()},get:function(){return this._screenDistance}}),Object.defineProperty(t.prototype,"scaleMode",{set:function(t){t!==pc.ScreenComponent.SCALEMODE_NONE&&t!==pc.ScreenComponent.SCALEMODE_BLEND&&t!==pc.ScreenComponent.SCALEMODE_EXPAND&&t!==pc.ScreenComponent.SCALEMODE_SHRINK&&(t=pc.ScreenComponent.SCALEMODE_NONE),this._screenType===pc.SCREEN_TYPE_WORLD&&t!==pc.ScreenComponent.SCALEMODE_NONE&&(t=pc.ScreenComponent.SCALEMODE_NONE),this._scaleMode=t,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}}),Object.defineProperty(t.prototype,"scaleBlend",{set:function(t){this._scaleBlend=t,this._updateScale(),this._calcProjectionMatrix(),this.fire("set:scaleblend",this._scaleBlend)},get:function(){return this._scaleBlend}}),Object.defineProperty(t.prototype,"camera",{set:function(t){this._camera=t,this._camera||this.screenType!==pc.SCREEN_TYPE_CAMERA||(this.screenType=pc.SCREEN_TYPE_SCREEN),this._camera&&this._isFallbackOverlay&&(this.screenType=pc.SCREEN_TYPE_CAMERA),t&&null!=t.renderTarget&&this._resolution.set(t.renderTarget.width,t.renderTarget.height),this._calcProjectionMatrix()},get:function(){return this._camera}}),Object.defineProperty(t.prototype,"meshInstances",{get:function(){return[this.canvasMeshInstance]}}),{ScreenComponent:t,SCREEN_TYPE_WORLD:"world",SCREEN_TYPE_CAMERA:"camera",SCREEN_TYPE_SCREEN:"screen"}}()),Object.assign(pc,function(){const t=["enabled"],e=function(t,i){const s=t.element;if(s){const e=t._unityComponents.canvasRenderer[0];e&&(e._absoluteDepth=i),s.drawOrder=i++}const n=t._children;for(let t=0;t<n.length;t++)i=e(n[t],i);return i},i=function(e){pc.ComponentSystem.call(this,e),this.id="screen",this.app=e,this.ComponentType=pc.ScreenComponent,this.DataType=pc.ScreenComponentData,this.schema=t,this.windowResolution=new pc.Vec2,this._drawOrderSyncQueue=new pc.IndexedList,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),pc.ComponentSystem.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)};return(i.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=i,pc.Component._buildAccessors(pc.ScreenComponent.prototype,t),Object.assign(i.prototype,{initializeComponentData:function(t,e,i){void 0!==e.priority&&(t.priority=e.priority),void 0!==e.screenSpace&&(t.screenSpace=e.screenSpace),t.cull=t.screenSpace,void 0!==e.screenType&&(t.screenType=e.screenType),void 0!==e.scaleMode&&(t.scaleMode=e.scaleMode),void 0!==e.scaleBlend&&(t.scaleBlend=e.scaleBlend),void 0!==e.screenDistance&&(t.screenDistance=e.screenDistance),void 0!==e.layer&&(t.layer=e.layer),void 0!==e.drawOrder&&(t.drawOrder=e.drawOrder),void 0!==e.resolution&&(e.resolution instanceof pc.Vec2?t._resolution.copy(e.resolution):t._resolution.set(e.resolution[0],e.resolution[1]),t.resolution=t._resolution),void 0!==e.referenceResolution&&(e.referenceResolution instanceof pc.Vec2?t._referenceResolution.copy(e.referenceResolution):t._referenceResolution.set(e.referenceResolution[0],e.referenceResolution[1]),t.referenceResolution=t._referenceResolution),t.syncDrawOrder(),pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i),t._updateScreenInChildren()},destroy:function(){this.off(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},_syncDrawOrder:function(){e(pc.Application.getApplication().root,0)},_onUpdate:function(t){const e=this.store;this._dirtyOrder&&(this._syncDrawOrder(),this._dirtyOrder=!1);for(const i in e)e[i].entity.screen.update&&e[i].entity.screen.update(t)},_onResize:function(t,e){this.windowResolution.x=t,this.windowResolution.y=e},cloneComponent:function(t,e){const i=t.screen;return this.addComponent(e,{enabled:i.enabled,screenType:i.screenType,scaleMode:i.scaleMode,resolution:i.resolution.clone(),referenceResolution:i.referenceResolution.clone()})},onRemoveComponent:function(t,e){e.onRemove()},onDestroy:function(t,e){e.onRemove()},processDrawOrderSyncQueue:function(){const t=this._drawOrderSyncQueue.list();for(let e=0;e<t.length;e++){const i=t[e];i.callback.call(i.scope)}this._drawOrderSyncQueue.clear()},queueDrawOrderSync:function(t,e,i){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(t)||this._drawOrderSyncQueue.push(t,{callback:e,scope:i})}}),{ScreenComponentSystem:i}}()),Object.assign(pc,{ScreenComponentData:function(){this.enabled=!0}}),Object.assign(pc,{UIUtils:{findParentScreen:function(t){let e=t,i=null;for(;e;){if(e.screen){i=e.screen;break}e=e.parent}return i}}}),pc.extend(pc,function(){pc.ELEMENTTYPE_GROUP="group",pc.ELEMENTTYPE_IMAGE="image",pc.ELEMENTTYPE_TEXT="text";const t=new pc.Vec4,e=function(t,e){pc.Component.call(this,t,e),this._width=0,this._height=0,this._stencilLayer=255,this._anchors=new pc.Vec4,this._pivot=new pc.Vec2(.5,.5),this._sizeDelta=new pc.Vec2(0,0);const i=e.getLocalPosition();this._anchoredPosition=new pc.Vec2(i.x,i.y),this.entity.on("insert",this._onInsert,this),this._lastSyncAABBVersion=-1,this._dirtyScreen=!1,this._dirtyRect=!1,this.screen=null,this._type=pc.ELEMENTTYPE_GROUP,this._pivotPoint=new pc.Vec3,this._image=null,this._text=null,this._group=null,this._localPositionAnimated=new pc.Vec3,this._dirtyAnimatedLocalPosition=!1,this._anchoredPositionAnimated=new pc.Vec3,this._dirtyAnimatedAnchoredPosition=!1,this._canvasGroups=[],this.cachedRect=new UnityEngine.Rect};(e.prototype=Object.create(pc.Component.prototype)).constructor=e,pc.extend(e.prototype,{dirtifyScreen(){if(!this._dirtyScreen){this.entity._app.scene.addDirty(this.entity),this._dirtyScreen=!0;for(const t of this.entity.children)t.element&&t.element.dirtifyRect()}},dirtifyRect(){if(!this._dirtyRect){this.entity._app.scene.addDirty(this.entity),this._dirtyRect=!0;for(const t of this.entity.children)t.element&&t.element.dirtifyRect()}},_getStencilParameters:function(){const t=this._masked?pc.FUNC_EQUAL:pc.FUNC_ALWAYS,e=this._image&&this._image.masksChildren||this._text&&this._text.masksChildren;return new pc.StencilParameters({func:t,ref:this._stencilLayer,writeMask:e?this._stencilLayer:0,readMask:e?this._stencilLayer>>1:this._stencilLayer,zfail:pc.STENCILOP_KEEP,zpass:pc.STENCILOP_REPLACE,fail:this._masked?pc.STENCILOP_KEEP:pc.STENCILOP_REPLACE})},_patch:function(){this.entity.flags|=pc.GraphNode.Flags.HijackedByElementComponent,this._lastSyncAABBVersion=-1,this.dirtifyRect()},_unpatch:function(){this.entity.flags&=~pc.GraphNode.Flags.HijackedByElementComponent},getRect:function(){const t=this._findParentElement();return t&&t.element.getRect(),this._dirtyRect&&this.entity._sync(),this.cachedRect.m_XMin=-this._pivotPoint.x,this.cachedRect.m_YMin=-this._pivotPoint.y,this.cachedRect.m_Width=this._width,this.cachedRect.m_Height=this._height,this.cachedRect.m_XMax=this.cachedRect.m_XMin+this._width,this.cachedRect.m_YMax=this.cachedRect.m_YMin+this._height,this.cachedRect},setVerticesDirty:function(){this._image&&this._image.setVerticesDirty(),this._text&&this._text.setVerticesDirty()},_onInsert:function(t){const e=this._findScreen();this._updateScreen(e),e&&!this.entity.isPrefab&&this.entity.getScene()&&this.triggerOnElementDimesionsChange(!0,!0)},_updateScreen:function(t,e){this.screen=this._findScreen(),this._patch(),this.fire("set:screen",this.screen),this.dirtifyRect(),this.dirtifyScreen(),this._updateScreenForNonElement(this.entity,t,e),this.screen&&!e&&this.screen.screen.syncDrawOrder()},_updateScreenForNonElement:function(t,e,i){const s=t.getChildren();for(let t=0,n=s.length;t<n;t++)s[t].element?s[t].element._updateScreen(e,i):this._updateScreenForNonElement(s[t],e,i)},_findScreen:function(){let t=this.entity,e=this.screen;for(this._nearestScreen=null;t;)this._nearestScreen=this._nearestScreen||t.screen,e=t.screen||e,t=t._parent;return e?e.entity:null},_findParentElement:function(){let t=this.entity._parent;for(;t&&!t.element;)t=t._parent;return t},_onScreenResize:function(t){this.dirtifyScreen(),this.fire("screen:set:resolution",t)},_onScreenTypeChange:function(){this.dirtifyScreen(),this.fire("screen:set:screentype",this.screen.screen.screenType)},addCanvasGroup:function(t,e){null==e?e=0:this.entity._canvasGroups.length>0&&e++,this._canvasGroups.splice(e,0,t);const i=this.entity.children;for(let s=0;s<i.length;s++){const n=i[s].element;n&&n.addCanvasGroup(t,e)}},removeCanvasGroup:function(t){const e=this._canvasGroups.indexOf(t);e>-1&&this._canvasGroups.splice(e,1);const i=this.entity.children;for(let e=0;e<i.length;e++){const s=i[e].element;s&&s.removeCanvasGroup(t)}},onRemove:function(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy()},triggerOnElementDimesionsChange:function(t,e){this.entity._elementDimesionsChange();const i=this.entity.children;for(let s=0;s<i.length;s++){if(!i[s]._activeSelf)continue;const n=i[s].element;if(n){const i=t&&n._anchors.x!==n._anchors.z,s=e&&n._anchors.y!==n._anchors.w;(i||s)&&n.triggerOnElementDimesionsChange(i,s)}}},setupParametersFromImage:function(t,e,i,s,n,r,o,a,c,h,l){const p=this._image;if(!p)return;const u=p._updateMesh;p._updateMesh=function(){},this["UnityEngine.UI.Image"]=t,p.sprite=e,p.spriteType=i,p.fillMethod=s,p.fillOrigin=n,p.fillAmount=r,p.fillCenter=o,p.preserveAspect=a,p.ignoreMask=c,p.enabled=h,p.color=t.m_Color,p._updateMesh=u,p._updateMesh(),this.material=l}}),Object.defineProperty(e.prototype,"type",{get:function(){return this._type},set:function(t){t!==this._type&&(this._type=t,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),t===pc.ELEMENTTYPE_IMAGE?this._image=new pc.ImageElement(this):t===pc.ELEMENTTYPE_TEXT&&(this._text=new pc.TextElement(this)))}}),Object.defineProperty(e.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(t){this._drawOrder!==t&&(this._drawOrder=t,this.fire("set:draworder",this._drawOrder))}}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width}}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height}}),Object.defineProperty(e.prototype,"pivot",{get:function(){return this._pivot},set:function(t){t instanceof pc.Vec2?this._pivot.set(t.x,t.y):this._pivot.set(t[0],t[1]),this.dirtifyRect()}}),Object.defineProperty(e.prototype,"anchor",{get:function(){return this._anchors},set:function(e){let i=e;if(i instanceof pc.Vec4||(i=t,i.set(i[0],i[1],i[2],i[3])),i.equals(this._anchors))return;const s=this._anchors.z-this._anchors.x!=i.z-i.x,n=this._anchors.w-this._anchors.y!=i.w-i.y;this._anchors.copy(i),this.dirtifyRect(),(s||n)&&this.triggerOnElementDimesionsChange(s,n)}}),Object.defineProperty(e.prototype,"anchoredPosition",{get:function(){return this._anchoredPosition},set:function(t){this._anchoredPosition.copy(t),this.dirtifyRect()}}),Object.defineProperty(e.prototype,"sizeDelta",{get:function(){return this._sizeDelta},set:function(t){const e=this._sizeDelta.x!==t.x,i=this._sizeDelta.y!==t.y;(e||i)&&(this._sizeDelta.copy(t),this.dirtifyRect(),this.triggerOnElementDimesionsChange(e,i))}}),Object.defineProperty(e.prototype,"rect",{get:e.prototype.getRect}),Object.defineProperty(e.prototype,"stencilLayer",{get:function(){return this._stencilLayer},set:function(t){this._stencilLayer!==t&&(this._stencilLayer=t,this.fire("set:stencillayer",t))}});const i=function(t){Object.defineProperty(e.prototype,t,{get:function(){return this._text?this._text[t]:this._image?this._image[t]:null},set:function(e){this._text?this._text[t]=e:this._image&&(this._image[t]=e)}})};return i("fontSize"),i("color"),i("font"),i("fontAsset"),i("spacing"),i("lineHeight"),i("align"),i("verticalAlign"),i("text"),i("texture"),i("textureAsset"),i("material"),i("materialAsset"),i("opacity"),i("masksChildren"),i("showMaskGraphics"),i("alphaTest"),i("border"),{ElementComponent:e}}()),Object.assign(pc,function(){const t=["enabled"],e=function(e){pc.ComponentSystem.call(this,e),this.id="element",this.app=e,this.ComponentType=pc.ElementComponent,this.DataType=pc.ElementComponentData,this.schema=t,this._unicodeConverter=null,this._rtlReorder=null,this.on("beforeremove",this.onRemoveComponent,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.ElementComponent.prototype,t),Object.assign(e.prototype,{destroy:function(){this._defaultTexture.destroy()},initializeComponentData:function(t,e,i){let s;t._beingInitialized=!0,void 0!==e.anchor&&(e.anchor instanceof pc.Vec4?t._anchors.copy(e.anchor):t._anchors.set(e.anchor[0],e.anchor[1],e.anchor[2],e.anchor[3])),void 0!==e.pivot&&(e.pivot instanceof pc.Vec2?t._pivot.copy(e.pivot):t._pivot.set(e.pivot[0],e.pivot[1])),void 0!==e.sizeDelta&&(e.sizeDelta instanceof pc.Vec2?t._sizeDelta.copy(e.sizeDelta):t._sizeDelta.set(e.sizeDelta[0],e.sizeDelta[1])),void 0!==e.anchoredPosition&&(e.anchoredPosition instanceof pc.Vec2?t._anchoredPosition.copy(e.anchoredPosition):t._anchoredPosition.set(e.anchoredPosition[0],e.anchoredPosition[1])),void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.useInput&&(t.useInput=e.useInput),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,e.layers&&"array"===pc.type(e.layers)&&(t.layers=e.layers.slice(0)),t.type=e.type,t.type===pc.ELEMENTTYPE_IMAGE?(void 0!==e.rect&&(t.rect=e.rect),void 0!==e.color&&(s=e.color,s instanceof pc.Color||(s=new pc.Color(e.color[0],e.color[1],e.color[2])),t.color=s),void 0!==e.masksChildren&&(t.masksChildren=e.masksChildren),void 0!==e.alphaTest&&(t.alphaTest=e.alphaTest),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.textureAsset&&(t.textureAsset=e.textureAsset),e.texture&&(t.texture=e.texture),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.spriteFrame&&(t.spriteFrame=e.spriteFrame),void 0!==e.pixelsPerUnit&&null!==e.pixelsPerUnit&&(t.pixelsPerUnit=e.pixelsPerUnit),void 0!==e.materialAsset&&(t.materialAsset=e.materialAsset),e.material&&(t.material=e.material),e.border&&(t.border=e.border),void 0!==e.mask&&(t.mask=e.mask)):t.type===pc.ELEMENTTYPE_TEXT&&(void 0!==e.align&&(t.align=e.align),void 0!==e.verticalAlign&&(t.verticalAlign=e.verticalAlign),void 0!==e.autoWidth&&(t.autoWidth=e.autoWidth),void 0!==e.autoHeight&&(t.autoHeight=e.autoHeight),void 0!==e.rtlReorder&&(t.rtlReorder=e.rtlReorder),void 0!==e.unicodeConverter&&(t.unicodeConverter=e.unicodeConverter),void 0!==e.text&&(t.text=e.text),void 0!==e.color&&(s=e.color,s instanceof pc.Color||(s=new pc.Color(s[0],s[1],s[2])),t.color=s),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.spacing&&(t.spacing=e.spacing),void 0!==e.fontSize&&(t.fontSize=e.fontSize,e.lineHeight||(t.lineHeight=e.fontSize)),void 0!==e.lineHeight&&(t.lineHeight=e.lineHeight),void 0!==e.wrapLines&&(t.wrapLines=e.wrapLines),void 0!==e.fontAsset&&(t.fontAsset=e.fontAsset),void 0!==e.font&&(t.font=e.font),void 0!==e.alignment&&(t.alignment=e.alignment));const n=t._findScreen();n&&n.screen&&t._updateScreen(n.screen),pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i),t._beingInitialized=!1,t.type===pc.ELEMENTTYPE_IMAGE&&t._image._meshDirty&&t._image._updateMesh(t._image.mesh)},onRemoveComponent:function(t,e){e.onRemove()},cloneComponent:function(t,e){const i=t.element;return this.addComponent(e,{enabled:i.enabled,width:i.width,height:i.height,anchor:i.anchor.clone(),pivot:i.pivot.clone(),margin:i.margin.clone(),alignment:i.alignment&&i.alignment.clone()||i.alignment,autoWidth:i.autoWidth,autoHeight:i.autoHeight,type:i.type,rect:i.rect&&i.rect.clone()||i.rect,rtlReorder:i.rtlReorder,unicodeConverter:i.unicodeConverter,materialAsset:i.materialAsset,material:i.material,color:i.color&&i.color.clone()||i.color,opacity:i.opacity,textureAsset:i.textureAsset,texture:i.texture,spriteAsset:i.spriteAsset,sprite:i.sprite,spriteFrame:i.spriteFrame,pixelsPerUnit:i.pixelsPerUnit,text:i.text,spacing:i.spacing,lineHeight:i.lineHeight,wrapLines:i.wrapLines,layers:i.layers,fontSize:i.fontSize,fontAsset:i.fontAsset,font:i.font,useInput:i.useInput,batchGroupId:i.batchGroupId,mask:i.mask})},registerUnicodeConverter:function(t){this._unicodeConverter=t},registerRtlReorder:function(t){this._rtlReorder=t},getUnicodeConverter:function(){return this._unicodeConverter},getRtlReorder:function(){return this._rtlReorder},_onUpdate:function(t){const e=this.store;for(const i in e)e[i].entity.element.update&&e[i].entity.element.update(t)}}),{ElementComponentSystem:e}}()),Object.assign(pc,{ElementComponentData:function(){this.enabled=!0}}),pc.extend(pc,function(){const t=[0,0,0,0],e=function(e){this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._masksChildren=!1,this._alphaTest=.01,this._ignoreMask=!1,this._showMaskGraphics=!0,this._enabled=!0,this._rect=new pc.Vec4(0,0,1,1),this._border=new pc.Vec4(0,0,0,0),this._color=new pc.Color(1,1,1,1),this._pivotPoint=new pc.Vec2,this._material=UnityEngine.Canvas.DefaultCanvasMaterial.handle,this._maskMaterial=UnityEngine.Canvas.DefaultCanvasMaterial.handle,this._positions=[],this._normals=[],this._uvs=[],this._indices=[],this._colors=[],this._canvasRenderer=this._entity._unityComponents.canvasRenderer[0],this._mesh=this._createMesh(),this._model=this._canvasRenderer.model,this._model.setParameter("_TextureSampleAdd",t),this._canvasRenderer.setMesh(this._mesh),this._canvasRenderer.setMaterial(this._material,0),this._drawOrder=0,this._fillCenter=!0,this._fillMethod=0,this._spriteType=0,this._element.on("resize",this._onParentResize,this)};return pc.extend(e.prototype,{destroy:function(){this._canvasRenderer.setMesh(null),this._element.off("resize",this._onParentResize,this),this._mesh&&(this._mesh.destroy(),this._mesh=null)},_onParentResize:function(){if(this._mesh){if(this._pivotPoint.equals(this._element._pivotPoint)&&this._width===this._element.width&&this._height===this._element.height)return;this._updateMesh(this._mesh),this._width=this._element.width,this._height=this._element.height,this._pivotPoint.copy(this._element._pivotPoint)}},setVerticesDirty:function(){this._mesh&&this._updateMesh(this._mesh)},_updateMaterial:function(){const t=this._material||UnityEngine.Canvas.DefaultCanvasMaterial.handle;this._canvasRenderer.setMaterial(t,0)},_createMesh:function(){const t=this._element.width,e=this._element.height;this._positions[0]=0,this._positions[1]=0,this._positions[2]=0,this._positions[3]=t,this._positions[4]=0,this._positions[5]=0,this._positions[6]=t,this._positions[7]=e,this._positions[8]=0,this._positions[9]=0,this._positions[10]=e,this._positions[11]=0;for(let t=0;t<12;t+=3)this._normals[t]=0,this._normals[t+1]=0,this._normals[t+2]=-1;this._uvs[0]=0,this._uvs[1]=0,this._uvs[2]=1,this._uvs[3]=0,this._uvs[4]=1,this._uvs[5]=1,this._uvs[6]=0,this._uvs[7]=1,this._indices[0]=0,this._indices[1]=1,this._indices[2]=3,this._indices[3]=2,this._indices[4]=3,this._indices[5]=1;const i=pc.createMesh(this._system.app.graphicsDevice,this._positions,{uvs:this._uvs,normals:this._normals,indices:this._indices});return this._updateMesh(i),i}}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(t){this._color.copy(t)}}),Object.defineProperty(e.prototype,"masksChildren",{get:function(){return this._masksChildren},set:function(t){this._masksChildren=t,this._canvasRenderer.model.masksChildren=t,this._element&&this._element.screen&&(this._element.screen.screen.canvasMeshInstance.renderersDirty=!0)}}),Object.defineProperty(e.prototype,"alphaTest",{get:function(){return this._alphaTest},set:function(t){this._alphaTest=t,this._updateMaterial()}}),Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color.data[3]},set:function(t){this._color.a=t,this.color=this._color}}),Object.defineProperty(e.prototype,"rect",{get:function(){return this._rect},set:function(t){t instanceof pc.Vec4?this._rect.set(t.x,t.y,t.z,t.w):this._rect.set(t[0],t[1],t[2],t[3]),this._mesh&&this._updateMesh(this._mesh)}}),Object.defineProperty(e.prototype,"border",{get:function(){return this._border},set:function(t){t instanceof pc.Vec4?this._border.set(t.x,t.y,t.z,t.w):this._border.set(t[0],t[1],t[2],t[3]),this._mesh&&this._updateMesh(this._mesh)}}),Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t,this._updateMaterial()}}),Object.defineProperty(e.prototype,"texture",{get:function(){return this._texture},set:function(t){this._texture=t,this._canvasRenderer.setTexture(this._texture),this._mesh&&this._updateMesh(this._mesh)}}),Object.defineProperty(e.prototype,"ignoreMask",{get:function(){return this._ignoreMask},set:function(t){this._ignoreMask=t,t&&(this.alphaTest=0),this._updateMaterial()}}),Object.defineProperty(e.prototype,"showMaskGraphics",{get:function(){return this._showMaskGraphics},set:function(t){this._showMaskGraphics=t,this._canvasRenderer.showMaskGraphics=t,this._updateMaterial()}}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){if(this._enabled===t)return;this._enabled=t,this._canvasRenderer.enabled=t;const e=this._enabled?this._canvasRenderer.findParentCanvas():null;this._canvasRenderer.reparentCanvas(e)}}),{ImageElement:e}}()),pc.extend(pc,function(){const t=[1,1,1,0],e=function(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._enabled=!0,this._horizontalWrap=!1,this._verticalOverflow=!1,this._align=pc.TEXT_ALIGN_CENTER,this._veticalAlign=pc.TEXT_VERTICAL_ALIGN_MIDDLE,this._fontAsset=null,this._font=null,this._color=new pc.Color(1,1,1,1),this._spacing=1,this._fontSize=32,this._lineHeight=1,this._bestFit=!1,this._minFontSize=0,this._maxFontSize=1e3,this.width=0,this.height=0,this._material=null,this._canvasRenderer=this._entity._unityComponents.canvasRenderer?this._entity._unityComponents.canvasRenderer[0]:null,this._mesh=this._createMesh(""),this._model=this._canvasRenderer.model,this._model.setParameter("_TextureSampleAdd",t),this._canvasRenderer.setMesh(this._mesh),this._canvasRenderer.setMaterial(this._material,0),this._positions=[],this._normals=[],this._uvs=[],this._indices=[],this._spacings=new pc.Vec4(0,0,0,0),this._noResize=!1,this._masksChildren=!1};return pc.extend(e.prototype,{destroy:function(){this._canvasRenderer.setMesh(null),this._element.off("resize",this._onParentResize,this),this._mesh&&(this._mesh.destroy(),this._mesh=null)},_updateTextObsolete:function(t){if(this._font&&(!this._element||this._element._enabled)){if(void 0===t&&(t=this._text),this._mesh&&t.length===this._text.length)this._updateMesh(this._mesh,t);else{if(this._mesh){this._canvasRenderer.setMesh(null),this._mesh.vertexBuffer.destroy();for(let t=0;t<this._mesh.indexBuffer.length;t++)this._mesh.indexBuffer[t].destroy();this._model=null,this._mesh=null,this._meshInstance=null}this._updateMaterial(),this._mesh=this._createMesh(t),this._canvasRenderer.setMesh(this._mesh),this._onStencilLayerChange(),this._updateAligns()}this._canvasRenderer.setTexture(this._font.texture)}},_updateAligns:function(){let t=1;if(this._bestFit){const e=this._element.width/this.width,i=this._element.width/this.width,s=this._minFontSize/this._fontSize,n=this._maxFontSize/this._fontSize;t=Math.min(e,i),t=Math.min(n,Math.max(s,t)),this._node.setLocalScale(t,t,t)}if(!this._mesh)return;const e=pc.Vec3.ZERO.clone();e.x+=this._spacings.x*t,e.y+=this._spacings.w*t},_updateMaterial:function(){const t=this._material||UnityEngine.Canvas.DefaultCanvasMaterial.handle;this._canvasRenderer.setMaterial(t,0)},_createMeshObsolete:function(t){let e=t.length;0===e&&(e=1,t=" "),this._positions=new Array(3*e*4),this._normals=new Array(3*e*4),this._uvs=new Array(2*e*4),this._indices=new Array(3*e*2);for(let t=0;t<e;t++)this._indices.push(4*t,4*t+1,4*t+3),this._indices.push(4*t+2,4*t+3,4*t+1);const i=pc.createMesh(this._system.app.graphicsDevice,this._positions,{uvs:this._uvs,normals:this._normals,indices:this._indices});return this._updateMesh(i,t),i},setVerticesDirty:function(){this._mesh&&this._updateMesh(this._mesh,this.text)}}),Object.defineProperty(e.prototype,"text",{get:function(){return this._text},set:function(t){const e=(t||"").toString();this._text!==e&&(this._font&&this._updateText(e),this._text=e)}}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(t){this._color.copy(t)}}),Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color.data[3]},set:function(t){this._color.a=t,this.color=this._color}}),Object.defineProperty(e.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(t){this._lineHeight=t}}),Object.defineProperty(e.prototype,"spacing",{get:function(){return this._spacing},set:function(t){this._spacing=t}}),Object.defineProperty(e.prototype,"align",{get:function(){return this._align},set:function(t){this._align=t}}),Object.defineProperty(e.prototype,"verticalAlign",{get:function(){return this._veticalAlign},set:function(t){this._veticalAlign=t}}),Object.defineProperty(e.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){this._fontSize=t}}),Object.defineProperty(e.prototype,"horizontalWrap",{get:function(){return this._horizontalWrap},set:function(t){this._horizontalWrap=t}}),Object.defineProperty(e.prototype,"verticalOverflow",{get:function(){return this._verticalOverflow},set:function(t){this._verticalOverflow=t}}),Object.defineProperty(e.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t}}),Object.defineProperty(e.prototype,"bestFit",{get:function(){return this._bestFit},set:function(t){this._bestFit=t}}),Object.defineProperty(e.prototype,"minFontSize",{get:function(){return this._minFontSize},set:function(t){this._minFontSize=t}}),Object.defineProperty(e.prototype,"maxFontSize",{get:function(){return this._maxFontSize},set:function(t){this._maxFontSize=t}}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){if(this._enabled===t)return;this._enabled=t,this._canvasRenderer.enabled=t,!this._enabled&&this._textGenerator&&this._textGenerator._reset();const e=this._enabled?this._canvasRenderer.findParentCanvas():null;this._canvasRenderer.reparentCanvas(e)}}),Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t,this._updateMaterial()}}),Object.defineProperty(e.prototype,"masksChildren",{get:function(){return this._masksChildren},set:function(t){this._masksChildren=t;const e=this._canvasRenderer.model.meshInstances;for(let i=0;i<e.length;i++){const s=e[i];t?s._shaderDefs|=pc.SHADERDEF_UI_MASK:s._shaderDefs&=~pc.SHADERDEF_UI_MASK}this._element&&this._element.screen&&(this._element.screen.screen.canvasMeshInstance.renderersDirty=!0)}}),{TextElement:e,TEXT_ALIGN_LEFT:"left",TEXT_ALIGN_RIGHT:"right",TEXT_ALIGN_CENTER:"center",TEXT_VERTICAL_ALIGN_TOP:"top",TEXT_VERTICAL_ALIGN_MIDDLE:"middle",TEXT_VERTICAL_ALIGN_BOTTOM:"bottom"}}()),pc.extend(pc,{POINTEREVENT_MOVE:"pointer:move",POINTEREVENT_UP:"pointer:up",POINTEREVENT_DOWN:"pointer:down",POINTEREVENT_CLICK:"pointer:click",POINTEREVENT_SCROLL:"pointer:scroll",POINTEREVENT_ENTER:"pointer:enter",POINTEREVENT_LEAVE:"pointer:leave"}),Object.assign(pc,function(){pc.FONT_MSDF="msdf",pc.FONT_BITMAP="bitmap";const t=function(t,e){this.type=t&&t.type||pc.FONT_MSDF,this.em=1,this.intensity=0,this._data=null,this.data=t,this._name=e.name||"",this._ascent=t.info.ascent||0,this._lineHeight=t.info.lineHeight||0,this._fontSize=t.info.fontSize||null,this._characterInfo=e.characterInfo||null,this._textures=e.texture||null};return Object.defineProperty(t.prototype,"name",{get:function(){return this._name}}),Object.defineProperty(t.prototype,"ascent",{get:function(){return this._ascent}}),Object.defineProperty(t.prototype,"lineHeight",{get:function(){return this._lineHeight}}),Object.defineProperty(t.prototype,"fontSize",{get:function(){return this._fontSize}}),Object.defineProperty(t.prototype,"characterInfo",{get:function(){return this._characterInfo}}),Object.defineProperty(t.prototype,"texture",{get:function(){return this._textures}}),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(t){if(this._data=t,t&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(const t in this._data.chars)this._data.chars.hasOwnProperty(t)&&(this._data.chars[t].map=0)}}),{FONT_MSDF:pc.FONT_MSDF,Font:t}}()),Object.assign(pc,function(){const t=function(t,e){this.type="bitmap",this.app=t,this.intensity=0,e=e||{},this.fontWeight=e.fontWeight||"normal",this.fontSize=parseInt(e.fontSize,10),this.glyphSize=this.fontSize,this.fontName=e.fontName||"Arial",this.color=e.color||new pc.Color(1,1,1),this._customGetCharScale=e.getCharScale||null;const i=e.width>4096?4096:e.width||2048,s=e.height>4096?4096:e.height||2048,n=document.createElement("canvas");n.height=s,n.width=i;const r=new pc.Texture(this.app.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0});r.setSource(n),r.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR,r.magFilter=pc.FILTER_LINEAR,r.addressU=pc.ADDRESS_CLAMP_TO_EDGE,r.addressV=pc.ADDRESS_CLAMP_TO_EDGE,this.textures=[r],this.chars="",this.data={}};return t.prototype.createTextures=function(t){const e=this._normalizeCharsSet(t);if(e.length===this.chars.length){for(let t=0;t<e.length;t++)if(e[t]!==this.chars[t])return void this._renderAtlas(e)}else this._renderAtlas(e)},t.prototype.updateTextures=function(t){const e=this._normalizeCharsSet(t),i=[];for(let t=0;t<e.length;t++){const s=e[t];this.data.chars[s]||i.push(s)}i.length>0&&this._renderAtlas(this.chars.concat(i))},t.prototype.destroy=function(){for(let t=0;t<this.textures.length;t++)this.textures[t].destroy();this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.textures=null,this.type=null,this.fontWeight=null},t.prototype._getAndClearContext=function(t,e){const i=t.width,s=t.height,n=t.getContext("2d",{alpha:!0});return n.clearRect(0,0,i,s),n.fillStyle=e,n.fillRect(0,0,i,s),n},t.prototype._colorToRgbString=function(t,e){let i;const s=Math.round(255*t.r),n=Math.round(255*t.g),r=Math.round(255*t.b);return i=e?"rgba("+s+", "+n+", "+r+", "+t.a+")":"rgb("+s+", "+n+", "+r+")",i},t.prototype.renderCharacter=function(t,e,i,s,n){t.fillStyle=n,t.fillText(e,i,s)},t.prototype._renderAtlas=function(t){this.chars=t;let e=1,i=this.textures[e-1].getSource();const s=i.width,n=i.height,r=this._colorToRgbString(this.color,!1),o=this.color.a;this.color.a=1/255;const a=this._colorToRgbString(this.color,!0);this.color.a=o;let c=this._getAndClearContext(i,a);c.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName,c.textAlign="center",c.textBaseline="bottom",this.data=this._createJson(this.chars,this.fontName,s,n);const h=this.glyphSize,l=this.glyphSize,p=h/2;let u,d=p,_=l;const f=pc.string.getSymbols(this.chars.join("")),m=this.textures.length;for(u=0;u<f.length;u++){const t=f[u],o=pc.string.getCodePoint(f[u]),g=this._getCharScale(o)*this.fontSize;c.font=this.fontWeight+" "+g.toString()+"px "+this.fontName,c.textAlign="center",c.textBaseline="bottom",this.renderCharacter(c,t,d,_,r);const y=c.measureText(t).width,E=(h-y)/2,T=0,A=y;if(this._addChar(this.data,t,o,d-p,_-l,h,l,E,T,A,e-1,s,n),d+=h,d+p>s&&(d=p,_+=l,_>n))if(this.textures[e-1].upload(),e++,_=l,e>m){i=document.createElement("canvas"),i.height=n,i.width=s,c=this._getAndClearContext(i,a);const t=new pc.Texture(this.app.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0});t.setSource(i),t.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR,t.magFilter=pc.FILTER_LINEAR,t.addressU=pc.ADDRESS_CLAMP_TO_EDGE,t.addressV=pc.ADDRESS_CLAMP_TO_EDGE,this.textures.push(t)}else i=this.textures[e-1].getSource(),c=this._getAndClearContext(i,a)}if(this.textures[e-1].upload(),e<m){for(u=e;u<m;u++)this.textures[u].destroy();this.textures.splice(e)}},t.prototype._createJson=function(t,e,i,s){return{version:3,intensity:this.intensity,info:{face:e,width:i,height:s,maps:[{width:i,height:s}]},chars:{}}},t.prototype._getCharScale=function(t){if(this._customGetCharScale){const e=this._customGetCharScale(t);if(e>=0)return e}return t>=192&&t<=221?.875:t>=126976&&t<=129535?.8:t>=9728&&t<=9983?.8:t>=9984&&t<=10175?.8:10145===t||t>=11008&&t<=11023?.8:1},t.prototype._addChar=function(t,e,i,s,n,r,o,a,c,h,l,p,u){t.info.maps.length<l+1&&t.info.maps.push({width:p,height:u});const d=this._getCharScale(i)*this.fontSize/32;t.chars[e]={id:i,letter:e,x:s,y:n,width:r,height:o,xadvance:h/d,xoffset:a/d,yoffset:c/d,scale:d,range:1,map:l,bounds:[0,0,r/d,o/d]}},t.prototype._normalizeCharsSet=function(t){const e=this.app.systems.element.getUnicodeConverter();e&&(t=e(t));const i={},s=pc.string.getSymbols(t);let n;for(n=0;n<s.length;n++){const t=s[n];i[t]||(i[t]=t)}return Object.keys(i).sort()},{CanvasFont:t}}()),Object.assign(pc,function(){let t=!1;const e=function(t,e,i){if(t instanceof pc.Application&&(e=t,t="Untitled"),pc.GraphNode.call(this,t),this._batchHandle=null,this.c={},this._app=e,!e&&(this._app=pc.Application.getApplication(),!this._app))throw new Error("Couldn't find current application");this.$id=null,this.objectJson=null,this.isPrefab=!0===i,this.getGuid(),this["__UnityEngine.Transform"]=null,this["__UnityEngine.RectTransform"]=null,this["__UnityEngine.GameObject"]=null,this._destroying=!1,this._cullingLayer=0,this._beingDestroyed=!1,this._destroyed=!1,this._unityComponents={rigidbody:[],collider:[],joint:[],rigidbody2D:[],collider2D:[],joint2D:[],uiBehaviour:[],monoBehaviour:[],animator:[],animation:[],particlesystem:[],particleSystemRenderer:[],reflectionprobe:[],videoPlayer:[],canvasRenderer:[],audiosourceunity:[],renderer:[],meshFilter:[],effector2D:[]},this._magicMethods=null,this._eventHanders=null,this.animation=null,this.audiolistener=null,this.camera=null,this.light=null,this.particlesystem=null,this.screen=null,this.sound=null,this.scene=null};return(e.prototype=Object.create(pc.GraphNode.prototype)).constructor=e,e.prototype.addComponent=function(t,e){const i=this._app.systems[t];return i?this.c[t]?(console.warn("addComponent: Entity already has "+t+" component. (Check for components duplicates, e.g. SkinnedMesh & MeshFilter are both 'Models')"),null):i.addComponent(this,e):(console.error("addComponent: System "+t+" doesn't exist"),null)},e.prototype.addUnityComponentFromDeserialization=function(t,e){this._app.systems[t].addComponent(this,e)},e.prototype.addUnityComponent=function(e,i){const s=[];if(LunaUnity.Application.Instance.app.systems.unitymanager.disableCallbacks(),this._app.systems[e].addComponent(this,i),s.push(i),!t){t=!0,pc.UnityComponent.addRequiredComponents(this,i.code,s),LunaUnity.Application.Instance.app.systems.unitymanager.enableCallbacks();for(let t=s.length-1;t>=0;t--){const e=s[t];e.configureForEntity&&e.configureForEntity(this),e.onAttached&&e.onAttached(),e.onInit&&e.onInit(),this.enabled&&e.enabled&&e._onEntityStateChanged&&e._onEntityStateChanged(!0)}t=!1}},e.prototype.removeComponent=function(t){const e=this._app.systems[t];e?this.c[t]?e.removeComponent(this):console.warn("removeComponent: Entity doesn't have "+t+" component"):console.error("removeComponent: System "+t+" doesn't exist")},e.prototype.getGuid=function(){return this._guid||this.setGuid(pc.guid.create()),this._guid},e.prototype.setGuid=function(t){const e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this},e.prototype._notifyHierarchyStateChanged=function(t,e){let i,s,n=!1;t===this&&0===this._app._enableList.length&&(n=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&this._app._enableList.push(t);const r=t._children;for(i=0,s=r.length;i<s;i++)r[i]._activeSelf&&this._notifyHierarchyStateChanged(r[i],e);if(t._beingEnabled=!1,n){for(i=0,s=this._app._enableList.length;i<s;i++)this._app._enableList[i]._onHierarchyStatePostChanged();this._app._enableList.length=0}},e.prototype._onHierarchyStateChanged=function(t){let e;pc.GraphNode.prototype._onHierarchyStateChanged.call(this,t),this.fire(t?"enable":"disable"),this._unityComponents&&this._app.systems.unity._onEntityHierarchyStateChanged(this,t);const i=this.c;for(const s in i)i.hasOwnProperty(s)&&(e=i[s],e.enabled&&(t?e.onEnable():e.onDisable()))},e.prototype._onHierarchyStatePostChanged=function(){const t=this.c;for(const e in t)t.hasOwnProperty(e)&&t[e].onPostStateChange()},e.prototype.setRequest=function(t){this._request=t},e.prototype.getRequest=function(){return this._request},e.prototype.findByGuid=function(t){if(this._guid===t)return this;const e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null},e.prototype.destroy=function(){let t;for(t in this._destroying=!0,this.c)this.c.hasOwnProperty(t)&&(this.c[t].enabled=!1);for(t in this.c)this.c.hasOwnProperty(t)&&this.c[t].system.removeComponent(this);for(let t=0;t<pc.UNITY_SYSTEM_IDS.length;t++){const e=this._unityComponents[pc.UNITY_SYSTEM_IDS[t]];for(let t=0;t<e.length;t++)e[t].destroy()}this._parent&&this._parent.removeChild(this);const e=this._children;let i=e.shift();for(;i;)i instanceof pc.Entity&&i.destroy(),i._parent=null,i=e.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1,this._destroyed=!0,this._layoutElements=[],this._layoutControllers=[],this._layoutSelfControllers=[],this._dimensionListeners=[],this._canvasElements=[],this._canvasGroups=[],this._meshModifiers=[]},e.prototype.clone=function(){const t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,function t(e,i,s,n){let r,o;if(i instanceof pc.Entity){const a=i.c;for(const t in a)if(a.hasOwnProperty(t)){const i=a[t],c=i.system.getPropertiesOfType("entity");for(r=0,o=c.length;r<o;r++){const o=c[r].name,a=i[o];if(!!e.findByGuid(a)){const e=n[a].getGuid();e?s.c[t][o]=e:console.warn("Could not find corresponding entity id when resolving duplicated entity references")}}}a.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(a.script,n);const c=i.children.filter(t=>t instanceof pc.Entity),h=s.children.filter(t=>t instanceof pc.Entity);for(r=0,o=c.length;r<o;r++)t(e,c[r],h[r],n)}}(this,this,e,t),e},e.prototype._cloneRecursively=function(t){const e=new pc.Entity(this._app);pc.GraphNode.prototype._cloneInternal.call(this,e);for(const t in this.c)if(this.c.hasOwnProperty(t)){this.c[t].system.cloneComponent(this,e)}let i;for(i=0;i<this._children.length;i++){const s=this._children[i];if(s instanceof pc.Entity){const i=s._cloneRecursively(t);e.addChild(i),t[s.getGuid()]=i}}return e},{Entity:e}}()),Object.assign(pc,{inherits:function(t,e){const i=function(){},s=function(i,s,n,r,o,a,c,h){e.call(this,i,s,n,r,o,a,c,h),t.call(this,i,s,n,r,o,a,c,h)};return s._super=e.prototype,i.prototype=e.prototype,s.prototype=new i,s}}),Object.assign(pc.gfx,{drawQuadWithShader:pc.drawQuadWithShader,programlib:pc.programlib,shaderChunks:pc.shaderChunks,ContextCreationError:pc.ContextCreationError,Device:pc.GraphicsDevice,IndexBuffer:pc.IndexBuffer,ProgramLibrary:pc.ProgramLibrary,RenderTarget:pc.RenderTarget,ScopeId:pc.ScopeId,Shader:pc.Shader,ShaderInput:pc.ShaderInput,Texture:pc.Texture,UnsupportedBrowserError:pc.UnsupportedBrowserError,VertexBuffer:pc.VertexBuffer,VertexFormat:pc.VertexFormat,VertexIterator:pc.VertexIterator}),function(){function t(t){this.name="UnsupportedBrowserError",this.message=t||""}function e(t){this.name="ContextCreationError",this.message=t||""}t.prototype=Error.prototype,e.prototype=Error.prototype,pc.ContextCreationError=e,pc.UnsupportedBrowserError=t}(),Object.assign(pc.input,{getTouchTargetCoords:pc.getTouchTargetCoords,Controller:pc.Controller,GamePads:pc.GamePads,Keyboard:pc.Keyboard,KeyboardEvent:pc.KeyboardEvent,Mouse:pc.Mouse,MouseEvent:pc.MouseEvent,Touch:pc.Touch,TouchDevice:pc.TouchDevice,TouchEvent:pc.TouchEvent}),pc.math.INV_LOG2=Math.LOG2E,pc.math.intToBytes=pc.math.intToBytes32,pc.math.bytesToInt=pc.math.bytesToInt32,pc.posteffect={createFullscreenQuad:pc.createFullscreenQuad,drawFullscreenQuad:pc.drawFullscreenQuad,PostEffect:pc.PostEffect,PostEffectQueue:pc.PostEffectQueue},Object.assign(pc.scene,{partitionSkin:pc.partitionSkin,procedural:{calculateTangents:pc.calculateTangents,createMesh:pc.createMesh,createTorus:pc.createTorus,createCylinder:pc.createCylinder,createCapsule:pc.createCapsule,createCone:pc.createCone,createSphere:pc.createSphere,createPlane:pc.createPlane,createBox:pc.createBox},BasicMaterial:pc.BasicMaterial,DepthMaterial:pc.DepthMaterial,ForwardRenderer:pc.ForwardRenderer,GraphNode:pc.GraphNode,Material:pc.Material,Command:pc.Command,Mesh:pc.Mesh,MeshInstance:pc.MeshInstance,Model:pc.Model,ParticleEmitter:pc.ParticleEmitter,PhongMaterial:pc.StandardMaterial,Picker:pc.Picker,PickMaterial:pc.PickMaterial,Projection:{ORTHOGRAPHIC:pc.PROJECTION_ORTHOGRAPHIC,PERSPECTIVE:pc.PROJECTION_PERSPECTIVE},Scene:pc.Scene,Skin:pc.Skin,SkinInstance:pc.SkinInstance}),pc.time=pc,pc.PhongMaterial=pc.StandardMaterial,pc.ELEMENTTYPE_INT8=pc.TYPE_INT8,pc.ELEMENTTYPE_UINT8=pc.TYPE_UINT8,pc.ELEMENTTYPE_INT16=pc.TYPE_INT16,pc.ELEMENTTYPE_UINT16=pc.TYPE_UINT16,pc.ELEMENTTYPE_INT32=pc.TYPE_INT32,pc.ELEMENTTYPE_UINT32=pc.TYPE_UINT32,pc.ELEMENTTYPE_FLOAT32=pc.TYPE_FLOAT32,Object.defineProperty(pc.shaderChunks,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+pc.shaderChunks.transformVS}}),Object.defineProperty(pc.Vec2.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),Object.defineProperty(pc.Vec3.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),Object.defineProperty(pc.Vec4.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),Object.defineProperty(pc.Color.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(pc.Color.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),pc.Material.prototype.getName=function(){return console.warn("DEPRECATED: pc.Material#getName is deprecated. Get the pc.Material#name property instead."),this.name},pc.Material.prototype.setName=function(t){console.warn("DEPRECATED: pc.Material#getName is deprecated. Set the pc.Material#name property instead."),this.name=t},pc.Material.prototype.getShader=function(){return console.warn("DEPRECATED: pc.Material#getShader is deprecated. Get the pc.Material#shader property instead."),this.shader},pc.Material.prototype.setShader=function(t){console.warn("DEPRECATED: pc.Material#setShader is deprecated. Set the pc.Material#shader property instead."),this.shader=t},Object.assign(pc.Application.prototype,function(){const t=new pc.GraphNode,e=new pc.GraphNode,i=[];let s=!1;const n=function(t){this.lineVertexFormat=new pc.VertexFormat(t,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_COLOR,components:4,type:pc.TYPE_UINT8,normalize:!0}]),this.lineBatches=[],this.layers=[],this.layerToBatch={},this.quadMesh=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.identityGraphNode=new pc.GraphNode};n.prototype.addLayer=function(t){this.layers.indexOf(t)<0&&this.layers.push(t)},n.prototype.getLayerIdx=function(t){return this.layerToBatch[t.id]},n.prototype.addLayerIdx=function(t,e){this.layerToBatch[e.id]=t};const r=function(){this.numLinesAllocated=128,this.vb=null,this.vbRam=null,this.mesh=null,this.linesUsed=0,this.material=null,this.meshInstance=null,this.layer=null};return Object.assign(r.prototype,{init:function(t,i,s,n){for(this.mesh||(this.mesh=new pc.Mesh,this.mesh.primitive[0].type=pc.PRIMITIVE_LINES,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new pc.BasicMaterial,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=pc.BLEND_NORMAL,this.material.update()),this.layer=s;this.linesUsed+n>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=i,this.vb||(this.vb=new pc.VertexBuffer(t,i,2*this.numLinesAllocated,pc.BUFFER_DYNAMIC),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(e.setWorldTransform(pc.Mat4.IDENTITY),this.meshInstance=new pc.MeshInstance(e,this.mesh,this.material),this.meshInstance.cull=!1))},addLines:function(t,e){const i=!!e.length;let s,n=2*this.linesUsed*this.vertexFormat.size;for(let r=0;r<t.length;r++)this.vbRam.setFloat32(n,t[r].x,!0),n+=4,this.vbRam.setFloat32(n,t[r].y,!0),n+=4,this.vbRam.setFloat32(n,t[r].z,!0),n+=4,s=i?e[r]:e,this.vbRam.setUint8(n,255*s.r),n+=1,this.vbRam.setUint8(n,255*s.g),n+=1,this.vbRam.setUint8(n,255*s.b),n+=1,this.vbRam.setUint8(n,255*s.a),n+=1;this.linesUsed+=t.length/2},finalize:function(){this.linesUsed>0&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,i[0]=this.meshInstance,this.layer.addMeshInstances(i,!0),this.linesUsed=0)}}),{renderMeshInstance:function(t,e){e||(e={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)}),this._initImmediate(),this._immediateData.addLayer(e.layer),i[0]=t,e.layer.addMeshInstances(i,!0)},renderMesh:function(e,s,n,r){r||(r={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)}),this._initImmediate(),t.setWorldTransform(n);const o=new pc.MeshInstance(t,e,s);o.cull=!1,r.mask&&(o.mask=r.mask),this._immediateData.addLayer(r.layer),i[0]=o,r.layer.addMeshInstances(i,!0)},renderWiredMesh:function(t,e,i){const s=new pc.Vec3,n=new pc.Vec3,r=new pc.Vec3,o=new pc.Color(1,0,0,1),a={depthTest:!1},c=e.numIndices,h=t.format.size/4;for(let l=0;l<c;l+=3){let c=e.storage[l]*h;s.x=t.storage[c],s.y=t.storage[c+1],s.z=t.storage[c+2],i.transformPoint(s,s),c=e.storage[l+1]*h,n.x=t.storage[c],n.y=t.storage[c+1],n.z=t.storage[c+2],i.transformPoint(n,n),c=e.storage[l+2]*h,r.x=t.storage[c],r.y=t.storage[c+1],r.z=t.storage[c+2],i.transformPoint(r,r),this.renderLine(s,n,o,a),this.renderLine(n,r,o,a),this.renderLine(r,s,o,a)}},renderLine:function(t,e,i,n,r){let o,a=i;n instanceof pc.Color?(a=n,"number"==typeof r?(s||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),s=!0),o=r===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):o=r):"number"==typeof n?(s||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),s=!0),a=i,o=n===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):o=n||{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0},this._addLines([t,e],[i,a],o)},renderLines:function(t,e,i){i?"number"==typeof i&&(s||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),s=!0),i=i===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):i={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0},!e.length||t.length===e.length?t.length%2==0?this._addLines(t,e,i):console.error("renderLines: array length is not divisible by 2"):console.error("renderLines: position/color arrays have different lengths")},renderQuad:function(e,s,n){if(n||(n={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)}),this._initImmediate(),!this._immediateData.quadMesh){const t=new pc.VertexFormat(this.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32}]),e=new pc.VertexBuffer(this.graphicsDevice,t,4),i=new pc.VertexIterator(e);i.element[pc.SEMANTIC_POSITION].set(-.5,-.5,0),i.next(),i.element[pc.SEMANTIC_POSITION].set(.5,-.5,0),i.next(),i.element[pc.SEMANTIC_POSITION].set(-.5,.5,0),i.next(),i.element[pc.SEMANTIC_POSITION].set(.5,.5,0),i.end(),this._immediateData.quadMesh=new pc.Mesh,this._immediateData.quadMesh.vertexBuffer=e,this._immediateData.quadMesh.primitive[0].type=pc.PRIMITIVE_TRISTRIP,this._immediateData.quadMesh.primitive[0].base=0,this._immediateData.quadMesh.primitive[0].count=4,this._immediateData.quadMesh.primitive[0].indexed=!1}t.setWorldTransform(e);const r=new pc.MeshInstance(t,this._immediateData.quadMesh,s);r.cull=!1,i[0]=r,this._immediateData.addLayer(n.layer),n.layer.addMeshInstances(i,!0)},renderWireCube:function(t,e,i){let s;if(this._initImmediate(),!this._immediateData.cubeLocalPos){const t=.5;this._immediateData.cubeLocalPos=[new pc.Vec3(-t,-t,-t),new pc.Vec3(-t,t,-t),new pc.Vec3(t,t,-t),new pc.Vec3(t,-t,-t),new pc.Vec3(-t,-t,t),new pc.Vec3(-t,t,t),new pc.Vec3(t,t,t),new pc.Vec3(t,-t,t)],this._immediateData.cubeWorldPos=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3]}const n=this._immediateData.cubeLocalPos,r=this._immediateData.cubeWorldPos;for(s=0;s<8;s++)t.transformPoint(n[s],r[s]);this.renderLines([r[0],r[1],r[1],r[2],r[2],r[3],r[3],r[0],r[4],r[5],r[5],r[6],r[6],r[7],r[7],r[4],r[0],r[4],r[1],r[5],r[2],r[6],r[3],r[7]],e,i)},_addLines:function(t,e,i){void 0===(i=i||{}).layer&&(i.layer=this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)),void 0===i.depthTest&&(i.depthTest=!0),this._initImmediate();const s=i.layer;this._immediateData.addLayer(s);let n=this._immediateData.getLayerIdx(s);if(void 0===n){const e=new r;e.init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,t.length/2),e.material.depthTest=i.depthTest,i.mask&&(e.meshInstance.mask=i.mask),n=this._immediateData.lineBatches.push(e)-1,this._immediateData.addLayerIdx(n,s)}else this._immediateData.lineBatches[n].init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,t.length/2),this._immediateData.lineBatches[n].material.depthTest=i.depthTest,i.mask&&(this._immediateData.lineBatches[n].meshInstance.mask=i.mask);this._immediateData.lineBatches[n].addLines(t,e)},_initImmediate:function(){this._immediateData||(this._immediateData=new n(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_preRenderImmediate:function(){for(let t=0;t<this._immediateData.lineBatches.length;t++)this._immediateData.lineBatches[t]&&this._immediateData.lineBatches[t].finalize()},_postRenderImmediate:function(){for(let t=0;t<this._immediateData.layers.length;t++)this._immediateData.layers[t].clearMeshInstances(!0);this._immediateData.layers.length=0}}}()),Object.assign(pc,function(){const t=function(t){this.id=pc.Mesh.id++,this.entity=t.entity,this.parentScreen=t,this.renderers=new pc.IndexedList,this.device=pc.Application.getApplication().graphicsDevice,this.renderer=pc.Application.getApplication().renderer,this.renderersDirty=!1,this._aabb=new pc.BoundingBox,this.node=t.entity,this.visible=!0,this.cull=!0,this.isCanvas=!0,this._material=UnityEngine.Canvas.GetDefaultCanvasMaterial().handle,this._material.setParameter("unity_GUIZTestMode",pc.FUNC_ALWAYS+1);const e=this._material.parameters.unity_GUIZTestMode;e.scopeId||(e.scopeId=this.device.scope.resolve("unity_GUIZTestMode")),this._mesh={},this.scene=pc.Application.getApplication().scene,this.drawCalls=[],this.meshInstances=[]};return Object.assign(t.prototype,{uiElementsSort:function(t,e){return pc.SortUtils.uiElementsSort(t.model,e.model)},render:function(t,e,i,s,n){this.checkDirtyAndUpdateHierarchy(),this.drawCalls.length=0,this.meshInstances.length=0;const r=this.renderers.list(),o=[];for(let t=0;t<r.length;t++){const e=r[t];if(!e.isCanvas&&(0===e._groupAlpha||e.cull))continue;!e.isCanvas&&e.popMaterialCount>0&&o.push(e);const i=e.model.meshInstances;for(let t=0;t<i.length;t++){const e=i[t];(e.isCanvas||0!==e._mesh.primitive[0].count)&&this.meshInstances.push(e)}}i?pc.Culling.cullUi(i,this.meshInstances,this.drawCalls):this.drawCalls=this.meshInstances;for(let t=0;t<o.length;t++){const e=o[t],i=this.getLastDrawChild(e.entity,this.drawCalls,0);if(i){const t=i.node._guid;this.scene.activeUiMasks[t]||(this.scene.activeUiMasks[t]=[]),this.scene.activeUiMasks[t].push(e)}}const a=this.parentScreen.screenType!==pc.SCREEN_TYPE_SCREEN?pc.FUNC_LESSEQUAL+1:pc.FUNC_ALWAYS+1;for(let r=0;r<this.drawCalls.length;r++){const o=this.drawCalls[r];if(o.isCanvas){o.render(t,e,i,s,n);continue}o.material.setParameter("unity_GUIZTestMode",a),this.renderer.renderMeshInstance(t,e,i,o,n);const c=this.scene.activeUiMasks[o.node._guid];if(c){for(let s=0;s<c.length;s++){const r=c[s],o=r._popMaterials,a=r.model.meshInstances[0];if(a)for(let s=0;s<o.length;s++){const r=o[s].handle;this.clearMask(t,e,i,a,n,r)}}this.scene.activeUiMasks[o.node._guid]=null}}if(!this.parentScreen.parentScreen)for(const t in this.scene.activeUiMasks)this.scene.activeUiMasks[t]=null},getLastDrawChild(t,e,i){let s=null;const n=t.allChildren();for(let t=i+1;t<e.length;t++){const i=e[t],r=i.node;n.indexOf(r)>=0&&(s=i)}return s},clearMask(t,e,i,s,n,r){const o=s.material,a=s.parameters.hasOwnProperty("_ColorMask")?s.parameters._ColorMask.data:null;s.material=r,a&&(s.parameters._ColorMask.data=r.parameters._ColorMask.data),this.renderer.renderMeshInstance(t,e,i,s,n),s.material=o,a&&(s.parameters._ColorMask.data=a)},addRenderer:function(t){this.renderers.has(t)||(this.renderers.push(t),this.renderersDirty=!0)},removeRenderer:function(t){this.renderers.has(t)&&(this.renderers.remove(t),this.renderersDirty=!0)},checkDirtyAndUpdateHierarchy(){if(this.updateModel(),!this.renderersDirty)return;this.parentScreen.system._syncDrawOrder(),this.parentScreen._updateStencilParameters(),this.renderers.sort(this.uiElementsSort),this._aabb.setToInfinity();const t=this.renderers.list();for(let e=0;e<t.length;e++){const i=t[e].model.meshInstances;for(let t=0;t<i.length;t++)this._aabb.add(i[t].aabb)}this.renderersDirty=!1},updateModel:function(){const t=this.renderers.list();for(let e=0;e<t.length;e++){const i=t[e];i.isCanvas||i.model.update()}}}),Object.defineProperty(t.prototype,"aabb",{get:function(){return this.checkDirtyAndUpdateHierarchy(),this._aabb}}),Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh}}),Object.defineProperty(t.prototype,"sortingLayerIndex",{get:function(){return this.parentScreen.sortingLayerIndex}}),Object.defineProperty(t.prototype,"sortingOrder",{get:function(){return this.parentScreen.sortingOrder}}),Object.defineProperty(t.prototype,"drawOrder",{get:function(){return this.parentScreen.drawOrder}}),Object.defineProperty(t.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t}}),Object.defineProperty(t.prototype,"model",{get:function(){return this.parentScreen}}),{CanvasMeshInstance:t}}());